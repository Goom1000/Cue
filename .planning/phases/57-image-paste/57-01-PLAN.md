---
phase: 57-image-paste
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/usePaste.ts
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "User pastes a screenshot and it becomes a new full-image slide"
    - "Pasted image is compressed to prevent file bloat (max 1920px, JPEG 0.8)"
    - "User sees toast with option to replace current slide instead of creating new"
    - "Web-copied images with HTML wrappers route to image paste, not HTML parse"
  artifacts:
    - path: "hooks/usePaste.ts"
      provides: "Image-vs-HTML routing with wrapper detection"
    - path: "App.tsx"
      provides: "handleImagePaste handler, compressImage utility, toast-based action prompt"
  key_links:
    - from: "hooks/usePaste.ts"
      to: "App.tsx"
      via: "onPaste callback with isImageOnly flag"
      pattern: "isImageOnly.*imageBlob"
    - from: "App.tsx compressImage"
      to: "Slide.imageUrl"
      via: "Canvas compression before storage"
      pattern: "compressImage.*toDataURL"
---

<objective>
Add image paste routing so standalone images (screenshots, copied images) create full-image slides with compressed storage. When a user pastes an image, it defaults to creating a new slide; a toast offers the alternative to replace the current slide's image.

Purpose: IMG-01 (paste images from clipboard) and IMG-03 (pasted image displays as full bleed) are the foundational behaviors for Phase 57. Compression prevents .cue file bloat from Retina screenshots.

Output: Updated usePaste hook with image-vs-HTML routing, compressImage utility in App.tsx, handleImagePaste flow with toast prompt, full-image slides created from standalone image pastes.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-image-paste/57-RESEARCH.md
@hooks/usePaste.ts
@App.tsx
@components/Toast.tsx
@types.ts
@components/SlideRenderers.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image routing to usePaste and compressImage utility</name>
  <files>hooks/usePaste.ts, App.tsx</files>
  <action>
  **usePaste.ts changes:**

  The current usePaste hook extracts `imageBlob` from clipboard items and returns it alongside `html` and `text`. The callback signature is `(result: { html: string | null; text: string | null; imageBlob: Blob | null }) => void`.

  Add an `isImageOnly` flag to the callback result. Determine this by checking:
  1. `imageBlob` is present AND
  2. Either `html` is null/empty OR `html` is just an image wrapper (contains only an `<img>` tag with no substantive text content)

  To detect HTML image wrappers: parse the HTML string, strip tags, check if remaining text content (trimmed) is empty or just whitespace. If so, the HTML is just wrapping an image — treat as image-only paste.

  Updated callback type: `(result: { html: string | null; text: string | null; imageBlob: Blob | null; isImageOnly: boolean }) => void`

  **App.tsx changes — compressImage utility:**

  Add a `compressImage` function near the existing `readBlobAsDataUrl` helper (around line 896-903). This function:
  - Takes a data URL string, optional maxDimension (default 1920), optional quality (default 0.8)
  - Creates an Image element, loads the data URL
  - If image dimensions are both <= maxDimension, return original data URL (no compression needed)
  - Otherwise, scale down proportionally to fit within maxDimension
  - For GIF images (check if dataUrl starts with `data:image/gif`), skip compression entirely (preserve animation)
  - Draw to canvas, return `canvas.toDataURL('image/jpeg', quality)`
  - Returns Promise<string>

  **App.tsx changes — handleImagePaste flow:**

  Modify the existing `handlePasteSlide` callback to check `result.isImageOnly`. When true, instead of going through the HTML parsing flow:

  1. Read the imageBlob as data URL using existing `readBlobAsDataUrl`
  2. Compress using `compressImage(dataUrl)`
  3. Default action: Create a new slide at the current insert position with:
     - `layout: 'full-image'`
     - `imageUrl: compressedDataUrl`
     - `title: 'Image Slide'` (placeholder, editable)
     - `content: []` (empty — no text overlay)
     - `source: { type: 'pasted', pastedAt: new Date().toISOString() }`
     - Do NOT set `originalPastedImage` (that's for PowerPoint pastes only — Phase 56)
  4. Show toast: "Image added as new slide" with action button `{ label: 'Replace current instead', onClick: () => replaceCurrentSlideImage(compressedDataUrl) }`
  5. The `replaceCurrentSlideImage` function: calls `handleUpdateSlide` on the active slide with `{ layout: 'full-image', imageUrl: compressedDataUrl, content: [] }`. Keep existing `title` and `speakerNotes`. Show toast "Replaced slide image".

  When `isImageOnly` is false (HTML paste with real content), the existing `handlePasteSlide` flow continues unchanged — this is the PowerPoint/rich-text path from Phase 55/56.

  **Important:** The toast timeout should be generous (8-10 seconds) since "Replace current instead" is a time-sensitive action. After timeout, the default (new slide) is already done.
  </action>
  <verify>
  1. Build succeeds: `npm run build` (no TypeScript errors)
  2. Grep for `isImageOnly` in `hooks/usePaste.ts` — should appear in callback result
  3. Grep for `compressImage` in `App.tsx` — should appear as function definition
  4. Grep for `Replace current instead` in `App.tsx` — should appear in toast action
  </verify>
  <done>
  - Pasting a screenshot creates a new full-image slide with compressed image
  - Toast appears with "Replace current instead" option
  - Web-copied images with HTML wrappers correctly route to image paste (not HTML parse)
  - GIF images are not compressed (animation preserved)
  - Existing HTML paste flow (PowerPoint) is unchanged
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Paste a screenshot (Cmd+Shift+4 on Mac, then Cmd+V) — new full-image slide appears
3. The pasted image fills the slide edge-to-edge
4. Toast appears with "Replace current instead" action
5. Clicking "Replace current instead" replaces the active slide's image
6. Copy an image from a web page (right-click > Copy Image) — routes to image paste, not HTML parse
7. Paste from PowerPoint — still goes through existing HTML/image analysis flow
</verification>

<success_criteria>
- IMG-01 satisfied: Screenshots and copied images become slides
- IMG-03 satisfied: Images display as full-bleed slides
- Image compression prevents .cue file bloat
- Existing paste flows (PowerPoint, rich text) are not broken
</success_criteria>

<output>
After completion, create `.planning/phases/57-image-paste/57-01-SUMMARY.md`
</output>
