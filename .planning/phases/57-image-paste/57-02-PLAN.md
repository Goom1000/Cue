---
phase: 57-image-paste
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - services/providers/geminiProvider.ts
  - services/providers/claudeProvider.ts
  - services/slideAnalysis/slideAnalysisPrompts.ts
autonomous: true

must_haves:
  truths:
    - "analyzeImage() method exists on AIProviderInterface"
    - "Gemini provider implements analyzeImage with vision API and structured output"
    - "Claude provider implements analyzeImage with vision API and tool_choice"
    - "Image caption prompt generates description + teaching talking points"
  artifacts:
    - path: "services/aiProvider.ts"
      provides: "analyzeImage method on AIProviderInterface"
      contains: "analyzeImage"
    - path: "services/providers/geminiProvider.ts"
      provides: "Gemini analyzeImage implementation"
      contains: "analyzeImage"
    - path: "services/providers/claudeProvider.ts"
      provides: "Claude analyzeImage implementation"
      contains: "analyzeImage"
    - path: "services/slideAnalysis/slideAnalysisPrompts.ts"
      provides: "IMAGE_CAPTION_PROMPT, IMAGE_CAPTION_SCHEMA, IMAGE_CAPTION_TOOL"
      contains: "IMAGE_CAPTION"
  key_links:
    - from: "services/aiProvider.ts"
      to: "services/providers/geminiProvider.ts"
      via: "AIProviderInterface.analyzeImage"
      pattern: "analyzeImage.*imageBase64"
    - from: "services/slideAnalysis/slideAnalysisPrompts.ts"
      to: "services/providers/geminiProvider.ts"
      via: "Import of IMAGE_CAPTION constants"
      pattern: "import.*IMAGE_CAPTION"
---

<objective>
Add a lighter-weight AI image caption method to both providers. Unlike analyzePastedSlide (which extracts slide structure from PowerPoint screenshots), analyzeImage describes what's in any image and suggests teaching talking points.

Purpose: IMG-05 backend — provides the AI infrastructure for generating captions on image-only slides. The UI integration (on-demand button) happens in Plan 03.

Output: analyzeImage() method on AIProviderInterface, implementations in both Gemini and Claude providers, image caption prompts and schemas in slideAnalysisPrompts.ts.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-image-paste/57-RESEARCH.md
@services/aiProvider.ts
@services/providers/geminiProvider.ts
@services/providers/claudeProvider.ts
@services/slideAnalysis/slideAnalysisPrompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image caption prompts and schemas</name>
  <files>services/slideAnalysis/slideAnalysisPrompts.ts</files>
  <action>
  Add new exports to the existing `slideAnalysisPrompts.ts` file (which already has `SLIDE_ANALYSIS_PROMPT`, `SLIDE_RESPONSE_SCHEMA`, and `SLIDE_CREATION_TOOL` from Phase 56).

  **IMAGE_CAPTION_PROMPT** — a system prompt for image captioning:
  ```
  You are an education assistant for Cue, a presentation tool for primary school teachers (Year 6, ages 10-11, Australian curriculum).

  Analyze this image and provide:
  1. A short, descriptive title (3-7 words) suitable as a slide title
  2. A caption describing what the image shows (1-2 sentences)
  3. Teaching talking points — what should the teacher say about this image? Include key concepts, vocabulary to highlight, and questions to ask students.

  Format the talking points as a natural teleprompter script the teacher can read while presenting. Write in second person ("Tell the students...", "Point out...").
  ```

  **IMAGE_CAPTION_SCHEMA** — Gemini responseSchema format (using the same `Type` import from `@google/genai` already used in this file):
  ```typescript
  export const IMAGE_CAPTION_SCHEMA = {
    type: Type.OBJECT,
    properties: {
      title: { type: Type.STRING, description: "Short descriptive title for the image (3-7 words)" },
      caption: { type: Type.STRING, description: "What the image shows (1-2 sentences)" },
      teachingNotes: { type: Type.STRING, description: "Teleprompter script with teaching talking points, vocabulary, and student questions" },
    },
    required: ["title", "caption", "teachingNotes"],
  };
  ```

  **IMAGE_CAPTION_TOOL** — Claude tool_choice format (JSON Schema, same pattern as existing `SLIDE_CREATION_TOOL`):
  ```typescript
  export const IMAGE_CAPTION_TOOL = {
    name: "create_image_caption",
    description: "Generate a title, caption, and teaching notes for an image",
    input_schema: {
      type: "object" as const,
      properties: {
        title: { type: "string", description: "Short descriptive title for the image (3-7 words)" },
        caption: { type: "string", description: "What the image shows (1-2 sentences)" },
        teachingNotes: { type: "string", description: "Teleprompter script with teaching talking points, vocabulary, and student questions" },
      },
      required: ["title", "caption", "teachingNotes"],
    },
  };
  ```

  **ImageCaptionResult type** — export interface:
  ```typescript
  export interface ImageCaptionResult {
    title: string;
    caption: string;
    teachingNotes: string;
  }
  ```
  </action>
  <verify>
  1. File compiles: `npx tsc --noEmit services/slideAnalysis/slideAnalysisPrompts.ts` (or `npm run build`)
  2. Grep for `IMAGE_CAPTION_PROMPT` — exported
  3. Grep for `IMAGE_CAPTION_SCHEMA` — exported
  4. Grep for `IMAGE_CAPTION_TOOL` — exported
  5. Grep for `ImageCaptionResult` — exported
  </verify>
  <done>
  Image caption prompts and schemas exist and compile. Ready for provider implementation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement analyzeImage on both providers</name>
  <files>services/aiProvider.ts, services/providers/geminiProvider.ts, services/providers/claudeProvider.ts</files>
  <action>
  **aiProvider.ts — interface update:**

  Add `analyzeImage` to the `AIProviderInterface`. Import `ImageCaptionResult` from slideAnalysisPrompts. Follow the existing pattern of `analyzePastedSlide`:

  ```typescript
  analyzeImage(imageBase64: string): Promise<ImageCaptionResult>;
  ```

  Add it after the existing `analyzePastedSlide` method in the interface. The `imageBase64` parameter is the raw base64 string (no `data:image/...;base64,` prefix), same convention as `analyzePastedSlide`.

  Also add `analyzeImage` to the `currentProvider` proxy object that delegates to `activeProvider.analyzeImage(...)`.

  **geminiProvider.ts — implementation:**

  Add `analyzeImage` method following the exact same pattern as `analyzePastedSlide` (which is already in this file). Key differences:
  - Use `IMAGE_CAPTION_PROMPT` instead of `SLIDE_ANALYSIS_PROMPT`
  - Use `IMAGE_CAPTION_SCHEMA` instead of `SLIDE_RESPONSE_SCHEMA`
  - Return `ImageCaptionResult` instead of slide structure
  - Same vision API call pattern: `generateContent` with inline image data (`inlineData: { mimeType: 'image/jpeg', data: imageBase64 }`)
  - Same `responseMimeType: 'application/json'` and `responseSchema` pattern
  - Parse JSON response and return `{ title, caption, teachingNotes }`
  - Wrap in try/catch, console.error on failure, throw user-friendly error

  Import `IMAGE_CAPTION_PROMPT`, `IMAGE_CAPTION_SCHEMA`, `ImageCaptionResult` from `../slideAnalysis/slideAnalysisPrompts`.

  **claudeProvider.ts — implementation:**

  Add `analyzeImage` method following the exact same pattern as `analyzePastedSlide` (which is already in this file). Key differences:
  - Use `IMAGE_CAPTION_PROMPT` instead of `SLIDE_ANALYSIS_PROMPT`
  - Use `IMAGE_CAPTION_TOOL` instead of `SLIDE_CREATION_TOOL`
  - Return `ImageCaptionResult` instead of slide structure
  - Same Messages API call with image content block: `{ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: imageBase64 } }`
  - Same `tool_choice: { type: 'tool', name: 'create_image_caption' }` pattern
  - Extract result from `tool_use` content block input
  - Return `{ title, caption, teachingNotes }`
  - Wrap in try/catch, console.error on failure, throw user-friendly error

  Import `IMAGE_CAPTION_PROMPT`, `IMAGE_CAPTION_TOOL`, `ImageCaptionResult` from `../slideAnalysis/slideAnalysisPrompts`.
  </action>
  <verify>
  1. `npm run build` succeeds with no TypeScript errors
  2. Grep for `analyzeImage` in `services/aiProvider.ts` — appears in interface and proxy
  3. Grep for `analyzeImage` in `services/providers/geminiProvider.ts` — implementation exists
  4. Grep for `analyzeImage` in `services/providers/claudeProvider.ts` — implementation exists
  5. Grep for `IMAGE_CAPTION` in both providers — imports present
  </verify>
  <done>
  - analyzeImage() is callable via the AIProviderInterface
  - Both Gemini and Claude providers implement it with their respective vision APIs
  - Returns { title, caption, teachingNotes } with educational talking points
  - Error handling matches existing provider patterns
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. The analyzeImage method exists on AIProviderInterface
3. Both providers implement it following existing vision API patterns
4. Prompt includes Year 6 educational context
5. Structured output schemas match between Gemini (responseSchema) and Claude (tool_choice) approaches
</verification>

<success_criteria>
- IMG-05 backend satisfied: AI can analyze images and generate captions with teaching talking points
- Both Gemini and Claude providers work (dual-provider parity maintained)
- Lighter-weight than analyzePastedSlide (simpler prompt, fewer output fields)
- No new dependencies needed
</success_criteria>

<output>
After completion, create `.planning/phases/57-image-paste/57-02-SUMMARY.md`
</output>
