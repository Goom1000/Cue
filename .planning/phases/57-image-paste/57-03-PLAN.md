---
phase: 57-image-paste
plan: 03
type: execute
wave: 2
depends_on: ["57-01", "57-02"]
files_modified:
  - hooks/useDragDrop.ts
  - components/SlideRenderers.tsx
  - components/SlideCard.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag an image file from Finder onto the app and it becomes a slide"
    - "Dropping an image on the editing stage replaces the active slide's image"
    - "Full Image layout shows placeholder with file picker when no image exists"
    - "User can click 'Generate AI Notes' button on image slides to get teaching talking points"
    - "AI-generated caption appears as editable speaker notes"
  artifacts:
    - path: "hooks/useDragDrop.ts"
      provides: "onImageFile callback for image drag-drop"
      contains: "onImageFile"
    - path: "components/SlideRenderers.tsx"
      provides: "Full Image empty state with placeholder and file picker"
      contains: "Paste or drop an image"
    - path: "components/SlideCard.tsx"
      provides: "Generate AI Notes button for image slides"
      contains: "Generate AI Notes"
    - path: "App.tsx"
      provides: "handleImageDrop handler, handleGenerateImageCaption handler"
      contains: "handleImageDrop"
  key_links:
    - from: "hooks/useDragDrop.ts"
      to: "App.tsx handleImageDrop"
      via: "onImageFile callback parameter"
      pattern: "onImageFile.*handleImageDrop"
    - from: "components/SlideCard.tsx Generate AI Notes button"
      to: "App.tsx handleGenerateImageCaption"
      via: "onGenerateCaption prop"
      pattern: "onGenerateCaption"
    - from: "App.tsx handleGenerateImageCaption"
      to: "services/aiProvider.ts analyzeImage"
      via: "currentProvider.analyzeImage call"
      pattern: "analyzeImage.*imageBase64"
---

<objective>
Add drag-drop image support, Full Image layout empty state, and AI caption UI. This completes all five IMG requirements by wiring the infrastructure from Plans 01 and 02 into the user-facing experience.

Purpose: IMG-02 (Full Image layout option), IMG-04 (drag-drop images), and IMG-05 (AI caption UI) complete the image paste feature set.

Output: Extended useDragDrop hook, Full Image empty state with file picker, drag-drop handlers in App.tsx, "Generate AI Notes" button on image slides, AI caption wired to teleprompter/speaker notes.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-image-paste/57-RESEARCH.md
@.planning/phases/57-image-paste/57-01-SUMMARY.md
@.planning/phases/57-image-paste/57-02-SUMMARY.md
@hooks/useDragDrop.ts
@components/SlideRenderers.tsx
@components/SlideCard.tsx
@App.tsx
@services/aiProvider.ts
@components/Toast.tsx
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useDragDrop for image files and wire drop handler</name>
  <files>hooks/useDragDrop.ts, App.tsx</files>
  <action>
  **useDragDrop.ts changes:**

  Add an `onImageFile` optional callback parameter to the `useDragDrop` function signature:

  ```typescript
  export function useDragDrop(
    onFile: (file: File) => void,
    enabled: boolean = true,
    onInvalidFile?: (file: File) => void,
    onImageFile?: (file: File) => void
  ): void
  ```

  In the `handleDrop` function, before the existing `.cue`/`.pipi` extension check, add:

  ```typescript
  if (file.type.startsWith('image/') && onImageFile) {
    onImageFile(file);
    return;
  }
  ```

  This routes image files to the new callback while preserving existing .cue file handling. If `onImageFile` is not provided, image files fall through to `onInvalidFile` (existing behavior).

  Also update the `handleDragOver` to accept image files in the visual feedback (if any drag-over styling exists).

  **App.tsx changes — handleImageDrop handler:**

  Create a `handleImageDrop` callback (useCallback) that:
  1. Reads the dropped File as a data URL using `readBlobAsDataUrl(file)`
  2. Compresses it using the `compressImage` utility from Plan 01
  3. Replaces the ACTIVE slide's image: call `handleUpdateSlide(activeSlideId, { layout: 'full-image', imageUrl: compressedDataUrl, content: [] })`. Keep existing title and speakerNotes.
  4. Shows toast: "Image dropped — replaced current slide"
  5. If no active slide exists (empty deck), create a new slide instead (same as paste flow from Plan 01)

  The rationale for defaulting to "replace" on drop (vs "new slide" on paste): drag-drop has spatial intent — the user is dropping onto a visible slide. Paste is ambient — no spatial target.

  Wire `handleImageDrop` into the existing `useDragDrop` call in App.tsx as the 4th argument:

  ```typescript
  useDragDrop(handleFileOpen, true, handleInvalidFile, handleImageDrop);
  ```
  </action>
  <verify>
  1. `npm run build` succeeds
  2. Grep for `onImageFile` in `hooks/useDragDrop.ts` — appears in signature and handleDrop
  3. Grep for `handleImageDrop` in `App.tsx` — handler defined and passed to useDragDrop
  4. Grep for `image/` in `hooks/useDragDrop.ts` — MIME type check present
  </verify>
  <done>
  - Dragging an image file from Finder onto the app replaces the active slide's image
  - If no slides exist, creates a new full-image slide
  - Existing .cue file drag-drop is unchanged
  - Toast confirms the drop action
  </done>
</task>

<task type="auto">
  <name>Task 2: Full Image empty state and AI caption button</name>
  <files>components/SlideRenderers.tsx, components/SlideCard.tsx, App.tsx</files>
  <action>
  **SlideRenderers.tsx — Full Image empty state:**

  In the `FullImageLayout` component (or wherever the full-image layout is rendered), add an empty state when `layout === 'full-image'` but `imageUrl` is falsy and `originalPastedImage` is falsy:

  Show a placeholder with:
  - Dashed border container (matching the app's design language)
  - Camera/image icon (use an SVG icon inline, or a simple emoji-free text icon like a dashed rectangle)
  - Text: "Paste or drop an image"
  - A hidden `<input type="file" accept="image/*">` that opens on clicking the placeholder
  - On file selection: read the file, compress it (call the onImageSelected callback passed as prop), update the slide's imageUrl

  The placeholder should fill the slide area and look intentional, not broken. Use Tailwind classes matching the existing design (border-dashed, border-2, rounded-lg, flex items-center justify-center, text-slate-400).

  Add an `onImageSelected` prop to the FullImageLayout (or to SlideContentRenderer which wraps it). This callback receives the compressed image data URL. The parent (SlideCard/App.tsx) provides this callback which calls `handleUpdateSlide(slideId, { imageUrl: compressedDataUrl })`.

  **SlideCard.tsx — Generate AI Notes button:**

  Add a "Generate AI Notes" button that appears when:
  - The slide has `layout === 'full-image'` AND `imageUrl` is truthy
  - The slide does NOT already have speakerNotes (or show as "Regenerate AI Notes" if it does)

  Button placement: In the slide editing area, near the existing AI-related controls. Use a small secondary button style.

  The button calls an `onGenerateCaption` prop: `(slideId: string) => void`

  While generating, show a loading state (disable button, show spinner text like "Generating...").

  **App.tsx — handleGenerateImageCaption handler:**

  Create a `handleGenerateImageCaption` callback that:
  1. Gets the slide by ID from state
  2. Extracts the base64 data from `slide.imageUrl` (strip the `data:image/...;base64,` prefix)
  3. Calls `currentProvider.analyzeImage(imageBase64)` (from Plan 02)
  4. On success: update the slide with:
     - `title: result.title` (replace placeholder title)
     - `speakerNotes: result.caption + '\n\n' + result.teachingNotes` (caption + teaching notes combined)
  5. Show toast: "AI notes generated"
  6. On error: show toast with error message, don't update slide

  Pass `handleGenerateImageCaption` as `onGenerateCaption` prop to SlideCard.

  Also pass a new `onImageSelected` callback to SlideCard (or through to SlideRenderers) that handles the file picker result: read file as data URL, compress, update slide imageUrl.
  </action>
  <verify>
  1. `npm run build` succeeds
  2. Grep for `Paste or drop an image` in `components/SlideRenderers.tsx` — empty state text present
  3. Grep for `Generate AI Notes` in `components/SlideCard.tsx` — button present
  4. Grep for `handleGenerateImageCaption` in `App.tsx` — handler defined
  5. Grep for `onGenerateCaption` in `components/SlideCard.tsx` — prop present
  6. Grep for `onImageSelected` in code — callback chain exists
  </verify>
  <done>
  - Full Image layout with no image shows dashed placeholder with "Paste or drop an image"
  - Clicking placeholder opens file picker for image selection
  - "Generate AI Notes" button appears on image slides
  - Clicking button calls AI and populates title + speaker notes
  - AI notes are editable (standard speakerNotes field)
  - IMG-02, IMG-05 UI complete
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Drag an image file from Finder onto the app — replaces active slide
3. Select "Full Image" layout on an empty slide — dashed placeholder appears
4. Click placeholder — file picker opens, selecting image fills the slide
5. Click "Generate AI Notes" on an image slide — AI generates title and teaching notes
6. Speaker notes are populated with caption + teaching talking points
7. Existing drag-drop for .cue files still works
</verification>

<success_criteria>
- IMG-02 satisfied: Full Image layout option with functional empty state
- IMG-04 satisfied: Drag-drop images onto slides works
- IMG-05 satisfied: AI generates editable caption with teaching notes
- All five IMG requirements are complete when combined with Plans 01 and 02
</success_criteria>

<output>
After completion, create `.planning/phases/57-image-paste/57-03-SUMMARY.md`
</output>
