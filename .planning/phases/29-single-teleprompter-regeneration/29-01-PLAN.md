---
phase: 29-single-teleprompter-regeneration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - services/geminiService.ts
  - services/providers/geminiProvider.ts
  - services/providers/claudeProvider.ts
  - components/PresentationView.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can click Regen button in teleprompter panel to regenerate current slide's script"
    - "Regenerated script matches currently selected verbosity level (Concise/Standard/Detailed)"
    - "Regenerated script flows naturally with surrounding slides (not generic intro on slide 8)"
    - "Standard regeneration updates speakerNotes and clears cache"
    - "Concise/Detailed regeneration updates cache only"
  artifacts:
    - path: "services/aiProvider.ts"
      provides: "Extended regenerateTeleprompter interface signature"
      contains: "prevSlide?: Slide"
    - path: "services/geminiService.ts"
      provides: "Context-aware regeneration prompt"
      contains: "CONTEXT FOR COHERENT FLOW"
    - path: "services/providers/geminiProvider.ts"
      provides: "Updated method passthrough"
      contains: "prevSlide, nextSlide"
    - path: "services/providers/claudeProvider.ts"
      provides: "Updated method with context"
      contains: "prevSlide, nextSlide"
    - path: "components/PresentationView.tsx"
      provides: "Regenerate handler and UI button"
      contains: "handleRegenerateScript"
  key_links:
    - from: "components/PresentationView.tsx"
      to: "provider.regenerateTeleprompter"
      via: "handleRegenerateScript calls provider method"
      pattern: "provider\\.regenerateTeleprompter.*prevSlide.*nextSlide"
    - from: "handleRegenerateScript"
      to: "onUpdateSlide"
      via: "callback prop for cache/speakerNotes update"
      pattern: "onUpdateSlide.*currentSlide\\.id"
---

<objective>
Add single-slide teleprompter regeneration with context awareness.

Purpose: Teachers can regenerate a slide's script after manual edits without losing context coherence with surrounding slides. This extends v3.1 verbosity system with explicit regeneration trigger.

Output: Working "Regen" button in teleprompter panel that regenerates script for current slide at current verbosity level, using surrounding slides for natural flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-single-teleprompter-regeneration/29-RESEARCH.md

# Key existing code references (from research):
# - services/aiProvider.ts lines 206-210: Current regenerateTeleprompter interface
# - services/geminiService.ts lines 861-907: Current regenerateTeleprompter implementation
# - services/providers/geminiProvider.ts lines 137-143: Provider passthrough
# - services/providers/claudeProvider.ts lines 826-849: Claude implementation
# - components/PresentationView.tsx lines 901-952: handleVerbosityChange pattern
# - components/PresentationView.tsx lines 1296-1316: Verbosity selector UI
# - App.tsx lines 317-336: handleUpdateSlide cache invalidation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AI Provider Interface and Implementations</name>
  <files>
    services/aiProvider.ts
    services/geminiService.ts
    services/providers/geminiProvider.ts
    services/providers/claudeProvider.ts
  </files>
  <action>
    Extend regenerateTeleprompter method signature across all provider files to accept surrounding slides for context coherence.

    1. **services/aiProvider.ts** (interface definition):
       - Update `regenerateTeleprompter` in `AIProviderInterface` to add optional parameters:
         ```typescript
         regenerateTeleprompter(
           slide: Slide,
           verbosity: VerbosityLevel,
           prevSlide?: Slide,
           nextSlide?: Slide
         ): Promise<string>;
         ```

    2. **services/geminiService.ts** (core implementation):
       - Update function signature to accept `prevSlide?: Slide, nextSlide?: Slide`
       - Add context section to systemInstruction prompt:
         ```typescript
         // Build context section for surrounding slides
         const contextLines: string[] = [];
         if (prevSlide) {
           contextLines.push(`- Previous slide: "${prevSlide.title}" covered: ${prevSlide.content.slice(0, 2).join('; ')}`);
         } else {
           contextLines.push('- This is the first slide in the presentation.');
         }
         if (nextSlide) {
           contextLines.push(`- Next slide: "${nextSlide.title}" will cover: ${nextSlide.content.slice(0, 2).join('; ')}`);
         } else {
           contextLines.push('- This is the last slide in the presentation.');
         }

         const contextSection = `
         CONTEXT FOR COHERENT FLOW:
         ${contextLines.join('\n')}
         Ensure your script transitions naturally from what came before and sets up what comes next.
         `;
         ```
       - Insert contextSection into systemInstruction before the CRITICAL output instruction

    3. **services/providers/geminiProvider.ts**:
       - Update `regenerateTeleprompter` method signature to accept and pass through `prevSlide?, nextSlide?`
       - Update call to `geminiRegenerateTeleprompter(this.apiKey, slide, verbosity, prevSlide, nextSlide)`

    4. **services/providers/claudeProvider.ts**:
       - Update `regenerateTeleprompter` method signature to accept `prevSlide?: Slide, nextSlide?: Slide`
       - Add same context section logic as geminiService
       - Insert into systemPrompt before the CRITICAL output instruction

    **AVOID:** Do not change the return type or error handling - only extend the signature and enhance the prompt.
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit
    ```
  </verify>
  <done>
    - AIProviderInterface.regenerateTeleprompter accepts prevSlide?, nextSlide?
    - geminiService.regenerateTeleprompter includes context section in prompt
    - GeminiProvider passes through new parameters
    - ClaudeProvider includes context section in prompt
    - TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Regenerate Handler and UI Button</name>
  <files>
    components/PresentationView.tsx
  </files>
  <action>
    Add handleRegenerateScript function and Regen button to the teleprompter panel.

    1. **Add handleRegenerateScript handler** (after handleVerbosityChange, around line 952):
       ```typescript
       // Handle explicit regeneration request (always regenerate, ignoring cache)
       const handleRegenerateScript = async () => {
         if (!provider) {
           onRequestAI('regenerate teleprompter script');
           return;
         }

         // Prevent regeneration on empty slides
         if (currentSlide.content.length === 0) {
           onError('Cannot Regenerate', 'Add bullet points to the slide before regenerating.');
           return;
         }

         setIsRegenerating(true);

         try {
           // Context for coherence (REGEN-03)
           const prevSlide = currentIndex > 0 ? slides[currentIndex - 1] : undefined;
           const nextSlide = currentIndex < slides.length - 1 ? slides[currentIndex + 1] : undefined;

           const newScript = await provider.regenerateTeleprompter(
             currentSlide,
             verbosityLevel,
             prevSlide,
             nextSlide
           );

           // Update display state
           if (verbosityLevel === 'standard') {
             setRegeneratedScript(null);  // Standard uses speakerNotes directly
           } else {
             setRegeneratedScript(newScript);
           }

           // Update slide data - different behavior based on verbosity level
           if (verbosityLevel === 'standard') {
             // Standard: update speakerNotes, clear cache (content effectively changed)
             onUpdateSlide(currentSlide.id, {
               speakerNotes: newScript,
               verbosityCache: undefined,
             });
           } else {
             // Concise/Detailed: update cache only
             onUpdateSlide(currentSlide.id, {
               verbosityCache: {
                 ...currentSlide.verbosityCache,
                 [verbosityLevel]: newScript,
               },
             });
           }
         } catch (error) {
           console.error('Failed to regenerate teleprompter:', error);
           if (error instanceof AIProviderError) {
             onError('Regeneration Failed', error.userMessage);
           } else {
             onError('Error', 'Could not regenerate script. Please try again.');
           }
         } finally {
           setIsRegenerating(false);
         }
       };
       ```

    2. **Add Regen button to verbosity selector UI** (lines 1296-1316):
       - After the verbosity level buttons and before the spinner, add a divider and Regen button:
       ```typescript
       {/* Verbosity Selector */}
       <div className="flex justify-center items-center gap-2 px-3 py-2 border-b border-slate-700 bg-slate-800/30">
         <span className="text-[9px] font-bold text-slate-500 uppercase tracking-widest mr-2">Script Style</span>
         {(['concise', 'standard', 'detailed'] as const).map(level => (
           <button
             key={level}
             onClick={() => handleVerbosityChange(level)}
             disabled={isRegenerating || (!isAIAvailable && level !== 'standard')}
             className={`px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-lg transition-all ${
               verbosityLevel === level
                 ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20'
                 : 'bg-slate-700 text-slate-400 hover:text-white hover:bg-slate-600'
             } ${(isRegenerating || (!isAIAvailable && level !== 'standard')) && verbosityLevel !== level ? 'opacity-50 cursor-not-allowed' : ''}`}
           >
             {level}
           </button>
         ))}

         {/* Divider */}
         <div className="w-px h-5 bg-slate-600 mx-1" />

         {/* Regenerate Button */}
         <button
           onClick={handleRegenerateScript}
           disabled={isRegenerating || !isAIAvailable || currentSlide.content.length === 0}
           className={`px-2.5 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-lg transition-all flex items-center gap-1.5 ${
             isRegenerating || !isAIAvailable || currentSlide.content.length === 0
               ? 'bg-slate-700/50 text-slate-500 cursor-not-allowed'
               : 'bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white'
           }`}
           title={!isAIAvailable ? 'Add API key in Settings' : currentSlide.content.length === 0 ? 'Add slide content first' : 'Regenerate script for this slide'}
         >
           <svg className="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor">
             <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd" />
           </svg>
           Regen
         </button>

         {isRegenerating && (
           <div className="w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin ml-2" />
         )}
       </div>
       ```

    **AVOID:**
    - Do not create a separate isRegenerating state - reuse the existing one (same state is correct; buttons should disable together)
    - Do not add confirmation dialogs - the action is reversible
    - Do not regenerate all three verbosity levels at once - only current level (faster, simpler)
  </action>
  <verify>
    1. TypeScript compiles:
       ```bash
       cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit
       ```

    2. Dev server starts without errors:
       ```bash
       cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npm run dev
       ```
       (Check console for React errors)
  </verify>
  <done>
    - handleRegenerateScript function exists and handles all three verbosity behaviors
    - Regen button appears in verbosity selector row with divider
    - Button is disabled when: isRegenerating, !isAIAvailable, or slide has no content
    - Button uses amber hover color to distinguish from verbosity selection
    - Standard regeneration updates speakerNotes and clears verbosityCache
    - Concise/Detailed regeneration updates only the cache at current level
    - TypeScript compiles and dev server runs
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript compilation:**
   ```bash
   cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit
   ```

2. **Visual verification:**
   - Start dev server: `npm run dev`
   - Create or load a presentation with AI provider configured
   - Enter presentation mode
   - Verify "Regen" button appears after verbosity selector buttons with divider
   - Verify button is disabled if no API key configured
   - Verify button is disabled on empty slides

3. **Functional verification (if API key available):**
   - Click Regen on a slide with content
   - Verify spinner appears during regeneration
   - Verify script updates in teleprompter panel
   - Switch verbosity level to Standard, click Regen - verify speakerNotes updates
   - Switch to Concise, click Regen - verify cache updates (switch away and back to confirm cached)
</verification>

<success_criteria>
- [ ] Regen button visible in teleprompter panel verbosity selector row
- [ ] Button disabled when AI not available or slide empty
- [ ] Click triggers regeneration with spinner feedback
- [ ] Standard regeneration updates speakerNotes and clears cache
- [ ] Concise/Detailed regeneration updates cache only
- [ ] Regenerated script flows naturally (uses surrounding slide context)
- [ ] TypeScript compiles without errors
- [ ] REGEN-01, REGEN-02, REGEN-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/29-single-teleprompter-regeneration/29-01-SUMMARY.md`
</output>
