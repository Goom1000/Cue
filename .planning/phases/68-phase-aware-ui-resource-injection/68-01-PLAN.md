---
phase: 68-phase-aware-ui-resource-injection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/phaseDetection/phasePatterns.ts
  - utils/phaseDistribution.ts
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Each slide card in the sidebar shows a color-coded phase badge with text label"
    - "Teacher can click the badge to select a different phase from a dropdown"
    - "A phase balance indicator between the Lesson Flow header and slide thumbnails shows distribution across all 6 phases"
    - "Phases with 0% coverage are flagged in the balance indicator"
    - "Slides without a phase label show no badge (graceful null handling)"
  artifacts:
    - path: "services/phaseDetection/phasePatterns.ts"
      provides: "PHASE_COLORS map with Tailwind classes for each LessonPhase"
      contains: "PHASE_COLORS"
    - path: "utils/phaseDistribution.ts"
      provides: "computePhaseDistribution pure function"
      exports: ["computePhaseDistribution", "PhaseDistribution"]
    - path: "App.tsx"
      provides: "Phase badges on sidebar thumbnails, phase override dropdown, balance indicator bar"
  key_links:
    - from: "App.tsx"
      to: "services/phaseDetection/phasePatterns.ts"
      via: "import PHASE_COLORS, PHASE_DISPLAY_LABELS"
      pattern: "PHASE_COLORS\\[slide\\.lessonPhase\\]"
    - from: "App.tsx"
      to: "utils/phaseDistribution.ts"
      via: "useMemo calling computePhaseDistribution"
      pattern: "computePhaseDistribution\\(slides\\)"
    - from: "App.tsx phase dropdown"
      to: "handleUpdateSlide"
      via: "onChange -> handleUpdateSlide(slide.id, { lessonPhase })"
      pattern: "handleUpdateSlide.*lessonPhase"
---

<objective>
Add phase-aware UI to the editor sidebar: color-coded phase badges on each slide thumbnail, a native select dropdown to override phases, and a phase balance indicator showing distribution across all 6 GRR phases.

Purpose: Teachers see at a glance which lesson phase each slide belongs to (Hook, I Do, We Do, etc.) and can correct misdetections. The balance indicator flags missing phases so teachers know if their deck is incomplete.

Output: PHASE_COLORS map, computePhaseDistribution utility, sidebar badges + dropdown + balance bar in App.tsx.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-phase-aware-ui-resource-injection/68-RESEARCH.md
@services/phaseDetection/phasePatterns.ts
@types.ts (LessonPhase type at line 11, Slide.lessonPhase at line 41)
@App.tsx (sidebar thumbnails at lines 2762-2811, handleUpdateSlide callback)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PHASE_COLORS map and computePhaseDistribution utility</name>
  <files>services/phaseDetection/phasePatterns.ts, utils/phaseDistribution.ts</files>
  <action>
    1. In `services/phaseDetection/phasePatterns.ts`, add a `PHASE_COLORS` export after `PHASE_DISPLAY_LABELS` (line 147). This is a `Record<LessonPhase, { bg: string; text: string; darkBg: string; darkText: string }>` mapping each of the 6 phases to Tailwind background + text color classes for both light and dark mode:
       - hook: emerald (bg-emerald-100, text-emerald-700, dark:bg-emerald-900/40, dark:text-emerald-400)
       - i-do: blue (bg-blue-100, text-blue-700, dark:bg-blue-900/40, dark:text-blue-400)
       - we-do: violet (bg-violet-100, text-violet-700, dark:bg-violet-900/40, dark:text-violet-400)
       - we-do-together: purple (bg-purple-100, text-purple-700, dark:bg-purple-900/40, dark:text-purple-400)
       - you-do: amber (bg-amber-100, text-amber-700, dark:bg-amber-900/40, dark:text-amber-400)
       - plenary: rose (bg-rose-100, text-rose-700, dark:bg-rose-900/40, dark:text-rose-400)

    2. Create NEW file `utils/phaseDistribution.ts` with:
       - Import `LessonPhase` from `../types` and `Slide` from `../types`
       - Export `PhaseDistribution` interface: `{ counts: Record<LessonPhase, number>; percentages: Record<LessonPhase, number>; total: number; missingPhases: LessonPhase[]; unassigned: number }`
       - Export `ALL_PHASES` constant: `['hook', 'i-do', 'we-do', 'we-do-together', 'you-do', 'plenary'] as const`
       - Export `computePhaseDistribution(slides: Slide[]): PhaseDistribution` -- pure function that counts slides per phase using reduce, calculates percentages (Math.round), identifies phases with 0 count as missingPhases, and counts slides with no lessonPhase as unassigned. Handle empty slides array (return all zeros).

    Follow the same pure utility function pattern as `utils/resourceCapping.ts` and `utils/gapSlideInsertion.ts`.
  </action>
  <verify>
    - `phasePatterns.ts` exports PHASE_COLORS with 6 entries
    - `phaseDistribution.ts` exports computePhaseDistribution and PhaseDistribution
    - TypeScript compiles: `npx tsc --noEmit` passes
  </verify>
  <done>PHASE_COLORS map exists with Tailwind classes for all 6 phases. computePhaseDistribution returns counts, percentages, missingPhases, and unassigned count for any Slide array.</done>
</task>

<task type="auto">
  <name>Task 2: Add phase badges, override dropdown, and balance indicator to sidebar</name>
  <files>App.tsx</files>
  <action>
    Add three imports at the top of App.tsx:
    - `import { PHASE_DISPLAY_LABELS, PHASE_COLORS } from './services/phaseDetection/phasePatterns';`
    - `import { computePhaseDistribution, ALL_PHASES } from './utils/phaseDistribution';`

    **Phase Balance Indicator (PHASE-04):**
    Between the existing "Lesson Flow" label + title input (line 2744-2749) and the `<div className="space-y-0.5">` slide list (line 2752), add a phase balance indicator:
    - Compute distribution using `useMemo`: `const phaseDistribution = useMemo(() => computePhaseDistribution(slides), [slides]);`
    - Only render if at least one slide has a lessonPhase (check `phaseDistribution.total > phaseDistribution.unassigned`).
    - Render as a horizontal stacked bar: a flex container `h-3 rounded-full overflow-hidden` with segments for each phase colored by PHASE_COLORS. Each segment width is `style={{ width: '${percentage}%' }}` with `min-w-[2px]` so tiny phases are still visible.
    - Below the bar, if `phaseDistribution.missingPhases.length > 0`, show a small amber warning: `<p className="text-[9px] text-amber-600 dark:text-amber-400 mt-1">Missing: {missingPhases.map(p => PHASE_DISPLAY_LABELS[p]).join(', ')}</p>`
    - Wrap in a `<div className="mb-3 px-1">` for spacing.

    **Phase Badge on Sidebar Thumbnails (PHASE-03 + PHASE-05):**
    Inside each slide's sidebar button (line 2790-2796 area), after the `<span>` with slide number and the title/content div, add a phase badge row. Replace the static badge concept with a `<select>` element that IS the badge (per research recommendation -- the select styled as a colored pill):
    - Add a new row below the title/content div (`<div className="flex-1 min-w-0">` block, after line 2794):
      ```
      {(slide.lessonPhase || activeSlideIndex === idx) && (
        <div className="mt-1">
          <select
            value={slide.lessonPhase || ''}
            onChange={(e) => { e.stopPropagation(); handleUpdateSlide(slide.id, { lessonPhase: (e.target.value || undefined) as LessonPhase | undefined }); }}
            onClick={(e) => e.stopPropagation()}
            className={`text-[9px] font-bold uppercase tracking-wider rounded-md px-1.5 py-0.5 border cursor-pointer focus:outline-none focus:ring-1 ${
              slide.lessonPhase
                ? `${PHASE_COLORS[slide.lessonPhase].bg} ${PHASE_COLORS[slide.lessonPhase].text} ${PHASE_COLORS[slide.lessonPhase].darkBg} ${PHASE_COLORS[slide.lessonPhase].darkText} border-transparent`
                : 'bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-500 border-slate-200 dark:border-slate-700'
            }`}
          >
            <option value="">No Phase</option>
            {Object.entries(PHASE_DISPLAY_LABELS).map(([key, label]) => (
              <option key={key} value={key}>{label}</option>
            ))}
          </select>
        </div>
      )}
      ```
    - The select only renders when: the slide has a phase assigned OR it's the active slide (so user can assign one).
    - `e.stopPropagation()` on both onClick and onChange prevents the parent button from firing `setActiveSlideIndex`.
    - Import `LessonPhase` from types if not already imported (it should already be available since Slide is imported).

    **Key implementation notes:**
    - The phase override uses the existing `handleUpdateSlide(slide.id, { lessonPhase: newValue })` pattern (same as question flag toggle at line 2805).
    - Casting `e.target.value` to `LessonPhase | undefined` -- empty string becomes `undefined` to clear the phase.
    - The select element's background changes to match the selected phase's color, making it look like a colored badge that also functions as a dropdown.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (type check)
    - `npx vite build` succeeds (build check)
    - Visually: after generating slides (which auto-assigns phases), sidebar thumbnails show colored phase badges. Clicking a badge opens a native dropdown to change the phase.
  </verify>
  <done>
    Sidebar shows color-coded phase badges (select-as-badge) on each slide thumbnail. Teacher can click to change phase via native dropdown. Phase balance indicator bar shows distribution with missing-phase warning. All three requirements (PHASE-03, PHASE-04, PHASE-05) are met.
  </done>
</task>

</tasks>

<verification>
1. Generate a deck in Fresh mode with a lesson plan -- sidebar should show phase badges on each slide thumbnail
2. Click a phase badge -- dropdown appears with all 6 phases plus "No Phase"
3. Change a phase -- badge color updates immediately
4. Phase balance bar shows colored segments proportional to slide count per phase
5. If a phase has 0 slides, the missing-phase warning appears below the bar
6. Slides without a lessonPhase show no badge (unless it's the active slide, which shows the unset dropdown)
7. TypeScript compiles with no errors
8. Vite build succeeds
</verification>

<success_criteria>
- PHASE_COLORS exported from phasePatterns.ts with 6 phase-color mappings
- computePhaseDistribution utility correctly counts and calculates percentages
- Each sidebar thumbnail shows its phase as a color-coded select-badge
- Phase override works via dropdown changing Slide.lessonPhase
- Balance indicator shows phase distribution with missing-phase warnings
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/68-phase-aware-ui-resource-injection/68-01-SUMMARY.md`
</output>
