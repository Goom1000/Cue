---
phase: 68-phase-aware-ui-resource-injection
plan: 03
type: execute
wave: 1
depends_on: ["68-02"]
files_modified:
  - services/geminiService.ts
  - services/providers/claudeProvider.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When supplementary resources are uploaded, the AI actively weaves resource content into relevant slides"
    - "Resource integration directives appear in system prompts with CRITICAL-level language matching existing directive style"
    - "Both Gemini and Claude providers produce equivalent resource-aware behavior (PROV-01/PROV-02 parity)"
  artifacts:
    - path: "services/geminiService.ts"
      provides: "Resource awareness in Gemini system prompt"
      contains: "CRITICAL.*SUPPLEMENTARY RESOURCES"
    - path: "services/providers/claudeProvider.ts"
      provides: "Resource awareness in Claude system prompt"
      contains: "CRITICAL.*SUPPLEMENTARY RESOURCES"
  key_links:
    - from: "services/geminiService.ts generateLessonSlides"
      to: "getSystemInstructionForMode"
      via: "hasResources boolean parameter"
      pattern: "getSystemInstructionForMode.*hasResources|supplementaryResourceText"
    - from: "services/providers/claudeProvider.ts generateLessonSlides"
      to: "getSystemPromptForMode"
      via: "hasResources boolean parameter"
      pattern: "getSystemPromptForMode.*hasResources|supplementaryResourceText"
---

<objective>
Fix UAT gap: AI ignores uploaded supplementary resources because resource injection text lives only in the user prompt, while the system prompt (200+ lines of CRITICAL/MANDATORY directives) has zero awareness of resources. The AI deprioritizes the weak user-level "Weave content..." suggestion against strong system-level mandates.

Purpose: Add CRITICAL-level resource awareness directives to system prompts in both providers so the AI treats resource integration as a mandatory requirement, not an optional suggestion.

Output: Modified system prompt builders in both providers that conditionally include resource integration rules when supplementaryResourceText is present.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-phase-aware-ui-resource-injection/68-02-SUMMARY.md
@utils/resourceInjection.ts
@services/geminiService.ts
@services/providers/claudeProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resource awareness to Gemini system prompt</name>
  <files>services/geminiService.ts</files>
  <action>
  Modify `getSystemInstructionForMode()` (line 131) to accept a new parameter `hasResources: boolean = false` as the last parameter.

  At the bottom of each mode's system prompt string (fresh, refine, blend), BEFORE the closing backtick, conditionally append a resource awareness block when `hasResources` is true. Use a helper variable built once at the top of the function:

  ```typescript
  const resourceAwarenessRules = hasResources ? `
CRITICAL - SUPPLEMENTARY RESOURCES:
The teacher has uploaded supplementary teaching resources that appear in the user prompt under "SUPPLEMENTARY TEACHING RESOURCES".
- You MUST actively integrate content from these resources into relevant slides.
- For each resource used, add a callout reference on the slide (e.g., "[See: filename]") so the teacher knows which slide relates to which resource.
- Weave resource content naturally into slide bullet points and teleprompter scripts -- do NOT create a separate "Resources" slide.
- If a resource contains examples, case studies, or data, use them to enrich the relevant topic slides.
- Every uploaded resource MUST be referenced in at least one slide.` : '';
  ```

  Then in each mode case (fresh at line ~186, refine at line ~221, blend at line ~248), insert `${resourceAwarenessRules}` on a new line just before the LAYOUTS line. This placement puts it alongside other CRITICAL/MANDATORY directives.

  At the call site in `generateLessonSlides()` (line 315), pass the resource flag:

  ```typescript
  const systemInstruction = getSystemInstructionForMode(
    input.mode, input.verbosity, input.gradeLevel,
    detectedContent, teachableMoments, useVisualScaffolding,
    !!input.supplementaryResourceText
  );
  ```

  Do NOT modify the user prompt injection (lines 337-340) -- that stays as-is. The resource content remains in the user prompt; this task adds system-level rules that tell the AI to use it.
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no type errors.
  Grep for "CRITICAL - SUPPLEMENTARY RESOURCES" in `services/geminiService.ts` to confirm the directive block exists.
  Grep for "hasResources" in `services/geminiService.ts` to confirm both the parameter and the call site are wired.
  </verify>
  <done>
  `getSystemInstructionForMode()` accepts hasResources flag, conditionally appends CRITICAL-level resource awareness directives to all three mode prompts, and the call site in `generateLessonSlides()` passes `!!input.supplementaryResourceText`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add resource awareness to Claude system prompt (provider parity)</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
  Apply the IDENTICAL pattern from Task 1 to the Claude provider, maintaining PROV-01/PROV-02 parity.

  Modify `getSystemPromptForMode()` (line 424) to accept `hasResources: boolean = false` as the last parameter.

  Build the SAME `resourceAwarenessRules` helper variable at the top of the function (copy the exact string from Task 1 -- both providers MUST use identical directive text for parity).

  Insert `${resourceAwarenessRules}` in each mode case (fresh at line ~479, refine at line ~516, blend at line ~548), on a new line just before the LAYOUTS line -- mirroring the exact placement used in the Gemini service.

  At the call site in `generateLessonSlides()` (line 744), pass the resource flag:

  ```typescript
  const systemPrompt = getSystemPromptForMode(
    input.mode, input.verbosity, input.gradeLevel,
    detectedContent, teachableMoments, useVisualScaffolding,
    !!input.supplementaryResourceText
  );
  ```

  Do NOT modify the user prompt injection (lines 775-781) -- that stays as-is.

  **PARITY CHECK:** The resourceAwarenessRules string must be character-for-character identical in both providers. The parameter name, position, and call-site pattern must match. Copy-paste the string, do not rephrase.
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no type errors.
  Grep for "CRITICAL - SUPPLEMENTARY RESOURCES" in `services/providers/claudeProvider.ts` to confirm the directive block exists.
  Grep for "hasResources" in `services/providers/claudeProvider.ts` to confirm both the parameter and the call site are wired.
  Run a diff-style check: extract the resourceAwarenessRules string from both files and confirm they are identical.
  </verify>
  <done>
  `getSystemPromptForMode()` accepts hasResources flag, conditionally appends CRITICAL-level resource awareness directives to all three mode prompts, the call site passes `!!input.supplementaryResourceText`, and the directive text is identical to the Gemini provider.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Both `services/geminiService.ts` and `services/providers/claudeProvider.ts` contain "CRITICAL - SUPPLEMENTARY RESOURCES" directive block
3. Both providers' system prompt functions accept `hasResources` parameter in identical position (last param, default false)
4. Both providers' `generateLessonSlides()` functions pass `!!input.supplementaryResourceText` to their system prompt builder
5. The resource awareness directive text is identical in both files (provider parity)
6. The user prompt injection (resource content in user message) is NOT modified -- only system-level rules are added
7. When no resources are uploaded (`supplementaryResourceText` is undefined/empty), system prompts are UNCHANGED from current behavior
</verification>

<success_criteria>
- System prompts in both providers include CRITICAL-level resource integration directives when supplementary resources are present
- Directive language matches existing system prompt style (CRITICAL, MUST, MANDATORY patterns)
- Resource content stays in user prompt (unchanged), system prompt now tells AI to use it
- No resources uploaded = no change to system prompt (conditional injection)
- Provider parity maintained: identical directive text, identical parameter pattern
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/68-phase-aware-ui-resource-injection/68-03-SUMMARY.md`
</output>
