---
phase: 63-share-modal-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - services/providers/claudeProvider.ts
  - services/providers/geminiProvider.ts
  - components/ShareModal.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "A 'Share with colleague' button is visible in the editor toolbar next to Export PPTX"
    - "Clicking the Share button opens a modal that auto-starts AI transformation"
    - "The modal shows progress during transformation ('Transforming N slides...' with spinner)"
    - "After transformation, teacher sees a scrollable preview grid of script-version slides"
    - "Teacher can click 'Download PPTX' to export and the file downloads automatically"
    - "PDF option is visible but disabled with 'Coming soon' label"
    - "If transformation fails, teacher sees an error message and can close the modal"
    - "If no slides have teleprompter content, teacher sees a helpful message instead of empty preview"
    - "Share button is disabled when no API key is configured or deck has no slides"
  artifacts:
    - path: "components/ShareModal.tsx"
      provides: "ShareModal component with 4-phase state machine"
      min_lines: 120
    - path: "services/aiProvider.ts"
      provides: "onProgress callback in transformForColleague signature"
      contains: "onProgress"
    - path: "services/providers/claudeProvider.ts"
      provides: "onProgress wiring in Claude chunk loop"
      contains: "onProgress"
    - path: "services/providers/geminiProvider.ts"
      provides: "onProgress wiring in Gemini chunk loop"
      contains: "onProgress"
    - path: "App.tsx"
      provides: "showShareModal state and ShareModal rendering"
      contains: "ShareModal"
  key_links:
    - from: "App.tsx"
      to: "components/ShareModal.tsx"
      via: "showShareModal state + conditional render"
      pattern: "showShareModal.*ShareModal"
    - from: "components/ShareModal.tsx"
      to: "services/aiProvider.ts"
      via: "provider.transformForColleague call with onProgress"
      pattern: "transformForColleague.*onProgress"
    - from: "components/ShareModal.tsx"
      to: "services/pptxService.ts"
      via: "exportScriptPptx call on download"
      pattern: "exportScriptPptx"
---

<objective>
Create the complete "Share with colleague" workflow: add progress tracking to the AI transformation service, build the ShareModal component with transform/preview/export states, and wire it into the editor toolbar.

Purpose: Teachers need a single-click path from their Cue deck to a downloadable PPTX that a colleague can deliver. This phase connects Phase 61 (AI transformation) and Phase 62 (PPTX export) with a polished UI.
Output: Working ShareModal with progress, preview, PPTX download, and disabled PDF placeholder.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-share-modal-ui/63-RESEARCH.md
@.planning/phases/61-ai-transformation-service/61-01-SUMMARY.md
@.planning/phases/62-pptx-export/62-01-SUMMARY.md
@services/aiProvider.ts
@services/providers/claudeProvider.ts
@services/providers/geminiProvider.ts
@services/pptxService.ts
@components/ExportModal.tsx
@App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onProgress callback to transformForColleague interface and both providers</name>
  <files>
    services/aiProvider.ts
    services/providers/claudeProvider.ts
    services/providers/geminiProvider.ts
  </files>
  <action>
    Add an optional `onProgress` callback parameter to the `transformForColleague` method signature:

    **services/aiProvider.ts** (interface declaration, ~line 394-398):
    Change the interface method to:
    ```
    transformForColleague(
      slides: Slide[],
      deckVerbosity: VerbosityLevel,
      gradeLevel: string,
      onProgress?: (progress: { current: number; total: number }) => void
    ): Promise<ColleagueTransformationResult>;
    ```

    **services/providers/claudeProvider.ts** (~line 2242-2329):
    1. Add `onProgress?` as 4th parameter to the method signature
    2. After computing `transformable` and `chunks`, before the chunk loop, call: `onProgress?.({ current: 0, total: transformable.length });`
    3. Inside the `for` loop, after `allTransformed.push(...chunkResults)` (after line ~2314), add:
       ```
       onProgress?.({ current: allTransformed.length, total: transformable.length });
       ```
    4. The final `onProgress` call after the loop is not needed since the last chunk push already reported.

    **services/providers/geminiProvider.ts** (~line 891-962):
    Same pattern as Claude:
    1. Add `onProgress?` as 4th parameter
    2. Initial progress call `onProgress?.({ current: 0, total: transformable.length })` before chunk loop
    3. After `allTransformed.push(...chunkResults)` inside loop (~line 954), add: `onProgress?.({ current: allTransformed.length, total: transformable.length })`

    The callback is optional so all existing callers (if any) remain compatible. No other files import or call transformForColleague currently (Phase 62's exportScriptPptx receives the result, doesn't call transform directly).
  </action>
  <verify>
    Run `npx tsc --noEmit` from the project root. Zero TypeScript errors. Grep for `onProgress` in all three files to confirm presence.
  </verify>
  <done>
    The transformForColleague method on AIProviderInterface accepts an optional onProgress callback. Both ClaudeProvider and GeminiProvider fire progress updates per-chunk during transformation. Existing code continues to work without passing the callback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ShareModal component with transform, preview, and export workflow</name>
  <files>
    components/ShareModal.tsx
  </files>
  <action>
    Create `components/ShareModal.tsx` as a new file. Follow the existing modal chrome pattern from ExportModal.tsx (overlay, card, header, footer).

    **Props interface:**
    ```typescript
    interface ShareModalProps {
      slides: Slide[];
      lessonTitle: string;
      deckVerbosity: VerbosityLevel;
      gradeLevel: string;
      provider: AIProviderInterface;
      onClose: () => void;
      addToast: (message: string, duration?: number, type?: 'info' | 'success' | 'error' | 'warning') => void;
    }
    ```

    **State machine** with `SharePhase` type: `'transforming' | 'preview' | 'exporting' | 'error'`

    **State variables:**
    - `phase: SharePhase` (initial: `'transforming'`)
    - `transformResult: ColleagueTransformationResult | null` (initial: null)
    - `progress: { current: number; total: number } | null` (initial: null)
    - `errorMessage: string | null` (initial: null)
    - `selectedFormat: 'pptx' | 'pdf'` (initial: `'pptx'`)

    **Auto-trigger on mount** (useEffect with `cancelled` flag pattern from ExportModal):
    1. Call `provider.transformForColleague(slides, deckVerbosity, gradeLevel, (p) => { if (!cancelled) setProgress(p); })`
    2. On success: if `result.slides.length === 0`, set phase to `'error'` with message "No slides have teleprompter scripts to transform. Generate speaker notes first."
    3. On success with slides: set `transformResult`, set phase to `'preview'`
    4. On error: set phase to `'error'`, extract message from `AIProviderError.userMessage` or fallback "Transformation failed. Please try again.", call `addToast(message, 5000, 'error')`
    5. Cleanup: `return () => { cancelled = true; }`

    **Modal layout** (use exact same CSS classes as ExportModal):
    - Overlay: `"fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-6"`
    - Card: `"bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col"`
    - Header: Share icon (use emoji or simple SVG) in a `"w-12 h-12 rounded-2xl bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center"` container, title "Share with Colleague" in `"text-xl font-bold font-fredoka"`, close X button (disabled during 'exporting' phase only -- allow close during transforming and preview)
    - Body: scrollable `"flex-1 overflow-y-auto p-6"`
    - Footer: action buttons

    **Rendering by phase:**

    **'transforming' phase:**
    - Centered spinner (use CSS animation: `animate-spin` on a circular SVG or border spinner)
    - Text: if `progress` is null, show "Preparing transformation..."
    - If `progress` exists and `progress.total <= 20` (single chunk), show "Transforming {progress.total} slides..." with spinner
    - If `progress` exists and `progress.total > 20`, show "Transforming slides {progress.current} of {progress.total}..."
    - Cancel/close button in footer

    **'preview' phase:**
    - Summary line: "{transformResult.slides.length} slides transformed" (and if skippedCount > 0: ", {skippedCount} skipped (no script content)")
    - Scrollable preview grid: 2 columns (`grid grid-cols-2 gap-4`), each item shows:
      - Slide number badge (bottom-left, `"absolute bottom-2 left-2 bg-black/60 text-white text-xs font-bold px-2 py-1 rounded-lg"`)
      - Title in bold above the bullets
      - The expanded bullets as a simple bulleted list (use `ul` with `list-disc` and `pl-5`)
      - Strip `**` markdown bold markers from bullet text for display (`.replace(/\*\*/g, '')`)
      - Each card: `"bg-slate-50 dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700"`
    - Do NOT use SlideContentRenderer for preview (the transformed data is text-only bullets, not full Slide objects with layouts). Render a simple text-based preview card instead. This avoids complex data adaptation and shows exactly what the exported PPTX will contain.
    - Format selector in footer:
      - PPTX option: radio or button, selectable, label "PowerPoint (.pptx)"
      - PDF option: radio or button, visually disabled with opacity-50, label "PDF (.pdf) -- Coming soon"
      - PDF option is NOT clickable (not just styled -- actually disabled)
    - "Download" primary button (indigo-600 dark:amber-500 colors) -- enabled only when format is 'pptx'
    - "Cancel" secondary button

    **'exporting' phase:**
    - Show "Generating PowerPoint..." with spinner
    - Close button disabled
    - Call `exportScriptPptx(slides, transformResult!, lessonTitle)` -- this is synchronous and triggers browser download via `pptx.writeFile()`
    - On success: call `addToast('Script version downloaded!', 3000, 'success')`, call `onClose()`
    - On error: call `addToast('Export failed. Please try again.', 5000, 'error')`, return to 'preview' phase
    - Note: exportScriptPptx is synchronous (PptxGenJS writeFile). Wrap in try/catch. The 'exporting' phase may flash briefly -- that's fine.

    **'error' phase:**
    - Error icon (red/orange)
    - Display `errorMessage` text
    - "Close" button

    **Imports needed:**
    ```typescript
    import React, { useState, useEffect } from 'react';
    import { Slide } from '../types';
    import { AIProviderInterface, AIProviderError, ColleagueTransformationResult, VerbosityLevel } from '../services/aiProvider';
    import { exportScriptPptx } from '../services/pptxService';
    ```

    **Important behavioral notes:**
    - Do NOT mutate the `slides` prop. All transform data is modal-local state.
    - The `exportScriptPptx` function needs the original `slides` array (for image lookup by index) plus the `transformResult` (for bullet text).
    - Handle Escape key to close modal (consistent with other modals) except during 'exporting' phase.
    - Use `useEffect` with `keydown` listener for Escape, checking phase !== 'exporting'.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- zero errors. The file should be ~180-250 lines. Confirm it exports a default or named export that App.tsx can import.
  </verify>
  <done>
    ShareModal.tsx exists with 4-phase state machine (transforming/preview/exporting/error). Auto-triggers transformation on mount with progress callback. Preview shows text-based slide cards in 2-column grid. Download calls exportScriptPptx. PDF option shown disabled with "Coming soon". Error states handled with toast notifications. Escape key closes modal except during export.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire ShareModal into App.tsx editor toolbar</name>
  <files>
    App.tsx
  </files>
  <action>
    **Add import** (near other component imports, ~line 26):
    ```typescript
    import ShareModal from './components/ShareModal';
    ```

    **Add state** (near `showExportModal` state, ~line 359):
    ```typescript
    const [showShareModal, setShowShareModal] = useState(false);
    ```

    **Add "Share with colleague" button** in the editor toolbar (after the "Export PPTX" button, ~line 2052). Place it AFTER the Export PPTX button and BEFORE the divider that precedes the Present buttons:
    ```tsx
    <Button
      variant="secondary"
      className="!py-1.5 !px-4 text-sm"
      onClick={() => setShowShareModal(true)}
      disabled={!provider || slides.length === 0}
    >
      Share
    </Button>
    ```
    Keep the label short: "Share" (not "Share with colleague" -- toolbar space is limited). The modal title says "Share with Colleague" which provides full context.

    **Render ShareModal** (near the ExportModal render, ~line 2883, after the ExportModal closing tag):
    ```tsx
    {showShareModal && provider && (
      <ShareModal
        slides={slides}
        lessonTitle={lessonTitle}
        deckVerbosity={deckVerbosity}
        gradeLevel="Year 6 (10-11 years old)"
        provider={provider}
        onClose={() => setShowShareModal(false)}
        addToast={addToast}
      />
    )}
    ```

    Note: The `gradeLevel` is hardcoded to "Year 6 (10-11 years old)" -- this matches the existing pattern at App.tsx line 556 where grade level is hardcoded for generation input. The grade level is used by the transformation prompt for language calibration.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- zero errors. Grep App.tsx for "ShareModal" to confirm import, state, and render are all present. Grep for "Share" button text to confirm toolbar button exists.
  </verify>
  <done>
    App.tsx has a "Share" button in the editor toolbar (disabled when no provider or empty deck). Clicking it opens ShareModal with all required props (slides, lessonTitle, deckVerbosity, gradeLevel, provider, onClose, addToast). The modal renders conditionally alongside ExportModal.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. The "Share" button appears in the editor toolbar when a deck has slides
3. The "Share" button is disabled when no API key is configured
4. Clicking "Share" opens the modal and begins transformation automatically
5. Progress is displayed honestly (spinner with slide count for small decks, batch progress for 20+ slides)
6. After transformation, preview grid shows slide cards with titles and expanded bullets
7. PDF format option is visible but disabled with "Coming soon"
8. Clicking "Download" triggers PPTX export and file download
9. Modal closes after successful download with success toast
10. Errors during transformation show error state with clear message
11. Empty transformation result (no teleprompter content) shows helpful guidance message
12. Escape key closes modal during transforming and preview phases, not during export
</verification>

<success_criteria>
- Teacher can click "Share" in editor toolbar, see transformation progress, preview script-version slides, and download a PPTX file
- The workflow completes end-to-end: button click -> modal opens -> transformation runs -> preview displayed -> download triggered -> modal closes
- All error paths handled: no provider, empty deck, transformation failure, no transformable slides, export failure
- PDF option visible but disabled (ready for Phase 64 to enable)
- UI matches existing modal chrome pattern (dark mode, rounded corners, Fredoka header)
</success_criteria>

<output>
After completion, create `.planning/phases/63-share-modal-ui/63-01-SUMMARY.md`
</output>
