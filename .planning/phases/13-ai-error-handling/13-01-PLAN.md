---
phase: 13-ai-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/geminiService.ts
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "When AI service fails (network, rate limit), user sees toast error message"
    - "When AI returns malformed JSON, user sees parse error toast"
    - "Errors are non-blocking (toast, not modal)"
    - "System retries silently 1-2 times before showing error"
  artifacts:
    - path: "services/geminiService.ts"
      provides: "Error-wrapped reviseSlide function"
      contains: "AIProviderError"
    - path: "App.tsx"
      provides: "handleReviseSlide with retry and toast"
      contains: "addToast"
  key_links:
    - from: "services/geminiService.ts"
      to: "AIProviderError"
      via: "throw new AIProviderError"
      pattern: "throw new AIProviderError"
    - from: "App.tsx"
      to: "useToast"
      via: "addToast call in catch block"
      pattern: "addToast.*error"
---

<objective>
Add graceful error handling to AI slide revision with user-friendly toast notifications.

Purpose: When AI revision fails (network error, rate limit, malformed response), users see a clear, non-blocking toast message instead of an error modal or app crash. The system silently retries transient failures before bothering the user.

Output: Updated geminiService.ts with error-wrapped reviseSlide, updated App.tsx with retry logic and toast notifications.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-ai-error-handling/13-CONTEXT.md
@.planning/phases/13-ai-error-handling/13-RESEARCH.md
@services/aiProvider.ts (AIProviderError, AIErrorCode, USER_ERROR_MESSAGES)
@components/Toast.tsx (useToast, ToastVariant, ToastAction)
@services/geminiService.ts (reviseSlide function at line 291-308)
@services/providers/geminiProvider.ts (wrapError pattern)
@App.tsx (handleReviseSlide at line 328-350)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error handling to geminiService.reviseSlide</name>
  <files>services/geminiService.ts</files>
  <action>
Wrap the reviseSlide function (line 291-308) with proper error handling:

1. Import AIProviderError and USER_ERROR_MESSAGES from '../aiProvider' at top of file (add to existing imports if any).

2. Wrap the ai.models.generateContent call in try/catch:
   - Catch API errors (network, rate limit, etc.)
   - Throw AIProviderError with NETWORK_ERROR code for connection failures
   - Note: The geminiProvider.wrapError will convert UNKNOWN_ERROR to a generic message, so specific error detection here improves user feedback

3. Wrap JSON.parse(response.text || "{}") in try/catch:
   - Catch SyntaxError from malformed JSON
   - Throw AIProviderError with PARSE_ERROR code and USER_ERROR_MESSAGES.PARSE_ERROR message

Pattern to follow (from claudeProvider.ts):
```typescript
try {
  // API call
} catch (error: any) {
  throw new AIProviderError(USER_ERROR_MESSAGES.NETWORK_ERROR, 'NETWORK_ERROR', error);
}

try {
  return JSON.parse(response.text || "{}");
} catch (parseError) {
  throw new AIProviderError(USER_ERROR_MESSAGES.PARSE_ERROR, 'PARSE_ERROR', parseError);
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>reviseSlide throws AIProviderError for both API failures and JSON parse failures instead of raw errors</done>
</task>

<task type="auto">
  <name>Task 2: Update handleReviseSlide with retry logic and toast</name>
  <files>App.tsx</files>
  <action>
Update handleReviseSlide (line 328-350) to:

1. Add AIErrorCode to imports from './services/aiProvider' (AIProviderError should already be imported).

2. Replace setErrorModal with addToast for AI errors. The useToast hook is already used in App.tsx - find the existing addToast function from that hook.

3. Add silent retry logic with exponential backoff for transient errors:
   - Retry up to 2 times for: NETWORK_ERROR, RATE_LIMIT, SERVER_ERROR
   - No retry for: AUTH_ERROR, PARSE_ERROR, QUOTA_EXCEEDED, UNKNOWN_ERROR
   - Wait 1s after first failure, 2s after second failure (exponential backoff)
   - Only show toast AFTER all retries exhausted

4. Include retry action in toast for user convenience:
   - Add ToastAction with label "Retry" that re-calls handleReviseSlide with same args
   - Use 5000ms duration (per CONTEXT.md decision)

Implementation pattern:
```typescript
const handleReviseSlide = async (id: string, instruction: string) => {
  if (!provider) {
    setEnableAIModal({ featureName: 'refine this slide with AI' });
    return;
  }
  const target = slides.find(s => s.id === id);
  if (!target) return;
  handleUpdateSlide(id, { isGeneratingImage: true });

  const retryableErrors: AIErrorCode[] = ['NETWORK_ERROR', 'RATE_LIMIT', 'SERVER_ERROR'];
  const maxRetries = 2;
  let lastError: AIProviderError | null = null;

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      const updates = await provider.reviseSlide(target, instruction);
      handleUpdateSlide(id, { ...updates, isGeneratingImage: false });

      // Image regeneration if imagePrompt changed
      if (updates.imagePrompt && updates.imagePrompt !== target.imagePrompt && autoGenerateImages) {
        const img = await provider.generateSlideImage(updates.imagePrompt, updates.layout || target.layout);
        handleUpdateSlide(id, { imageUrl: img });
      }
      return; // Success - exit function
    } catch (err) {
      if (err instanceof AIProviderError) {
        lastError = err;
        if (retryableErrors.includes(err.code) && attempt < maxRetries) {
          await new Promise(r => setTimeout(r, 1000 * (attempt + 1)));
          continue;
        }
      }
      break; // Non-retryable error or retries exhausted
    }
  }

  // All retries failed or non-retryable error
  handleUpdateSlide(id, { isGeneratingImage: false });
  if (lastError) {
    addToast(
      lastError.userMessage,
      5000,
      'error',
      { label: 'Retry', onClick: () => handleReviseSlide(id, instruction) }
    );
  }
};
```

Note: Do NOT remove setErrorModal entirely from App.tsx - it's used elsewhere. Only change the AI revision error handling to use toast.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Manual test: In running app, try to revise a slide when offline - should see error toast, not modal
  </verify>
  <done>
- Network/rate limit errors trigger silent retry (up to 2 attempts)
- After retry exhaustion, error toast appears with "Retry" button
- No modal appears for AI revision errors
- Toast auto-dismisses after 5 seconds
  </done>
</task>

</tasks>

<verification>
1. **TypeScript compiles**: `npx tsc --noEmit` - no errors
2. **Error path test**: Temporarily modify geminiService.ts to throw error, verify toast appears
3. **Toast styling**: Error toast is red (error variant), has Retry button
4. **No modal**: AI revision errors do not trigger setErrorModal
</verification>

<success_criteria>
- [ ] AI service failure (network, rate limit) shows toast error, not modal
- [ ] Malformed AI response shows parse error toast
- [ ] System retries 1-2 times silently before showing error
- [ ] Error toast has "Retry" button that re-attempts the revision
- [ ] Toast auto-dismisses after 5 seconds
- [ ] Requirements ERROR-01 and ERROR-02 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/13-ai-error-handling/13-01-SUMMARY.md`
</output>
