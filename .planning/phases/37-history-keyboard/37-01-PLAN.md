---
phase: 37-history-keyboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [components/PresentationView.tsx]
autonomous: true

must_haves:
  truths:
    - "Cmd/Ctrl+K opens Ask AI panel and focuses input"
    - "Escape blurs input to allow arrow key slide navigation"
    - "Q&A entries accumulate in history during session"
    - "History displays in scrollable list with newest first"
    - "Clear button removes all history entries"
    - "Arrow keys always navigate slides (already implemented)"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "History state, keyboard shortcuts, history UI"
      contains: "askAIHistory"
  key_links:
    - from: "handleAskAISend"
      to: "askAIHistory state"
      via: "setAskAIHistory append after successful response"
      pattern: "setAskAIHistory.*prev.*question.*answer"
    - from: "document keydown listener"
      to: "askAIInputRef.focus()"
      via: "Cmd+K handler"
      pattern: "metaKey.*ctrlKey.*key.*k"
---

<objective>
Add session history tracking and keyboard shortcuts to Ask AI feature.

Purpose: Complete Phase 37 requirements - teachers can quickly access Ask AI with Cmd+K, see previous Q&A in scrollable history, and clear history when needed. Escape key returns focus for slide navigation.

Output: Working keyboard shortcuts (Cmd+K, Escape), session history with scrollable UI and clear button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-history-keyboard/37-RESEARCH.md
@.planning/phases/36-core-ask-ai/36-04-SUMMARY.md
@components/PresentationView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add history state, input ref, and keyboard shortcuts</name>
  <files>components/PresentationView.tsx</files>
  <action>
Add state and refs after existing Ask AI state (around line 189):

```typescript
// NEW: Ask AI history state
const [askAIHistory, setAskAIHistory] = useState<Array<{
  question: string;
  answer: string;
  timestamp: number;
}>>([]);
const askAIInputRef = useRef<HTMLInputElement>(null);
```

Add keyboard shortcut useEffect after existing useEffects (around line 390):

```typescript
// Ask AI keyboard shortcuts
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    // Cmd+K or Ctrl+K to focus Ask AI input
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (!askAIPanelOpen) {
        setAskAIPanelOpen(true);
      } else {
        askAIInputRef.current?.focus();
      }
    }

    // Escape to blur input (allows arrow keys to navigate slides)
    if (e.key === 'Escape' && document.activeElement === askAIInputRef.current) {
      askAIInputRef.current?.blur();
    }
  };

  document.addEventListener('keydown', handleKeyDown);
  return () => document.removeEventListener('keydown', handleKeyDown);
}, [askAIPanelOpen]);
```

Add auto-focus useEffect immediately after:

```typescript
// Auto-focus Ask AI input when panel opens
useEffect(() => {
  if (askAIPanelOpen && askAIInputRef.current) {
    askAIInputRef.current.focus();
  }
}, [askAIPanelOpen]);
```

Add ref to input element (around line 1540):
- Find the input with `value={askAIInput}`
- Add `ref={askAIInputRef}` as first prop
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>askAIHistory state, askAIInputRef, keyboard shortcut useEffect, and auto-focus useEffect are in place. Input has ref attached.</done>
</task>

<task type="auto">
  <name>Task 2: Track Q&A in history on successful send</name>
  <files>components/PresentationView.tsx</files>
  <action>
Modify handleAskAISend to save to history after successful streaming completes.

In the `finally` block (around line 1173), update to:

```typescript
finally {
  if (askAIMountedRef.current) {
    // Save successful Q&A to history (only if we have a response and no error)
    if (fullResponse && !askAIError) {
      setAskAIHistory(prev => [...prev, {
        question: message,
        answer: fullResponse,
        timestamp: Date.now()
      }]);
    }
    setAskAIIsLoading(false);
    setAskAIIsStreaming(false);
  }
}
```

Note: The `message` variable already exists at line 1136. The `fullResponse` variable exists at line 1150. Need to check error state before saving.

Actually, better approach - check if we have a response and no error was set. Move the history append to just before the finally block, after the for-await loop completes successfully:

After line 1162 (`setAskAIResponse(fullResponse);`) and before the catch block:
```typescript
      // Save successful Q&A to history
      if (fullResponse) {
        setAskAIHistory(prev => [...prev, {
          question: message,
          answer: fullResponse,
          timestamp: Date.now()
        }]);
      }
```

Add clear history handler after handleAskAIClear (around line 1200):

```typescript
// Ask AI: Clear history
const handleClearHistory = useCallback(() => {
  setAskAIHistory([]);
}, []);
```

Update handleAskAISend useCallback dependency array to include askAIError if referencing it.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Q&A pairs are saved to askAIHistory after successful response. handleClearHistory handler exists.</done>
</task>

<task type="auto">
  <name>Task 3: Add history UI with scrollable list and clear button</name>
  <files>components/PresentationView.tsx</files>
  <action>
Add history UI inside the Ask AI dropdown panel, after the response display section (after line 1621, before the closing `</div>` of the panel).

Insert before the final `</div></div>` that closes the panel (around line 1623):

```tsx
{/* Session History */}
{askAIHistory.length > 0 && (
  <div className="mt-3 border-t border-slate-700 pt-3">
    <div className="flex items-center justify-between mb-2">
      <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">
        History ({askAIHistory.length})
      </span>
      <button
        onClick={handleClearHistory}
        className="text-xs text-slate-400 hover:text-white transition-colors"
      >
        Clear
      </button>
    </div>
    <div className="max-h-48 overflow-y-auto space-y-2">
      {[...askAIHistory].reverse().map((entry) => (
        <div key={entry.timestamp} className="bg-slate-700/30 rounded p-2 text-xs">
          <div className="text-slate-300 font-medium mb-1 truncate">Q: {entry.question}</div>
          <div className="text-slate-400 line-clamp-2">A: {entry.answer}</div>
        </div>
      ))}
    </div>
  </div>
)}
```

Key details:
- Renders only when history has entries
- Shows count in header
- Clear button calls handleClearHistory
- `max-h-48 overflow-y-auto` makes it scrollable (HIST-02)
- `[...askAIHistory].reverse()` shows newest first (per RESEARCH.md recommendation)
- `truncate` on question, `line-clamp-2` on answer for compact display
- Uses timestamp as key (guaranteed unique)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Start app and test:
   - Press Cmd+K (Mac) or Ctrl+K (Windows) - panel opens, input focuses
   - Press Escape - input blurs, arrow keys navigate slides
   - Ask a question - response appears
   - Ask another question - history shows 2 entries
   - Click Clear - history clears
   - Close panel, press Cmd+K - panel opens with input focused
  </verify>
  <done>
History UI displays below response with:
- "History (N)" header with count
- Clear button that removes all entries
- Scrollable list (max-h-48) showing newest first
- Each entry shows truncated question and 2-line answer preview
All 6 requirements (HIST-01, HIST-02, HIST-03, KEY-01, KEY-02, KEY-03) verified working.
  </done>
</task>

</tasks>

<verification>
1. **HIST-01**: Q&A history persists during session
   - Ask multiple questions, history accumulates
   - Navigate between slides, history preserved

2. **HIST-02**: Scrollable history view
   - Ask 5+ questions, history becomes scrollable
   - Scroll works within max-h-48 container

3. **HIST-03**: Clear history button
   - Click Clear, all entries removed
   - History section disappears (conditional render)

4. **KEY-01**: Cmd/Ctrl+K focuses input
   - From anywhere in presentation, Cmd+K opens panel and focuses
   - If panel open, Cmd+K focuses input

5. **KEY-02**: Escape returns focus
   - With input focused, press Escape
   - Input blurs, arrow keys now navigate slides

6. **KEY-03**: Arrow keys navigate slides
   - Already implemented in Phase 36
   - Verify still works: focus input, press ArrowRight, input blurs, slide advances
</verification>

<success_criteria>
- All 6 requirements (HIST-01 through KEY-03) verified working
- TypeScript compiles without errors
- Build succeeds
- No console errors during usage
- History survives slide navigation
- History clears when presentation closed/reloaded (session-only)
</success_criteria>

<output>
After completion, create `.planning/phases/37-history-keyboard/37-01-SUMMARY.md`
</output>
