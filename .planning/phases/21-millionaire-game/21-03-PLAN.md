---
phase: 21-millionaire-game
plan: 03
type: execute
wave: 3
depends_on: ["21-02"]
files_modified:
  - components/games/millionaire/LifelinePanel.tsx
  - components/games/millionaire/AudiencePollOverlay.tsx
  - components/games/millionaire/PhoneAFriendOverlay.tsx
  - services/geminiService.ts
  - components/games/MillionaireGame.tsx
  - components/PresentationView.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Teacher can activate 50:50 lifeline and 2 wrong answers disappear"
    - "Teacher can activate Ask the Audience lifeline and poll percentages display"
    - "Teacher can activate Phone-a-Friend lifeline and AI-generated hint appears"
    - "Each lifeline can only be used once per game"
    - "Used lifelines appear grayed out"
  artifacts:
    - path: "components/games/millionaire/LifelinePanel.tsx"
      provides: "Row of lifeline buttons with used/available state"
      exports: ["LifelinePanel"]
    - path: "components/games/millionaire/AudiencePollOverlay.tsx"
      provides: "Bar chart display of audience poll results"
      exports: ["AudiencePollOverlay"]
    - path: "components/games/millionaire/PhoneAFriendOverlay.tsx"
      provides: "AI hint display styled as phone call"
      exports: ["PhoneAFriendOverlay"]
    - path: "services/geminiService.ts"
      provides: "generatePhoneAFriendHint function"
      exports: ["generatePhoneAFriendHint"]
  key_links:
    - from: "components/games/MillionaireGame.tsx"
      to: "LifelinePanel"
      via: "import and render"
      pattern: "import LifelinePanel"
    - from: "components/PresentationView.tsx"
      to: "services/geminiService.ts"
      via: "generatePhoneAFriendHint call"
      pattern: "generatePhoneAFriendHint"
---

<objective>
Implement all three Millionaire lifelines: 50:50, Ask the Audience, and Phone-a-Friend

Purpose: Add the classic Millionaire lifeline mechanics that make the game engaging and provide scaffolding for students.

Output: Functional lifeline system with 50:50 elimination, audience poll display, and AI-generated phone hints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-millionaire-game/21-CONTEXT.md
@.planning/phases/21-millionaire-game/21-RESEARCH.md
@.planning/phases/21-millionaire-game/21-01-SUMMARY.md
@.planning/phases/21-millionaire-game/21-02-SUMMARY.md

# Key source files
@types.ts
@services/geminiService.ts
@components/games/MillionaireGame.tsx
@components/PresentationView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LifelinePanel and overlay components</name>
  <files>components/games/millionaire/LifelinePanel.tsx, components/games/millionaire/AudiencePollOverlay.tsx, components/games/millionaire/PhoneAFriendOverlay.tsx</files>
  <action>
  1. Create LifelinePanel.tsx:
     ```typescript
     interface LifelinePanelProps {
       lifelines: {
         fiftyFifty: boolean;
         phoneAFriend: boolean;
         askTheAudience: boolean;
       };
       onUseLifeline: (lifeline: 'fiftyFifty' | 'askTheAudience' | 'phoneAFriend') => void;
       disabled: boolean; // Disable all during reveal
       isLoading?: 'phoneAFriend' | null; // Show loading state for AI call
     }
     ```

     - Row of 3 circular buttons with icons:
       - 50:50 icon (two rectangles)
       - Audience icon (people silhouette)
       - Phone icon
     - Available lifelines: full color, clickable
     - Used lifelines: grayed out, not clickable
     - Loading state for Phone-a-Friend (spinner)
     - Consistent with Millionaire blue/purple theme

  2. Create AudiencePollOverlay.tsx:
     ```typescript
     interface AudiencePollOverlayProps {
       percentages: [number, number, number, number]; // A, B, C, D
       onClose: () => void;
     }
     ```

     - Modal overlay with semi-transparent background
     - Title: "Audience Poll Results"
     - 4 vertical bars (A, B, C, D) showing percentages
     - Bars animate up from 0 to their percentage over 1 second
     - Highest bar highlighted in amber, others in blue
     - Close button

  3. Create PhoneAFriendOverlay.tsx:
     ```typescript
     interface PhoneAFriendOverlayProps {
       hint: {
         confidence: 'high' | 'medium' | 'low';
         response: string;
       };
       onClose: () => void;
     }
     ```

     - Modal overlay styled as phone call
     - Phone icon header
     - Confidence indicator (green/yellow/red based on level)
     - Response text in speech bubble style
     - "Hang Up" close button

  Use Tailwind classes consistent with existing overlays/modals.
  </action>
  <verify>Components render without errors</verify>
  <done>LifelinePanel displays 3 lifeline buttons with correct states, overlay components display results</done>
</task>

<task type="auto">
  <name>Task 2: Add Phone-a-Friend AI generation to geminiService</name>
  <files>services/geminiService.ts</files>
  <action>
  Add generatePhoneAFriendHint function to geminiService.ts:

  ```typescript
  export interface PhoneAFriendResponse {
    confidence: 'high' | 'medium' | 'low';
    response: string;
  }

  export const generatePhoneAFriendHint = async (
    apiKey: string,
    question: string,
    options: string[]
  ): Promise<PhoneAFriendResponse> => {
    const ai = new GoogleGenAI({ apiKey });
    const model = "gemini-3-flash-preview";

    const systemInstruction = `
      You are a helpful friend receiving a phone call on "Who Wants to Be a Millionaire."
      You have 30 seconds to help.

      IMPORTANT: Vary your response style randomly. Pick ONE of these approaches:
      1. CONFIDENT: "I'm pretty sure it's [X] because..."
      2. REASONING: "Well, I know that [fact], so it might be..."
      3. ELIMINATION: "I don't think it's [X] or [Y], so maybe..."
      4. UNCERTAIN: "Hmm, this is tricky. My best guess would be..."

      RULES:
      - Keep response under 50 words (it's a timed call!)
      - Sound natural, like a real phone conversation
      - Never say "I am an AI" or break character
      - Sometimes be intentionally wrong or uncertain (maybe 15% of the time for realism)
      - Match response style to confidence level randomly
    `;

    const prompt = `
      Question: ${question}
      Options:
      A) ${options[0]}
      B) ${options[1]}
      C) ${options[2]}
      D) ${options[3]}

      Provide your phone-a-friend response.
    `;

    try {
      const response = await ai.models.generateContent({
        model,
        contents: prompt,
        config: {
          systemInstruction,
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.OBJECT,
            properties: {
              confidence: { type: Type.STRING, enum: ['high', 'medium', 'low'] },
              response: { type: Type.STRING, description: "Natural phone conversation response, under 50 words" }
            },
            required: ['confidence', 'response']
          }
        }
      });

      return JSON.parse(response.text || '{"confidence":"low","response":"Sorry, I\\'m not sure on this one."}');
    } catch (e) {
      return { confidence: 'low', response: "The connection cut out! I couldn't hear the question properly." };
    }
  };
  ```

  Note: Do NOT pass correctIndex to the AI - let it genuinely reason about the question (with occasional errors) for more realistic gameplay.
  </action>
  <verify>`npm run build` succeeds, function is exported from geminiService.ts</verify>
  <done>generatePhoneAFriendHint function generates varied, natural-sounding hints with random confidence levels</done>
</task>

<task type="auto">
  <name>Task 3: Integrate lifelines into MillionaireGame and PresentationView</name>
  <files>components/games/MillionaireGame.tsx, components/PresentationView.tsx</files>
  <action>
  1. Update MillionaireGame.tsx:
     - Import LifelinePanel, AudiencePollOverlay, PhoneAFriendOverlay
     - Add local state for showing overlays:
       ```typescript
       const [showAudiencePoll, setShowAudiencePoll] = useState(false);
       const [showPhoneHint, setShowPhoneHint] = useState(false);
       ```
     - Render LifelinePanel above question area (receives lifelines from state)
     - Conditionally render AudiencePollOverlay when state.audiencePoll is set
     - Conditionally render PhoneAFriendOverlay when state.phoneHint is set
     - Add prop `isLifelineLoading?: 'phoneAFriend' | null` to show loading state

  2. Update PresentationView.tsx lifeline handlers:

     ```typescript
     const handleUseLifeline = useCallback(async (lifeline: 'fiftyFifty' | 'askTheAudience' | 'phoneAFriend') => {
       if (activeGame?.gameType !== 'millionaire') return;
       const state = activeGame;
       if (state.status !== 'playing') return;

       // Mark lifeline as used
       const updatedLifelines = {
         ...state.lifelines,
         [lifeline]: false,
       };

       if (lifeline === 'fiftyFifty') {
         // Randomly eliminate 2 of 3 wrong answers
         const currentQuestion = state.questions[state.currentQuestionIndex];
         const correctIndex = currentQuestion.correctAnswerIndex;
         const wrongIndices = [0, 1, 2, 3].filter(i => i !== correctIndex);
         const shuffled = wrongIndices.sort(() => Math.random() - 0.5);
         const eliminated = [shuffled[0], shuffled[1]];

         setActiveGame({
           ...state,
           lifelines: updatedLifelines,
           eliminatedOptions: eliminated,
         });

       } else if (lifeline === 'askTheAudience') {
         // Generate difficulty-based poll percentages
         const currentQuestion = state.questions[state.currentQuestionIndex];
         const correctIndex = currentQuestion.correctAnswerIndex;
         const questionProgress = state.currentQuestionIndex / state.questions.length;

         // Later questions = harder = more scattered votes
         const difficulty = questionProgress < 0.3 ? 'easy' : questionProgress < 0.7 ? 'medium' : 'hard';

         const correctRange = difficulty === 'easy' ? [60, 80]
           : difficulty === 'medium' ? [40, 55]
           : [25, 35];

         const correctPercent = Math.floor(
           Math.random() * (correctRange[1] - correctRange[0]) + correctRange[0]
         );
         let remaining = 100 - correctPercent;

         // Distribute remaining among wrong answers
         const wrongIndices = [0, 1, 2, 3].filter(i => i !== correctIndex);
         const percentages: [number, number, number, number] = [0, 0, 0, 0];
         percentages[correctIndex] = correctPercent;

         wrongIndices.forEach((idx, i) => {
           if (i === wrongIndices.length - 1) {
             percentages[idx] = remaining;
           } else {
             const portion = Math.floor(Math.random() * remaining * 0.6);
             percentages[idx] = portion;
             remaining -= portion;
           }
         });

         setActiveGame({
           ...state,
           lifelines: updatedLifelines,
           audiencePoll: percentages,
         });

       } else if (lifeline === 'phoneAFriend') {
         if (!provider) return;

         // Set loading state
         setActiveGame({
           ...state,
           lifelines: updatedLifelines,
         });
         setLifelineLoading('phoneAFriend');

         const currentQuestion = state.questions[state.currentQuestionIndex];
         try {
           const hint = await generatePhoneAFriendHint(
             provider.apiKey,
             currentQuestion.question,
             currentQuestion.options
           );

           setActiveGame(prev => {
             if (prev?.gameType !== 'millionaire') return prev;
             return { ...prev, phoneHint: hint };
           });
         } catch (e) {
           setActiveGame(prev => {
             if (prev?.gameType !== 'millionaire') return prev;
             return { ...prev, phoneHint: { confidence: 'low', response: "The line went dead! Try another lifeline." } };
           });
         } finally {
           setLifelineLoading(null);
         }
       }
     }, [activeGame, provider]);
     ```

  3. Add state for lifeline loading:
     ```typescript
     const [lifelineLoading, setLifelineLoading] = useState<'phoneAFriend' | null>(null);
     ```

  4. Pass handleUseLifeline and lifelineLoading to GameContainer/MillionaireGame.

  5. Import generatePhoneAFriendHint from '../services/geminiService'.

  6. In MillionaireGame, add dismiss handlers for overlays (clear audiencePoll/phoneHint from state when closing overlay - OR keep them visible, per preference. Recommend: keep visible but allow dismiss to hide UI while keeping data in state for student view).
  </action>
  <verify>`npm run build` succeeds, all three lifelines work: 50:50 eliminates options, audience poll shows bar chart, phone-a-friend shows AI hint</verify>
  <done>All three lifelines functional: 50:50 hides 2 wrong answers, Ask the Audience shows difficulty-based poll, Phone-a-Friend generates AI hint</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. LifelinePanel shows 3 buttons above question area
3. Clicking 50:50 eliminates 2 wrong answers (they become hidden/grayed)
4. Clicking Ask the Audience shows poll percentages in bar chart overlay
5. Clicking Phone-a-Friend shows loading, then displays AI hint in overlay
6. Used lifelines are grayed out and not clickable
7. Lifeline data persists in state for student view sync
</verification>

<success_criteria>
- 50:50 eliminates exactly 2 wrong answers, keeping the correct answer
- Ask the Audience generates difficulty-scaled poll percentages
- Phone-a-Friend generates varied, natural-sounding AI hints
- Each lifeline can only be used once per game
- Used lifelines visually distinct from available ones
- Lifeline overlays display clearly and can be dismissed
</success_criteria>

<output>
After completion, create `.planning/phases/21-millionaire-game/21-03-SUMMARY.md`
</output>
