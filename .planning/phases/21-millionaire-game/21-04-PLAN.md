---
phase: 21-millionaire-game
plan: 04
type: execute
wave: 4
depends_on: ["21-03"]
files_modified:
  - components/StudentGameView.tsx
  - components/games/millionaire/SafeHavenCelebration.tsx
  - components/games/millionaire/WrongAnswerReveal.tsx
  - components/games/millionaire/VictoryCelebration.tsx
  - index.html
  - hooks/useSound.ts
  - components/games/MillionaireGame.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Student view shows Millionaire game with money tree and current question"
    - "Student view displays lifeline results (eliminated options, poll, hint)"
    - "Safe haven celebrations show dramatic pause with visual effects"
    - "Wrong answer shows TV-style drama with red flash and correct answer reveal"
    - "Victory screen displays celebratory animation"
    - "Audio is OFF by default, can be toggled"
  artifacts:
    - path: "components/StudentGameView.tsx"
      provides: "MillionaireStudentView component"
      contains: "MillionaireStudentView"
    - path: "components/games/millionaire/SafeHavenCelebration.tsx"
      provides: "Safe haven reached animation overlay"
      exports: ["SafeHavenCelebration"]
    - path: "components/games/millionaire/WrongAnswerReveal.tsx"
      provides: "Wrong answer dramatic reveal overlay"
      exports: ["WrongAnswerReveal"]
    - path: "components/games/millionaire/VictoryCelebration.tsx"
      provides: "Victory celebration with confetti"
      exports: ["VictoryCelebration"]
    - path: "index.html"
      provides: "Millionaire CSS animations"
      contains: "millionaireGlow"
    - path: "hooks/useSound.ts"
      provides: "Zero-dependency audio hook"
      exports: ["useSound"]
  key_links:
    - from: "components/StudentGameView.tsx"
      to: "MillionaireState"
      via: "discriminated union switch"
      pattern: "gameType === 'millionaire'"
    - from: "components/games/MillionaireGame.tsx"
      to: "hooks/useSound.ts"
      via: "sound effects"
      pattern: "import.*useSound"
---

<objective>
Complete Millionaire with student view sync, celebration animations, and optional audio

Purpose: Polish the Millionaire experience with dramatic visual effects and enable student view to display the game.

Output: Student view displays Millionaire game state, dramatic animations for safe havens/wrong answers/victory, optional sound effects.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-millionaire-game/21-CONTEXT.md
@.planning/phases/21-millionaire-game/21-RESEARCH.md
@.planning/phases/21-millionaire-game/21-01-SUMMARY.md
@.planning/phases/21-millionaire-game/21-02-SUMMARY.md
@.planning/phases/21-millionaire-game/21-03-SUMMARY.md

# Key source files
@types.ts
@components/StudentGameView.tsx
@components/games/MillionaireGame.tsx
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create celebration and drama overlays with CSS animations</name>
  <files>components/games/millionaire/SafeHavenCelebration.tsx, components/games/millionaire/WrongAnswerReveal.tsx, components/games/millionaire/VictoryCelebration.tsx, index.html</files>
  <action>
  1. Add Millionaire CSS animations to index.html (in existing style block):
     ```css
     /* Millionaire theme animations */
     @keyframes millionaireGlow {
       0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
       50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8); }
     }
     .animate-millionaire-glow { animation: millionaireGlow 2s ease-in-out infinite; }

     @keyframes wrongAnswerFlash {
       0% { background-color: inherit; transform: scale(1); }
       20% { background-color: #dc2626; transform: scale(1.05); }
       40% { background-color: inherit; transform: scale(1); }
       60% { background-color: #dc2626; transform: scale(1.03); }
       100% { background-color: #dc2626; transform: scale(1); opacity: 0.7; }
     }
     .animate-wrong-answer { animation: wrongAnswerFlash 1.5s ease-out forwards; }

     @keyframes safeHavenCelebration {
       0% { transform: scale(1); opacity: 1; }
       50% { transform: scale(1.1); box-shadow: 0 0 60px rgba(245, 158, 11, 0.9); }
       100% { transform: scale(1); box-shadow: 0 0 30px rgba(245, 158, 11, 0.5); }
     }
     .animate-safe-haven { animation: safeHavenCelebration 2s ease-out; }

     @keyframes confettiFall {
       0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
       100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
     }
     .confetti-piece {
       position: fixed;
       width: 10px;
       height: 10px;
       top: 0;
       animation: confettiFall 3s ease-out forwards;
       pointer-events: none;
     }

     @keyframes answerRevealPulse {
       0% { transform: scale(1); opacity: 0.6; }
       50% { transform: scale(1.02); opacity: 1; }
       100% { transform: scale(1); opacity: 1; }
     }
     .animate-answer-reveal { animation: answerRevealPulse 0.3s ease-out forwards; }
     ```

  2. Create SafeHavenCelebration.tsx:
     ```typescript
     interface SafeHavenCelebrationProps {
       amount: number;
       onComplete: () => void;
     }
     ```
     - Full screen overlay with amber gradient background
     - "SAFE HAVEN REACHED!" title
     - Prize amount displayed large
     - "You've secured ${amount}!" subtitle
     - Auto-dismisses after 3 seconds OR click to dismiss
     - Use animate-safe-haven class for glow effect

  3. Create WrongAnswerReveal.tsx:
     ```typescript
     interface WrongAnswerRevealProps {
       correctAnswer: string;
       correctLetter: string; // "A", "B", "C", "D"
       safeHavenAmount: number;
       onClose: () => void;
     }
     ```
     - Full screen overlay with dark red gradient
     - "WRONG ANSWER" title with animate-wrong-answer effect
     - Show correct answer: "The correct answer was {letter}: {answer}"
     - Show safe haven: "You take home ${safeHavenAmount}"
     - "Game Over" button to dismiss

  4. Create VictoryCelebration.tsx:
     ```typescript
     interface VictoryCelebrationProps {
       finalPrize: number;
       onClose: () => void;
       onRestart?: () => void;
     }
     ```
     - Full screen overlay with golden gradient
     - "MILLIONAIRE!" or "WINNER!" title
     - Final prize displayed large
     - CSS confetti effect (20-30 confetti pieces with random colors, positions, delays)
     - "Play Again" and "Back to Lesson" buttons
  </action>
  <verify>Components render, animations play, CSS is in index.html</verify>
  <done>Celebration overlays display with dramatic CSS animations matching Millionaire theme</done>
</task>

<task type="auto">
  <name>Task 2: Add MillionaireStudentView to StudentGameView</name>
  <files>components/StudentGameView.tsx</files>
  <action>
  Update StudentGameView.tsx to add MillionaireStudentView:

  1. Remove 'millionaire' from PlaceholderStudentView (it's now a real game).

  2. Add MillionaireStudentView component:
     ```typescript
     const MillionaireStudentView: React.FC<{ state: MillionaireState }> = ({ state }) => {
       const config = MONEY_TREE_CONFIGS[state.questionCount];
       const currentQuestion = state.questions[state.currentQuestionIndex];

       // Build answered array for MoneyTree
       const answeredCorrectly = Array.from(
         { length: state.currentQuestionIndex },
         () => true
       );

       return (
         <div className="h-screen w-screen bg-gradient-to-br from-blue-950 to-indigo-950 flex font-poppins">
           {/* Left: Money Tree */}
           <div className="w-1/4 p-4 flex items-center">
             <MoneyTree
               config={config}
               currentQuestionIndex={state.currentQuestionIndex}
               answeredCorrectly={answeredCorrectly}
             />
           </div>

           {/* Right: Question area */}
           <div className="flex-1 p-6 flex flex-col justify-center">
             {/* Question number */}
             <div className="text-center mb-4">
               <span className="inline-block px-4 py-1 bg-amber-500 text-amber-950 rounded-full text-sm font-bold">
                 Question {state.currentQuestionIndex + 1} for ${config.prizes[state.currentQuestionIndex].toLocaleString()}
               </span>
             </div>

             {/* Question text */}
             <div className="bg-blue-900/50 p-8 rounded-2xl border-2 border-blue-400/30 mb-6 animate-millionaire-glow">
               <p className="text-2xl md:text-4xl font-bold text-white text-center">
                 {currentQuestion?.question || 'Loading...'}
               </p>
             </div>

             {/* Answer options */}
             {currentQuestion && (
               <div className="grid grid-cols-2 gap-4">
                 {currentQuestion.options.map((opt, idx) => {
                   const letter = String.fromCharCode(65 + idx);
                   const isEliminated = state.eliminatedOptions.includes(idx);
                   const isSelected = state.selectedOption === idx;
                   const isCorrect = idx === currentQuestion.correctAnswerIndex;
                   const showResult = state.status === 'reveal' || state.status === 'result';

                   if (isEliminated) {
                     return (
                       <div key={idx} className="h-20 bg-blue-950/30 rounded-xl opacity-30" />
                     );
                   }

                   return (
                     <div
                       key={idx}
                       className={`
                         flex items-center gap-4 p-4 rounded-xl border-2 transition-all
                         ${isSelected && !showResult ? 'bg-amber-500 border-amber-400 text-amber-950' : 'bg-blue-900/50 border-blue-400/30 text-white'}
                         ${showResult && isCorrect ? 'bg-green-600 border-green-400 animate-flash-correct' : ''}
                         ${showResult && isSelected && !isCorrect ? 'bg-red-600 border-red-400 animate-wrong-answer' : ''}
                       `}
                     >
                       <span className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center font-bold">
                         {letter}
                       </span>
                       <span className="text-lg md:text-xl font-bold">{opt}</span>
                     </div>
                   );
                 })}
               </div>
             )}

             {/* Lifeline results */}
             {state.audiencePoll && (
               <div className="mt-6 bg-blue-900/50 p-4 rounded-xl">
                 <p className="text-sm text-blue-300 mb-2">Audience Poll:</p>
                 <div className="flex gap-4">
                   {state.audiencePoll.map((pct, idx) => (
                     <div key={idx} className="flex-1 text-center">
                       <div className="text-2xl font-bold text-white">{pct}%</div>
                       <div className="text-blue-300">{String.fromCharCode(65 + idx)}</div>
                     </div>
                   ))}
                 </div>
               </div>
             )}

             {state.phoneHint && (
               <div className="mt-6 bg-blue-900/50 p-4 rounded-xl">
                 <p className="text-sm text-blue-300 mb-2">Phone-a-Friend says:</p>
                 <p className="text-lg text-white italic">"{state.phoneHint.response}"</p>
               </div>
             )}
           </div>
         </div>
       );
     };
     ```

  3. Update the game-specific rendering switch:
     ```typescript
     // Replace PlaceholderStudentView call for millionaire:
     if (gameState.gameType === 'millionaire') {
       return <MillionaireStudentView state={gameState} />;
     }
     ```

  4. Import MoneyTree and MONEY_TREE_CONFIGS:
     ```typescript
     import MoneyTree from './games/millionaire/MoneyTree';
     import { MONEY_TREE_CONFIGS } from './games/millionaire/millionaireConfig';
     ```

  Note: Student view is read-only - shows selection, reveals, lifeline results but no interaction.
  </action>
  <verify>Student view displays Millionaire game correctly with money tree, question, answers, lifeline results</verify>
  <done>Student view shows complete Millionaire game state including money tree, current question, eliminated options, and lifeline results</done>
</task>

<task type="auto">
  <name>Task 3: Add useSound hook and integrate celebrations into MillionaireGame</name>
  <files>hooks/useSound.ts, components/games/MillionaireGame.tsx</files>
  <action>
  1. Create hooks/useSound.ts:
     ```typescript
     import { useCallback, useRef, useState } from 'react';

     interface UseSoundOptions {
       volume?: number;
       enabled?: boolean;
     }

     export function useSound(src: string, options: UseSoundOptions = {}) {
       const { volume = 1, enabled = true } = options;
       const audioRef = useRef<HTMLAudioElement | null>(null);
       const [isPlaying, setIsPlaying] = useState(false);

       const play = useCallback(() => {
         if (!enabled) return;

         if (!audioRef.current) {
           audioRef.current = new Audio(src);
         }

         const audio = audioRef.current;
         audio.volume = volume;
         audio.currentTime = 0;

         audio.play()
           .then(() => setIsPlaying(true))
           .catch(err => console.warn('Audio play failed:', err));

         audio.onended = () => setIsPlaying(false);
       }, [src, volume, enabled]);

       const stop = useCallback(() => {
         if (audioRef.current) {
           audioRef.current.pause();
           audioRef.current.currentTime = 0;
           setIsPlaying(false);
         }
       }, []);

       return { play, stop, isPlaying };
     }
     ```

  2. Update MillionaireGame.tsx to integrate celebrations and audio:
     - Add local state:
       ```typescript
       const [soundEnabled, setSoundEnabled] = useState(false); // OFF by default per CONTEXT.md
       const [showSafeHaven, setShowSafeHaven] = useState(false);
       const [showWrongAnswer, setShowWrongAnswer] = useState(false);
       const [showVictory, setShowVictory] = useState(false);
       ```

     - Add sound toggle button in header area (mute/unmute icon)

     - Detect when to show celebrations:
       - Safe haven: When currentQuestionIndex enters a safe haven position after correct answer
       - Wrong answer: When status becomes 'result' AND player was wrong (currentPrize === safeHavenAmount and safeHavenAmount !== max prize)
       - Victory: When status becomes 'result' AND player won (currentPrize === max prize)

     - Import and conditionally render overlays:
       ```typescript
       {showSafeHaven && (
         <SafeHavenCelebration
           amount={state.safeHavenAmount}
           onComplete={() => setShowSafeHaven(false)}
         />
       )}
       {showWrongAnswer && (
         <WrongAnswerReveal
           correctAnswer={currentQuestion.options[currentQuestion.correctAnswerIndex]}
           correctLetter={String.fromCharCode(65 + currentQuestion.correctAnswerIndex)}
           safeHavenAmount={state.safeHavenAmount}
           onClose={() => setShowWrongAnswer(false)}
         />
       )}
       {showVictory && (
         <VictoryCelebration
           finalPrize={state.currentPrize}
           onClose={onClose}
           onRestart={onRestart}
         />
       )}
       ```

     - Add useEffect to trigger celebrations when state changes appropriately

     - Sound effects are optional enhancement - if you don't add actual audio files, the useSound hook will gracefully handle missing files. For now, just wire up the hook structure. Audio files can be added later.
  </action>
  <verify>`npm run build` succeeds, celebrations display at appropriate times, sound toggle works (even without audio files)</verify>
  <done>MillionaireGame shows celebration overlays for safe haven/wrong answer/victory, sound toggle present (audio OFF by default)</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Millionaire animations work in index.html (glow, wrong answer flash, safe haven, confetti)
3. Student view displays Millionaire game correctly via BroadcastChannel
4. Safe haven celebration shows when reaching a safe haven position
5. Wrong answer reveals correct answer with dramatic effect
6. Victory celebration shows confetti when winning
7. Sound toggle button present and defaults to OFF
</verification>

<success_criteria>
- Student view shows money tree, question, answers, lifeline results synchronized from teacher view
- Safe haven celebrations appear at questions 5 and 10 (or equivalent for shorter games)
- Wrong answer shows TV-style drama with correct answer reveal
- Victory celebration displays with confetti effect
- Audio is OFF by default with visible mute/unmute toggle
- All Millionaire requirements (MILL-01 through MILL-08) are met
</success_criteria>

<output>
After completion, create `.planning/phases/21-millionaire-game/21-04-SUMMARY.md`
</output>
