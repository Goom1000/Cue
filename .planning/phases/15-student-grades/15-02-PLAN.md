---
phase: 15-student-grades
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - components/ClassManagementModal.tsx
  - types.ts
  - services/saveService.ts
  - services/loadService.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can see grade dropdown for each student in expanded class view"
    - "Teacher can change a student's grade via dropdown"
    - "Grade changes persist across browser refresh"
    - "Exported .pipi files include grade data"
    - "Imported .pipi files restore grade assignments"
  artifacts:
    - path: "components/ClassManagementModal.tsx"
      provides: "Grade dropdown per student, badge in collapsed view"
      contains: "GradeLevel"
    - path: "types.ts"
      provides: "Extended PiPiFileContent with studentGrades"
      contains: "studentGrades"
    - path: "services/saveService.ts"
      provides: "Grade data in createPiPiFile"
      contains: "studentGrades"
    - path: "services/loadService.ts"
      provides: "Grade data validation in isValidPiPiFile"
      contains: "studentGrades"
  key_links:
    - from: "components/ClassManagementModal.tsx"
      to: "hooks/useClassBank.ts"
      via: "onUpdateGrade prop calling updateStudentGrade"
      pattern: "onUpdateGrade"
    - from: "services/saveService.ts"
      to: "types.ts"
      via: "import PiPiFileContent"
      pattern: "studentGrades"
---

<objective>
Add UI for viewing and editing student grades, and preserve grades in export/import.

Purpose: Teachers can assign and modify grade levels through the existing Class Management Modal. Grades are preserved when saving/loading .pipi files.

Output: Grade dropdown in ClassManagementModal, grade badges, and export/import preservation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/15-student-grades/15-01-SUMMARY.md

# Files to modify
@components/ClassManagementModal.tsx
@types.ts
@services/saveService.ts
@services/loadService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grade dropdown to ClassManagementModal</name>
  <files>components/ClassManagementModal.tsx</files>
  <action>
Extend ClassManagementModal to display and edit student grades:

1. Import GradeLevel type:
   ```typescript
   import { SavedClass, GradeLevel } from '../types';
   ```

2. Add onUpdateGrade prop to ClassManagementModalProps:
   ```typescript
   interface ClassManagementModalProps {
     classes: SavedClass[];
     onClose: () => void;
     onRename: (classId: string, newName: string) => void;
     onUpdateStudents: (classId: string, students: string[]) => void;
     onDelete: (classId: string, className: string) => void;
     onUpdateGrade: (classId: string, studentName: string, grade: GradeLevel | null) => void;  // New
     activeClassName: string | null;
   }
   ```

3. Destructure onUpdateGrade in component:
   ```typescript
   const ClassManagementModal: React.FC<ClassManagementModalProps> = ({
     classes,
     onClose,
     onRename,
     onUpdateStudents,
     onDelete,
     onUpdateGrade,  // New
     activeClassName,
   }) => {
   ```

4. Helper function to get grade for a student:
   ```typescript
   const getStudentGrade = (classData: SavedClass, studentName: string): GradeLevel | null => {
     return classData.studentData?.find(s => s.name === studentName)?.grade ?? null;
   };
   ```

5. In the expanded student editor (inside the student chips map), add a grade select after each student name:
   Replace the existing student chip rendering with:
   ```tsx
   {classData.students.map((student) => {
     const currentGrade = getStudentGrade(classData, student);
     return (
       <div
         key={student}
         className="flex items-center gap-1.5 bg-indigo-50 dark:bg-slate-700 text-indigo-700 dark:text-amber-400 px-2.5 py-1 rounded-lg text-[10px] font-bold border border-indigo-100 dark:border-amber-500/20"
       >
         {student}
         {/* Grade Select */}
         <select
           value={currentGrade || ''}
           onChange={(e) => onUpdateGrade(classData.id, student, (e.target.value || null) as GradeLevel | null)}
           className="ml-1 px-1 py-0.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded text-[9px] text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:focus:ring-amber-500"
           onClick={(e) => e.stopPropagation()}
         >
           <option value="">-</option>
           <option value="A">A</option>
           <option value="B">B</option>
           <option value="C">C</option>
           <option value="D">D</option>
           <option value="E">E</option>
         </select>
         <button
           onClick={() => handleRemoveStudent(classData.id, classData.students, student)}
           className="text-indigo-300 dark:text-amber-600 hover:text-red-500 transition-colors"
         >
           <svg className="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />
           </svg>
         </button>
       </div>
     );
   })}
   ```

6. In the collapsed class row (not expanded), show grade distribution badge:
   After the student count text, add a grade summary:
   ```tsx
   <p className="text-xs text-slate-400 dark:text-slate-500 mt-0.5">
     {classData.students.length} student{classData.students.length !== 1 ? 's' : ''}
     {classData.studentData && classData.studentData.some(s => s.grade) && (
       <span className="ml-2 text-[9px] text-indigo-500 dark:text-amber-400">
         ({classData.studentData.filter(s => s.grade).length} graded)
       </span>
     )}
   </p>
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Grep for "onUpdateGrade" in ClassManagementModal.tsx - should find prop and usage.
  </verify>
  <done>
ClassManagementModal displays grade dropdown per student in expanded view. Grade changes call onUpdateGrade prop. Collapsed view shows "(X graded)" badge.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire grade updates in App.tsx</name>
  <files>App.tsx</files>
  <action>
Connect the ClassManagementModal's new onUpdateGrade prop to the useClassBank hook.

1. Find where ClassManagementModal is rendered in App.tsx (should be near the end of the component).

2. The useClassBank hook is already used in App.tsx. Destructure updateStudentGrade from it:
   Find the existing destructuring:
   ```typescript
   const { classes, saveClass, ... } = useClassBank();
   ```
   Add updateStudentGrade to the destructuring:
   ```typescript
   const { classes, saveClass, deleteClass, renameClass, updateClassStudents, getClassByName, refreshClasses, updateStudentGrade } = useClassBank();
   ```

3. Add the onUpdateGrade prop to ClassManagementModal:
   Find the ClassManagementModal JSX and add the prop:
   ```tsx
   <ClassManagementModal
     classes={classes}
     onClose={() => setShowManageModal(false)}
     onRename={handleRenameClass}
     onUpdateStudents={handleUpdateClassStudents}
     onDelete={handleDeleteClass}
     onUpdateGrade={updateStudentGrade}  // New
     activeClassName={activeClassName}
   />
   ```

Note: updateStudentGrade from the hook matches the expected signature (classId, studentName, grade), so it can be passed directly without a wrapper handler.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Run `npm run build` - should build successfully.
  </verify>
  <done>
ClassManagementModal's onUpdateGrade prop connected to useClassBank's updateStudentGrade function. Grade changes now persist to localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend export/import to preserve grades</name>
  <files>types.ts, services/saveService.ts, services/loadService.ts</files>
  <action>
Extend the .pipi file format to include student grade data:

**types.ts:**

1. Extend PiPiFileContent to include optional studentGrades:
   ```typescript
   export interface PiPiFileContent {
     slides: Slide[];
     studentNames: string[];
     lessonText: string;
     studentGrades?: StudentWithGrade[];  // New: optional for backward compatibility
   }
   ```

**services/saveService.ts:**

1. Import StudentWithGrade type:
   ```typescript
   import { Slide, PiPiFile, CURRENT_FILE_VERSION, StudentWithGrade } from '../types';
   ```

2. Update createPiPiFile function signature to accept optional studentGrades:
   ```typescript
   export function createPiPiFile(
     title: string,
     slides: Slide[],
     studentNames: string[],
     lessonText: string,
     existingFile?: PiPiFile,
     studentGrades?: StudentWithGrade[]  // New parameter
   ): PiPiFile {
   ```

3. Include studentGrades in the content object:
   ```typescript
   return {
     version: CURRENT_FILE_VERSION,
     createdAt: existingFile?.createdAt ?? now,
     modifiedAt: now,
     title,
     content: {
       slides,
       studentNames,
       lessonText,
       ...(studentGrades && studentGrades.length > 0 ? { studentGrades } : {}),
     },
   };
   ```

**services/loadService.ts:**

1. Update isValidPiPiFile to accept optional studentGrades:
   After validating content.slides, add:
   ```typescript
   // Validate optional studentGrades if present
   if (content.studentGrades !== undefined) {
     if (!Array.isArray(content.studentGrades)) return false;
     // Shallow validation - detailed validation happens in useClassBank
   }
   ```

Note: The loadService validation is intentionally shallow. The full validation of StudentWithGrade structure is handled by useClassBank when the data is used.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Grep for "studentGrades" in types.ts, saveService.ts, loadService.ts - should find in all three.
  </verify>
  <done>
PiPiFileContent extended with optional studentGrades. createPiPiFile accepts studentGrades parameter. loadService validates optional studentGrades field.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Build succeeds: `npm run build` completes without errors
3. UI integration: `grep -n "onUpdateGrade" components/ClassManagementModal.tsx App.tsx` shows prop usage
4. Export/import: `grep -n "studentGrades" types.ts services/saveService.ts services/loadService.ts` shows field in all
5. Manual test: Open app, create class with students, assign grades in Manage Classes modal, refresh page, verify grades persist
</verification>

<success_criteria>
- Grade dropdown appears next to each student name in expanded class view
- Selecting a grade calls onUpdateGrade and persists to localStorage
- Collapsed class row shows "(X graded)" badge when students have grades
- createPiPiFile accepts optional studentGrades parameter
- Exported .pipi files include studentGrades when present
- Imported .pipi files with studentGrades load without errors
- App builds and runs without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-student-grades/15-02-SUMMARY.md`
</output>
