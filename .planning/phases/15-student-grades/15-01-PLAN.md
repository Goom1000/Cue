---
phase: 15-student-grades
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - hooks/useClassBank.ts
autonomous: true

must_haves:
  truths:
    - "GradeLevel type exists as 'A' | 'B' | 'C' | 'D' | 'E'"
    - "SavedClass can store grade data per student"
    - "Existing classes without grades load without errors"
    - "updateStudentGrade function modifies a student's grade"
  artifacts:
    - path: "types.ts"
      provides: "GradeLevel type, StudentWithGrade interface, extended SavedClass"
      contains: "GradeLevel"
    - path: "hooks/useClassBank.ts"
      provides: "updateStudentGrade function, migration logic"
      exports: ["useClassBank"]
  key_links:
    - from: "hooks/useClassBank.ts"
      to: "types.ts"
      via: "import GradeLevel, StudentWithGrade, SavedClass"
      pattern: "import.*GradeLevel.*from"
---

<objective>
Extend the data model and persistence layer to support student grade levels.

Purpose: Foundation for assigning A/B/C/D/E grades to individual students within saved classes. Required before UI can display or modify grades.

Output: GradeLevel type, StudentWithGrade interface, extended SavedClass interface, and updateStudentGrade hook function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work on class bank
@.planning/phases/10-class-bank-core/10-01-SUMMARY.md
@.planning/phases/11-class-management-ui/11-01-SUMMARY.md

# Files to modify
@types.ts
@hooks/useClassBank.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GradeLevel type and extend SavedClass</name>
  <files>types.ts</files>
  <action>
Add grade-related types to types.ts:

1. Add GradeLevel union type after the SavedClass interface:
   ```typescript
   // Student grade levels for targeted questioning
   export type GradeLevel = 'A' | 'B' | 'C' | 'D' | 'E';
   ```

2. Add StudentWithGrade interface:
   ```typescript
   // Student with optional grade assignment
   export interface StudentWithGrade {
     name: string;
     grade: GradeLevel | null;
   }
   ```

3. Extend SavedClass interface to include optional studentData:
   ```typescript
   export interface SavedClass {
     id: string;
     name: string;
     students: string[];           // Keep for backward compatibility
     studentData?: StudentWithGrade[]; // New: grade assignments (optional for migration)
     savedAt: string;
   }
   ```

The students[] array is kept for backward compatibility. studentData is optional so existing saved classes load without errors.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Grep types.ts for "GradeLevel" - should find the type definition.
  </verify>
  <done>
GradeLevel type exported, StudentWithGrade interface exported, SavedClass extended with optional studentData field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend useClassBank with grade support</name>
  <files>hooks/useClassBank.ts</files>
  <action>
Extend the useClassBank hook to support grade assignments:

1. Import the new types at the top:
   ```typescript
   import { SavedClass, GradeLevel, StudentWithGrade } from '../types';
   ```

2. Update isValidSavedClass to accept optional studentData:
   ```typescript
   // After validating students array, add optional studentData validation:
   if (obj.studentData !== undefined) {
     if (!Array.isArray(obj.studentData)) return false;
     if (!obj.studentData.every((s: unknown) => {
       if (typeof s !== 'object' || s === null) return false;
       const student = s as Record<string, unknown>;
       if (typeof student.name !== 'string') return false;
       if (student.grade !== null && !['A', 'B', 'C', 'D', 'E'].includes(student.grade as string)) return false;
       return true;
     })) return false;
   }
   ```

3. Update readClassesFromStorage to initialize studentData if missing (migration):
   After validation passes, before returning:
   ```typescript
   // Migrate classes without studentData
   return parsed.map((c: SavedClass) => {
     if (!c.studentData) {
       return {
         ...c,
         studentData: c.students.map(name => ({ name, grade: null })),
       };
     }
     return c;
   });
   ```

4. Update saveClass to maintain studentData sync:
   When creating newClass, include studentData:
   ```typescript
   const newClass: SavedClass = {
     id: existingIndex >= 0 ? prev[existingIndex].id : crypto.randomUUID(),
     name: trimmedName,
     students: [...students],
     studentData: students.map(name => {
       // Preserve existing grades if class exists
       const existingStudent = existingIndex >= 0
         ? prev[existingIndex].studentData?.find(s => s.name === name)
         : undefined;
       return { name, grade: existingStudent?.grade ?? null };
     }),
     savedAt: new Date().toISOString(),
   };
   ```

5. Update updateClassStudents to maintain studentData sync:
   ```typescript
   const updateClassStudents = useCallback((classId: string, students: string[]) => {
     setClasses(prev => prev.map(c => {
       if (c.id === classId) {
         return {
           ...c,
           students: [...students],
           studentData: students.map(name => {
             // Preserve existing grades
             const existingStudent = c.studentData?.find(s => s.name === name);
             return { name, grade: existingStudent?.grade ?? null };
           }),
           savedAt: new Date().toISOString(),
         };
       }
       return c;
     }));
   }, []);
   ```

6. Add updateStudentGrade function:
   ```typescript
   /**
    * Update the grade for a specific student in a class.
    */
   const updateStudentGrade = useCallback((classId: string, studentName: string, grade: GradeLevel | null) => {
     setClasses(prev => prev.map(c => {
       if (c.id === classId) {
         const updatedStudentData = (c.studentData || []).map(s => {
           if (s.name === studentName) {
             return { ...s, grade };
           }
           return s;
         });
         return {
           ...c,
           studentData: updatedStudentData,
           savedAt: new Date().toISOString(),
         };
       }
       return c;
     }));
   }, []);
   ```

7. Return updateStudentGrade from the hook:
   ```typescript
   return {
     classes,
     saveClass,
     deleteClass,
     getClassByName,
     refreshClasses,
     renameClass,
     updateClassStudents,
     updateStudentGrade,  // New
   };
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Run `npm run build` - should build successfully.
  </verify>
  <done>
useClassBank hook exports updateStudentGrade function. Existing classes without studentData are migrated on load. saveClass and updateClassStudents maintain studentData in sync with students array.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Build succeeds: `npm run build` completes without errors
3. Types exported: `grep -n "GradeLevel\|StudentWithGrade" types.ts` shows exports
4. Hook extended: `grep -n "updateStudentGrade" hooks/useClassBank.ts` shows function
</verification>

<success_criteria>
- GradeLevel type ('A' | 'B' | 'C' | 'D' | 'E') is defined and exported
- StudentWithGrade interface with name and optional grade is defined
- SavedClass has optional studentData field
- useClassBank provides updateStudentGrade(classId, studentName, grade) function
- Existing saved classes without grades load successfully (migration)
- TypeScript compiles and app builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-student-grades/15-01-SUMMARY.md`
</output>
