---
phase: 65-foundation-types-phase-detection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/phaseDetection/phasePatterns.ts
  - services/phaseDetection/phaseDetector.ts
  - services/phaseDetection/phaseDetector.test.ts
autonomous: true

must_haves:
  truths:
    - "LessonPhase type has exactly 6 values: hook, i-do, we-do, we-do-together, you-do, plenary"
    - "Slide interface has optional lessonPhase field"
    - "detectPhasesInText correctly identifies all 6 phases from UK/Australian terminology"
    - "detectPhasesInText returns empty phases array for text with no GRR terminology"
    - "assignPhasesToSlides assigns phases to slides based on detection results and positional heuristics"
    - "False positives are prevented -- 'I do not recommend' does not match I Do phase"
    - "We Do Together is matched before We Do (longer match first)"
  artifacts:
    - path: "types.ts"
      provides: "LessonPhase type and lessonPhase? field on Slide"
      contains: "LessonPhase"
    - path: "services/phaseDetection/phasePatterns.ts"
      provides: "Phase synonym dictionary with structural and content regex patterns"
      exports: ["PHASE_PATTERNS", "PHASE_DISPLAY_LABELS"]
    - path: "services/phaseDetection/phaseDetector.ts"
      provides: "Phase detection and slide assignment functions"
      exports: ["detectPhasesInText", "assignPhasesToSlides", "DetectedPhase", "PhaseDetectionResult"]
    - path: "services/phaseDetection/phaseDetector.test.ts"
      provides: "Unit tests for phase detection accuracy"
      min_lines: 80
  key_links:
    - from: "services/phaseDetection/phaseDetector.ts"
      to: "services/phaseDetection/phasePatterns.ts"
      via: "import PHASE_PATTERNS"
      pattern: "import.*PHASE_PATTERNS.*from.*phasePatterns"
    - from: "services/phaseDetection/phaseDetector.ts"
      to: "types.ts"
      via: "import LessonPhase, Slide"
      pattern: "import.*LessonPhase.*from"
---

<objective>
Create the LessonPhase type system and build the regex-based phase detection module with comprehensive UK/Australian teaching terminology support.

Purpose: This is the foundation for all phase-aware features in v5.0. The type and detection module must exist before generation wiring (Plan 02) can use them.
Output: LessonPhase type on Slide, phasePatterns.ts synonym dictionary, phaseDetector.ts with detectPhasesInText and assignPhasesToSlides, and a comprehensive test suite validating detection accuracy.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-foundation-types-phase-detection/65-RESEARCH.md
@types.ts
@services/contentPreservation/detector.ts
@services/contentPreservation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LessonPhase type and create phase patterns dictionary</name>
  <files>types.ts, services/phaseDetection/phasePatterns.ts</files>
  <action>
1. In `types.ts`, add the LessonPhase type AFTER the SlideSource type definition (around line 8):
```typescript
export type LessonPhase = 'hook' | 'i-do' | 'we-do' | 'we-do-together' | 'you-do' | 'plenary';
```

2. In `types.ts`, add `lessonPhase?: LessonPhase;` to the Slide interface, after the `originalPastedImage` field (end of the interface). Add a comment: `// Lesson phase label for pedagogically structured decks (Phase 65)`.

3. Create `services/phaseDetection/phasePatterns.ts` following the exact pattern from the research. This file exports:
   - `PHASE_PATTERNS: PhasePattern[]` -- array of 6 pattern objects, one per phase. Each has `phase: LessonPhase`, `structuralPatterns: RegExp[]` (start-of-line anchored patterns for headings/bullets), and `contentPatterns: RegExp[]` (patterns that appear in body text of a section).
   - `PHASE_DISPLAY_LABELS: Record<LessonPhase, string>` -- mapping phase IDs to human-readable display labels (e.g., `'hook': 'Hook / Starter'`, `'i-do': 'I Do (Modelling)'`, etc.)
   - The `PhasePattern` interface itself.

CRITICAL for structural patterns:
- All structural patterns MUST be anchored to line start: `^[\s*\-#]*` prefix to handle headings, bullets, dashes
- All structural patterns MUST require a delimiter after the keyword: `[:\-\u2013\u2014\n]` (colon, dash, em-dash, or newline)
- Use `m` flag on all structural regexes for multiline matching
- "I Do" must use case-sensitive matching in the structural regex to avoid false positives from "I do not"
- Match "We Do Together" patterns BEFORE "We Do" patterns (order PHASE_PATTERNS array as: hook, i-do, we-do-together, we-do, you-do, plenary -- NOT the display order)

Use the exact synonym lists from the research Phase Taxonomy table. Structural patterns include all the heading-level terms. Content patterns include the body-text indicators.
  </action>
  <verify>
- `npx tsc --noEmit` passes (types compile correctly)
- Verify LessonPhase type has exactly 6 members
- Verify Slide interface includes lessonPhase optional field
- Verify PHASE_PATTERNS has 6 entries with we-do-together BEFORE we-do in array order
  </verify>
  <done>LessonPhase type exists on Slide, PHASE_PATTERNS dictionary covers all 6 phases with UK/Australian synonyms, PHASE_DISPLAY_LABELS maps all 6 phases to display names</done>
</task>

<task type="auto">
  <name>Task 2: Build phase detector module with TDD</name>
  <files>services/phaseDetection/phaseDetector.ts, services/phaseDetection/phaseDetector.test.ts</files>
  <action>
Follow RED-GREEN-REFACTOR for the phase detector module.

**RED: Write failing tests first** in `services/phaseDetection/phaseDetector.test.ts`:

Test cases for `detectPhasesInText(text: string): PhaseDetectionResult`:
1. Empty text returns `{ phases: [], hasExplicitPhases: false }`
2. Text with "Hook:" at line start detects hook phase with high confidence
3. Text with "Modelled Practice:" detects i-do phase
4. Text with "Guided Practice:" detects we-do phase
5. Text with "Partner Work:" detects we-do-together phase (NOT we-do)
6. Text with "Independent Practice:" detects you-do phase
7. Text with "Plenary:" detects plenary phase
8. Full lesson plan with multiple phases detects all in order, `hasExplicitPhases: true`
9. "I do not recommend" does NOT match i-do phase (false positive prevention)
10. "We do this every day" does NOT match we-do phase (false positive prevention)
11. Text with no GRR terms returns `hasExplicitPhases: false`
12. Australian terms work: "Tuning In:" matches hook, "Explicit Teaching:" matches i-do

Test cases for `assignPhasesToSlides(slides: Slide[], detectedPhases: PhaseDetectionResult): Slide[]`:
13. When hasExplicitPhases is true and 6+ slides, assigns detected phases to slides based on position mapping
14. When hasExplicitPhases is false and 5+ slides, applies positional heuristics (first slide = hook, last = plenary)
15. When hasExplicitPhases is false and <5 slides, returns slides with undefined lessonPhase
16. Slides that already have lessonPhase set are not overwritten
17. Returns new slide objects (does not mutate input)

Use `import { describe, it, expect } from '@jest/globals';` for ESM compatibility.

**GREEN: Implement `services/phaseDetection/phaseDetector.ts`:**

Exports:
- `DetectedPhase` interface: `{ phase: LessonPhase, startPosition: number, endPosition: number, matchedKeyword: string, confidence: 'high' | 'medium' }`
- `PhaseDetectionResult` interface: `{ phases: DetectedPhase[], hasExplicitPhases: boolean }`
- `detectPhasesInText(text: string): PhaseDetectionResult` -- iterates PHASE_PATTERNS, runs structural patterns first (high confidence), then content patterns (medium confidence). Deduplicates overlapping detections (same character range). Sets `hasExplicitPhases = true` if any structural pattern matched.
- `assignPhasesToSlides(slides: Slide[], detectedPhases: PhaseDetectionResult): Slide[]`:
  - If `detectedPhases.hasExplicitPhases`: Map detected phase boundaries to slide indices proportionally (phase at 30% of text -> assign to slide at ~30% of deck). Each slide gets the phase whose boundary it falls within.
  - If NOT `hasExplicitPhases` and `slides.length >= 5`: Apply positional heuristics only:
    - First slide: hook
    - Second slide: i-do
    - Middle slides (indices 2 through n-2): distribute we-do, we-do-together, you-do proportionally
    - Last slide: plenary
  - If NOT `hasExplicitPhases` and `slides.length < 5`: Return slides unchanged (no phase assignment)
  - Never overwrite an existing `lessonPhase` value on a slide
  - Return NEW slide objects (spread operator), never mutate

Follow the same pure-function, deterministic pattern as `contentPreservation/detector.ts`. No side effects, no AI calls.

**REFACTOR:** Clean up if needed, ensure all tests pass.
  </action>
  <verify>
- `npm test -- --testPathPattern=phaseDetector` -- all tests pass
- `npx tsc --noEmit` -- no type errors
  </verify>
  <done>Phase detector correctly identifies all 6 phases from UK/Australian terminology, prevents false positives from casual English, assigns phases to slides via both explicit detection and positional heuristics, all unit tests pass</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full project compiles without errors
2. `npm test -- --testPathPattern=phaseDetector` -- all phase detection tests pass
3. Existing tests still pass: `npm test` (no regressions)
4. Manual check: `lessonPhase` field appears on Slide interface in types.ts
5. Manual check: PHASE_PATTERNS array has 6 entries covering all required synonyms
</verification>

<success_criteria>
- LessonPhase type with 6 values exists in types.ts
- Slide interface has optional lessonPhase field
- phasePatterns.ts has comprehensive UK/Australian synonym dictionary
- phaseDetector.ts exports detectPhasesInText and assignPhasesToSlides
- All unit tests pass with zero false positives on casual English
- Existing codebase compiles and tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/65-foundation-types-phase-detection/65-01-SUMMARY.md`
</output>
