---
phase: 58-deck-cohesion
plan: 03
type: execute
wave: 2
depends_on: ["58-01"]
files_modified:
  - components/CohesionPreview.tsx
  - App.tsx
autonomous: false

must_haves:
  truths:
    - "Make Cohesive button appears in editor top bar when deck has 2+ slides"
    - "Clicking Make Cohesive triggers AI analysis with loading indicator"
    - "Preview modal shows proposed changes with visual diff for each affected slide"
    - "User can click Apply All to apply changes or Cancel to discard"
    - "Applied changes update slide content via handleUpdateSlide"
    - "Button is disabled when no API key is configured"
  artifacts:
    - path: "components/CohesionPreview.tsx"
      provides: "Modal component showing cohesion changes with diff view, Apply All and Cancel buttons"
      min_lines: 80
    - path: "App.tsx"
      provides: "Make Cohesive button in top bar, handleMakeCohesive handler, handleApplyCohesion handler, CohesionPreview integration"
      contains: "handleMakeCohesive"
  key_links:
    - from: "App.tsx"
      to: "services/aiProvider.ts"
      via: "provider.makeDeckCohesive call"
      pattern: "provider.*makeDeckCohesive"
    - from: "App.tsx"
      to: "components/CohesionPreview.tsx"
      via: "import and render CohesionPreview component"
      pattern: "CohesionPreview"
    - from: "components/CohesionPreview.tsx"
      to: "services/aiProvider.ts"
      via: "CohesionResult type for props"
      pattern: "CohesionResult"
---

<objective>
Create the CohesionPreview modal component and integrate the full cohesion flow into App.tsx: button, AI call, preview, apply/cancel.

Purpose: Delivers COHE-01 (Make Cohesive button), COHE-02 (AI analysis trigger), COHE-03 (preview with diff), and COHE-04 (apply/cancel). This is the user-facing feature that ties the AI backend to the UI.

Output: New CohesionPreview.tsx component and updated App.tsx with full cohesion workflow.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-deck-cohesion/58-RESEARCH.md
@.planning/phases/58-deck-cohesion/58-01-SUMMARY.md

Key reference files:
@App.tsx — Top bar at line ~2050, handleUpdateSlide at line ~602, provider/addToast/isDarkMode/deckVerbosity patterns
@components/EnhancementPanel.tsx — ReactDiffViewer usage pattern (lines ~310-320)
@components/PasteComparison.tsx — Preview/action modal pattern
@services/aiProvider.ts — CohesionResult, CohesionChange types, withRetry, AIProviderError
@types.ts — Slide interface
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CohesionPreview.tsx modal component</name>
  <files>components/CohesionPreview.tsx</files>
  <action>
Create a NEW file `components/CohesionPreview.tsx` — a modal overlay that displays proposed cohesion changes with visual diffs and Apply All / Cancel buttons.

**Props interface:**
```typescript
interface CohesionPreviewProps {
  result: CohesionResult;
  onApply: () => void;
  onCancel: () => void;
  isDarkMode: boolean;
}
```

**Component structure:**

1. **Backdrop** — fixed full-screen overlay with semi-transparent background (same pattern as other modals in the codebase: `fixed inset-0 z-50 bg-black/50 flex items-center justify-center`).

2. **Modal container** — white/dark rounded card, max-width ~4xl, max-height ~90vh with overflow-y-auto. Style: `bg-white dark:bg-slate-900 rounded-2xl shadow-2xl`.

3. **Header section** — shows:
   - Title: "Deck Cohesion Preview"
   - Summary banner: `result.summary` in a highlighted box
   - Stats line: "{N} of {total} slides will be updated" and "Tone: {result.toneDescription}"

4. **Changes list** — for each `change` in `result.changes`:
   - **Slide header**: "Slide {change.slideIndex + 1}: {change.originalTitle}" with a reason badge showing `change.reason`
   - **Expandable diff sections** (default expanded):
     - **Title diff** (only if `change.proposedTitle` exists): Show ReactDiffViewer comparing `change.originalTitle` vs `change.proposedTitle`
     - **Content diff** (only if `change.proposedContent` exists): Show ReactDiffViewer comparing `change.originalContent.join('\n')` vs `change.proposedContent.join('\n')`
     - **Speaker Notes diff** (only if `change.proposedSpeakerNotes` exists): Show ReactDiffViewer comparing `change.originalSpeakerNotes` vs `change.proposedSpeakerNotes`
   - Use collapse/expand toggle per slide (useState tracking expanded slide indices, default all expanded)

5. **ReactDiffViewer usage** — follow the exact pattern from EnhancementPanel.tsx:
```typescript
import ReactDiffViewer, { DiffMethod } from 'react-diff-viewer-continued';

<ReactDiffViewer
  oldValue={originalText}
  newValue={proposedText}
  splitView={false}
  useDarkTheme={isDarkMode}
  compareMethod={DiffMethod.WORDS}
  hideLineNumbers={true}
  showDiffOnly={false}
  styles={{
    variables: {
      dark: {
        diffViewerBackground: '#1e293b',
        addedBackground: '#064e3b22',
        removedBackground: '#7f1d1d22',
        wordAddedBackground: '#059669',
        wordRemovedBackground: '#dc2626',
      }
    }
  }}
/>
```

6. **Footer** — sticky at bottom with two buttons:
   - "Cancel" (secondary, left) — calls `onCancel`
   - "Apply All Changes" (primary, right) — calls `onApply`
   - Style: `flex justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-800`

7. **Empty state** — if `result.changes.length === 0`, show a friendly message: "Your deck is already cohesive! No changes needed." with just a Close button.

**Styling notes:**
- Follow project theme: indigo primary in light mode, amber in dark mode
- Reason badges: small rounded pill with subtle background
- Each diff section gets a label ("Title", "Content", "Speaker Notes") in small caps
- Diff sections have a rounded container with border for visual separation

**Import:** React, ReactDiffViewer/DiffMethod, CohesionResult from '../services/aiProvider'
  </action>
  <verify>
Run `npx tsc --noEmit` — file compiles with no errors. Component renders conditionally based on CohesionResult content.
  </verify>
  <done>CohesionPreview.tsx exists as a modal with summary, per-slide diff views (title/content/speakerNotes), Apply All and Cancel buttons, and empty-state handling.</done>
</task>

<task type="auto">
  <name>Task 2: Add Make Cohesive button and cohesion flow to App.tsx</name>
  <files>App.tsx</files>
  <action>
**1. Add imports at top of App.tsx:**
```typescript
import CohesionPreview from './components/CohesionPreview';
import { CohesionResult } from './services/aiProvider';
import { withRetry } from './services/aiProvider';  // if not already imported
```

**2. Add state variables** (near other state declarations around line ~320-360):
```typescript
const [isProcessingCohesion, setIsProcessingCohesion] = useState(false);
const [cohesionResult, setCohesionResult] = useState<CohesionResult | null>(null);
```

**3. Add `handleMakeCohesive` handler** (near other handler functions):
```typescript
const handleMakeCohesive = useCallback(async () => {
  if (!provider || slides.length < 2) return;

  setIsProcessingCohesion(true);
  try {
    const result = await withRetry(() =>
      provider.makeDeckCohesive(slides, 'Year 6 (10-11 years old)', deckVerbosity)
    );

    if (result.changes.length === 0) {
      addToast('Your deck is already cohesive! No changes needed.', 3000, 'success');
    } else {
      setCohesionResult(result);
    }
  } catch (error: any) {
    const message = error?.userMessage || error?.message || 'Failed to analyze deck';
    addToast(message, 5000, 'error');
  } finally {
    setIsProcessingCohesion(false);
  }
}, [provider, slides, deckVerbosity, addToast]);
```

**4. Add `handleApplyCohesion` handler:**
```typescript
const handleApplyCohesion = useCallback(() => {
  if (!cohesionResult) return;

  for (const change of cohesionResult.changes) {
    const updates: Partial<Slide> = {};
    if (change.proposedTitle) updates.title = change.proposedTitle;
    if (change.proposedContent) updates.content = change.proposedContent;
    if (change.proposedSpeakerNotes) updates.speakerNotes = change.proposedSpeakerNotes;

    handleUpdateSlide(change.slideId, updates);
  }

  addToast(
    `Cohesion applied to ${cohesionResult.changes.length} slide${cohesionResult.changes.length === 1 ? '' : 's'}`,
    3000,
    'success'
  );
  setCohesionResult(null);
}, [cohesionResult, handleUpdateSlide, addToast]);
```

**5. Add `handleCancelCohesion` handler:**
```typescript
const handleCancelCohesion = useCallback(() => {
  setCohesionResult(null);
}, []);
```

**6. Add "Make Cohesive" button to the top bar** — inside the `{appState === AppState.EDITING && (` block, in the top bar div (around line ~2051). Place it AFTER the slide selection controls div closing `</div>` (after the "Export for Working Wall" button) and before the top bar's closing `</div>`.

Add a spacer + button:
```tsx
{/* Make Cohesive Button — right-aligned, separate from selection controls */}
{slides.length >= 2 && (
  <div className="ml-auto flex items-center gap-2">
    <button
      onClick={handleMakeCohesive}
      disabled={!provider || isProcessingCohesion}
      className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-bold transition-all ${
        !provider || isProcessingCohesion
          ? 'bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-500 cursor-not-allowed'
          : 'bg-gradient-to-r from-purple-600 to-indigo-600 dark:from-amber-500 dark:to-orange-500 text-white dark:text-slate-900 hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]'
      }`}
    >
      {isProcessingCohesion ? (
        <>
          <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
          </svg>
          <span>Analyzing deck...</span>
        </>
      ) : (
        <>
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span>Make Cohesive</span>
        </>
      )}
    </button>
  </div>
)}
```

**7. Render CohesionPreview modal** — add just before the closing of the EDITING block (before `</div>` that closes the main editing container), alongside other modals:

```tsx
{/* Cohesion Preview Modal */}
{cohesionResult && (
  <CohesionPreview
    result={cohesionResult}
    onApply={handleApplyCohesion}
    onCancel={handleCancelCohesion}
    isDarkMode={document.documentElement.classList.contains('dark')}
  />
)}
```

**Key details:**
- Button uses gradient styling (purple-to-indigo light / amber-to-orange dark) to visually distinguish it as an AI deck-wide operation
- Disabled when no provider or while processing
- The cohesion icon is a "sync/refresh" arrow icon (suggestive of harmonization)
- `withRetry` wraps the provider call for transient error resilience
- `handleApplyCohesion` does NOT overwrite `slide.source` — it only updates title/content/speakerNotes via handleUpdateSlide's Partial<Slide> merge
- The modal is rendered inside the EDITING block but uses fixed positioning so it overlays everything
  </action>
  <verify>
Run `npx tsc --noEmit` — file compiles. Verify "Make Cohesive" button renders in top bar JSX. Verify CohesionPreview is imported and rendered conditionally on cohesionResult state.
  </verify>
  <done>"Make Cohesive" button in top bar (visible when 2+ slides), AI call with loading state, preview modal with diff, Apply All updates slides, Cancel discards.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Full deck cohesion workflow:
1. "Make Cohesive" button in editor top bar (visible with 2+ slides)
2. AI analyzes entire deck for tone/flow consistency
3. Preview modal shows proposed changes with visual diffs per slide
4. Apply All updates slides; Cancel discards changes
  </what-built>
  <how-to-verify>
1. Open the app at https://localhost:3000 (or dev server URL)
2. Create or load a presentation with 3+ slides (mix of AI-generated and manually edited for best results)
3. Verify the "Make Cohesive" button appears in the editor top bar (right side)
4. Click "Make Cohesive" — verify spinner shows while AI is working
5. When preview modal appears:
   - Verify summary banner shows at top
   - Verify each changed slide shows with reason and diff view(s)
   - Verify diffs clearly show word-level changes (green = added, red = removed)
   - Toggle dark mode and verify diffs still look correct
6. Click "Cancel" — verify no changes were applied to slides
7. Click "Make Cohesive" again, then click "Apply All Changes"
8. Verify slides are updated with the proposed content
9. Verify toast confirms "Cohesion applied to N slides"
10. If deck has only 1 slide, verify button is NOT visible
11. If no API key, verify button is disabled
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. "Make Cohesive" button is visible in top bar when deck has 2+ slides
3. Button is disabled when no provider (no API key) or during processing
4. Clicking button shows loading spinner, then opens CohesionPreview modal
5. Modal shows summary, tone description, and per-slide diff views
6. "Apply All" applies changes via handleUpdateSlide (does NOT overwrite source field)
7. "Cancel" closes modal without changes
8. Empty result (0 changes) shows toast instead of modal
9. Error during AI call shows error toast
10. Dark mode styling works correctly
</verification>

<success_criteria>
- COHE-01: "Make Cohesive" button visible in editor toolbar when deck has 2+ slides
- COHE-02: AI analyzes entire deck with progress indicator (spinner on button)
- COHE-03: Preview panel shows proposed changes with visual diff for each affected slide
- COHE-04: User can apply all or cancel cohesion changes
- All four phase requirements delivered and verified
</success_criteria>

<output>
After completion, create `.planning/phases/58-deck-cohesion/58-03-SUMMARY.md`
</output>
