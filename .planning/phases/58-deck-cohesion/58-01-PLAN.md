---
phase: 58-deck-cohesion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/prompts/cohesionPrompts.ts
  - services/aiProvider.ts
  - services/providers/geminiProvider.ts
autonomous: true

must_haves:
  truths:
    - "CohesionResult and CohesionChange types are exported from aiProvider.ts"
    - "makeDeckCohesive method is declared on AIProviderInterface"
    - "Gemini provider implements makeDeckCohesive with structured responseSchema"
    - "Cohesion prompt includes teleprompter segment rules and pasted-image handling"
  artifacts:
    - path: "services/prompts/cohesionPrompts.ts"
      provides: "System prompt, Gemini responseSchema, Claude tool schema, deck serializer"
      min_lines: 80
    - path: "services/aiProvider.ts"
      provides: "CohesionResult type, CohesionChange type, makeDeckCohesive on interface"
      exports: ["CohesionResult", "CohesionChange"]
    - path: "services/providers/geminiProvider.ts"
      provides: "makeDeckCohesive implementation using structured output"
      contains: "makeDeckCohesive"
  key_links:
    - from: "services/providers/geminiProvider.ts"
      to: "services/prompts/cohesionPrompts.ts"
      via: "import COHESION_SYSTEM_PROMPT, COHESION_RESPONSE_SCHEMA, buildDeckContextForCohesion"
      pattern: "import.*cohesionPrompts"
    - from: "services/aiProvider.ts"
      to: "services/prompts/cohesionPrompts.ts"
      via: "re-export or import CohesionResult type"
      pattern: "CohesionResult"
---

<objective>
Create the cohesion AI infrastructure: prompts, schemas, types, and Gemini provider implementation.

Purpose: Provides the AI backend that analyzes an entire deck and proposes text harmonization changes. This is the foundation that both the Claude provider (Plan 02) and the UI (Plan 03) depend on.

Output: New `cohesionPrompts.ts` file with dual schemas, updated `aiProvider.ts` with types and interface method, and working Gemini `makeDeckCohesive` implementation.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-deck-cohesion/58-RESEARCH.md

Key reference files:
@services/slideAnalysis/slideAnalysisPrompts.ts — Dual-schema pattern (Gemini Type + Claude tool) to follow exactly
@services/aiProvider.ts — AIProviderInterface, CohesionResult/CohesionChange types go here, VerbosityLevel re-export
@services/providers/geminiProvider.ts — Add makeDeckCohesive method following analyzePastedSlide pattern
@types.ts — Slide interface (especially source, originalPastedImage, content, speakerNotes fields)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cohesionPrompts.ts with system prompt and dual schemas</name>
  <files>services/prompts/cohesionPrompts.ts</files>
  <action>
Create a NEW file `services/prompts/cohesionPrompts.ts` following the exact dual-schema pattern from `services/slideAnalysis/slideAnalysisPrompts.ts`.

**1. System Prompt (`COHESION_SYSTEM_PROMPT`)**

Export a system prompt string for deck cohesion. Content must include:
- Role: Expert educational content editor for Cue (Year 6, ages 10-11)
- Task: Analyze entire deck, propose changes for tone/flow/terminology consistency
- Rules:
  - Only propose changes for slides that NEED them; skip slides that already fit
  - Preserve educational content (never remove key concepts)
  - Maintain each slide's structure (same number of bullets)
  - For slides marked as `[pasted-image]`, ONLY modify speakerNotes (content is hidden behind full-screen image)
  - Do NOT change layout, theme, or trigger image regeneration
- Teleprompter rules (CRITICAL):
  - Use the pointing right hand emoji (Unicode \u{1F449}) as delimiter between segments
  - Segment count MUST equal number of bullets + 1
  - Segment 0 = intro before any bullet appears
  - Each subsequent segment explains the bullet that was JUST revealed
  - NEVER repeat slide text in speaker notes
  - NEVER preview upcoming bullets
- Verbosity awareness: Include a placeholder `{VERBOSITY_RULES}` that the user prompt builder will fill

**2. User Prompt Builder (`buildCohesionUserPrompt`)**

Export a function `buildCohesionUserPrompt(verbosity: VerbosityLevel, gradeLevel: string): string` that returns the user-facing instruction. Include verbosity-specific hints:
- concise: "Keep speaker notes brief: 2-3 short phrases per segment"
- standard: "Use 1-2 sentences per segment with examples"
- detailed: "Provide 3-5 sentences per segment with transitions and interaction prompts"

Include the grade level in the prompt.

**3. Deck Serializer (`buildDeckContextForCohesion`)**

Export a function `buildDeckContextForCohesion(slides: Slide[]): string` that:
- Caps at 20 slides (as per research)
- For each slide, outputs a compact block:
  ```
  --- Slide {i+1} [{source}] ---
  Title: {slide.title}
  Content: {slide.content.join(' | ')}
  Speaker Notes (first 200 chars): {truncated}
  Layout: {slide.layout || 'split'}
  Bullet count: {slide.content.length}
  ```
- Marks slides with `originalPastedImage` as `[pasted-image]` source type
- Returns the full serialized string

**4. Gemini Response Schema (`COHESION_RESPONSE_SCHEMA`)**

Export using `Type` from `@google/genai` (same import pattern as slideAnalysisPrompts.ts):
```typescript
{
  type: Type.OBJECT,
  properties: {
    summary: { type: Type.STRING },
    toneDescription: { type: Type.STRING },
    changes: {
      type: Type.ARRAY,
      items: {
        type: Type.OBJECT,
        properties: {
          slideIndex: { type: Type.NUMBER },
          proposedTitle: { type: Type.STRING },
          proposedContent: { type: Type.ARRAY, items: { type: Type.STRING } },
          proposedSpeakerNotes: { type: Type.STRING },
          reason: { type: Type.STRING }
        },
        required: ['slideIndex', 'reason']
      }
    }
  },
  required: ['summary', 'toneDescription', 'changes']
}
```

**5. Claude Tool Schema (`COHESION_TOOL`)**

Export following the same pattern as `SLIDE_CREATION_TOOL` and `IMAGE_CAPTION_TOOL`:
```typescript
{
  name: 'propose_cohesion_changes',
  description: 'Propose changes to make a slide deck cohesive in tone and flow',
  input_schema: {
    type: 'object' as const,
    properties: { /* same fields as Gemini schema but using JSON Schema types */ },
    required: ['summary', 'toneDescription', 'changes']
  }
}
```

**Import:** `import { Type } from '@google/genai';` and `import { Slide } from '../../types';` and `import { VerbosityLevel } from '../geminiService';`
  </action>
  <verify>
Run `npx tsc --noEmit` — file compiles with no errors. Verify the file exports: COHESION_SYSTEM_PROMPT, buildCohesionUserPrompt, buildDeckContextForCohesion, COHESION_RESPONSE_SCHEMA, COHESION_TOOL.
  </verify>
  <done>cohesionPrompts.ts exists with system prompt, user prompt builder, deck serializer, Gemini schema, and Claude tool schema. All exports are importable.</done>
</task>

<task type="auto">
  <name>Task 2: Add CohesionResult types and interface method, then implement Gemini makeDeckCohesive</name>
  <files>services/aiProvider.ts, services/providers/geminiProvider.ts</files>
  <action>
**Part A: Update `services/aiProvider.ts`**

1. Add new types BEFORE the AIProviderInterface declaration:

```typescript
// Cohesion types for deck-wide harmonization (Phase 58)
export interface CohesionChange {
  slideIndex: number;           // 0-indexed position in deck
  slideId: string;              // For applying via handleUpdateSlide
  originalTitle: string;        // For diff display
  proposedTitle?: string;       // Only if title changes
  originalContent: string[];    // For diff display
  proposedContent?: string[];   // Only if content changes
  originalSpeakerNotes: string; // For diff display
  proposedSpeakerNotes?: string;// Only if notes change
  reason: string;               // Why this slide was changed
}

export interface CohesionResult {
  changes: CohesionChange[];
  summary: string;              // Overall description of harmonization
  toneDescription: string;      // The unified tone applied
}
```

2. Add method to `AIProviderInterface` (after `analyzeImage`):

```typescript
  // Analyze entire deck and propose cohesion changes (Phase 58)
  makeDeckCohesive(
    slides: Slide[],
    gradeLevel: string,
    verbosity: VerbosityLevel
  ): Promise<CohesionResult>;
```

**Part B: Implement in `services/providers/geminiProvider.ts`**

1. Add import at top:
```typescript
import { COHESION_SYSTEM_PROMPT, buildCohesionUserPrompt, buildDeckContextForCohesion, COHESION_RESPONSE_SCHEMA } from '../prompts/cohesionPrompts';
```
Also import `CohesionResult` from `'../aiProvider'`.

2. Add `makeDeckCohesive` method to the GeminiProvider class (after `analyzeImage`):

```typescript
async makeDeckCohesive(
  slides: Slide[],
  gradeLevel: string,
  verbosity: VerbosityLevel
): Promise<CohesionResult> {
  try {
    const ai = new GoogleGenAI({ apiKey: this.apiKey });
    const deckContext = buildDeckContextForCohesion(slides);
    const userPrompt = buildCohesionUserPrompt(verbosity, gradeLevel);

    const response = await ai.models.generateContent({
      model: this.model,
      contents: `${userPrompt}\n\nDECK TO ANALYZE:\n\n${deckContext}`,
      config: {
        systemInstruction: COHESION_SYSTEM_PROMPT,
        responseMimeType: 'application/json',
        responseSchema: COHESION_RESPONSE_SCHEMA,
        temperature: 0.7
      }
    });

    const text = response.text || '{}';
    const parsed = JSON.parse(text);

    // Enrich AI response with original slide data for diff display
    const changes = (parsed.changes || []).map((change: any) => {
      const slide = slides[change.slideIndex];
      if (!slide) return null;
      return {
        slideIndex: change.slideIndex,
        slideId: slide.id,
        originalTitle: slide.title,
        proposedTitle: change.proposedTitle || undefined,
        originalContent: [...slide.content],
        proposedContent: change.proposedContent || undefined,
        originalSpeakerNotes: slide.speakerNotes,
        proposedSpeakerNotes: change.proposedSpeakerNotes || undefined,
        reason: change.reason || 'Tone consistency'
      };
    }).filter(Boolean);

    return {
      changes,
      summary: parsed.summary || 'Deck cohesion analysis complete',
      toneDescription: parsed.toneDescription || ''
    };
  } catch (error) {
    console.error('[GeminiProvider] makeDeckCohesive error:', error);
    throw this.wrapError(error);
  }
}
```

**Key details:**
- The AI returns `slideIndex` only (0-indexed). The provider enriches with `slideId` and original field values from the actual slides array for diff display.
- `proposedTitle`, `proposedContent`, `proposedSpeakerNotes` are optional -- AI only returns them if changed.
- Filter out any changes referencing invalid slide indices.
- Use `this.wrapError(error)` for consistent error handling (same pattern as analyzePastedSlide).
  </action>
  <verify>
Run `npx tsc --noEmit` — both files compile. Verify `CohesionResult` and `CohesionChange` are exported from aiProvider.ts. Verify `makeDeckCohesive` exists on GeminiProvider class.
  </verify>
  <done>CohesionResult/CohesionChange types exported. AIProviderInterface has makeDeckCohesive method. GeminiProvider implements it with structured responseSchema and original-data enrichment.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `services/prompts/cohesionPrompts.ts` exports COHESION_SYSTEM_PROMPT, buildCohesionUserPrompt, buildDeckContextForCohesion, COHESION_RESPONSE_SCHEMA, COHESION_TOOL
3. `services/aiProvider.ts` exports CohesionResult and CohesionChange types
4. AIProviderInterface now has `makeDeckCohesive(slides, gradeLevel, verbosity)` method
5. GeminiProvider.makeDeckCohesive uses responseSchema pattern (not free-text JSON)
6. Cohesion prompt includes teleprompter rules (segment count, emoji delimiter, no preview)
7. Cohesion prompt marks pasted-image slides as teleprompter-only
8. Deck serializer caps at 20 slides with truncated speaker notes
</verification>

<success_criteria>
- New cohesionPrompts.ts file with dual schemas (Gemini Type + Claude tool) following slideAnalysisPrompts.ts pattern
- CohesionResult type with changes array, summary, toneDescription
- CohesionChange type with slideIndex, slideId, original/proposed fields, reason
- makeDeckCohesive declared on AIProviderInterface
- GeminiProvider.makeDeckCohesive returns enriched CohesionResult with original data for diff
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/58-deck-cohesion/58-01-SUMMARY.md`
</output>
