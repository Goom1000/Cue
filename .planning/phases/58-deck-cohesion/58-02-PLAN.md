---
phase: 58-deck-cohesion
plan: 02
type: execute
wave: 2
depends_on: ["58-01"]
files_modified:
  - services/providers/claudeProvider.ts
autonomous: true

must_haves:
  truths:
    - "Claude provider implements makeDeckCohesive matching the AIProviderInterface"
    - "Claude uses tool_choice with COHESION_TOOL for structured output"
    - "Claude enriches AI response with original slide data for diff display"
  artifacts:
    - path: "services/providers/claudeProvider.ts"
      provides: "makeDeckCohesive implementation using Claude tool_choice"
      contains: "makeDeckCohesive"
  key_links:
    - from: "services/providers/claudeProvider.ts"
      to: "services/prompts/cohesionPrompts.ts"
      via: "import COHESION_SYSTEM_PROMPT, COHESION_TOOL, buildCohesionUserPrompt, buildDeckContextForCohesion"
      pattern: "import.*cohesionPrompts"
---

<objective>
Implement the Claude provider's `makeDeckCohesive` method, completing dual-provider support for deck cohesion.

Purpose: Ensures the cohesion feature works with both AI providers (Gemini and Claude), matching the dual-provider pattern used throughout the codebase.

Output: Working `makeDeckCohesive` on ClaudeProvider that produces the same `CohesionResult` shape as Gemini.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-deck-cohesion/58-RESEARCH.md
@.planning/phases/58-deck-cohesion/58-01-SUMMARY.md

Key reference files:
@services/providers/claudeProvider.ts — Add method following analyzePastedSlide/analyzeImage pattern (fetch + tool_choice)
@services/prompts/cohesionPrompts.ts — Import COHESION_SYSTEM_PROMPT, COHESION_TOOL, buildCohesionUserPrompt, buildDeckContextForCohesion (created in Plan 01)
@services/aiProvider.ts — CohesionResult type (created in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ClaudeProvider.makeDeckCohesive</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
**1. Add imports at top of file:**

```typescript
import { COHESION_SYSTEM_PROMPT, COHESION_TOOL, buildCohesionUserPrompt, buildDeckContextForCohesion } from '../prompts/cohesionPrompts';
```

Also add `CohesionResult` to the existing import from `'../aiProvider'`.

**2. Add `makeDeckCohesive` method to the ClaudeProvider class.**

Follow the exact pattern used by `analyzePastedSlide` (lines ~1663-1729) — direct fetch to `https://api.anthropic.com/v1/messages` with tool_choice.

```typescript
async makeDeckCohesive(
  slides: Slide[],
  gradeLevel: string,
  verbosity: VerbosityLevel
): Promise<CohesionResult> {
  try {
    const deckContext = buildDeckContextForCohesion(slides);
    const userPrompt = buildCohesionUserPrompt(verbosity, gradeLevel);

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': this.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: this.model,
        max_tokens: 8192,
        system: COHESION_SYSTEM_PROMPT,
        tools: [COHESION_TOOL],
        tool_choice: { type: 'tool', name: 'propose_cohesion_changes' },
        messages: [{
          role: 'user',
          content: `${userPrompt}\n\nDECK TO ANALYZE:\n\n${deckContext}`
        }]
      })
    });

    if (!response.ok) {
      const errorText = await response.text().catch(() => 'Unknown error');
      throw new AIProviderError(
        USER_ERROR_MESSAGES[this.getErrorCode(response.status)],
        this.getErrorCode(response.status),
        errorText
      );
    }

    const data = await response.json();

    // Extract tool use result
    const toolUse = data.content?.find((c: any) => c.type === 'tool_use');
    if (!toolUse?.input) {
      throw new AIProviderError(
        USER_ERROR_MESSAGES.PARSE_ERROR,
        'PARSE_ERROR',
        'No tool result in cohesion response'
      );
    }

    const result = toolUse.input;

    // Enrich AI response with original slide data for diff display
    const changes = (result.changes || []).map((change: any) => {
      const slide = slides[change.slideIndex];
      if (!slide) return null;
      return {
        slideIndex: change.slideIndex,
        slideId: slide.id,
        originalTitle: slide.title,
        proposedTitle: change.proposedTitle || undefined,
        originalContent: [...slide.content],
        proposedContent: change.proposedContent || undefined,
        originalSpeakerNotes: slide.speakerNotes,
        proposedSpeakerNotes: change.proposedSpeakerNotes || undefined,
        reason: change.reason || 'Tone consistency'
      };
    }).filter(Boolean);

    return {
      changes,
      summary: result.summary || 'Deck cohesion analysis complete',
      toneDescription: result.toneDescription || ''
    };
  } catch (error) {
    if (error instanceof AIProviderError) {
      throw error;
    }
    console.error('[ClaudeProvider] makeDeckCohesive error:', error);
    throw new AIProviderError(
      USER_ERROR_MESSAGES.UNKNOWN_ERROR,
      'UNKNOWN_ERROR',
      error
    );
  }
}
```

**Key details:**
- `max_tokens: 8192` — generous for a full deck cohesion response (same ballpark as document enhancement)
- Uses `tool_choice: { type: 'tool', name: 'propose_cohesion_changes' }` to force structured output (same as analyzePastedSlide uses SLIDE_CREATION_TOOL)
- Error handling follows the exact Claude pattern: re-throw AIProviderError, wrap unknown errors
- Enrichment logic is identical to Gemini provider: map AI slideIndex to actual slide IDs and original content
- The `this.getErrorCode(response.status)` method already exists on ClaudeProvider
  </action>
  <verify>
Run `npx tsc --noEmit` — file compiles. Verify `makeDeckCohesive` exists on ClaudeProvider. Verify it imports from cohesionPrompts.ts and uses COHESION_TOOL.
  </verify>
  <done>ClaudeProvider.makeDeckCohesive implemented with tool_choice pattern, returning enriched CohesionResult matching Gemini provider output shape.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. ClaudeProvider.makeDeckCohesive exists and matches AIProviderInterface signature
3. Method uses `tool_choice: { type: 'tool', name: 'propose_cohesion_changes' }` for structured output
4. Method enriches AI response with slideId, originalTitle, originalContent, originalSpeakerNotes
5. Error handling follows existing Claude pattern (re-throw AIProviderError, wrap unknowns)
6. Import of COHESION_SYSTEM_PROMPT, COHESION_TOOL, buildCohesionUserPrompt, buildDeckContextForCohesion from cohesionPrompts.ts
</verification>

<success_criteria>
- ClaudeProvider has working makeDeckCohesive method
- Uses same tool_choice pattern as analyzePastedSlide/analyzeImage
- Returns CohesionResult with enriched original data for diff display
- TypeScript compiles cleanly
- Both providers now implement the full AIProviderInterface
</success_criteria>

<output>
After completion, create `.planning/phases/58-deck-cohesion/58-02-SUMMARY.md`
</output>
