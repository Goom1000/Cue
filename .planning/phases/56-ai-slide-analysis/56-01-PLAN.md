---
phase: 56-ai-slide-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/slideAnalysis/slideAnalysisPrompts.ts
  - services/aiProvider.ts
  - services/providers/geminiProvider.ts
  - services/providers/claudeProvider.ts
autonomous: true

must_haves:
  truths:
    - "analyzePastedSlide() returns a structured Slide object from a base64 image"
    - "Both Gemini and Claude providers implement the method with their respective structured output patterns"
    - "Prompts instruct AI to extract text, choose layout, and generate teleprompter notes with segment delimiters"
  artifacts:
    - path: "services/slideAnalysis/slideAnalysisPrompts.ts"
      provides: "System prompt, user prompt builder, Gemini responseSchema, Claude tool schema"
      contains: "SLIDE_ANALYSIS_SYSTEM_PROMPT"
    - path: "services/aiProvider.ts"
      provides: "analyzePastedSlide method on AIProviderInterface"
      contains: "analyzePastedSlide"
    - path: "services/providers/geminiProvider.ts"
      provides: "Gemini implementation of analyzePastedSlide using vision + responseSchema"
      contains: "analyzePastedSlide"
    - path: "services/providers/claudeProvider.ts"
      provides: "Claude implementation of analyzePastedSlide using vision + tool_choice"
      contains: "analyzePastedSlide"
  key_links:
    - from: "services/providers/geminiProvider.ts"
      to: "services/slideAnalysis/slideAnalysisPrompts.ts"
      via: "import SLIDE_ANALYSIS_SYSTEM_PROMPT, buildSlideAnalysisPrompt, SLIDE_RESPONSE_SCHEMA"
      pattern: "import.*from.*slideAnalysis"
    - from: "services/providers/claudeProvider.ts"
      to: "services/slideAnalysis/slideAnalysisPrompts.ts"
      via: "import SLIDE_ANALYSIS_SYSTEM_PROMPT, buildSlideAnalysisPrompt, SLIDE_CREATION_TOOL"
      pattern: "import.*from.*slideAnalysis"
    - from: "services/providers/geminiProvider.ts"
      to: "@google/genai"
      via: "GoogleGenAI vision with inlineData + responseSchema"
      pattern: "inlineData.*mimeType.*image"
    - from: "services/providers/claudeProvider.ts"
      to: "anthropic API"
      via: "image content block with base64 + tool_choice"
      pattern: "type.*image.*source.*base64"
---

<objective>
Add AI slide analysis capability to both Gemini and Claude providers, enabling pasted slide images to be transformed into structured Cue-format slides with proper layouts and teleprompter notes.

Purpose: This is the AI backbone that Phase 56 depends on. Without this method, pasted slides remain as raw images with no text extraction or AI improvement.
Output: New `analyzePastedSlide()` method on AIProviderInterface, implemented in both providers, with dedicated prompts and schemas.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-ai-slide-analysis/56-RESEARCH.md

# Key source files to reference for existing patterns
@services/aiProvider.ts
@services/providers/geminiProvider.ts
@services/providers/claudeProvider.ts
@services/documentAnalysis/analysisPrompts.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create slide analysis prompts and schemas</name>
  <files>services/slideAnalysis/slideAnalysisPrompts.ts</files>
  <action>
Create new file `services/slideAnalysis/slideAnalysisPrompts.ts` following the pattern in `services/documentAnalysis/analysisPrompts.ts`.

This file exports:

1. **SLIDE_ANALYSIS_SYSTEM_PROMPT** (string constant): System prompt for AI slide analysis. Must instruct the AI to:
   - Extract text and visual content from a pasted PowerPoint slide image
   - Transform content into Cue format for Year 6 students (ages 10-11)
   - Generate a clear title (max 10 words)
   - Create 3-5 bullet points with key concepts
   - Choose appropriate layout from: 'split', 'full-image', 'center-text', 'two-column'
   - Choose theme from: 'default', 'purple', 'blue', 'green', 'warm'
   - Generate teleprompter notes following Cue's segment pattern:
     - Use the emoji pointer (right-pointing hand) as delimiter between segments
     - Segment 0 = introduction before any bullet appears
     - Segment N = explain bullet N AFTER student reads it
     - Number of segments = number of bullets + 1
     - NEVER preview upcoming bullets
     - Add examples, analogies, "why this matters" -- do NOT repeat slide text
   - Generate an imagePrompt for a supporting educational illustration
   - If slide is primarily a diagram/chart with no extractable text, return layout 'full-image' with descriptive speaker notes about the visual

2. **buildSlideAnalysisPrompt(verbosity: VerbosityLevel)** function: Returns user prompt string. Import VerbosityLevel from `../geminiService`. Vary speaker notes depth:
   - 'concise': 2-3 phrases per segment
   - 'standard': 1-2 sentences per segment
   - 'detailed': 3-5 sentences per segment
   The prompt should say: "Analyze this pasted slide image and extract: 1) Title text, 2) Main content/bullet points, 3) Any diagrams/charts/visual elements (describe in speaker notes), 4) Appropriate layout for Cue. {verbosityHint}. Return a structured slide object following the schema."

3. **SLIDE_RESPONSE_SCHEMA** (object): Gemini responseSchema using `Type` imported from `@google/genai`. Properties:
   - title: Type.STRING
   - content: Type.ARRAY of Type.STRING items
   - speakerNotes: Type.STRING (with description mentioning pointer delimiter and segment count = bullets + 1)
   - imagePrompt: Type.STRING
   - layout: Type.STRING with enum ['split', 'full-image', 'center-text', 'two-column']
   - theme: Type.STRING with enum ['default', 'purple', 'blue', 'green', 'warm']
   All required.

4. **SLIDE_CREATION_TOOL** (object): Claude tool schema for tool_choice structured output. Same properties as above but in JSON Schema format (type: 'object', properties with type: 'string' / type: 'array', etc.). Name: 'create_slide'. Description: 'Transform pasted slide content into Cue slide format'.

IMPORTANT: Import `Type` from `@google/genai` for the Gemini schema. Import `VerbosityLevel` from `../geminiService`. Do NOT import from `../aiProvider` -- VerbosityLevel is re-exported from geminiService, and the canonical export location used by all prompts files is geminiService.

Follow the existing pattern where prompts files are self-contained with all prompt text and schemas, not referencing types.ts.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Confirm the file exports all 4 items: SLIDE_ANALYSIS_SYSTEM_PROMPT, buildSlideAnalysisPrompt, SLIDE_RESPONSE_SCHEMA, SLIDE_CREATION_TOOL.
  </verify>
  <done>
slideAnalysisPrompts.ts exists with all 4 exports. System prompt includes Cue-specific rules for Year 6 content, teleprompter segment pattern with pointer delimiter, and layout selection guidance. Both Gemini and Claude schemas define identical properties (title, content, speakerNotes, imagePrompt, layout, theme) in their respective formats.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add analyzePastedSlide to AIProviderInterface and both providers</name>
  <files>
    services/aiProvider.ts
    services/providers/geminiProvider.ts
    services/providers/claudeProvider.ts
  </files>
  <action>
**In services/aiProvider.ts:**
Add `analyzePastedSlide` method to the `AIProviderInterface` interface (after the `analyzeDocument` method, around line 300):
```typescript
// Analyze a pasted slide image and transform into Cue format (Phase 56)
analyzePastedSlide(
  imageBase64: string,        // Raw base64, NO data URL prefix
  verbosity?: VerbosityLevel  // Controls speaker notes depth
): Promise<Slide>;
```

**In services/providers/geminiProvider.ts:**
1. Add import at top: `import { SLIDE_ANALYSIS_SYSTEM_PROMPT, buildSlideAnalysisPrompt, SLIDE_RESPONSE_SCHEMA } from '../slideAnalysis/slideAnalysisPrompts';`
2. Implement `analyzePastedSlide` method following the existing `analyzeDocument` pattern (lines 301-370). Key differences from analyzeDocument:
   - Single image (not array), single inlineData part
   - Uses SLIDE_ANALYSIS_SYSTEM_PROMPT (not DOCUMENT_ANALYSIS_SYSTEM_PROMPT)
   - Uses SLIDE_RESPONSE_SCHEMA (not the inline document schema)
   - Uses buildSlideAnalysisPrompt(verbosity) for user prompt
   - Returns a Slide object (not DocumentAnalysis)
   - Parse the JSON response text, construct Slide with empty id (caller provides), set source to undefined (caller sets), set isGeneratingImage to false
   - Wrap in try/catch like other methods, use `this.wrapError(error)` for error handling
   - Use `this.model` for the model name (same as analyzeDocument)
   - Call pattern: `ai.models.generateContent({ model: this.model, contents: { parts }, config: { systemInstruction, responseMimeType: 'application/json', responseSchema: SLIDE_RESPONSE_SCHEMA } })`

**In services/providers/claudeProvider.ts:**
1. Add import at top: `import { SLIDE_ANALYSIS_SYSTEM_PROMPT, buildSlideAnalysisPrompt, SLIDE_CREATION_TOOL } from '../slideAnalysis/slideAnalysisPrompts';`
2. Implement `analyzePastedSlide` method following the existing `analyzeDocument` pattern (lines 1591-1660). Key differences:
   - Single image content block (not array loop)
   - Uses SLIDE_ANALYSIS_SYSTEM_PROMPT as system prompt
   - Uses buildSlideAnalysisPrompt(verbosity) for the text content
   - Uses SLIDE_CREATION_TOOL in tools array
   - tool_choice: { type: 'tool', name: 'create_slide' }
   - Extract result from toolUse.input, construct Slide with empty id and isGeneratingImage: false
   - Include 'anthropic-dangerous-direct-browser-access': 'true' header (required for browser CORS, same as analyzeDocument)
   - Error handling: same pattern with AIProviderError, getErrorMessage, getErrorCode
   - max_tokens: 4096 (same as analyzeDocument)

Both implementations should default verbosity to 'standard' if not provided.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all TypeScript compiles. Check that both GeminiProvider and ClaudeProvider classes now have `analyzePastedSlide` methods. Verify the AIProviderInterface includes the new method signature.
  </verify>
  <done>
AIProviderInterface has analyzePastedSlide(imageBase64, verbosity?) method. GeminiProvider implements it using GoogleGenAI vision with responseSchema pattern. ClaudeProvider implements it using fetch to Messages API with image content block and tool_choice pattern. Both return Slide objects with title, content, speakerNotes, imagePrompt, layout, and theme fields populated by AI.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `services/slideAnalysis/slideAnalysisPrompts.ts` exists and exports all 4 items
3. `AIProviderInterface` in `services/aiProvider.ts` includes `analyzePastedSlide` method
4. Both `geminiProvider.ts` and `claudeProvider.ts` implement the method
5. Method signatures match: `analyzePastedSlide(imageBase64: string, verbosity?: VerbosityLevel): Promise<Slide>`
</verification>

<success_criteria>
- TypeScript compiles without errors
- Both providers have analyzePastedSlide() implementations that follow existing analyzeDocument() patterns
- Prompts file contains Cue-specific educational context (Year 6, teleprompter segments, layout selection)
- Gemini uses responseSchema for structured output, Claude uses tool_choice -- matching existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/56-ai-slide-analysis/56-01-SUMMARY.md`
</output>
