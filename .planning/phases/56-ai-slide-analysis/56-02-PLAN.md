---
phase: 56-ai-slide-analysis
plan: 02
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - App.tsx
  - components/PasteComparison.tsx
autonomous: false

must_haves:
  truths:
    - "After pasting a slide image, AI automatically analyzes it and replaces the placeholder with a structured Cue slide"
    - "User can see a before/after comparison showing original pasted image vs AI-improved slide"
    - "User can skip AI improvement and keep the raw pasted image as a full-image slide"
    - "User can revert an AI-improved slide back to the original pasted image"
    - "AI analysis shows a loading state while processing"
  artifacts:
    - path: "App.tsx"
      provides: "Updated handlePasteSlide that calls analyzePastedSlide and stores original image"
      contains: "analyzePastedSlide"
    - path: "components/PasteComparison.tsx"
      provides: "Before/after comparison UI for pasted slides with accept/revert controls"
      contains: "PasteComparison"
  key_links:
    - from: "App.tsx"
      to: "services/aiProvider.ts"
      via: "provider.analyzePastedSlide() call in handlePasteSlide"
      pattern: "provider\\.analyzePastedSlide"
    - from: "App.tsx"
      to: "components/PasteComparison.tsx"
      via: "import and render PasteComparison for pasted slides"
      pattern: "import.*PasteComparison"
    - from: "components/PasteComparison.tsx"
      to: "react-diff-viewer-continued"
      via: "ReactDiffViewer for text content diff"
      pattern: "import ReactDiffViewer"
---

<objective>
Wire AI slide analysis into the paste flow so pasted slides are automatically improved by AI, and add a before/after comparison UI that lets users see what changed, accept the AI result, skip AI, or revert to the original image.

Purpose: This completes the user-facing Phase 56 experience. Without this, the AI analysis capability from Plan 01 is never called, and users see no improvement in their pasted slides.
Output: Updated paste flow in App.tsx calling AI analysis, new PasteComparison component for before/after UI.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-ai-slide-analysis/56-RESEARCH.md
@.planning/phases/56-ai-slide-analysis/56-01-SUMMARY.md

# Key source files
@App.tsx
@types.ts
@hooks/usePaste.ts
@components/EnhancementPanel.tsx
@services/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update handlePasteSlide to call AI analysis and support comparison</name>
  <files>App.tsx</files>
  <action>
Modify `handlePasteSlide` in App.tsx (currently at line ~896) to add AI analysis after image paste. The current flow creates a placeholder, reads the image blob, and sets a full-image layout. Phase 56 extends this to call AI analysis on the image.

**Changes to handlePasteSlide:**

1. **Add `originalPastedImage` to Slide state tracking:** After reading the imageBlob with FileReader (line ~929-963), instead of immediately setting the final slide, first store the data URL as `originalPastedImage` on the slide, then kick off AI analysis:

```typescript
// After reader.onload:
const imageDataUrl = reader.result as string;

// Store original image immediately (user sees it while AI processes)
setSlides(curr => curr.map(s => {
  if (s.id !== tempId) return s;
  return {
    ...s,
    title: "Analyzing pasted slide...",
    content: ["AI is extracting content from this slide..."],
    speakerNotes: "",
    imageUrl: imageDataUrl,
    imagePrompt: "",
    isGeneratingImage: true, // Keep loading indicator
    layout: 'full-image' as const,
    originalPastedImage: imageDataUrl, // Store for comparison
  };
}));

// Call AI analysis (non-blocking - slide already visible with image)
try {
  const aiResult = await provider.analyzePastedSlide(
    imageDataUrl.split(',')[1], // Strip data URL prefix, send raw base64
    settings.verbosity || 'standard'
  );

  // Replace with AI-improved slide, keep original for comparison
  setSlides(curr => curr.map(s => {
    if (s.id !== tempId) return s;
    return {
      ...s,
      title: aiResult.title,
      content: aiResult.content,
      speakerNotes: aiResult.speakerNotes,
      imagePrompt: aiResult.imagePrompt,
      layout: aiResult.layout || 'split',
      theme: aiResult.theme || 'default',
      isGeneratingImage: false,
      imageUrl: undefined, // Clear the pasted image from display (AI created text content)
      originalPastedImage: imageDataUrl, // Keep for revert/comparison
      source: { type: 'pasted', pastedAt: new Date().toISOString() },
    };
  }));
  addToast('AI improved your pasted slide', 3000, 'success');
} catch (aiError) {
  console.error('AI analysis failed, keeping raw image:', aiError);
  // Fallback: keep raw image as full-image layout (graceful degradation)
  setSlides(curr => curr.map(s => {
    if (s.id !== tempId) return s;
    return {
      ...s,
      title: "Pasted Slide",
      content: ["Content pasted from PowerPoint"],
      speakerNotes: "Pasted from clipboard. Add your speaker notes here.",
      imageUrl: imageDataUrl,
      isGeneratingImage: false,
      layout: 'full-image' as const,
      originalPastedImage: imageDataUrl,
    };
  }));
  addToast('Pasted as image (AI analysis unavailable)', 3000, 'info');
}
```

2. **The reader.onload callback needs to be async.** Currently it's a synchronous callback. Change it to: wrap the body in an async IIFE, or better, convert the FileReader usage to a Promise-based helper at the top of the function:
```typescript
// Helper at top of handlePasteSlide or outside it:
const readBlobAsDataUrl = (blob: Blob): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result as string);
    reader.onerror = () => reject(new Error('Failed to read image blob'));
    reader.readAsDataURL(blob);
  });
};
```
Then use: `const imageDataUrl = await readBlobAsDataUrl(result.imageBlob);` instead of the current callback pattern.

3. **Add `provider` and `settings` to the useCallback dependency array.** The current dependency array is `[activeSlideIndex, slides, addToast]`. Add `provider` and `settings.verbosity` since we now use them. Check what `provider` and `settings` are -- they should be stable refs or memoized values. Look at how other handlers in App.tsx reference provider (e.g., search for other `provider.` calls in useCallbacks to see the pattern).

4. **Add `originalPastedImage` to the Slide interface in types.ts:** Add an optional field:
```typescript
// In types.ts Slide interface, after source?:
originalPastedImage?: string; // Data URL of original pasted image for before/after comparison (Phase 56)
```

5. **Handle HTML paste with AI too:** For the HTML paste branch (line ~966-981 where parseClipboardContent is called), after parsing, also call AI analysis if a provider is available. But keep this simpler -- the HTML parse already extracts title/bullets, so AI is less critical. Add a comment: `// Phase 56: AI enhancement of HTML paste is handled by the same flow`. For now, the AI analysis only applies to image-only paste (the primary PowerPoint use case). HTML paste continues to work as-is with parseClipboardContent.

6. **Add handleRevertToOriginal function** (new useCallback near handlePasteSlide):
```typescript
const handleRevertToOriginal = useCallback((slideId: string) => {
  setSlides(curr => curr.map(s => {
    if (s.id !== slideId || !s.originalPastedImage) return s;
    return {
      ...s,
      title: "Pasted Slide",
      content: ["Content pasted from PowerPoint"],
      speakerNotes: "Pasted from clipboard. Add your speaker notes here.",
      imageUrl: s.originalPastedImage,
      imagePrompt: "",
      layout: 'full-image' as const,
      isGeneratingImage: false,
      // Keep originalPastedImage so user could re-analyze later
    };
  }));
  addToast('Reverted to original pasted image', 3000, 'info');
}, [addToast]);
```

7. **Import PasteComparison** (will be created in Task 2): Add import at top of App.tsx:
```typescript
import PasteComparison from './components/PasteComparison';
```

8. **Render PasteComparison for pasted slides:** In the slide editing area of App.tsx, find where the active slide's editing controls are rendered. Add a conditional render: if the active slide has `originalPastedImage` and `source?.type === 'pasted'`, render PasteComparison below the slide card. Look for where SlideCard is rendered in the editing view (search for `<SlideCard` in the JSX). Add after the slide card for the active slide:
```tsx
{activeSlide?.originalPastedImage && activeSlide?.source?.type === 'pasted' && (
  <PasteComparison
    slide={activeSlide}
    onRevert={() => handleRevertToOriginal(activeSlide.id)}
  />
)}
```
Where `activeSlide` is `slides[activeSlideIndex]`. If there's no existing `activeSlide` variable, create one: `const activeSlide = slides[activeSlideIndex];` in the render.

IMPORTANT: The `provider` variable needs to be available inside handlePasteSlide. Check how it's accessed -- it's likely from the settings/state. Search for `const provider` or `createAIProvider` in App.tsx to understand the pattern. If provider is conditionally available (user might not have API key set), guard the AI call: `if (provider) { ... } else { /* keep raw image */ }`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Check that handlePasteSlide now references `provider.analyzePastedSlide`. Check that `originalPastedImage` field exists on Slide interface in types.ts. Verify App.tsx imports PasteComparison.
  </verify>
  <done>
handlePasteSlide calls provider.analyzePastedSlide() for image pastes, stores originalPastedImage on the slide, shows loading state during AI processing, gracefully falls back to raw image on AI error. Slide interface has originalPastedImage field. handleRevertToOriginal function exists for reverting AI improvements. PasteComparison is imported and rendered conditionally for pasted slides.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PasteComparison component for before/after UI</name>
  <files>components/PasteComparison.tsx</files>
  <action>
Create `components/PasteComparison.tsx` -- a component that shows before/after comparison for AI-improved pasted slides. Follow the pattern in `components/EnhancementPanel.tsx` for diff viewer usage and styling.

**Props interface:**
```typescript
interface PasteComparisonProps {
  slide: Slide;              // The AI-improved slide (has originalPastedImage)
  onRevert: () => void;      // Revert to original image
}
```

**Component behavior:**

1. **Collapsed by default** with a toggle button "Compare with Original" (consistent with EnhancementPanel's opt-in diff pattern). Uses `useState<boolean>(false)` for `showComparison`.

2. **When expanded, show side-by-side view:**
   - Left side: "Original Paste" -- render the `slide.originalPastedImage` as an `<img>` tag with max-height constraint, rounded corners
   - Right side: "AI-Improved" -- render the AI slide content as a preview:
     - Title in bold
     - Bullet points as a list
     - Layout badge (e.g., "split", "two-column")
     - First ~100 chars of speaker notes as a preview

3. **Text diff toggle:** Below the side-by-side, add a "Show Text Diff" toggle that uses `ReactDiffViewer` to show the diff between:
   - oldValue: `"[Image Only]\n\nNo text content extracted from original paste."`
   - newValue: formatted AI result: `"Title: ${slide.title}\n\nContent:\n${slide.content.map((c,i) => \`${i+1}. ${c}\`).join('\\n')}\n\nSpeaker Notes:\n${slide.speakerNotes}"`
   - Use `DiffMethod.WORDS`, `splitView={false}`, `hideLineNumbers={true}`
   - Style with the same light/dark theme variables from EnhancementPanel.tsx (lines 318-345)

4. **Action buttons:**
   - "Revert to Original Image" button (secondary style) -- calls `onRevert`
   - The comparison panel should be collapsible

5. **Styling:** Use Tailwind classes consistent with the rest of the app:
   - Container: `bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 mt-4`
   - Toggle button: `text-sm text-indigo-600 dark:text-indigo-400 hover:underline cursor-pointer`
   - Side-by-side grid: `grid grid-cols-2 gap-4`
   - Image: `rounded-lg max-h-48 object-contain w-full`
   - Revert button: Use the existing `Button` component from `./Button` with `variant="secondary"` or equivalent styling pattern (check Button.tsx for props)

6. **Imports:**
```typescript
import React, { useState } from 'react';
import ReactDiffViewer, { DiffMethod } from 'react-diff-viewer-continued';
import { Slide } from '../types';
import Button from './Button';
```

7. **Guard:** If `!slide.originalPastedImage`, return null (don't render anything).

8. **Export:** Default export `PasteComparison`.

Keep the component simple -- under 120 lines. The comparison is informational, not a complex editing interface.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Verify component file exists at `components/PasteComparison.tsx`. Check it imports ReactDiffViewer and Slide type. Check it exports default.
  </verify>
  <done>
PasteComparison component renders a collapsible before/after comparison with original pasted image on the left and AI-improved slide preview on the right. Text diff view available via toggle. Revert button allows returning to original image. Component follows existing codebase patterns for styling and diff viewer usage.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete AI slide analysis flow: paste a PowerPoint slide image, AI extracts content and creates a Cue-format slide, before/after comparison visible, revert and skip options available.</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Open Cue in Chrome/Arc, create or load a presentation with at least one slide
3. Copy a slide from PowerPoint (Cmd+C on a slide in PowerPoint)
4. Paste in Cue (Cmd+V while not in a text field)
5. Verify: Loading state appears ("Analyzing pasted slide...")
6. Verify: After a few seconds, AI-improved slide appears with title, bullets, speaker notes, and chosen layout
7. Verify: "Compare with Original" toggle appears below the slide
8. Click "Compare with Original" -- verify side-by-side shows original image vs AI content
9. Click "Show Text Diff" -- verify diff viewer shows the extracted text
10. Click "Revert to Original Image" -- verify slide reverts to full-image layout with the pasted image
11. Test error case: Temporarily disconnect network, paste again -- verify graceful fallback to raw image with info toast
12. Test with both Gemini and Claude providers if both API keys are available
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Pasting a PowerPoint slide image triggers AI analysis automatically
3. AI result replaces placeholder with structured slide (title, bullets, notes, layout)
4. originalPastedImage stored on slide for comparison
5. PasteComparison component renders below pasted slides
6. Revert button restores original pasted image
7. AI failure gracefully falls back to raw image paste
8. Both Gemini and Claude providers work (if keys available)
</verification>

<success_criteria>
- CLIP-02 satisfied: AI analyzes pasted content and generates improved Cue-style slide
- CLIP-06 satisfied: Before/after comparison shows what AI changed from pasted content
- Success criteria 1: AI restructures content into proper Cue layouts
- Success criteria 2: AI generates teleprompter notes
- Success criteria 3: Before/after diff visible
- Success criteria 4: Works with both providers
- Success criteria 5: User can skip/revert AI improvement
</success_criteria>

<output>
After completion, create `.planning/phases/56-ai-slide-analysis/56-02-SUMMARY.md`
</output>
