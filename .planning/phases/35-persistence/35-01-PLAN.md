---
phase: 35-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/saveService.ts
  - services/loadService.ts
  - App.tsx
  - components/PresentationView.tsx
autonomous: true
must_haves:
  truths:
    - "Saving a presentation with 'detailed' verbosity includes that level in the .cue file"
    - "Loading a v3 .cue file restores the saved verbosity level to the UI selector"
    - "Loading a v2 .cue file (no verbosity) defaults to 'standard' verbosity"
    - "The verbosity selector in presentation mode reflects the loaded value"
  artifacts:
    - path: "types.ts"
      provides: "CueFile interface with optional deckVerbosity field"
      contains: "deckVerbosity?: VerbosityLevel"
    - path: "types.ts"
      provides: "File version bump"
      contains: "CURRENT_FILE_VERSION = 3"
    - path: "services/saveService.ts"
      provides: "createCueFile with deckVerbosity parameter"
      contains: "deckVerbosity?: VerbosityLevel"
    - path: "services/loadService.ts"
      provides: "v2->v3 migration documentation"
      contains: "fromVersion === 2"
    - path: "App.tsx"
      provides: "Lifted deckVerbosity state with save/load integration"
      contains: "deckVerbosity, setDeckVerbosity"
    - path: "components/PresentationView.tsx"
      provides: "deckVerbosity as controlled prop"
      contains: "deckVerbosity: VerbosityLevel"
  key_links:
    - from: "App.tsx"
      to: "services/saveService.ts"
      via: "createCueFile call with deckVerbosity"
      pattern: "createCueFile.*deckVerbosity"
    - from: "App.tsx"
      to: "components/PresentationView.tsx"
      via: "deckVerbosity prop"
      pattern: "deckVerbosity=\\{deckVerbosity\\}"
    - from: "App.tsx"
      to: "handleLoadFile"
      via: "setDeckVerbosity from loaded file"
      pattern: "setDeckVerbosity.*cueFile\\.deckVerbosity"
---

<objective>
Persist deck-wide verbosity level in .cue files with backward compatibility for v2 files.

Purpose: Users who save a presentation with "Detailed" verbosity should see that setting restored when they reload the file. v2 files (from before this feature) should load with "Standard" verbosity as the default.

Output: Updated file format (v3) with deckVerbosity field, working save/load round-trip.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-persistence/35-CONTEXT.md
@.planning/phases/35-persistence/35-RESEARCH.md
@types.ts
@services/saveService.ts
@services/loadService.ts
@App.tsx (partial - save/load handlers)
@components/PresentationView.tsx (partial - deckVerbosity state)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend file format with deckVerbosity field</name>
  <files>types.ts, services/saveService.ts, services/loadService.ts</files>
  <action>
  Update the file format to support deckVerbosity persistence:

  1. **types.ts** - Add deckVerbosity field and bump version:
     - Import VerbosityLevel type at top: `import { VerbosityLevel } from './services/geminiService';`
       (Or re-export VerbosityLevel in types.ts if circular import issues arise)
     - Change `CURRENT_FILE_VERSION` from 2 to 3
     - Add optional field to CueFile interface: `deckVerbosity?: VerbosityLevel;`
       Place it after `author?` and before `content` to group metadata together

  2. **services/saveService.ts** - Accept deckVerbosity in createCueFile:
     - Add parameter: `deckVerbosity?: VerbosityLevel` (after studentGrades)
     - Import VerbosityLevel from geminiService
     - Include in returned object conditionally (omit if 'standard' to keep files clean):
       ```typescript
       ...(deckVerbosity && deckVerbosity !== 'standard' ? { deckVerbosity } : {}),
       ```
     - Place this spread between `title` and `content` in the return object

  3. **services/loadService.ts** - Document v2->v3 migration:
     - Add comment block for v2->v3 migration in migrateFile():
       ```typescript
       // v2 -> v3: Added deckVerbosity to CueFile root
       if (fromVersion === 2) {
         // No action needed - deckVerbosity is optional
         // App.tsx defaults to 'standard' when undefined
       }
       ```
     - No validation changes needed - deckVerbosity is optional, TypeScript handles it

  Do NOT modify App.tsx or PresentationView.tsx in this task - that's Task 2.
  </action>
  <verify>
  - `npm run build` passes with no TypeScript errors
  - types.ts shows `CURRENT_FILE_VERSION = 3`
  - CueFile interface includes `deckVerbosity?: VerbosityLevel`
  - createCueFile signature includes deckVerbosity parameter
  - migrateFile has v2->v3 comment block
  </verify>
  <done>
  File format v3 is defined with deckVerbosity field. Save service accepts verbosity. Load service documents migration path. All TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lift deckVerbosity state and wire save/load</name>
  <files>App.tsx, components/PresentationView.tsx</files>
  <action>
  Lift deckVerbosity state from PresentationView to App.tsx for persistence:

  1. **App.tsx** - Add state and wire to save/load:

     a. Add import for VerbosityLevel:
        ```typescript
        import { VerbosityLevel } from './services/geminiService';
        ```
        (May already be imported via aiProvider - check and adjust)

     b. Add state near other state declarations (after upfrontVerbosity):
        ```typescript
        const [deckVerbosity, setDeckVerbosity] = useState<VerbosityLevel>('standard');
        ```

     c. Update handleSaveClick to pass deckVerbosity to createCueFile:
        ```typescript
        const file = createCueFile(lessonTitle, slides, studentNames, lessonText, undefined, studentGrades, deckVerbosity);
        ```
        (Add deckVerbosity as 7th argument - after studentGrades)

     d. Update handleSaveConfirm similarly:
        ```typescript
        const file = createCueFile(lessonTitle, slides, studentNames, lessonText, undefined, studentGrades, deckVerbosity);
        ```

     e. Update handleLoadFile to restore verbosity:
        After `setStudentGrades(loadedGrades);` add:
        ```typescript
        // Restore deck verbosity (defaults to standard for v2 files)
        setDeckVerbosity(cueFile.deckVerbosity || 'standard');
        ```

     f. Update PresentationView props to pass deckVerbosity state:
        ```tsx
        <PresentationView
          slides={slides}
          onExit={() => setAppState(AppState.EDITING)}
          studentNames={studentNames}
          studentData={studentGrades}
          initialSlideIndex={presentationStartIndex}
          provider={provider}
          onError={handleComponentError}
          onRequestAI={handleRequestAI}
          onUpdateSlide={handleUpdateSlide}
          deckVerbosity={deckVerbosity}
          onDeckVerbosityChange={setDeckVerbosity}
        />
        ```

  2. **components/PresentationView.tsx** - Convert to controlled props:

     a. Update PresentationViewProps interface:
        Add before the closing brace:
        ```typescript
        deckVerbosity: VerbosityLevel;
        onDeckVerbosityChange: (level: VerbosityLevel) => void;
        ```

     b. Update component destructuring:
        Add `deckVerbosity, onDeckVerbosityChange` to the props destructuring

     c. REMOVE the local useState for deckVerbosity:
        Delete this line:
        ```typescript
        const [deckVerbosity, setDeckVerbosity] = useState<VerbosityLevel>('standard');
        ```

     d. Replace setDeckVerbosity calls with onDeckVerbosityChange:
        Find all uses of `setDeckVerbosity` and replace with `onDeckVerbosityChange`
        (Should be in the batch regeneration confirmation handler)

  CRITICAL: The batch regeneration logic in PresentationView should continue to work.
  The only change is the source of truth moves from local state to props.
  </action>
  <verify>
  - `npm run build` passes with no TypeScript errors
  - Manual test: Create presentation, change verbosity to "Detailed", save as test.cue
  - Open test.cue in text editor: should contain `"deckVerbosity": "detailed"`
  - Manual test: Load test.cue, enter presentation mode - verbosity selector shows "Detailed"
  - Manual test: Load a v2 .cue file (or one without deckVerbosity) - defaults to "Standard"
  </verify>
  <done>
  deckVerbosity state lifted to App.tsx. Save includes verbosity in file. Load restores verbosity from file (defaults to 'standard' for v2). Verbosity selector in presentation mode reflects loaded value.
  </done>
</task>

</tasks>

<verification>
1. Build verification: `npm run build` completes without errors
2. Round-trip test:
   - Generate slides with "Detailed" upfront verbosity
   - Enter presentation mode, confirm verbosity shows "Detailed"
   - Exit presentation, save as test.cue
   - Reload app (refresh), load test.cue
   - Enter presentation mode - verbosity selector should show "Detailed"
3. Backward compatibility test:
   - Find or create a v2 .cue file (version: 2, no deckVerbosity field)
   - Load the file
   - Enter presentation mode - verbosity should default to "Standard"
   - Re-save the file
   - Check file: should now have version: 3 (migration occurred)
4. Omit 'standard' test:
   - Save a presentation without changing verbosity (stays 'standard')
   - Check saved file: should NOT contain deckVerbosity field (cleaner files)
</verification>

<success_criteria>
- PERS-01: .cue files saved with non-standard verbosity include deckVerbosity field
- PERS-02: Loading .cue file restores verbosity to UI (selector matches saved level)
- PERS-03: v2 files (no deckVerbosity) load with 'standard' verbosity
- File version bumped to 3
- TypeScript compilation succeeds
- No regressions to batch verbosity regeneration feature
</success_criteria>

<output>
After completion, create `.planning/phases/35-persistence/35-01-SUMMARY.md`
</output>
