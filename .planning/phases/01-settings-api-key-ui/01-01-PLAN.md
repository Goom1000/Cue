---
phase: 01-settings-api-key-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - hooks/useSettings.ts
  - services/apiValidation.ts
autonomous: true

must_haves:
  truths:
    - "Settings type defines provider and apiKey fields"
    - "useSettings hook reads from and writes to localStorage"
    - "validateApiKey function returns valid/invalid status for all three providers"
  artifacts:
    - path: "types.ts"
      provides: "AIProvider type and Settings interface"
      contains: "export type AIProvider"
    - path: "hooks/useSettings.ts"
      provides: "Settings persistence hook"
      exports: ["useSettings", "DEFAULT_SETTINGS"]
    - path: "services/apiValidation.ts"
      provides: "API key validation for Gemini, OpenAI, Claude"
      exports: ["validateApiKey"]
  key_links:
    - from: "hooks/useSettings.ts"
      to: "types.ts"
      via: "import Settings type"
      pattern: "import.*Settings.*from.*types"
    - from: "services/apiValidation.ts"
      to: "types.ts"
      via: "import AIProvider type"
      pattern: "import.*AIProvider.*from.*types"
---

<objective>
Create the foundational infrastructure for settings persistence and API key validation.

Purpose: Establish the types, storage hook, and validation utility that the Settings modal will use. This foundation enables all settings functionality in subsequent plans.

Output: Three files providing settings types, localStorage persistence hook, and API key validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-settings-api-key-ui/01-CONTEXT.md
@.planning/phases/01-settings-api-key-ui/01-RESEARCH.md

# Existing codebase patterns to follow:
@types.ts
@hooks/usePreviewPersistence.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Settings types to types.ts</name>
  <files>types.ts</files>
  <action>
Add to the existing types.ts file:

1. Export type AIProvider = 'gemini' | 'openai' | 'claude'

2. Export interface Settings with:
   - provider: AIProvider
   - apiKey: string

3. Export const DEFAULT_SETTINGS: Settings = { provider: 'gemini', apiKey: '' }

Place these after the existing interfaces but before the AppState enum. Follow existing naming conventions (PascalCase for types/interfaces, SCREAMING_SNAKE for constants).
  </action>
  <verify>TypeScript compiles without errors: `cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit`</verify>
  <done>AIProvider, Settings, and DEFAULT_SETTINGS are exported from types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create useSettings persistence hook</name>
  <files>hooks/useSettings.ts</files>
  <action>
Create new file hooks/useSettings.ts following the usePreviewPersistence pattern:

1. Import useState, useEffect, useCallback from 'react'
2. Import Settings, DEFAULT_SETTINGS from '../types'

3. Define STORAGE_KEY = 'pipi-settings'

4. Create isValidSettings(data: unknown): data is Settings type guard:
   - Check data is object and not null
   - Check provider is one of 'gemini' | 'openai' | 'claude'
   - Check apiKey is string

5. Export function useSettings():
   - Returns [Settings, (updates: Partial<Settings>) => void]
   - Lazy initialization: read from localStorage on mount, validate shape, merge with defaults
   - useEffect to save to localStorage when state changes
   - updateSettings callback for partial updates (like usePreviewPersistence)
   - Also export a clearSettings function to remove from localStorage

6. Export DEFAULT_SETTINGS re-export for convenience

Key difference from usePreviewPersistence: No presentationId parameter (settings are global), and include clearSettings function for danger zone feature.
  </action>
  <verify>TypeScript compiles: `cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit`</verify>
  <done>useSettings hook exports useSettings function that persists to localStorage with validation</done>
</task>

<task type="auto">
  <name>Task 3: Create API key validation utility</name>
  <files>services/apiValidation.ts</files>
  <action>
Create new file services/apiValidation.ts:

1. Import AIProvider from '../types'

2. Define ValidationResult interface: { valid: boolean; error?: string }

3. Export async function validateApiKey(provider: AIProvider, apiKey: string): Promise<ValidationResult>

Implementation per research:
- Gemini: GET `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`
  - Headers: none needed (key in URL)

- OpenAI: GET `https://api.openai.com/v1/models`
  - Headers: { 'Authorization': `Bearer ${apiKey}` }

- Claude: GET `https://api.anthropic.com/v1/models`
  - Headers: { 'x-api-key': apiKey, 'anthropic-version': '2023-06-01' }

Logic:
- If response.ok, return { valid: true }
- If 401/403, return { valid: false, error: 'Invalid API key' }
- If other error, parse response.json() and extract error.message or error.error.message
- Catch network errors: return { valid: false, error: 'Network error - check your connection' }

These are lightweight list-models endpoints (free/cheap) per RESEARCH.md.
  </action>
  <verify>TypeScript compiles: `cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit`</verify>
  <done>validateApiKey function exported and handles all three providers with proper error messages</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes with no errors
2. New files exist: hooks/useSettings.ts, services/apiValidation.ts
3. types.ts contains AIProvider, Settings, DEFAULT_SETTINGS exports
</verification>

<success_criteria>
- AIProvider type covers 'gemini' | 'openai' | 'claude'
- Settings interface has provider and apiKey fields
- useSettings hook persists to localStorage with 'pipi-settings' key
- useSettings validates data shape on load (handles corrupted data gracefully)
- validateApiKey returns { valid: true } for valid keys, { valid: false, error: string } for invalid
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-settings-api-key-ui/01-01-SUMMARY.md`
</output>
