---
phase: 51-detection-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - services/contentPreservation/types.ts
  - services/contentPreservation/detector.ts
  - services/contentPreservation/detector.test.ts
autonomous: true

must_haves:
  truths:
    - "Answer patterns are detected near questions within proximity threshold"
    - "Math expressions with operators are identified as math content"
    - "Vocabulary definitions are identified as vocabulary content"
    - "Comprehension patterns (why/because) are identified as comprehension content"
  artifacts:
    - path: "services/contentPreservation/types.ts"
      provides: "TeachableMoment and ContentCategory types"
      contains: "TeachableMoment"
    - path: "services/contentPreservation/detector.ts"
      provides: "findAnswerInRange and classifyContentCategory functions"
      exports: ["findAnswerInRange", "classifyContentCategory"]
    - path: "services/contentPreservation/detector.test.ts"
      provides: "Test coverage for answer detection and classification"
      contains: "describe.*Answer"
  key_links:
    - from: "services/contentPreservation/detector.ts"
      to: "services/contentPreservation/types.ts"
      via: "import TeachableMoment, ContentCategory"
      pattern: "import.*TeachableMoment"
---

<objective>
Add answer detection and content classification to the content preservation module using TDD.

Purpose: This establishes the building blocks for teachable moment detection - detecting answers near questions and classifying content types (math, vocabulary, comprehension, science) for scaffolding selection in later phases.

Output: New types (TeachableMoment, ContentCategory) and two tested pure functions (findAnswerInRange, classifyContentCategory).
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/51-detection-foundation/51-RESEARCH.md
@services/contentPreservation/types.ts
@services/contentPreservation/detector.ts
@services/contentPreservation/detector.test.ts
</context>

<feature>
  <name>Answer Detection and Content Classification</name>
  <files>
    services/contentPreservation/types.ts
    services/contentPreservation/detector.ts
    services/contentPreservation/detector.test.ts
  </files>
  <behavior>
    **Types (in types.ts):**
    - ContentCategory: 'math' | 'vocabulary' | 'comprehension' | 'science' | 'general'
    - TeachableMoment interface with: problem, answer, contentCategory, confidence, proximityChars

    **Answer Detection (findAnswerInRange):**
    - Input: text string, searchStartIndex number
    - Output: DetectedContent | null
    - Patterns to match:
      - "Answer:", "A:", "Ans:" followed by content
      - "A1:", "A2:" numbered answers
      - "= 15", "equals 42" math results
    - Returns null if no answer found

    **Content Classification (classifyContentCategory):**
    - Input: problemText string, answerText string
    - Output: ContentCategory
    - Classification priority (most specific first):
      1. math: numbers with operators (+,-,*,/,=), percent, fraction, calculate, solve
      2. vocabulary: "means", "defined as", synonyms, antonyms
      3. science: experiment, hypothesis, observe, predict, chemical, reaction
      4. comprehension: because/therefore, why does/did, cause/effect
      5. general: default fallback

    **Test Cases:**
    - "What is 3+4? Answer: 7" -> finds answer "7", classifies as 'math'
    - "Define osmosis. Osmosis means..." -> finds answer, classifies as 'vocabulary'
    - "Why did the ice melt? Because heat..." -> finds answer, classifies as 'comprehension'
    - "What happens when you heat water? It evaporates." -> classifies as 'science'
    - Question with no nearby answer -> returns null
    - Answer beyond proximity threshold (200 chars) -> returns null
  </behavior>
  <implementation>
    **RED phase:**
    1. Add types to types.ts (ContentCategory, TeachableMoment)
    2. Write tests in detector.test.ts for:
       - findAnswerInRange with various answer patterns
       - classifyContentCategory for each content type
       - Edge cases (no answer, beyond proximity, empty input)
    3. Run tests - they should fail (functions don't exist)

    **GREEN phase:**
    1. Implement findAnswerInRange in detector.ts:
       - ANSWER_PATTERNS array with regex for each pattern
       - Search within text slice, adjust indices for absolute position
       - Return DetectedContent with 'answer' type or null
    2. Implement classifyContentCategory in detector.ts:
       - MATH_SIGNALS, VOCABULARY_SIGNALS, SCIENCE_SIGNALS, COMPREHENSION_SIGNALS arrays
       - Check patterns in priority order
       - Return first match or 'general'
    3. Export both functions
    4. Run tests - they should pass

    **REFACTOR phase:**
    - Extract signal patterns to top of file with other constants
    - Ensure consistent naming with existing code style
  </implementation>
</feature>

<verification>
```bash
npm test -- --testPathPattern="detector.test.ts" --verbose
```

Expected: All existing tests pass + new answer detection and classification tests pass.
</verification>

<success_criteria>
- [ ] ContentCategory and TeachableMoment types added to types.ts
- [ ] findAnswerInRange function exported from detector.ts
- [ ] classifyContentCategory function exported from detector.ts
- [ ] Tests cover all answer patterns (Answer:, A:, A1:, =, equals)
- [ ] Tests cover all content categories (math, vocabulary, comprehension, science, general)
- [ ] Tests verify proximity threshold enforcement (200 chars)
- [ ] All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/51-detection-foundation/51-01-SUMMARY.md`
</output>
