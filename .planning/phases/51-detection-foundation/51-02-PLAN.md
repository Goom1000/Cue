---
phase: 51-detection-foundation
plan: 02
type: tdd
wave: 2
depends_on: ["51-01"]
files_modified:
  - services/contentPreservation/detector.ts
  - services/contentPreservation/detector.test.ts
autonomous: true

must_haves:
  truths:
    - "detectTeachableMoments returns paired problem-answer objects"
    - "Rhetorical questions are excluded from teachable moments"
    - "Detection rate stays below 30% of content (throttling works)"
    - "Each teachable moment includes content type classification"
  artifacts:
    - path: "services/contentPreservation/detector.ts"
      provides: "Main detectTeachableMoments function with throttling"
      exports: ["detectTeachableMoments"]
    - path: "services/contentPreservation/detector.test.ts"
      provides: "Comprehensive test coverage for teachable moment detection"
      contains: "describe.*detectTeachableMoments"
  key_links:
    - from: "detectTeachableMoments"
      to: "detectQuestions"
      via: "function call to get problem candidates"
      pattern: "detectQuestions\\(text\\)"
    - from: "detectTeachableMoments"
      to: "findAnswerInRange"
      via: "function call to find paired answer"
      pattern: "findAnswerInRange\\("
    - from: "detectTeachableMoments"
      to: "classifyContentCategory"
      via: "function call to classify content type"
      pattern: "classifyContentCategory\\("
---

<objective>
Implement the main detectTeachableMoments function with conservative throttling using TDD.

Purpose: This is the core detection function that identifies problem-answer pairs in lesson content. It aggregates the answer detection and classification from Plan 01, adds proximity-based pairing, and enforces the 30% throttling limit (DET-02) to preserve lesson flow.

Output: Exported detectTeachableMoments function with comprehensive test coverage.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/51-detection-foundation/51-RESEARCH.md
@.planning/phases/51-detection-foundation/51-01-SUMMARY.md
@services/contentPreservation/types.ts
@services/contentPreservation/detector.ts
@services/contentPreservation/detector.test.ts
</context>

<feature>
  <name>Teachable Moment Detection with Throttling</name>
  <files>
    services/contentPreservation/detector.ts
    services/contentPreservation/detector.test.ts
  </files>
  <behavior>
    **detectTeachableMoments(text: string): TeachableMoment[]**

    Input: Raw lesson text (could be PDF content, slide text, speaker notes)
    Output: Array of TeachableMoment objects, throttled to <30% of content

    Algorithm:
    1. Call detectQuestions(text) to find problem candidates
    2. Filter out low-confidence (rhetorical) questions
    3. For each remaining question:
       a. Search for answer within PROXIMITY_THRESHOLD (200 chars) after question
       b. If answer found, create TeachableMoment with:
          - problem: the question DetectedContent
          - answer: the answer DetectedContent
          - contentCategory: result of classifyContentCategory
          - confidence: inherit from answer detection
          - proximityChars: distance between question end and answer start
    4. Apply throttleDetections to limit to 30% of bullets
    5. Return sorted by position in text

    **throttleDetections(moments: TeachableMoment[], bulletCount: number, maxPercent: number): TeachableMoment[]**

    - Calculate max allowed: floor(bulletCount * maxPercent)
    - Sort by: confidence (high first), then proximityChars (closer first)
    - Return top N moments up to max allowed
    - If bulletCount is 0 or unknown, estimate from newline count

    **Test Cases:**
    - Simple Q&A: "What is 2+2? Answer: 4" -> 1 teachable moment, math category
    - Multiple Q&A: text with 3 Q&A pairs -> 3 moments (if under threshold)
    - Rhetorical excluded: "Isn't this amazing? What is photosynthesis? Answer: process..." -> only 1 moment
    - No answer nearby: "What is your name?" with answer 500 chars away -> no moment
    - Throttling: 10 bullets with 5 Q&A pairs -> max 3 moments returned (30%)
    - Mixed content: Q&A + plain text -> only Q&A portions become moments
    - Content types: verify math, vocab, comprehension, science detection in moments
    - Deterministic: same input produces same output (DET-04 consistency)
  </behavior>
  <implementation>
    **RED phase:**
    1. Write tests in detector.test.ts under new describe block "detectTeachableMoments":
       - Basic Q&A pairing
       - Rhetorical question exclusion
       - Proximity threshold enforcement
       - Content type classification in moments
       - Throttling at 30% threshold
       - Deterministic output (same input = same output)
    2. Write tests for throttleDetections helper:
       - Sorts by confidence then proximity
       - Respects max percentage
       - Handles edge cases (empty array, 0 bullets)
    3. Run tests - they should fail

    **GREEN phase:**
    1. Add PROXIMITY_THRESHOLD constant (200)
    2. Implement throttleDetections helper function
    3. Implement detectTeachableMoments:
       - Get questions, filter rhetorical (confidence !== 'low')
       - For each, search for answer with findAnswerInRange
       - Build TeachableMoment objects
       - Estimate bullet count from newlines or content structure
       - Apply throttling
       - Sort by startIndex
    4. Export detectTeachableMoments
    5. Run tests - they should pass

    **REFACTOR phase:**
    - Ensure PROXIMITY_THRESHOLD is configurable for future tuning
    - Add JSDoc comments matching existing code style
    - Verify no duplication with existing helper functions
  </implementation>
</feature>

<verification>
```bash
npm test -- --testPathPattern="detector.test.ts" --verbose
```

Expected: All tests pass including new detectTeachableMoments tests.

Manual verification of requirements:
- DET-01: Patterns detected (Q&A, definitions, math results) - covered by tests
- DET-02: <30% threshold - covered by throttling tests
- DET-03: Content type classification - verified in moment.contentCategory tests
- DET-04: Problem-answer pairing - verified in pairing tests
</verification>

<success_criteria>
- [ ] detectTeachableMoments exported from detector.ts
- [ ] PROXIMITY_THRESHOLD = 200 defined as constant
- [ ] throttleDetections helper function implemented
- [ ] Rhetorical questions excluded (confidence !== 'low')
- [ ] Content type classification included in each moment
- [ ] Throttling limits to 30% of bullet count
- [ ] Tests verify all DET requirements (DET-01 through DET-04)
- [ ] Deterministic output verified in tests
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/51-detection-foundation/51-02-SUMMARY.md`
</output>
