---
phase: 52-prompt-engineering-core
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - services/geminiService.ts
  - services/providers/claudeProvider.ts
autonomous: true

must_haves:
  truths:
    - "Generated slides split problem/answer into consecutive bullets (no answer leakage)"
    - "Teleprompter shows scaffolding strategies between problem and answer reveals"
    - "Scaffolding includes 2-3 question prompts appropriate to content type"
    - "Teacher sees scaffolding strategies regardless of AI provider (verified with Gemini and Claude)"
    - "Transitions between problem, scaffolding, and answer feel natural"
  artifacts:
    - path: "services/geminiService.ts"
      provides: "Teachable moment detection integrated into slide generation"
      contains: "detectTeachableMoments"
    - path: "services/providers/claudeProvider.ts"
      provides: "Teachable moment detection integrated into slide generation"
      contains: "detectTeachableMoments"
  key_links:
    - from: "services/geminiService.ts"
      to: "services/contentPreservation/detector.ts"
      via: "import detectTeachableMoments"
      pattern: "import.*detectTeachableMoments.*from"
    - from: "services/geminiService.ts"
      to: "services/prompts/teachableMomentRules.ts"
      via: "import getTeachableMomentRules"
      pattern: "import.*getTeachableMomentRules.*from"
    - from: "services/providers/claudeProvider.ts"
      to: "services/contentPreservation/detector.ts"
      via: "import detectTeachableMoments"
      pattern: "import.*detectTeachableMoments.*from"
    - from: "services/providers/claudeProvider.ts"
      to: "services/prompts/teachableMomentRules.ts"
      via: "import getTeachableMomentRules"
      pattern: "import.*getTeachableMomentRules.*from"
---

<objective>
Integrate teachable moment detection and prompt rules into both AI providers (Gemini and Claude) so that generated slides properly split problem/answer pairs with scaffolding guidance.

Purpose: This wires Phase 51's detection output to Phase 52's prompt rules, completing the pipeline from lesson text -> detected moments -> AI prompt -> scaffolded slides.

Output: Modified `geminiService.ts` and `claudeProvider.ts` that detect teachable moments and include scaffolding rules in system prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/52-prompt-engineering-core/52-CONTEXT.md
@.planning/phases/52-prompt-engineering-core/52-RESEARCH.md
@.planning/phases/52-prompt-engineering-core/52-01-SUMMARY.md

@services/geminiService.ts
@services/providers/claudeProvider.ts
@services/contentPreservation/detector.ts
@services/prompts/teachableMomentRules.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate teachable moments into geminiService.ts</name>
  <files>services/geminiService.ts</files>
  <action>
Modify `services/geminiService.ts` to detect teachable moments and include them in the system prompt.

1. Add imports at the top of the file:
```typescript
import { detectTeachableMoments } from './contentPreservation/detector';
import { TeachableMoment } from './contentPreservation/types';
import { getTeachableMomentRules } from './prompts/teachableMomentRules';
```

2. Modify `getSystemInstructionForMode()` signature to accept optional `teachableMoments` parameter:
```typescript
function getSystemInstructionForMode(
  mode: GenerationMode,
  verbosity: VerbosityLevel = 'standard',
  gradeLevel: string = 'Year 6 (10-11 years old)',
  preservableContent?: PreservableContent,
  teachableMoments?: TeachableMoment[]  // NEW parameter
): string
```

3. Inside `getSystemInstructionForMode()`, build teachable moment rules:
```typescript
const teachableMomentRules = teachableMoments && teachableMoments.length > 0
  ? getTeachableMomentRules(teachableMoments)
  : '';
```

4. Add `teachableMomentRules` to the system instruction template (after preservationRules, before teleprompterRules):
```typescript
${preservationRules}

${teachableMomentRules}

${teleprompterRules}
```

5. In `generateLessonSlides()`, detect teachable moments and pass to system instruction:
```typescript
// After detecting preservable content
const detectedContent = detectPreservableContent(sourceText);

// NEW: Detect teachable moments
const teachableMoments = detectTeachableMoments(sourceText);

// Debug logging
if (teachableMoments.length > 0) {
  console.log(`[GeminiService] Detected ${teachableMoments.length} teachable moments`);
  teachableMoments.forEach(tm => {
    console.log(`  - ${tm.contentCategory}: ${tm.problem.text.substring(0, 50)}...`);
  });
}

// Pass to system instruction
const systemInstruction = getSystemInstructionForMode(
  input.mode,
  input.verbosity,
  input.gradeLevel,
  detectedContent,
  teachableMoments  // NEW parameter
);
```
  </action>
  <verify>
```bash
grep -n "import.*detectTeachableMoments" services/geminiService.ts
grep -n "import.*getTeachableMomentRules" services/geminiService.ts
grep -n "teachableMoments.*detectTeachableMoments" services/geminiService.ts
npx tsc --noEmit services/geminiService.ts
```
All imports present, detection called, TypeScript compiles.
  </verify>
  <done>
geminiService.ts imports detection and rules functions, calls detectTeachableMoments in generateLessonSlides, passes teachable moments to getSystemInstructionForMode, includes rules in system prompt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate teachable moments into claudeProvider.ts</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
Apply the same integration pattern to `services/providers/claudeProvider.ts`.

1. Add imports at the top of the file:
```typescript
import { detectTeachableMoments } from '../contentPreservation/detector';
import { TeachableMoment } from '../contentPreservation/types';
import { getTeachableMomentRules } from '../prompts/teachableMomentRules';
```

2. Modify `getSystemPromptForMode()` signature (note: Claude uses `getSystemPromptForMode`, not `getSystemInstructionForMode`):
```typescript
function getSystemPromptForMode(
  mode: GenerationMode,
  verbosity: VerbosityLevel = 'standard',
  gradeLevel: string = 'Year 6 (10-11 years old)',
  preservableContent?: PreservableContent,
  teachableMoments?: TeachableMoment[]  // NEW parameter
): string
```

3. Inside `getSystemPromptForMode()`, build teachable moment rules:
```typescript
const teachableMomentRules = teachableMoments && teachableMoments.length > 0
  ? getTeachableMomentRules(teachableMoments)
  : '';
```

4. Add `teachableMomentRules` to each mode's system prompt template (after preservationRules, before teleprompterRules). The pattern is the same for fresh, refine, and blend modes.

5. In `generateLessonSlides()` method of `ClaudeProvider` class:
```typescript
// After detecting preservable content
const detectedContent = detectPreservableContent(sourceText);

// NEW: Detect teachable moments
const teachableMoments = detectTeachableMoments(sourceText);

// Debug logging
if (teachableMoments.length > 0) {
  console.log(`[ClaudeProvider] Detected ${teachableMoments.length} teachable moments`);
  teachableMoments.forEach(tm => {
    console.log(`  - ${tm.contentCategory}: ${tm.problem.text.substring(0, 50)}...`);
  });
}

// Pass to system prompt
const systemPrompt = getSystemPromptForMode(
  input.mode,
  input.verbosity,
  input.gradeLevel,
  detectedContent,
  teachableMoments  // NEW parameter
);
```
  </action>
  <verify>
```bash
grep -n "import.*detectTeachableMoments" services/providers/claudeProvider.ts
grep -n "import.*getTeachableMomentRules" services/providers/claudeProvider.ts
grep -n "teachableMoments.*detectTeachableMoments" services/providers/claudeProvider.ts
npx tsc --noEmit services/providers/claudeProvider.ts
```
All imports present, detection called, TypeScript compiles.
  </verify>
  <done>
claudeProvider.ts imports detection and rules functions, calls detectTeachableMoments in generateLessonSlides, passes teachable moments to getSystemPromptForMode, includes rules in system prompt.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify build and type safety</name>
  <files>services/geminiService.ts, services/providers/claudeProvider.ts</files>
  <action>
Run full TypeScript compilation to ensure no type errors across the integration.

1. Compile the project:
```bash
npx tsc --noEmit
```

2. If there are errors, fix them. Common issues:
   - Import path typos (e.g., `../` vs `./`)
   - Missing type imports
   - Function signature mismatches

3. Run any existing tests to ensure no regressions:
```bash
npm test
```

4. Verify the detection export is available:
```bash
grep -n "export.*detectTeachableMoments" services/contentPreservation/detector.ts
```
  </action>
  <verify>
```bash
npx tsc --noEmit
npm test 2>&1 | tail -20
```
TypeScript compiles without errors. Tests pass.
  </verify>
  <done>
Full project compiles without TypeScript errors. All existing tests pass. Integration is type-safe.
  </done>
</task>

</tasks>

<verification>
1. Both providers import `detectTeachableMoments` and `getTeachableMomentRules`
2. Both providers call `detectTeachableMoments(sourceText)` in their `generateLessonSlides` method
3. Both providers pass `teachableMoments` to their system prompt builder function
4. System prompts include teachable moment rules when moments are detected
5. TypeScript compiles: `npx tsc --noEmit`
6. Tests pass: `npm test`
</verification>

<success_criteria>
- RST-01: Split problem/answer into separate progressive bullets during generation (via prompt rules)
- RST-02: Problem bullet appears first with no answer leakage (via explicit examples in prompt)
- RST-03: Answer bullet appears as next progressive reveal (via prompt structure)
- RST-04: Maintain natural lesson flow (via NATURAL FLOW section in prompt)
- SCF-01: Generate strategy steps in teleprompter between problem and answer (via scaffolding templates)
- SCF-02: Include 2-3 question prompts per delayed answer (via template constraints)
- SCF-03: Scaffolding matches content complexity (via content-specific templates)

Teacher sees scaffolding strategies regardless of which AI provider (Gemini or Claude) generates the slides.
</success_criteria>

<output>
After completion, create `.planning/phases/52-prompt-engineering-core/52-02-SUMMARY.md`
</output>
