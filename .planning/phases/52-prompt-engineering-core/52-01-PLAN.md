---
phase: 52-prompt-engineering-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/prompts/teachableMomentRules.ts
autonomous: true

must_haves:
  truths:
    - "Teachable moment rules instruct AI to split problem/answer into separate bullets"
    - "Rules include content-specific scaffolding templates for math, vocabulary, comprehension, science"
    - "Rules specify 2-3 question prompts per teachable moment"
    - "Rules enforce vocabulary definitions without repeating the word"
    - "Rules maintain teleprompter segment count (Segments = Bullets + 1)"
    - "Rules include confirmation segment after answer reveal"
  artifacts:
    - path: "services/prompts/teachableMomentRules.ts"
      provides: "getTeachableMomentRules function and scaffolding templates"
      exports: ["getTeachableMomentRules"]
      min_lines: 100
  key_links:
    - from: "services/prompts/teachableMomentRules.ts"
      to: "services/contentPreservation/types.ts"
      via: "imports TeachableMoment, ContentCategory"
      pattern: "import.*TeachableMoment.*from"
---

<objective>
Create the teachable moment prompt rules that instruct AI to split problem/answer pairs into separate bullets with scaffolding guidance in the teleprompter.

Purpose: This file provides the core prompt engineering for the delay answer reveal feature. It defines how AI should format problem bullets (no answer leakage), answer bullets (as next reveal), and teleprompter scaffolding (content-specific strategies).

Output: `services/prompts/teachableMomentRules.ts` with `getTeachableMomentRules()` function that generates XML-tagged instructions based on detected teachable moments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/52-prompt-engineering-core/52-CONTEXT.md
@.planning/phases/52-prompt-engineering-core/52-RESEARCH.md
@.planning/phases/51-detection-foundation/51-01-SUMMARY.md
@.planning/phases/51-detection-foundation/51-02-SUMMARY.md

@services/contentPreservation/types.ts
@services/prompts/contentPreservationRules.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scaffolding template constants</name>
  <files>services/prompts/teachableMomentRules.ts</files>
  <action>
Create `services/prompts/teachableMomentRules.ts` with content-specific scaffolding templates.

Define these template constants:

1. `MATH_SCAFFOLDING_TEMPLATE`: Break into known vs unknown, step-by-step thinking prompts, visual/manipulative suggestions. Example: "What do we know? What are we trying to find? Can we draw this?"

2. `VOCABULARY_SCAFFOLDING_TEMPLATE`: Context clues, word breakdown (prefix/root/suffix), real-world examples. Example: "Look at the word. What parts do you recognize? Where might you use this word?"
**CRITICAL - Locked Decision:** Answer bullet shows definition ONLY, does NOT repeat the vocabulary word. Include explicit documentation comment in the template: "// NOTE: Definition must NOT repeat the vocabulary word - definition only"

3. `COMPREHENSION_SCAFFOLDING_TEMPLATE`: Text evidence prompts, reasoning/inference, connection to prior knowledge. Example: "What clues from the passage support your answer? Where have we seen this before?"

4. `SCIENCE_SCAFFOLDING_TEMPLATE`: Observation prompts, prediction/hypothesis, real-world connection. Example: "What do you observe? What do you think will happen? Why?"

5. `GENERAL_SCAFFOLDING_TEMPLATE`: Fallback for unclassified content. Think-pair-share structure.

Each template should include:
- 2-3 question prompt examples
- [PAUSE] timing cues
- Format guidance (brief, actionable prompts)
  </action>
  <verify>
```bash
# Verify file exists with all 5 templates
grep -n "MATH_SCAFFOLDING_TEMPLATE" services/prompts/teachableMomentRules.ts
grep -n "VOCABULARY_SCAFFOLDING_TEMPLATE" services/prompts/teachableMomentRules.ts
grep -n "COMPREHENSION_SCAFFOLDING_TEMPLATE" services/prompts/teachableMomentRules.ts
grep -n "SCIENCE_SCAFFOLDING_TEMPLATE" services/prompts/teachableMomentRules.ts
grep -n "GENERAL_SCAFFOLDING_TEMPLATE" services/prompts/teachableMomentRules.ts

# CRITICAL: Verify locked decision is documented
grep -n "NOT repeat\|without repeating\|definition only" services/prompts/teachableMomentRules.ts
```
All 5 template constants defined. Vocabulary template contains "NOT repeat" or equivalent documentation.
  </verify>
  <done>
Five scaffolding template constants exist with content-specific strategies and example prompts. Vocabulary template explicitly documents that definition must NOT repeat the word.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create getTeachableMomentRules function</name>
  <files>services/prompts/teachableMomentRules.ts</files>
  <action>
Add the main `getTeachableMomentRules(teachableMoments: TeachableMoment[]): string` function.

Import from contentPreservation types:
```typescript
import { TeachableMoment, ContentCategory } from '../contentPreservation/types';
```

Function logic:
1. Return empty string if `teachableMoments.length === 0` (don't clutter prompt)
2. Extract unique content categories from the moments
3. Build the rules string with these sections:

**BULLET STRUCTURE (MANDATORY):**
- Problem bullet: Contains ONLY the question/problem. NO answer text.
- Answer bullet: The immediately following bullet. Contains the answer/solution.
- Problem and answer are ALWAYS consecutive bullets on the SAME slide.
- Never combine problem and answer in one bullet (answer leakage).

**EXAMPLES (before/after):**
- Math example: Input "What is 3/4 of 12? The answer is 9." -> Correct split: Bullet 3: "What is 3/4 of 12?" Bullet 4: "The answer is 9"
- Vocabulary example: Input "Photosynthesis: The process plants use to make food from sunlight." -> Correct split: Bullet 5: "Photosynthesis" Bullet 6: "The process plants use to make food from sunlight" (NO word repetition in definition)

**TELEPROMPTER SCAFFOLDING:**
- Segment AFTER problem bullet (BEFORE answer reveal) contains scaffolding guidance
- Format: 2-3 question prompts with [PAUSE] timing cue
- Include only the templates for categories present in detected moments

**TELEPROMPTER CONFIRMATION:**
(This is a section within the getTeachableMomentRules output string, not a separate function)
- Segment AFTER answer bullet celebrates/extends learning
- Format: Acknowledgment + common misconception or extension
- Example output in rules: "After revealing the answer, your teleprompter should include a brief confirmation like 'Great! The key here is...' or address a common misconception."

**NATURAL FLOW:**
- Transitions between problem, scaffolding, and answer should feel natural
- Avoid abrupt changes in tone

Use template string interpolation to conditionally include scaffolding templates based on detected categories.
  </action>
  <verify>
```bash
grep -n "export function getTeachableMomentRules" services/prompts/teachableMomentRules.ts
grep -n "BULLET STRUCTURE" services/prompts/teachableMomentRules.ts
grep -n "TELEPROMPTER SCAFFOLDING" services/prompts/teachableMomentRules.ts
grep -n "TELEPROMPTER CONFIRMATION\|After revealing the answer\|confirmation" services/prompts/teachableMomentRules.ts
```
All four patterns should be found (including confirmation section in output).
  </verify>
  <done>
`getTeachableMomentRules` function exists, imports TeachableMoment type, returns empty string for empty array, builds rules with bullet structure, examples, scaffolding templates, confirmation guidance (as part of output string), and flow guidance.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add few-shot examples for edge cases</name>
  <files>services/prompts/teachableMomentRules.ts</files>
  <action>
Add a `TEACHABLE_MOMENT_EXAMPLES` constant with XML-tagged examples (following the pattern from `contentPreservationRules.ts`).

Include edge case examples:

1. **Multi-part math problem**: Shows handling of "What is 3 + 4 = 7 and 5 + 6 = 11" -> Split into separate problem/answer pairs

2. **Vocabulary in context**: Shows handling when word appears in a sentence vs standalone

3. **Rhetorical question**: Shows that rhetorical questions (no real answer expected) should NOT be split

4. **Multiple teachable moments on one slide**: Shows sequencing when slide has 2+ problem-answer pairs

Include these examples in the output of `getTeachableMomentRules` (after the scaffolding templates section).

Export the function from the module.
  </action>
  <verify>
```bash
grep -n "TEACHABLE_MOMENT_EXAMPLES" services/prompts/teachableMomentRules.ts
grep -n "export.*getTeachableMomentRules" services/prompts/teachableMomentRules.ts
```
Both patterns should be found.
  </verify>
  <done>
Few-shot examples constant exists with edge cases. Function is exported. File compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. File exists: `services/prompts/teachableMomentRules.ts`
2. TypeScript compiles: `npx tsc --noEmit services/prompts/teachableMomentRules.ts`
3. Export is correct: `grep "export function getTeachableMomentRules" services/prompts/teachableMomentRules.ts`
4. All 5 scaffolding templates defined
5. Vocabulary template documents "NOT repeat" constraint
6. Confirmation section exists in rules output
7. Function returns empty string for empty array
8. Function returns rules string for non-empty array
</verification>

<success_criteria>
- `getTeachableMomentRules([])` returns `''`
- `getTeachableMomentRules([{...math moment}])` returns string containing MATH_SCAFFOLDING_TEMPLATE content
- Function includes bullet structure rules, examples, scaffolding templates, confirmation guidance
- Vocabulary template explicitly states definition should NOT repeat the word
- Confirmation section instructs teleprompter content after answer reveal
- All content compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/52-prompt-engineering-core/52-01-SUMMARY.md`
</output>
