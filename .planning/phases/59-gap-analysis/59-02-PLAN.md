---
phase: 59-gap-analysis
plan: 02
type: execute
wave: 2
depends_on: ["59-01"]
files_modified:
  - services/providers/claudeProvider.ts
  - components/GapAnalysisPanel.tsx
autonomous: true

must_haves:
  truths:
    - "ClaudeProvider.analyzeGaps sends deck context + lesson plan text + page images via tool_choice and returns structured GapAnalysisResult"
    - "ClaudeProvider.generateSlideFromGap returns a full Slide with teleprompter-compliant speaker notes"
    - "GapAnalysisPanel displays gaps sorted by severity with colored badges (red/amber/gray)"
    - "Each gap in the panel shows topic, description, suggested content preview, and an Add Slide button"
    - "Panel has a summary banner showing coverage percentage and gap count"
    - "Panel has Re-analyze and Close buttons"
  artifacts:
    - path: "services/providers/claudeProvider.ts"
      provides: "analyzeGaps and generateSlideFromGap implementations for Claude"
      contains: "analyzeGaps"
    - path: "components/GapAnalysisPanel.tsx"
      provides: "Side panel component for gap list display"
      contains: "GapAnalysisPanel"
  key_links:
    - from: "services/providers/claudeProvider.ts"
      to: "services/prompts/gapAnalysisPrompts.ts"
      via: "imports GAP_ANALYSIS_SYSTEM_PROMPT, GAP_ANALYSIS_TOOL, buildGapSlideGenerationPrompt, GAP_SLIDE_TOOL"
      pattern: "import.*gapAnalysisPrompts"
    - from: "components/GapAnalysisPanel.tsx"
      to: "services/aiProvider.ts"
      via: "imports GapAnalysisResult, IdentifiedGap, GapSeverity types"
      pattern: "import.*GapAnalysisResult"
---

<objective>
Implement Claude provider gap analysis methods and create the GapAnalysisPanel UI component.

Purpose: Completes dual-provider support (Gemini from Plan 01 + Claude here) and builds the visual gap list that Plan 03 will wire into App.tsx.

Output: Working Claude `analyzeGaps` + `generateSlideFromGap` methods, and a `GapAnalysisPanel.tsx` component ready for integration.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-gap-analysis/59-RESEARCH.md
@.planning/phases/59-gap-analysis/59-01-SUMMARY.md
@services/aiProvider.ts
@services/prompts/gapAnalysisPrompts.ts
@services/providers/claudeProvider.ts
@components/CohesionPreview.tsx
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Claude analyzeGaps and generateSlideFromGap</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
Add two methods to `ClaudeProvider` class, following the exact pattern of `makeDeckCohesive` in the same file.

**Import** at top of file (add to existing imports from gapAnalysisPrompts):
```typescript
import {
  GAP_ANALYSIS_SYSTEM_PROMPT,
  buildGapAnalysisUserPrompt,
  buildGapAnalysisContext,
  GAP_ANALYSIS_TOOL,
  buildGapSlideGenerationPrompt,
  GAP_SLIDE_TOOL
} from '../prompts/gapAnalysisPrompts';
```

Import `GapAnalysisResult, IdentifiedGap` from `../aiProvider`.

**Method 1: `analyzeGaps`**

Follow the `makeDeckCohesive` Claude pattern exactly:

```typescript
async analyzeGaps(
  slides: Slide[],
  lessonPlanText: string,
  lessonPlanImages: string[],
  gradeLevel: string
): Promise<GapAnalysisResult> {
```

1. Build context with `buildGapAnalysisContext(slides, lessonPlanText)`
2. Build user prompt with `buildGapAnalysisUserPrompt(gradeLevel)`
3. Build the `content` array for the message:
   - Start with a text block: `{ type: 'text', text: userPrompt + '\n\n' + context }`
   - If `lessonPlanImages.length > 0`, append up to 5 image blocks: `{ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: img } }`
4. POST to `https://api.anthropic.com/v1/messages` with:
   - Headers: same as makeDeckCohesive (Content-Type, x-api-key, anthropic-version, anthropic-dangerous-direct-browser-access)
   - Body: `{ model: this.model, max_tokens: 8192, system: GAP_ANALYSIS_SYSTEM_PROMPT, tools: [GAP_ANALYSIS_TOOL], tool_choice: { type: 'tool', name: 'analyze_gaps' }, messages: [{ role: 'user', content: contentArray }] }`
5. Check `response.ok`, throw `AIProviderError` with `this.getErrorCode(response.status)` if not
6. Extract tool_use result: `data.content?.find((c: any) => c.type === 'tool_use')?.input`
7. If no tool result, throw PARSE_ERROR
8. Return: `{ gaps: result.gaps || [], summary: result.summary || 'Gap analysis complete', coveragePercentage: result.coveragePercentage ?? 0 }`
9. Wrap in try/catch. Log as `[ClaudeProvider] analyzeGaps error:`. If error is already AIProviderError, re-throw; otherwise wrap in UNKNOWN_ERROR.

**Method 2: `generateSlideFromGap`**

Follow the `makeDeckCohesive` tool_choice pattern but for single slide output:

```typescript
async generateSlideFromGap(
  gap: IdentifiedGap,
  slides: Slide[],
  lessonTopic: string,
  verbosity: VerbosityLevel
): Promise<Slide> {
```

1. Build prompt with `buildGapSlideGenerationPrompt(gap, 'Year 6 (10-11 years old)', verbosity)`
2. Import and use `buildDeckContextForCohesion` from cohesionPrompts for deck context
3. Append deck context: `prompt + '\n\nEXISTING DECK CONTEXT:\n' + buildDeckContextForCohesion(slides) + '\n\nLESSON TOPIC: ' + lessonTopic`
4. POST to Claude API with:
   - `max_tokens: 4096` (single slide needs less)
   - `tools: [GAP_SLIDE_TOOL]`
   - `tool_choice: { type: 'tool', name: 'generate_gap_slide' }`
   - `messages: [{ role: 'user', content: prompt }]`
   - No system prompt needed (instructions are in the user prompt from `buildGapSlideGenerationPrompt`)
5. Extract tool_use input, build Slide:
   ```typescript
   return {
     id: `gap-gen-${Date.now()}`,
     title: result.title || gap.suggestedTitle,
     content: result.content || gap.suggestedContent,
     speakerNotes: result.speakerNotes || '',
     imagePrompt: result.imagePrompt || `Educational illustration: ${gap.topic}`,
     layout: result.layout || 'split',
     source: { type: 'ai-generated' as const }
   };
   ```
6. Wrap in try/catch. Log as `[ClaudeProvider] generateSlideFromGap error:`. Same error handling pattern.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Should compile cleanly with zero errors (both Gemini and Claude now implement all interface methods).
  </verify>
  <done>
ClaudeProvider has working `analyzeGaps` (sends multimodal content with tool_choice `analyze_gaps`) and `generateSlideFromGap` (uses tool_choice `generate_gap_slide` for structured single-slide output). Both follow the established Claude fetch + tool_use extraction pattern. TypeScript compiles with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GapAnalysisPanel component</name>
  <files>components/GapAnalysisPanel.tsx</files>
  <action>
Create a new React component `GapAnalysisPanel.tsx` that displays gap analysis results as a side panel.

**Imports:**
```typescript
import React from 'react';
import { GapAnalysisResult, IdentifiedGap, GapSeverity } from '../services/aiProvider';
```

**Props Interface:**
```typescript
interface GapAnalysisPanelProps {
  result: GapAnalysisResult;
  onAddSlide: (gap: IdentifiedGap) => void;
  onReanalyze: () => void;
  onClose: () => void;
  generatingGapId: string | null;  // Currently generating gap (for spinner)
}
```

**Severity Config** (for badges):
```typescript
const severityConfig: Record<GapSeverity, { label: string; bg: string; text: string; order: number }> = {
  'critical': {
    label: 'Critical',
    bg: 'bg-red-100 dark:bg-red-900/30',
    text: 'text-red-600 dark:text-red-400',
    order: 0
  },
  'recommended': {
    label: 'Recommended',
    bg: 'bg-amber-100 dark:bg-amber-900/30',
    text: 'text-amber-600 dark:text-amber-400',
    order: 1
  },
  'nice-to-have': {
    label: 'Nice to Have',
    bg: 'bg-slate-100 dark:bg-slate-700',
    text: 'text-slate-500 dark:text-slate-400',
    order: 2
  }
};
```

**Component Structure:**

The panel is a fixed-position right-side panel that overlays the editor area. Use this outer container:
```
fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 shadow-2xl border-l border-slate-200 dark:border-slate-700 z-50 flex flex-col
```

**1. Header Section** (sticky top):
- Title: "Gap Analysis" with a close button (X icon) on the right
- Summary banner below: Show `result.summary` in a small text block
- Coverage bar: A thin progress bar showing `result.coveragePercentage`% filled with green gradient. Display text like "~{percentage}% covered"

**2. Gap Count Summary:**
- Show count by severity: "{N} critical, {N} recommended, {N} nice-to-have" with colored dots
- Only show categories that have gaps

**3. Gap List** (scrollable, `flex-1 overflow-y-auto`):
Sort gaps by severity order (critical first, then recommended, then nice-to-have).

Each gap card:
- **Severity badge**: Colored pill using `severityConfig[gap.severity]`
- **Topic title**: `gap.topic` in bold, medium text
- **Description**: `gap.description` in smaller muted text
- **Suggested content preview**: Collapsed by default, expandable. Show `gap.suggestedTitle` as proposed title and first 3 bullets of `gap.suggestedContent` as a preview list
- **Lesson plan excerpt**: Small italic quote: `gap.relatedLessonPlanExcerpt`
- **Add Slide button**: Teal/emerald gradient button (distinct from cohesion purple). Text: "Add Slide". When `generatingGapId === gap.id`, show spinner + "Generating...". When `generatingGapId` is non-null but different gap, disable button.
- **Position hint**: Small text "Insert at position {gap.suggestedPosition + 1}" in muted gray

Use a bottom border between gaps. Give each gap card `p-3` padding.

**4. Footer Section** (sticky bottom):
- "Re-analyze" button: Outline style, triggers `onReanalyze`
- Show "Results may be outdated if you've made changes" in small muted text

**Empty State:**
If `result.gaps.length === 0`, show a success message: "Great coverage! Your deck covers the lesson plan well." with a checkmark icon and the coverage percentage.

**Expand/Collapse for Suggested Content:**
Use local state `expandedGaps: Set<string>` to track which gap IDs have their suggested content expanded. Toggle on click of a "Show suggested content" / "Hide" button.

Export as default: `export default GapAnalysisPanel;`
  </action>
  <verify>
Run `npx tsc --noEmit`. GapAnalysisPanel.tsx should compile cleanly. Verify the component file exists and exports GapAnalysisPanel as default.
  </verify>
  <done>
GapAnalysisPanel.tsx exists with: severity badges (red/amber/gray), sorted gap list, summary banner with coverage bar, expandable suggested content previews, Add Slide buttons with loading state, Re-analyze button, Close button, and empty-state success message. Component accepts result, onAddSlide, onReanalyze, onClose, and generatingGapId props.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. ClaudeProvider.analyzeGaps sends multimodal content (text + images) with tool_choice
3. ClaudeProvider.generateSlideFromGap uses GAP_SLIDE_TOOL for structured output
4. GapAnalysisPanel renders gaps sorted by severity (critical -> recommended -> nice-to-have)
5. Each gap card has severity badge, topic, description, expandable preview, and Add Slide button
6. Panel has summary banner, coverage bar, Re-analyze button, and Close button
</verification>

<success_criteria>
- Claude analyzeGaps sends up to 5 page images as base64 image blocks
- Claude generateSlideFromGap returns Slide with source: { type: 'ai-generated' }
- GapAnalysisPanel shows coverage percentage with visual bar
- Add Slide button shows spinner when generatingGapId matches
- Panel is fixed-position right-side overlay (w-80, z-50)
- Empty gaps state shows success message instead of empty list
</success_criteria>

<output>
After completion, create `.planning/phases/59-gap-analysis/59-02-SUMMARY.md`
</output>
