---
phase: 59-gap-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/prompts/gapAnalysisPrompts.ts
  - services/aiProvider.ts
  - services/providers/geminiProvider.ts
autonomous: true

must_haves:
  truths:
    - "GapAnalysisResult and IdentifiedGap types exist and are exported from aiProvider.ts"
    - "GAP_ANALYSIS_SYSTEM_PROMPT instructs AI to compare deck vs lesson plan at topic level"
    - "Gemini responseSchema enforces structured gap output with severity enum"
    - "Claude tool schema matches Gemini schema structure for dual-provider parity"
    - "analyzeGaps and generateSlideFromGap methods exist on AIProviderInterface"
    - "GeminiProvider.analyzeGaps accepts slides + lesson plan text + page images and returns structured GapAnalysisResult"
    - "GeminiProvider.generateSlideFromGap accepts a gap and returns a full Slide with teleprompter-compliant speaker notes"
  artifacts:
    - path: "services/prompts/gapAnalysisPrompts.ts"
      provides: "System prompt, user prompt builder, Gemini schema, Claude tool, slide generation prompt"
      contains: "GAP_ANALYSIS_SYSTEM_PROMPT"
    - path: "services/aiProvider.ts"
      provides: "GapAnalysisResult, IdentifiedGap, GapSeverity types + interface methods"
      exports: ["GapAnalysisResult", "IdentifiedGap", "GapSeverity"]
    - path: "services/providers/geminiProvider.ts"
      provides: "analyzeGaps and generateSlideFromGap implementations"
      contains: "analyzeGaps"
  key_links:
    - from: "services/providers/geminiProvider.ts"
      to: "services/prompts/gapAnalysisPrompts.ts"
      via: "imports GAP_ANALYSIS_SYSTEM_PROMPT, schema, prompt builder"
      pattern: "import.*gapAnalysisPrompts"
    - from: "services/providers/geminiProvider.ts"
      to: "services/prompts/cohesionPrompts.ts"
      via: "imports buildDeckContextForCohesion for deck serialization"
      pattern: "buildDeckContextForCohesion"
    - from: "services/aiProvider.ts"
      to: "services/prompts/gapAnalysisPrompts.ts"
      via: "re-exports GapAnalysisResult types"
      pattern: "GapAnalysisResult"
---

<objective>
Create the gap analysis AI infrastructure: types, prompts, structured output schemas, and Gemini provider implementation.

Purpose: Establishes the AI contract for comparing a slide deck against a lesson plan PDF to identify missing topics. This is the foundation Plan 02 (Claude) and Plan 03 (App.tsx) build on.

Output: New `gapAnalysisPrompts.ts` file with dual-schema prompts, gap types on `aiProvider.ts`, and working Gemini `analyzeGaps` + `generateSlideFromGap` methods.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-gap-analysis/59-RESEARCH.md
@services/aiProvider.ts
@services/prompts/cohesionPrompts.ts
@services/providers/geminiProvider.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gap analysis prompts, schemas, and types</name>
  <files>services/prompts/gapAnalysisPrompts.ts, services/aiProvider.ts</files>
  <action>
**1. Create `services/prompts/gapAnalysisPrompts.ts`** (new file)

Follow the exact structure of `cohesionPrompts.ts`. Import `{ Type }` from `@google/genai`, `{ Slide }` from `../../types`, and `{ VerbosityLevel }` from `../geminiService`.

**Section 1: System Prompt** — `GAP_ANALYSIS_SYSTEM_PROMPT`

```
You are an expert educational content analyst for Cue, a presentation app for primary school teachers (Year 6, ages 10-11, Australian curriculum).

YOUR TASK:
Compare an existing slide deck against a lesson plan to identify missing topics, concepts, and activities.

ANALYSIS RULES:
1. Focus on TOPIC-LEVEL gaps, not word-level differences
2. A "gap" is a concept, skill, activity, or objective in the lesson plan that has NO corresponding slide
3. If a deck slide partially covers a lesson plan topic, it is NOT a gap (mention partial coverage in the summary instead)
4. Maximum 10 gaps -- prioritize by educational importance
5. If the deck already covers the lesson plan well, return an empty gaps array with high coveragePercentage

SEVERITY CLASSIFICATION:
- "critical": Core learning objective or key concept that the lesson plan explicitly requires. Missing this would leave a major hole in the lesson.
- "recommended": Supporting concept, example, or activity that strengthens the lesson. The lesson still works without it but would be weaker.
- "nice-to-have": Enrichment activity, extension task, or supplementary detail. Useful but not essential.

SUGGESTED POSITION:
- For each gap, suggest where in the EXISTING deck it would fit best (0-indexed)
- Place it after the most related existing slide
- If no good fit, suggest the end of the deck (index = total slides)

SUGGESTED CONTENT:
- Provide a title and 3-5 bullet points for each gap
- Content should match the deck's existing tone and complexity level
- Do NOT generate speaker notes or image prompts in this phase
```

**Section 2: User Prompt Builder** — `buildGapAnalysisUserPrompt(gradeLevel: string): string`

Return a prompt that instructs the AI to:
1. Read the lesson plan carefully -- identify all key concepts, learning objectives, and activities
2. Read each slide in the deck -- note what topics are already covered
3. Identify gaps: lesson plan topics with NO corresponding slide coverage
4. Rank each gap by severity (critical / recommended / nice-to-have)
5. Suggest where each gap slide would fit best in the existing deck order
6. Suggest a title and 3-5 bullet points for each missing slide
Include `gradeLevel` in the prompt text.

**Section 3: Context Builder** — `buildGapAnalysisContext(slides: Slide[], lessonPlanText: string): string`

Import `buildDeckContextForCohesion` from `./cohesionPrompts`. Combine:
- `=== EXISTING SLIDE DECK ===\n\n{deckContext}`
- `=== LESSON PLAN ===\n\n{lessonPlanText truncated to 8000 chars}`
If truncated, append `[Lesson plan truncated -- showing first 8000 characters]`.

**Section 4: Gemini Response Schema** — `GAP_ANALYSIS_RESPONSE_SCHEMA`

Use `Type` from `@google/genai`. Structure:
```
{
  type: Type.OBJECT,
  properties: {
    summary: { type: Type.STRING, description: 'Overall coverage assessment (1-2 sentences)' },
    coveragePercentage: { type: Type.NUMBER, description: 'Estimated percentage of lesson plan covered (0-100)' },
    gaps: {
      type: Type.ARRAY,
      items: {
        type: Type.OBJECT,
        properties: {
          id: { type: Type.STRING, description: 'Unique gap identifier (e.g., "gap-1")' },
          topic: { type: Type.STRING, description: 'Missing topic name (3-8 words)' },
          description: { type: Type.STRING, description: 'Why this is missing (1-2 sentences)' },
          severity: { type: Type.STRING, enum: ['critical', 'recommended', 'nice-to-have'] },
          suggestedTitle: { type: Type.STRING, description: 'Proposed slide title (max 10 words)' },
          suggestedContent: { type: Type.ARRAY, items: { type: Type.STRING }, description: '3-5 bullet points' },
          suggestedPosition: { type: Type.NUMBER, description: '0-indexed insertion position' },
          relatedLessonPlanExcerpt: { type: Type.STRING, description: 'Brief quote from lesson plan' }
        },
        required: ['id', 'topic', 'description', 'severity', 'suggestedTitle', 'suggestedContent', 'suggestedPosition', 'relatedLessonPlanExcerpt']
      }
    }
  },
  required: ['summary', 'coveragePercentage', 'gaps']
}
```

**Section 5: Claude Tool Schema** — `GAP_ANALYSIS_TOOL`

Mirror the Gemini schema as a JSON Schema object with `name: 'analyze_gaps'` and `description: 'Compare a slide deck against a lesson plan and identify missing topics'`. Use `type: 'object' as const` pattern matching `COHESION_TOOL`.

**Section 6: Gap Slide Generation Prompt** — `buildGapSlideGenerationPrompt(gap: IdentifiedGap, gradeLevel: string, verbosity: VerbosityLevel): string`

Create a prompt that generates a full slide from a gap. Include:
- The gap's topic, description, suggestedTitle, suggestedContent, and relatedLessonPlanExcerpt
- Grade level and verbosity level
- The TELEPROMPTER NOTES FORMAT rules (copy the exact rules from `COHESION_SYSTEM_PROMPT`: segment 0 intro, segment N per bullet, pointer emoji delimiter, segment count = bullet count + 1, never preview upcoming bullets, never repeat slide text)
- Verbosity-specific instructions: concise = 2-3 short phrases per segment; standard = 1-2 sentences per segment; detailed = 3-5 sentences per segment
- Return format: JSON with title, content (string[]), speakerNotes, imagePrompt, layout (suggest 'split' unless content is purely visual)

**Section 7: Gemini Slide Generation Schema** — `GAP_SLIDE_RESPONSE_SCHEMA`

Schema for single slide generation:
```
{
  type: Type.OBJECT,
  properties: {
    title: { type: Type.STRING },
    content: { type: Type.ARRAY, items: { type: Type.STRING } },
    speakerNotes: { type: Type.STRING },
    imagePrompt: { type: Type.STRING },
    layout: { type: Type.STRING, enum: ['split', 'full-image', 'center-text'] }
  },
  required: ['title', 'content', 'speakerNotes', 'imagePrompt', 'layout']
}
```

**Section 8: Claude Slide Generation Tool** — `GAP_SLIDE_TOOL`

Mirror schema 7 as Claude tool with `name: 'generate_gap_slide'`.

**2. Add types to `services/aiProvider.ts`**

Add after the existing `CohesionResult` interface block:

```typescript
// Gap Analysis types for deck-vs-lesson-plan comparison (Phase 59)
export type GapSeverity = 'critical' | 'recommended' | 'nice-to-have';

export interface IdentifiedGap {
  id: string;
  topic: string;
  description: string;
  severity: GapSeverity;
  suggestedTitle: string;
  suggestedContent: string[];
  suggestedPosition: number;
  relatedLessonPlanExcerpt: string;
}

export interface GapAnalysisResult {
  gaps: IdentifiedGap[];
  summary: string;
  coveragePercentage: number;
}
```

Add two methods to `AIProviderInterface`:

```typescript
// Analyze gaps between deck and lesson plan (Phase 59)
analyzeGaps(
  slides: Slide[],
  lessonPlanText: string,
  lessonPlanImages: string[],
  gradeLevel: string
): Promise<GapAnalysisResult>;

// Generate a full slide from an identified gap (Phase 59)
generateSlideFromGap(
  gap: IdentifiedGap,
  slides: Slide[],
  lessonTopic: string,
  verbosity: VerbosityLevel
): Promise<Slide>;
```

Import `IdentifiedGap` type in aiProvider.ts if needed (it's defined locally, so just ensure it's exported).
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Expect errors ONLY for missing implementations in geminiProvider.ts and claudeProvider.ts (which is expected at this stage for Claude -- Plan 02 handles that). The types, prompts, and schemas should compile cleanly.
  </verify>
  <done>
gapAnalysisPrompts.ts exists with 8 sections (system prompt, user prompt builder, context builder, Gemini gap schema, Claude gap tool, gap slide generation prompt, Gemini slide schema, Claude slide tool). aiProvider.ts exports GapSeverity, IdentifiedGap, GapAnalysisResult types and has analyzeGaps + generateSlideFromGap on the interface.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Gemini analyzeGaps and generateSlideFromGap</name>
  <files>services/providers/geminiProvider.ts</files>
  <action>
Add two methods to `GeminiProvider` class, following the exact pattern of `makeDeckCohesive`.

**Import** at top of file:
```typescript
import {
  GAP_ANALYSIS_SYSTEM_PROMPT,
  buildGapAnalysisUserPrompt,
  buildGapAnalysisContext,
  GAP_ANALYSIS_RESPONSE_SCHEMA,
  buildGapSlideGenerationPrompt,
  GAP_SLIDE_RESPONSE_SCHEMA
} from '../prompts/gapAnalysisPrompts';
```

Import `GapAnalysisResult, IdentifiedGap` from `../aiProvider`.

**Method 1: `analyzeGaps`**

```typescript
async analyzeGaps(
  slides: Slide[],
  lessonPlanText: string,
  lessonPlanImages: string[],
  gradeLevel: string
): Promise<GapAnalysisResult> {
```

Implementation pattern (follow makeDeckCohesive exactly):
1. Create `new GoogleGenAI({ apiKey: this.apiKey })`
2. Build context with `buildGapAnalysisContext(slides, lessonPlanText)`
3. Build user prompt with `buildGapAnalysisUserPrompt(gradeLevel)`
4. Build contents array: If `lessonPlanImages.length > 0`, build a multimodal contents array with the text as one part and each image (up to 5) as `inlineData` parts with `mimeType: 'image/jpeg'`. If no images, use plain text string.
   - Max 5 page images to control token usage
   - Format: `[{ text: userPrompt + context }, ...images.slice(0,5).map(img => ({ inlineData: { mimeType: 'image/jpeg', data: img } }))]`
5. Call `ai.models.generateContent` with:
   - `model: this.model`
   - `contents` (text or multimodal array)
   - `config: { systemInstruction: GAP_ANALYSIS_SYSTEM_PROMPT, responseMimeType: 'application/json', responseSchema: GAP_ANALYSIS_RESPONSE_SCHEMA, temperature: 0.5 }` (lower temp than cohesion for more consistent analysis)
6. Parse response text as JSON
7. Return `{ gaps: parsed.gaps || [], summary: parsed.summary || 'Gap analysis complete', coveragePercentage: parsed.coveragePercentage ?? 0 }`
8. Wrap in try/catch, log error as `[GeminiProvider] analyzeGaps error:`, throw `this.wrapError(error)`

**Method 2: `generateSlideFromGap`**

```typescript
async generateSlideFromGap(
  gap: IdentifiedGap,
  slides: Slide[],
  lessonTopic: string,
  verbosity: VerbosityLevel
): Promise<Slide> {
```

Implementation pattern (follow generateElaborateSlide):
1. Create `new GoogleGenAI({ apiKey: this.apiKey })`
2. Build prompt with `buildGapSlideGenerationPrompt(gap, 'Year 6 (10-11 years old)', verbosity)`
3. Add deck context: append `\n\nEXISTING DECK CONTEXT (for tone matching):\n${buildDeckContextForCohesion(slides)}\n\nLESSON TOPIC: ${lessonTopic}`
4. Call `ai.models.generateContent` with:
   - `model: this.model`
   - `contents: prompt`
   - `config: { responseMimeType: 'application/json', responseSchema: GAP_SLIDE_RESPONSE_SCHEMA, temperature: 0.7 }`
5. Parse response, build Slide object:
   ```typescript
   const parsed = JSON.parse(response.text || '{}');
   return {
     id: `gap-gen-${Date.now()}`,
     title: parsed.title || gap.suggestedTitle,
     content: parsed.content || gap.suggestedContent,
     speakerNotes: parsed.speakerNotes || '',
     imagePrompt: parsed.imagePrompt || `Educational illustration: ${gap.topic}`,
     layout: parsed.layout || 'split',
     source: { type: 'ai-generated' as const }
   };
   ```
6. Wrap in try/catch, log as `[GeminiProvider] generateSlideFromGap error:`, throw `this.wrapError(error)`
  </action>
  <verify>
Run `npx tsc --noEmit`. The only remaining errors should be in `claudeProvider.ts` for the missing `analyzeGaps` and `generateSlideFromGap` implementations (expected -- Plan 02 handles those). GeminiProvider should compile cleanly.
  </verify>
  <done>
GeminiProvider has working `analyzeGaps` (accepts slides, lesson plan text, page images, grade level; returns GapAnalysisResult with structured gaps) and `generateSlideFromGap` (accepts gap context; returns full Slide with teleprompter-compliant speaker notes). Both follow established patterns (responseSchema, wrapError, GoogleGenAI client).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` produces only claudeProvider.ts errors for missing gap methods (expected)
2. `gapAnalysisPrompts.ts` has all 8 sections: system prompt, user prompt builder, context builder, Gemini gap schema, Claude gap tool, slide generation prompt, Gemini slide schema, Claude slide tool
3. `aiProvider.ts` exports GapSeverity, IdentifiedGap, GapAnalysisResult
4. `AIProviderInterface` has analyzeGaps and generateSlideFromGap methods
5. GeminiProvider.analyzeGaps accepts multimodal input (text + page images)
6. GeminiProvider.generateSlideFromGap returns Slide with all required fields
</verification>

<success_criteria>
- GAP_ANALYSIS_SYSTEM_PROMPT focuses on topic-level gaps (not word-level), caps at 10 gaps, includes severity definitions
- Gemini schema enforces severity enum ['critical', 'recommended', 'nice-to-have']
- buildGapAnalysisContext truncates lesson plan text at 8000 chars
- analyzeGaps sends up to 5 page images as multimodal inlineData
- generateSlideFromGap includes teleprompter rules in prompt (segment count = bullet count + 1)
- TypeScript compiles (minus expected claudeProvider stub errors)
</success_criteria>

<output>
After completion, create `.planning/phases/59-gap-analysis/59-01-SUMMARY.md`
</output>
