---
phase: 70-slide-mapper-pipeline-integration
plan: 02
type: execute
wave: 2
depends_on: [70-01]
files_modified:
  - services/aiProvider.ts
  - services/generationPipeline.ts
  - services/geminiService.ts
  - services/providers/claudeProvider.ts
autonomous: true
requirements: [PIPE-01, PIPE-02, PIPE-05]

must_haves:
  truths:
    - "GenerationMode includes 'scripted' as a valid value"
    - "Scripted mode bypasses all three AI passes and returns slides directly from the mapper"
    - "Existing Fresh, Refine, and Blend modes produce identical output (zero changes to their code paths)"
    - "TypeScript compiles with zero errors after adding scripted to all switch sites"
    - "Pipeline returns PipelineResult with slides from mapper, null coverage, empty remaining gaps"
  artifacts:
    - path: "services/aiProvider.ts"
      provides: "Extended GenerationMode type with 'scripted'"
      contains: "'scripted'"
    - path: "services/generationPipeline.ts"
      provides: "Scripted mode early-return path before Pass 1"
      contains: "input.mode === 'scripted'"
    - path: "services/geminiService.ts"
      provides: "Unreachable 'scripted' cases in all switch statements"
      contains: "case 'scripted'"
    - path: "services/providers/claudeProvider.ts"
      provides: "Unreachable 'scripted' cases in all switch statements"
      contains: "case 'scripted'"
  key_links:
    - from: "services/generationPipeline.ts"
      to: "services/scriptedParser/scriptedMapper.ts"
      via: "imports mapBlocksToSlides for scripted early-return"
      pattern: "import.*mapBlocksToSlides.*scriptedMapper"
    - from: "services/generationPipeline.ts"
      to: "services/scriptedParser/scriptedParser.ts"
      via: "imports parseScriptedLessonPlan for scripted mode"
      pattern: "import.*parseScriptedLessonPlan.*scriptedParser"
    - from: "services/aiProvider.ts"
      to: "services/geminiService.ts"
      via: "GenerationMode type flows through GenerationInput to providers"
      pattern: "GenerationMode"
---

<objective>
Wire the `'scripted'` generation mode into the pipeline so that scripted imports bypass all AI passes and return slides directly from the mapper, while existing modes remain completely unchanged.

Purpose: This connects the mapper (Plan 01) to the app's generation flow. After this plan, calling `runGenerationPipeline` with `mode: 'scripted'` produces slides without any AI calls.

Output: Extended `GenerationMode` type, pipeline early-return path, unreachable provider switch cases. Full regression safety.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/70-slide-mapper-pipeline-integration/70-CONTEXT.md
@.planning/phases/70-slide-mapper-pipeline-integration/70-RESEARCH.md
@.planning/phases/70-slide-mapper-pipeline-integration/70-01-SUMMARY.md
@services/aiProvider.ts
@services/generationPipeline.ts
@services/geminiService.ts
@services/providers/claudeProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GenerationMode type and add scripted early-return in pipeline</name>
  <files>
    services/aiProvider.ts
    services/generationPipeline.ts
  </files>
  <action>
**Step 1: Extend GenerationMode (PIPE-01)**

In `services/aiProvider.ts`, line 66, change:
```typescript
export type GenerationMode = 'fresh' | 'refine' | 'blend';
```
to:
```typescript
export type GenerationMode = 'fresh' | 'refine' | 'blend' | 'scripted';
```

This is a type-only change. TypeScript will now flag all switch statements that don't handle 'scripted'.

**Step 2: Add scripted mode early-return in pipeline (PIPE-02)**

In `services/generationPipeline.ts`, add imports at the top:
```typescript
import { parseScriptedLessonPlan } from './scriptedParser/scriptedParser';
import { mapBlocksToSlides } from './scriptedParser/scriptedMapper';
```

In `runGenerationPipeline`, immediately after the destructuring of `options` (after line 102), before the Pass 1 comment block, add the scripted mode early-return:

```typescript
  // =========================================================================
  // Scripted mode: bypass all AI passes, map directly from parsed blocks
  // =========================================================================
  if (input.mode === 'scripted') {
    onProgress?.({
      stage: 'generating',
      stageIndex: 0,
      totalStages: 1,
    });

    const parseResult = parseScriptedLessonPlan(lessonPlanText);
    // Flatten all days' blocks (day selection is Phase 72)
    const allBlocks = parseResult.days.flatMap(day => day.blocks);
    const slides = mapBlocksToSlides(allBlocks);

    return {
      slides,
      coveragePercentage: null,
      remainingGaps: [],
      warnings: parseResult.warnings,
      wasPartial: false,
    };
  }
```

This goes BEFORE the existing Pass 1 code. The early return means no code after this point is reached for scripted mode, ensuring PIPE-05 (regression safety) because existing code paths are untouched.

Do NOT modify the `canAnalyzeGaps` expression at line 164 or any other existing code. The early return naturally handles it.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | head -30` -- expect TypeScript errors ONLY in geminiService.ts and claudeProvider.ts (missing 'scripted' cases in switch statements). The pipeline and aiProvider files should have zero errors. Verify the early-return code is syntactically correct by checking the pipeline file compiles if you temporarily comment out the provider imports.</verify>
  <done>GenerationMode includes 'scripted'. Pipeline has early-return for scripted mode. TypeScript correctly flags missing switch cases in providers (to be fixed in Task 2).</done>
</task>

<task type="auto">
  <name>Task 2: Add unreachable scripted cases to provider switch statements</name>
  <files>
    services/geminiService.ts
    services/providers/claudeProvider.ts
  </files>
  <action>
Add `'scripted'` cases to all switch statements and mode-checking expressions in both providers. These cases are unreachable because the pipeline early-returns before calling any provider methods for scripted mode. They exist solely for TypeScript exhaustiveness checking.

**CRITICAL: Do NOT modify ANY existing 'fresh', 'refine', or 'blend' case code. Only ADD the new 'scripted' case.**

**geminiService.ts switch sites (from research):**

1. `getDetectionSource` (around line 108-116) -- switch on `input.mode`:
   Add `case 'scripted': return '';`

2. `getSystemInstructionForMode` (around line 131-236) -- switch on `input.mode`:
   Add `case 'scripted': return '';`

3. `generateLessonSlides` internal mode checks -- search for all `switch` or `if` expressions on `input.mode` or `mode` within this function. For each switch, add `case 'scripted': return [];` or `case 'scripted': throw new Error('Unreachable: scripted mode bypasses provider');` as appropriate. For `if/else` chains, no change needed (the early return prevents these from executing).

**claudeProvider.ts switch sites (from research):**

1. `getDetectionSource` (around line 401-409) -- switch on `input.mode`:
   Add `case 'scripted': return '';`

2. `getSystemPromptForMode` (around line 425-534) -- switch on `input.mode`:
   Add `case 'scripted': return '';`

3. `generateLessonSlides` internal mode checks -- same approach as gemini. Add `case 'scripted'` to each switch statement.

**How to find all sites systematically:**
1. Run `npx tsc --noEmit 2>&1` and read every error about non-exhaustive switch.
2. For each error, add the 'scripted' case with an appropriate unreachable return value.
3. Re-run `npx tsc --noEmit` until zero errors.

For all unreachable cases, use a comment: `// Unreachable: pipeline early-returns before calling provider for scripted mode`

**Regression safety (PIPE-05):** After adding all cases, verify by reading through each modified switch that ONLY the new `case 'scripted':` line was added -- no existing case logic was touched.
  </action>
  <verify>
Run `npx tsc --noEmit` -- ZERO type errors across the entire project.
Run `npx jest services/scriptedParser/` -- all mapper tests from Plan 01 still pass.
Run `npx jest` (full suite if exists) -- no regressions.
Run a search: `grep -n "case 'scripted'" services/geminiService.ts services/providers/claudeProvider.ts` -- verify the count matches the expected number of switch sites (at least 3 per provider, ~6+ total).
  </verify>
  <done>All provider switch statements handle 'scripted' case. Zero TypeScript errors project-wide. Full test suite passes. No existing mode logic was modified.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero errors
2. `npx jest services/scriptedParser/` -- all mapper and parser tests pass
3. `grep -c "case 'scripted'" services/geminiService.ts services/providers/claudeProvider.ts` -- at least 3 per file
4. `grep "input.mode === 'scripted'" services/generationPipeline.ts` -- confirms early-return path exists
5. `grep "'scripted'" services/aiProvider.ts` -- confirms type extension
6. Verify no changes to existing mode cases: `git diff services/geminiService.ts` shows ONLY additions, no modifications to existing lines
</verification>

<success_criteria>
- GenerationMode is 'fresh' | 'refine' | 'blend' | 'scripted' in aiProvider.ts
- runGenerationPipeline early-returns for scripted mode, calling parseScriptedLessonPlan and mapBlocksToSlides
- All switch statements in geminiService.ts and claudeProvider.ts have 'scripted' cases
- Zero TypeScript errors project-wide
- All existing tests pass (regression-safe)
- No existing Fresh/Refine/Blend code paths were modified
</success_criteria>

<output>
After completion, create `.planning/phases/70-slide-mapper-pipeline-integration/70-02-SUMMARY.md`
</output>
