---
phase: 08-flexible-upload-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Landing page shows two distinct upload zones: Lesson Plan PDF and Existing Presentation PDF"
    - "Teacher can upload lesson PDF only and the Generate button enables"
    - "Teacher can upload existing presentation PDF only and the Generate button enables"
    - "Teacher can upload both files together and the Generate button enables"
    - "Mode indicator shows which generation mode will be used (fresh/refine/blend)"
    - "Removing a file updates the mode indicator correctly"
  artifacts:
    - path: "App.tsx"
      provides: "Dual upload zones, state management, mode derivation"
      contains: "existingPptFile"
  key_links:
    - from: "existingPptFile state"
      to: "uploadMode derivation"
      via: "useMemo"
      pattern: "uploadMode.*useMemo"
    - from: "handleGenerate"
      to: "existingPptImages"
      via: "validation check"
      pattern: "existingPptImages\\.length"
---

<objective>
Add a second PDF upload zone for existing presentations, implement upload mode derivation, and show a mode indicator so teachers know what generation mode will be used.

Purpose: Enable teachers to upload existing presentations (as PDF) alongside or instead of lesson plans, supporting the flexible upload feature for Phase 9's AI adaptation.

Output: Updated App.tsx with dual upload zones, shared PDF processing, mode state, and mode indicator UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-flexible-upload-ui/08-RESEARCH.md
@App.tsx (lines 139-197 for existing PDF handling, lines 648-750 for upload UI)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state and shared PDF processor</name>
  <files>App.tsx</files>
  <action>
Add new state variables for existing presentation PDF (after existing PDF state ~line 143):

```typescript
// Existing presentation PDF state
const [existingPptFile, setExistingPptFile] = useState<File | null>(null);
const [isProcessingPpt, setIsProcessingPpt] = useState(false);
const [existingPptImages, setExistingPptImages] = useState<string[]>([]);
const [existingPptText, setExistingPptText] = useState('');
const existingPptInputRef = useRef<HTMLInputElement>(null);
```

Extract existing PDF processing logic into a reusable helper function (before handleFileChange):

```typescript
// Shared PDF processor for both upload zones
const processPdf = async (
  file: File,
  onProgress: (processing: boolean) => void,
  onComplete: (text: string, images: string[]) => void,
  onError: (errorMsg: string) => void
) => {
  onProgress(true);
  try {
    const arrayBuffer = await file.arrayBuffer();
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

    let fullText = "";
    const images: string[] = [];
    const pagesToProcess = Math.min(pdf.numPages, 5);

    for (let i = 1; i <= pagesToProcess; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      fullText += textContent.items.map((item: any) => item.str).join(' ') + "\n\n";

      const viewport = page.getViewport({ scale: 1.5 });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({ canvasContext: context, viewport }).promise;
      images.push(canvas.toDataURL('image/jpeg', 0.8));
    }

    onComplete(fullText, images);
  } catch (err) {
    console.error("PDF Processing Error:", err);
    onError("Failed to analyze the PDF structure.");
  } finally {
    onProgress(false);
  }
};
```

Refactor existing handleFileChange to use the shared processor:

```typescript
const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;

  if (file.type !== 'application/pdf') {
    setError("Please upload a PDF document.");
    return;
  }

  setUploadedFile(file);
  setError(null);
  await processPdf(
    file,
    setIsProcessingFile,
    (text, images) => {
      setLessonText(text);
      setPageImages(images);
    },
    setError
  );
};
```

Add handler for existing presentation upload:

```typescript
const handlePptFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;

  if (file.type !== 'application/pdf') {
    setError("Please upload a PDF document.");
    return;
  }

  setExistingPptFile(file);
  setError(null);
  await processPdf(
    file,
    setIsProcessingPpt,
    (text, images) => {
      setExistingPptText(text);
      setExistingPptImages(images);
    },
    setError
  );
};
```

Add upload mode derivation using useMemo (after the state declarations):

```typescript
// Derive upload mode from which files are uploaded
type UploadMode = 'fresh' | 'refine' | 'blend' | 'none';

const uploadMode = useMemo<UploadMode>(() => {
  const hasLesson = uploadedFile !== null || lessonText.trim() !== '';
  const hasPpt = existingPptFile !== null;

  if (hasLesson && hasPpt) return 'blend';
  if (hasPpt) return 'refine';
  if (hasLesson) return 'fresh';
  return 'none';
}, [uploadedFile, lessonText, existingPptFile]);
```

Note: The UploadMode type can be declared at module level (near other types) or inline with useMemo.
  </action>
  <verify>
No TypeScript errors: `npx tsc --noEmit`
App runs without console errors: `npm run dev` and check browser console
  </verify>
  <done>
State variables for existing presentation PDF exist, shared PDF processor extracted, both handlers work, uploadMode computed correctly from state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dual upload zones and mode indicator UI</name>
  <files>App.tsx</files>
  <action>
Replace the existing single upload zone (lines ~648-687) with a two-column grid layout containing both upload zones. The existing lesson upload is green-themed; the new presentation upload is blue-themed.

Update the upload section to use a grid layout:

```typescript
{/* Dual Upload Zones */}
<div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
  {/* Lesson Plan PDF Upload (existing, green theme) */}
  <div
    onClick={() => fileInputRef.current?.click()}
    className={`border-2 border-dashed rounded-2xl p-6 flex flex-col items-center justify-center cursor-pointer transition-all min-h-[180px] ${uploadedFile ? 'border-green-300 bg-green-50 dark:bg-green-900/20 dark:border-green-700' : 'border-slate-200 dark:border-slate-700 hover:border-green-400 dark:hover:border-green-500 hover:bg-slate-50 dark:hover:bg-slate-800'}`}
  >
    <input
      type="file"
      ref={fileInputRef}
      onChange={handleFileChange}
      className="hidden"
      accept=".pdf"
    />

    {isProcessingFile ? (
      <div className="flex flex-col items-center animate-pulse">
        <div className="w-10 h-10 border-4 border-green-500 dark:border-green-400 border-t-transparent rounded-full animate-spin mb-3"></div>
        <p className="text-sm font-bold text-green-600 dark:text-green-400 uppercase tracking-widest">Analyzing...</p>
      </div>
    ) : uploadedFile ? (
      <div className="flex flex-col items-center text-center">
        <div className="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center text-white shadow-lg mb-3">
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" /></svg>
        </div>
        <p className="font-bold text-slate-800 dark:text-white text-sm truncate max-w-full px-2">{uploadedFile.name}</p>
        <p className="text-xs text-green-600 dark:text-green-400 font-medium mt-1">Lesson plan ready</p>
        <button onClick={(e) => { e.stopPropagation(); setUploadedFile(null); setPageImages([]); setLessonText(''); }} className="mt-2 p-1.5 text-slate-400 hover:text-red-500 transition-colors rounded-full hover:bg-red-50 dark:hover:bg-red-900/20">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
    ) : (
      <div className="text-center">
        <div className="w-14 h-14 bg-green-50 dark:bg-green-900/30 text-green-500 dark:text-green-400 rounded-2xl flex items-center justify-center mx-auto mb-3">
          <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
        </div>
        <p className="font-bold text-slate-700 dark:text-slate-300 text-sm">Lesson Plan PDF</p>
        <p className="text-xs text-slate-400 dark:text-slate-500 mt-1">AI creates fresh slides</p>
      </div>
    )}
  </div>

  {/* Existing Presentation PDF Upload (new, blue theme) */}
  <div
    onClick={() => existingPptInputRef.current?.click()}
    className={`border-2 border-dashed rounded-2xl p-6 flex flex-col items-center justify-center cursor-pointer transition-all min-h-[180px] ${existingPptFile ? 'border-blue-300 bg-blue-50 dark:bg-blue-900/20 dark:border-blue-700' : 'border-slate-200 dark:border-slate-700 hover:border-blue-400 dark:hover:border-blue-500 hover:bg-slate-50 dark:hover:bg-slate-800'}`}
  >
    <input
      type="file"
      ref={existingPptInputRef}
      onChange={handlePptFileChange}
      className="hidden"
      accept=".pdf"
    />

    {isProcessingPpt ? (
      <div className="flex flex-col items-center animate-pulse">
        <div className="w-10 h-10 border-4 border-blue-500 dark:border-blue-400 border-t-transparent rounded-full animate-spin mb-3"></div>
        <p className="text-sm font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest">Analyzing...</p>
      </div>
    ) : existingPptFile ? (
      <div className="flex flex-col items-center text-center">
        <div className="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center text-white shadow-lg mb-3">
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" /></svg>
        </div>
        <p className="font-bold text-slate-800 dark:text-white text-sm truncate max-w-full px-2">{existingPptFile.name}</p>
        <p className="text-xs text-blue-600 dark:text-blue-400 font-medium mt-1">Presentation ready</p>
        <button onClick={(e) => { e.stopPropagation(); setExistingPptFile(null); setExistingPptImages([]); setExistingPptText(''); }} className="mt-2 p-1.5 text-slate-400 hover:text-red-500 transition-colors rounded-full hover:bg-red-50 dark:hover:bg-red-900/20">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
    ) : (
      <div className="text-center">
        <div className="w-14 h-14 bg-blue-50 dark:bg-blue-900/30 text-blue-500 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-3">
          <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
        </div>
        <p className="font-bold text-slate-700 dark:text-slate-300 text-sm">Existing Presentation</p>
        <p className="text-xs text-slate-400 dark:text-slate-500 mt-1">PDF export from PowerPoint</p>
      </div>
    )}
  </div>
</div>
```

Add mode indicator below the upload zones (before the "Or paste text below" divider):

```typescript
{/* Mode Indicator */}
{uploadMode !== 'none' && (
  <div className={`mb-6 p-4 rounded-xl border ${
    uploadMode === 'fresh' ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700' :
    uploadMode === 'refine' ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-700' :
    'bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-700'
  }`}>
    <div className="flex items-center gap-3">
      <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
        uploadMode === 'fresh' ? 'bg-green-500 text-white' :
        uploadMode === 'refine' ? 'bg-blue-500 text-white' :
        'bg-purple-500 text-white'
      }`}>
        {uploadMode === 'fresh' && <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>}
        {uploadMode === 'refine' && <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>}
        {uploadMode === 'blend' && <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>}
      </div>
      <div>
        <p className={`font-bold text-sm ${
          uploadMode === 'fresh' ? 'text-green-700 dark:text-green-300' :
          uploadMode === 'refine' ? 'text-blue-700 dark:text-blue-300' :
          'text-purple-700 dark:text-purple-300'
        }`}>
          {uploadMode === 'fresh' && 'Fresh Generation'}
          {uploadMode === 'refine' && 'Refine Mode'}
          {uploadMode === 'blend' && 'Blend Mode'}
        </p>
        <p className="text-xs text-slate-600 dark:text-slate-400">
          {uploadMode === 'fresh' && 'AI creates new slides from your lesson plan'}
          {uploadMode === 'refine' && 'AI enhances your existing presentation'}
          {uploadMode === 'blend' && 'AI combines lesson content with your slides'}
        </p>
      </div>
    </div>
  </div>
)}
```

Update the Generate button disabled check to support all modes:

Find the Button with "Generate Slideshow" and update its disabled prop:
```typescript
disabled={uploadMode === 'none' || isGenerating}
```

Also update the button label based on mode (optional enhancement):
```typescript
{uploadMode === 'refine' ? 'Refine Presentation' : uploadMode === 'blend' ? 'Enhance Slides' : 'Generate Slideshow'}
```
  </action>
  <verify>
Visual verification:
1. `npm run dev` - landing page shows two upload zones side by side on desktop
2. Upload a lesson PDF only - green zone shows checkmark, mode shows "Fresh Generation"
3. Remove lesson PDF, upload presentation PDF - blue zone shows checkmark, mode shows "Refine Mode"
4. Upload both files - both zones show checkmarks, mode shows "Blend Mode"
5. Remove either file - mode indicator updates correctly
6. Generate button enables when any file is uploaded, disables when both removed
7. On mobile viewport - zones stack vertically
  </verify>
  <done>
Two distinct upload zones visible (green for lesson, blue for presentation), mode indicator shows correct mode based on uploads, Generate button enables for all valid upload combinations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update handleGenerate validation for Phase 9 readiness</name>
  <files>App.tsx</files>
  <action>
Update the handleGenerate function to validate that at least one input source exists, preparing for Phase 9's AI differentiation. The actual mode-specific AI logic is Phase 9's responsibility; this task ensures the validation and data passing is ready.

Find handleGenerate (~line 199) and update the validation:

```typescript
const handleGenerate = async () => {
  if (!provider) {
    setEnableAIModal({ featureName: 'generate slides' });
    return;
  }

  // Validation: need at least one input source
  const hasLessonContent = lessonText.trim() || pageImages.length > 0;
  const hasPptContent = existingPptImages.length > 0;

  if (!hasLessonContent && !hasPptContent) return;

  setIsGenerating(true);
  setAppState(AppState.PROCESSING_TEXT);
  setError(null);

  try {
    // Phase 8: Pass existing behavior for lesson content
    // Phase 9 will differentiate by uploadMode and use existingPptImages/existingPptText
    const generatedSlides = await provider.generateLessonSlides(lessonText, pageImages);

    // ... rest of function unchanged
```

Important: Do NOT change the AI call itself - Phase 9 handles mode differentiation. This task only updates validation to allow all three upload modes to proceed to generation.

Also ensure the existing presentation state is cleared when appropriate:
- When starting a new presentation from landing page, existingPpt state should be available
- When loading a .pipi file, existingPpt state is not used (loaded presentations have no "source")

No changes needed to load/save logic - existingPpt is input-only state, not persisted.
  </action>
  <verify>
1. Upload lesson PDF only, click Generate - generation starts (existing behavior preserved)
2. Upload presentation PDF only, click Generate - generation starts (uses empty lesson content for now, Phase 9 will fix)
3. Upload both, click Generate - generation starts
4. Upload nothing, click Generate - button should be disabled
5. Run `npx tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
handleGenerate validates all upload modes, existing lesson-only behavior works unchanged, app ready for Phase 9 to add mode-specific AI prompts.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **UPLOAD-01**: Landing page shows two upload zones (Lesson Plan PDF, Existing Presentation)
2. **UPLOAD-02**: Lesson PDF only works - upload, generate, slides appear (regression test)
3. **UPLOAD-03**: Presentation PDF only - upload works, generate starts (AI refinement in Phase 9)
4. **UPLOAD-04**: Both files together - both upload, mode shows "Blend", generate starts

Manual verification steps:
```bash
npm run dev
# Open http://localhost:5173
# Test all four requirements above
# Verify mode indicator shows correct state
# Verify mobile responsive (stack vertically)
```

Code verification:
```bash
npx tsc --noEmit  # No TypeScript errors
npm run build     # Build succeeds
```
</verification>

<success_criteria>
- [ ] Two upload zones visible on landing page with distinct colors (green/blue)
- [ ] Mode indicator shows Fresh/Refine/Blend based on which files uploaded
- [ ] Generate button enables for lesson-only, ppt-only, or both
- [ ] Existing lesson-only flow works exactly as before (no regression)
- [ ] Mobile responsive: zones stack vertically
- [ ] No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08-flexible-upload-ui/08-01-SUMMARY.md`
</output>
