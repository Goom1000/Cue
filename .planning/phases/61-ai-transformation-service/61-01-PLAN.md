---
phase: 61-ai-transformation-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - services/prompts/transformationPrompts.ts
autonomous: true

must_haves:
  truths:
    - "TransformedSlide type exists with slideIndex, originalTitle, expandedBullets, and slideType fields"
    - "System prompt instructs AI to produce student-facing delivery text (not teacher notes) with bold key terms, [Discussion point] cues, and [Activity] cues"
    - "Verbosity resolution uses fallback chain: verbosityCache[activeLevel] -> speakerNotes -> skip"
    - "Slides with no teleprompter content are filtered out before transformation"
    - "Context builder serializes deck slides for cross-slide narrative coherence"
    - "Gemini responseSchema and Claude tool schema both enforce the TransformedSlide[] output shape"
    - "Chunking threshold of 20 slides splits large decks into batches with previous-chunk summaries"
  artifacts:
    - path: "services/prompts/transformationPrompts.ts"
      provides: "System prompt, user prompt builder, context builder, verbosity resolver, slide filter, Gemini schema, Claude tool schema, chunking utility"
      min_lines: 150
    - path: "services/aiProvider.ts"
      provides: "TransformedSlide interface and ColleagueTransformationResult type, transformForColleague method on AIProviderInterface"
      exports: ["TransformedSlide", "ColleagueTransformationResult"]
  key_links:
    - from: "services/prompts/transformationPrompts.ts"
      to: "types.ts"
      via: "import Slide type for slide filtering and context building"
      pattern: "import.*Slide.*from.*types"
    - from: "services/prompts/transformationPrompts.ts"
      to: "services/aiProvider.ts"
      via: "import VerbosityLevel for resolution function"
      pattern: "import.*VerbosityLevel"
    - from: "services/aiProvider.ts"
      to: "services/prompts/transformationPrompts.ts"
      via: "TransformedSlide type used in interface method return type"
      pattern: "TransformedSlide"
---

<objective>
Create the transformation prompt module and types for converting teleprompter scripts into colleague-deliverable talking-point bullets.

Purpose: Establish the shared foundation (types, prompts, schemas, helpers) that both Gemini and Claude providers will import in Plan 02. The prompt engineering is the core intellectual work of this phase -- getting the system prompt right determines whether output is student-facing delivery text vs. useless teacher notes.

Output: `transformationPrompts.ts` with all prompt/schema/helper exports, and updated `aiProvider.ts` with `TransformedSlide` type and `transformForColleague` interface method.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/61-ai-transformation-service/61-CONTEXT.md
@.planning/phases/61-ai-transformation-service/61-RESEARCH.md
@services/prompts/condensationPrompts.ts (pattern reference for prompt module structure)
@services/prompts/gapAnalysisPrompts.ts (pattern reference for Gemini/Claude dual schemas)
@services/prompts/cohesionPrompts.ts (buildDeckContextForCohesion for context builder reference)
@services/aiProvider.ts (AIProviderInterface, VerbosityLevel, existing types)
@types.ts (Slide interface -- speakerNotes, verbosityCache, slideType, originalPastedImage, source)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transformation prompt module with types, prompts, schemas, and helpers</name>
  <files>services/prompts/transformationPrompts.ts, services/aiProvider.ts</files>
  <action>
**In `services/aiProvider.ts`:**

1. Add `TransformedSlide` interface after existing types (near line 30, after CondensationResult):
```typescript
export interface TransformedSlide {
  slideIndex: number;        // 0-indexed position in original deck
  originalTitle: string;     // Slide title for reference
  expandedBullets: string[]; // The transformed talking-point bullets
  slideType: string;         // 'standard' | 'elaborate' | 'work-together' | 'class-challenge' | 'pasted'
}

export interface ColleagueTransformationResult {
  slides: TransformedSlide[];
  skippedCount: number;      // Slides with no teleprompter content
}
```

2. Add `transformForColleague` method to `AIProviderInterface` (after `enhanceDocument`, before the closing `}`):
```typescript
// Transform teleprompter scripts into colleague-deliverable talking-point bullets (Phase 61)
transformForColleague(
  slides: Slide[],
  deckVerbosity: VerbosityLevel,
  gradeLevel: string
): Promise<ColleagueTransformationResult>;
```

**In `services/prompts/transformationPrompts.ts` (new file):**

Follow the exact module structure of `condensationPrompts.ts` and `gapAnalysisPrompts.ts`. Sections:

**Section 1 -- System Prompt (`TRANSFORMATION_SYSTEM_PROMPT`):**

The system prompt MUST instruct the AI to produce text a colleague reads ALOUD TO STUDENTS -- not teacher notes about teaching. This is the critical distinction per user decision.

Key instructions in the prompt:
- You are transforming a teacher's teleprompter script into expanded talking-point bullets that a DIFFERENT teacher can read aloud to deliver the lesson
- Each bullet is 2-4 sentences -- enough context that the colleague doesn't need to improvise
- Tone must be student-facing and conversational, matching how a teacher speaks TO students (e.g., "Let's look at how fractions work..." not "Explain fractions to the class")
- **Bold** key terms that students should remember (renders well in PPTX and PDF)
- Do NOT use sub-bullets -- keep bullets flat
- Convert interaction cues to hints: "[Discussion point: What might happen if...]", "[Activity: Work with your partner to...]"
- Bullet count is flexible per slide -- AI decides based on content volume (some slides get 3, others get 7)
- Do NOT repeat content across slides -- each slide's bullets should be self-contained but not redundant with adjacent slides
- For thin-content slides (transitions, brief intros): keep brief with 1-2 bullets that signal intent
- Preserve examples and analogies verbatim from the original script; rephrase surrounding context for clarity
- Avoid explicit transition phrases between slides -- just avoid repetition
- Handle answer-reveal slides by combining question + answer with `[Question]` and `[Answer]` cue markers
- Handle Work Together slides with `[Activity: ...]` format that makes the activity deliverable by a colleague who hasn't used the app
- Handle Class Challenge slides similarly -- make the challenge prompt deliverable
- For pasted-image slides that have teleprompter content: transform normally (the image provides visual context the colleague will see)
- The input text uses emoji delimiters (pointing right hand) for progressive disclosure segments -- treat the FULL concatenated text as the source material, ignore the delimiters

**Section 2 -- User Prompt Builder (`buildTransformationUserPrompt`):**

Function taking `gradeLevel: string` that returns instruction text. Include:
- Target audience reminder
- Output format: JSON array of TransformedSlide objects
- Reminder: flexible bullet count per slide, 2-4 sentences per bullet

**Section 3 -- Context Builder (`buildTransformationContext`):**

Function taking `slides: TransformableSlide[]` (filtered slides with resolved text) and returning a serialized string.

Define a helper type:
```typescript
interface TransformableSlide {
  index: number;
  title: string;
  teleprompterText: string;  // Resolved from verbosity cache
  slideType: string;
  contentBullets: string[];  // Original slide bullets for reference
}
```

Serialize each slide as:
```
--- Slide {index + 1} [{slideType}] ---
Title: {title}
Visible bullets: {bullets joined with " | "}
Teleprompter script: {teleprompterText}
```

No truncation of teleprompter text -- the full script is the source material. Cap at 40 slides (with truncation note).

**Section 4 -- Verbosity Resolution (`resolveTeleprompterText`):**

```typescript
export function resolveTeleprompterText(slide: Slide, deckVerbosity: VerbosityLevel): string {
  if (deckVerbosity === 'standard') {
    return slide.speakerNotes || '';
  }
  return slide.verbosityCache?.[deckVerbosity] || slide.speakerNotes || '';
}
```

Fallback chain per user decision: `verbosityCache[activeLevel] -> speakerNotes -> ''` (empty string means skip).

**Section 5 -- Slide Filter (`filterTransformableSlides`):**

```typescript
export function filterTransformableSlides(slides: Slide[], deckVerbosity: VerbosityLevel): TransformableSlide[] {
  return slides
    .map((slide, index) => {
      const text = resolveTeleprompterText(slide, deckVerbosity);
      if (!text.trim()) return null;
      // Strip emoji delimiters, join segments into continuous text
      const cleanText = text.replace(/\u{1F449}/gu, ' ').replace(/\s+/g, ' ').trim();
      return {
        index,
        title: slide.title,
        teleprompterText: cleanText,
        slideType: slide.originalPastedImage ? 'pasted' : (slide.slideType || 'standard'),
        contentBullets: slide.content,
      };
    })
    .filter((s): s is TransformableSlide => s !== null);
}
```

Per user decision: slides with no teleprompter content are skipped entirely.

**Section 6 -- Chunking Utility (`chunkSlides`):**

```typescript
export function chunkSlides(slides: TransformableSlide[], maxPerChunk: number = 20): TransformableSlide[][] {
  const chunks: TransformableSlide[][] = [];
  for (let i = 0; i < slides.length; i += maxPerChunk) {
    chunks.push(slides.slice(i, i + maxPerChunk));
  }
  return chunks;
}
```

Also provide `buildChunkSummary` function that takes prior TransformedSlide[] results and returns a brief text summary (slide titles + first bullet) for context injection in subsequent chunk calls.

**Section 7 -- Gemini Response Schema (`TRANSFORMATION_RESPONSE_SCHEMA`):**

Using `@google/genai` `Type`, define schema for an object with a `slides` array where each item has:
- `slideIndex` (NUMBER)
- `originalTitle` (STRING)
- `expandedBullets` (ARRAY of STRING)
- `slideType` (STRING)

**Section 8 -- Claude Tool Schema (`TRANSFORMATION_TOOL`):**

JSON Schema format matching the Gemini schema shape, named `transform_for_colleague`.
  </action>
  <verify>
- `npx tsc --noEmit` passes with no errors
- `grep -c "export" services/prompts/transformationPrompts.ts` shows at least 8 exports (TRANSFORMATION_SYSTEM_PROMPT, buildTransformationUserPrompt, buildTransformationContext, resolveTeleprompterText, filterTransformableSlides, chunkSlides, buildChunkSummary, TRANSFORMATION_RESPONSE_SCHEMA, TRANSFORMATION_TOOL)
- `grep "transformForColleague" services/aiProvider.ts` shows the interface method
- `grep "TransformedSlide" services/aiProvider.ts` shows the type export
  </verify>
  <done>
- TransformedSlide and ColleagueTransformationResult types exported from aiProvider.ts
- transformForColleague method declared on AIProviderInterface
- transformationPrompts.ts exists with system prompt, user prompt builder, context builder, verbosity resolver, slide filter, chunking utility, Gemini schema, and Claude tool schema
- System prompt explicitly instructs student-facing delivery tone (not teacher notes)
- Interaction cues use [Discussion point] and [Activity] format per user decision
- Bold key terms, no sub-bullets per discretion decision
- Verbosity resolution follows locked fallback chain
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- All exports from transformationPrompts.ts are importable
- AIProviderInterface now includes transformForColleague method
- Existing tests still pass: `npx jest --passWithNoTests`
</verification>

<success_criteria>
The transformation prompt module and types are complete and ready for both providers to import. The system prompt produces student-facing delivery text when used with either provider's structured output mechanism.
</success_criteria>

<output>
After completion, create `.planning/phases/61-ai-transformation-service/61-01-SUMMARY.md`
</output>
