---
phase: 32-class-challenge-slides
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/aiProvider.ts
  - services/geminiService.ts
  - services/providers/geminiProvider.ts
  - services/providers/claudeProvider.ts
  - components/SlideRenderers.tsx
  - components/PresentationView.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher clicks 'Class Challenge' in + menu to insert slide"
    - "Teacher can edit prompt/question at top of slide"
    - "Teacher can input student contributions during presentation"
    - "Contributions display as styled cards on slide"
    - "Contributions sync to student view in real-time"
    - "Contributions become read-only when navigating away from slide"
  artifacts:
    - path: "types.ts"
      provides: "contributions and challengePrompt fields on Slide interface"
      contains: "contributions?: string[]"
    - path: "services/aiProvider.ts"
      provides: "generateClassChallengeSlide in AIProviderInterface"
      contains: "generateClassChallengeSlide"
    - path: "services/geminiService.ts"
      provides: "AI prompt generation for Class Challenge slides"
      contains: "generateClassChallengeSlide"
    - path: "components/SlideRenderers.tsx"
      provides: "ClassChallengeLayout component with orange theme"
      contains: "ClassChallengeLayout"
    - path: "components/PresentationView.tsx"
      provides: "Contribution input field, delete buttons, prompt edit modal"
      contains: "handleAddContribution"
    - path: "App.tsx"
      provides: "InsertPoint Class Challenge button and handler"
      contains: "handleInsertClassChallengeSlide"
  key_links:
    - from: "App.tsx"
      to: "provider.generateClassChallengeSlide"
      via: "handleInsertClassChallengeSlide async call"
      pattern: "provider\\.generateClassChallengeSlide"
    - from: "PresentationView.tsx"
      to: "onUpdateSlide"
      via: "handleAddContribution and handleDeleteContribution"
      pattern: "onUpdateSlide.*contributions"
    - from: "SlideRenderers.tsx"
      to: "case 'class-challenge'"
      via: "SlideContentRenderer switch statement"
      pattern: "case 'class-challenge'"
---

<objective>
Add Class Challenge interactive slides - teachers can capture live student contributions during presentation with real-time sync to student view.

Purpose: Complete the v3.2 milestone with the final pedagogical slide type. Class Challenge enables live classroom participation capture - teacher types student answers, contributions display as cards, and everything syncs to projector in real-time.

Output: Working Class Challenge slide insertion with AI-generated prompts, contribution input during presentation, styled card display, and implicit locking when navigating away.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-class-challenge-slides/32-CONTEXT.md
@.planning/phases/32-class-challenge-slides/32-RESEARCH.md
@.planning/phases/31-work-together-slide-insertion/31-01-SUMMARY.md

# Key source files
@types.ts
@services/aiProvider.ts
@services/geminiService.ts
@services/providers/geminiProvider.ts
@services/providers/claudeProvider.ts
@components/SlideRenderers.tsx
@components/PresentationView.tsx
@App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Types and AI Provider Interface</name>
  <files>types.ts, services/aiProvider.ts</files>
  <action>
1. In types.ts, extend the Slide interface:
   - Add `contributions?: string[];` field (for Class Challenge student inputs)
   - Add `challengePrompt?: string;` field (the question/prompt at top of slide)
   - Add 'class-challenge' to the layout type union: `layout?: 'split' | 'full-image' | 'center-text' | 'flowchart' | 'grid' | 'tile-overlap' | 'work-together' | 'class-challenge';`
   - Note: 'class-challenge' already exists in slideType union - no change needed there

2. In services/aiProvider.ts, add to AIProviderInterface:
   ```typescript
   generateClassChallengeSlide(
     lessonTopic: string,
     sourceSlide: Slide,
     allSlides: Slide[]
   ): Promise<Slide>;
   ```
   This follows the exact same signature pattern as generateWorkTogetherSlide and generateElaborateSlide.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit
```
  </verify>
  <done>
- Slide interface has contributions and challengePrompt fields
- Layout type union includes 'class-challenge'
- AIProviderInterface has generateClassChallengeSlide method
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement AI Generation in Both Providers</name>
  <files>services/geminiService.ts, services/providers/geminiProvider.ts, services/providers/claudeProvider.ts</files>
  <action>
1. In services/geminiService.ts, add generateClassChallengeSlide function:
   - Follow the pattern from generateWorkTogetherSlide
   - System prompt should generate:
     - A short, engaging challenge prompt/question (stored in challengePrompt)
     - Facilitation tips for the teleprompter (speakerNotes)
   - The prompt should check student understanding of the source slide content
   - Set slideType: 'class-challenge', layout: 'class-challenge'
   - Initialize contributions as empty array []
   - Use orange background: backgroundColor: '#ea580c' (orange-600)
   - Title should be "Class Challenge" or similar
   - Content array can have 1-2 brief instruction bullets

   Example system prompt guidance:
   ```
   Generate a Class Challenge slide for interactive student participation.

   Based on the source slide content, create:
   1. A SHORT, engaging challenge prompt that checks understanding (2-3 sentences max)
   2. Facilitation tips for the teacher (when to pause, how to encourage responses, how to summarize)

   The teacher will type student contributions live during the lesson.
   Keep the prompt punchy and open-ended to encourage multiple responses.
   ```

2. In services/providers/geminiProvider.ts, add passthrough method:
   ```typescript
   generateClassChallengeSlide(lessonTopic: string, sourceSlide: Slide, allSlides: Slide[]): Promise<Slide> {
     return generateClassChallengeSlide(this.apiKey, lessonTopic, sourceSlide, allSlides);
   }
   ```

3. In services/providers/claudeProvider.ts, implement generateClassChallengeSlide:
   - Follow the Claude provider pattern (direct API call with anthropic-dangerous-direct-browser-access header)
   - Same prompt structure as Gemini implementation
   - Parse response and return Slide object
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit
```
  </verify>
  <done>
- geminiService.ts has generateClassChallengeSlide with orange theme and facilitation tips
- geminiProvider.ts has passthrough method
- claudeProvider.ts has full implementation
- Both providers generate: challengePrompt, facilitation speakerNotes, orange background
  </done>
</task>

<task type="auto">
  <name>Task 3: Add ClassChallengeLayout, InsertPoint Button, and PresentationView Integration</name>
  <files>components/SlideRenderers.tsx, App.tsx, components/PresentationView.tsx</files>
  <action>
**Part A: ClassChallengeLayout in SlideRenderers.tsx**

Add ClassChallengeLayout component (renders ONLY prompt and cards - NO input field):
```typescript
export const ClassChallengeLayout: React.FC<{ slide: Slide, visibleBullets: number }> = ({ slide, visibleBullets }) => {
  const contributions = slide.contributions || [];
  const cardCount = contributions.length;

  // Dynamic card sizing based on count (per CONTEXT.md: cards shrink to fit)
  const getCardClasses = () => {
    if (cardCount <= 6) return 'text-2xl p-6 min-w-[180px]';
    if (cardCount <= 12) return 'text-xl p-4 min-w-[140px]';
    if (cardCount <= 20) return 'text-lg p-3 min-w-[100px]';
    return 'text-base p-2 min-w-[80px]';
  };

  return (
    <div
      className="w-full h-full flex flex-col overflow-hidden"
      style={{ backgroundColor: slide.backgroundColor || '#ea580c' }}  // Orange-600
    >
      {/* Challenge Prompt */}
      <div className="px-6 md:px-10 pt-6 md:pt-8 text-center">
        <h2 className="text-4xl md:text-6xl lg:text-7xl font-bold text-white font-poppins leading-tight">
          {slide.challengePrompt || 'Click to add your challenge question'}
        </h2>
      </div>

      {/* Contribution Cards Grid */}
      <div className="flex-1 p-4 md:p-6 overflow-hidden">
        <div className="flex flex-wrap gap-3 md:gap-4 justify-center content-start h-full">
          {contributions.map((contribution, idx) => (
            <div
              key={idx}
              className={`bg-white/20 backdrop-blur-sm rounded-xl text-white font-medium ${getCardClasses()} animate-fade-in`}
            >
              {contribution}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};
```

Update SlideContentRenderer switch statement to include:
```typescript
case 'class-challenge':
  return <ClassChallengeLayout slide={slide} visibleBullets={visibleBullets} />;
```

**Part B: InsertPoint and Handler in App.tsx**

1. Add fifth button to InsertPoint dropdown (orange theme):
```typescript
<button
    onClick={(e) => { e.stopPropagation(); onClickClassChallenge(); setIsOpen(false); }}
    className="flex items-center gap-1.5 px-3 py-1.5 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors shadow-sm"
>
    <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Class Challenge</span>
</button>
```

2. Update InsertPoint props to include onClickClassChallenge

3. Add handleInsertClassChallengeSlide handler (follow handleInsertWorkTogetherSlide pattern):
```typescript
const handleInsertClassChallengeSlide = async (index: number) => {
  if (!provider) {
    setErrorModal({ title: 'AI Not Configured', message: 'Please configure your AI provider in Settings.' });
    return;
  }

  const source = index >= 0 ? slides[index] : undefined;
  if (!source) {
    setErrorModal({ title: 'Cannot Create Challenge', message: 'Need a slide above to create a challenge for.' });
    return;
  }

  const tempId = `temp-challenge-${Date.now()}`;
  const tempSlide: Slide = {
    id: tempId,
    title: "Creating Challenge...",
    content: ["Generating challenge prompt...", "Preparing facilitation tips..."],
    speakerNotes: "",
    imagePrompt: "",
    isGeneratingImage: true,
    layout: 'class-challenge'
  };

  // Insert temp slide after source
  const newSlides = [...slides];
  newSlides.splice(index + 1, 0, tempSlide);
  setSlides(newSlides);
  setActiveSlideIndex(index + 1);

  try {
    const challenge = await provider.generateClassChallengeSlide(lessonTitle, source, slides);

    setSlides(curr => curr.map(s => s.id === tempId
      ? { ...challenge, id: tempId, contributions: [], isGeneratingImage: autoGenerateImages }
      : s
    ));

    if (autoGenerateImages) {
      const img = await provider.generateSlideImage(challenge.imagePrompt, challenge.layout);
      setSlides(curr => curr.map(s => s.id === tempId ? { ...s, imageUrl: img, isGeneratingImage: false } : s));
    }
  } catch (err) {
    console.error("Class Challenge error:", err);
    setSlides(curr => curr.map(s => s.id === tempId ? { ...tempSlide, title: "New Slide", isGeneratingImage: false } : s));
    if (err instanceof AIProviderError) {
      setErrorModal({ title: 'Challenge Generation Failed', message: err.userMessage });
    }
  }
};
```

4. Wire to each InsertPoint in the slide list:
```typescript
onClickClassChallenge={() => handleInsertClassChallengeSlide(index)}
```

**Part C: PresentationView Integration**

This is the most complex part. In PresentationView.tsx:

1. Add state for contribution input and prompt editing:
```typescript
const [newContribution, setNewContribution] = useState('');
const [isEditingPrompt, setIsEditingPrompt] = useState(false);
const [editedPrompt, setEditedPrompt] = useState('');
const contributionInputRef = useRef<HTMLInputElement>(null);
```

2. Add handlers for contribution management:
```typescript
const handleAddContribution = useCallback(() => {
  const trimmed = newContribution.trim();
  if (!trimmed || !currentSlide) return;

  onUpdateSlide(currentSlide.id, {
    contributions: [...(currentSlide.contributions || []), trimmed]
  });
  setNewContribution('');
}, [newContribution, currentSlide, onUpdateSlide]);

const handleDeleteContribution = useCallback((index: number) => {
  if (!currentSlide?.contributions) return;

  const updated = currentSlide.contributions.filter((_, i) => i !== index);
  onUpdateSlide(currentSlide.id, { contributions: updated });
}, [currentSlide, onUpdateSlide]);

const handleSavePrompt = useCallback(() => {
  if (!currentSlide) return;
  onUpdateSlide(currentSlide.id, { challengePrompt: editedPrompt });
  setIsEditingPrompt(false);
}, [currentSlide, editedPrompt, onUpdateSlide]);
```

3. Auto-focus input when arriving at Class Challenge slide (per CONTEXT.md):
```typescript
useEffect(() => {
  if (currentSlide?.layout === 'class-challenge' && contributionInputRef.current) {
    contributionInputRef.current.focus();
  }
}, [currentIndex, currentSlide?.layout]);
```

4. Clear contribution input when slide changes:
```typescript
useEffect(() => {
  setNewContribution('');
  setIsEditingPrompt(false);
}, [currentIndex]);
```

5. Render input field and overlay ONLY when on Class Challenge slide. Add this in the main slide display area (inside the existing slide content section), as an overlay ABOVE the slide content:
```typescript
{currentSlide?.layout === 'class-challenge' && (
  <div className="absolute inset-0 pointer-events-none">
    {/* Contribution Input - bottom center */}
    <div className="absolute bottom-6 left-1/2 -translate-x-1/2 pointer-events-auto flex gap-2">
      <input
        ref={contributionInputRef}
        type="text"
        value={newContribution}
        onChange={(e) => setNewContribution(e.target.value)}
        onKeyDown={(e) => e.key === 'Enter' && handleAddContribution()}
        placeholder="Type student contribution..."
        className="w-80 px-4 py-3 rounded-xl bg-white/90 text-slate-800 placeholder-slate-400 text-lg font-medium shadow-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
      />
      <button
        onClick={handleAddContribution}
        className="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold shadow-lg transition-colors"
      >
        Add
      </button>
    </div>

    {/* Edit Prompt Button - top right */}
    <button
      onClick={() => {
        setEditedPrompt(currentSlide.challengePrompt || '');
        setIsEditingPrompt(true);
      }}
      className="absolute top-4 right-4 pointer-events-auto px-3 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg text-sm font-medium backdrop-blur-sm transition-colors"
    >
      Edit Prompt
    </button>

    {/* Delete buttons on cards - rendered as overlay */}
    <div className="absolute inset-0 p-4 md:p-6 pt-24 flex flex-wrap gap-3 md:gap-4 justify-center content-start pointer-events-none">
      {(currentSlide.contributions || []).map((_, idx) => {
        // Calculate position to match card grid
        const cardCount = currentSlide.contributions?.length || 0;
        const cardSize = cardCount <= 6 ? 'min-w-[180px]' : cardCount <= 12 ? 'min-w-[140px]' : cardCount <= 20 ? 'min-w-[100px]' : 'min-w-[80px]';

        return (
          <div key={idx} className={`relative ${cardSize}`}>
            <button
              onClick={() => handleDeleteContribution(idx)}
              className="pointer-events-auto absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-md transition-colors opacity-0 hover:opacity-100 group-hover:opacity-100"
              style={{ opacity: 0.8 }}
            >
              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        );
      })}
    </div>
  </div>
)}
```

6. Add prompt editing modal (when isEditingPrompt is true):
```typescript
{isEditingPrompt && (
  <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in">
    <div className="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl p-6">
      <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Edit Challenge Prompt</h3>
      <textarea
        value={editedPrompt}
        onChange={(e) => setEditedPrompt(e.target.value)}
        placeholder="Enter your challenge question..."
        className="w-full h-32 px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white placeholder-slate-400 text-lg resize-none focus:outline-none focus:ring-2 focus:ring-orange-500"
        autoFocus
      />
      <div className="flex justify-end gap-3 mt-4">
        <button
          onClick={() => setIsEditingPrompt(false)}
          className="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={handleSavePrompt}
          className="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors"
        >
          Save
        </button>
      </div>
    </div>
  </div>
)}
```

**Important implementation notes:**
- Input field and delete buttons are ONLY in PresentationView (teacher view) - StudentView just renders SlideContentRenderer which shows ClassChallengeLayout without these controls
- Lock behavior is implicit: input/delete only visible when currentSlide is the Class Challenge slide
- Contributions sync automatically via existing STATE_UPDATE (no new BroadcastChannel message needed)
- Delete button overlay position calculation is approximate - may need adjustment based on actual card grid layout
  </action>
  <verify>
1. TypeScript compiles:
```bash
cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit
```

2. Development server runs:
```bash
cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npm run dev
```
Then manually test:
- Generate a presentation with AI
- Click + between slides, verify "Class Challenge" button appears (orange)
- Click it, verify slide generates with orange background and prompt
- Enter presentation mode, verify input field appears at bottom
- Type contribution and press Enter, verify card appears
- Click Edit Prompt, verify modal opens
- Navigate away and back, verify contributions persist and input re-appears
- Launch student view, verify contributions sync without input field
  </verify>
  <done>
- ClassChallengeLayout renders prompt and contribution cards with orange theme
- InsertPoint has fifth "Class Challenge" button (orange)
- handleInsertClassChallengeSlide generates slide via AI
- PresentationView has contribution input, Add button, delete buttons, and prompt edit modal
- Input auto-focuses when arriving at Class Challenge slide
- Lock behavior implicit (input/delete only visible on current slide)
- Student view shows cards without input field
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation passes:**
   ```bash
   cd "/Users/ricky/Documents/App_Projects/Education Apps/DEV - PiPi" && npx tsc --noEmit
   ```

2. **All 6 requirements verified:**
   - CHAL-01: "Class Challenge" button in InsertPoint dropdown (orange)
   - CHAL-02: Prompt editable via Edit Prompt button -> modal
   - CHAL-03: Input field at bottom of slide during presentation
   - CHAL-04: Contributions display as white/orange cards with shrink behavior
   - CHAL-05: Contributions sync to student view (via existing STATE_UPDATE)
   - CHAL-06: Input/delete not visible when on different slide (implicit lock)

3. **Manual verification flow:**
   - Create presentation -> Insert Class Challenge slide -> Enter presentation
   - Type contributions, verify cards appear
   - Edit prompt, verify it saves
   - Navigate away, verify input disappears
   - Navigate back, verify input reappears and contributions persist
   - Launch student view, verify cards display without input field
</verification>

<success_criteria>
- [ ] TypeScript compiles without errors
- [ ] Class Challenge button appears in InsertPoint dropdown (5th option, orange)
- [ ] AI generates challenge prompt and facilitation tips
- [ ] ClassChallengeLayout renders orange background with prompt and cards
- [ ] Contribution input field visible only in teacher view during Class Challenge
- [ ] Enter key and Add button both submit contributions
- [ ] Delete buttons allow removing contributions (teacher only)
- [ ] Prompt edit modal works
- [ ] Input auto-focuses when arriving at Class Challenge slide
- [ ] Contributions sync to student view in real-time
- [ ] Lock behavior implicit (input not visible on other slides)
- [ ] Cards shrink when many contributions added
</success_criteria>

<output>
After completion, create `.planning/phases/32-class-challenge-slides/32-01-SUMMARY.md`
</output>
