---
phase: 60-deck-condensation
plan: 03
type: execute
wave: 2
depends_on: ["60-01"]
files_modified:
  - components/CondensationPreview.tsx
  - App.tsx
  - components/CohesionPreview.tsx
autonomous: true

must_haves:
  truths:
    - "'Condense Deck' button appears when deck has 2+ slides, replacing 'Make Cohesive'"
    - "Button checks gapLessonPlanText — if exists, condenses directly; if not, triggers PDF upload"
    - "Preview modal shows every slide with color-coded action badge (keep/edit/remove/merge)"
    - "Stats line shows 'N slides → M slides' condensation summary"
    - "Merge groups visually connected with purple left border"
    - "Apply correctly edits, merges, then batch-removes by ID"
    - "CohesionPreview.tsx is deleted (replaced by CondensationPreview.tsx)"
  artifacts:
    - path: "components/CondensationPreview.tsx"
      provides: "Condensation preview modal with action badges, merge indicators, and stats"
      exports: ["default"]
    - path: "App.tsx"
      provides: "Condense Deck button, handlers, file input ref, modal rendering"
      contains: "handleCondenseDeck"
  key_links:
    - from: "App.tsx"
      to: "services/aiProvider.ts"
      via: "import CondensationResult type and condenseDeck via provider"
      pattern: "import.*CondensationResult"
    - from: "App.tsx"
      to: "components/CondensationPreview.tsx"
      via: "import and render modal"
      pattern: "import CondensationPreview"
    - from: "components/CondensationPreview.tsx"
      to: "services/aiProvider.ts"
      via: "import CondensationResult type"
      pattern: "import.*CondensationResult"
---

<objective>
Create the CondensationPreview component and integrate condensation into App.tsx — replacing all cohesion UI with condensation equivalents.

Purpose: Delivers the user-facing condensation experience: the button, PDF upload flow, preview modal with action badges, and apply logic that correctly handles edits, merges, and removals.

Output: Complete working feature — user can condense a bloated deck down to essential slides using a lesson plan as guide.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-deck-condensation/60-01-SUMMARY.md
@App.tsx
@components/CohesionPreview.tsx
@services/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CondensationPreview component</name>
  <files>components/CondensationPreview.tsx</files>
  <action>
  Create `components/CondensationPreview.tsx` — a modal component that displays the AI's condensation proposal for review before applying. Follow the structure of `CohesionPreview.tsx` but with significant UI changes for action badges and merge grouping.

  **Props interface:**
  ```typescript
  interface CondensationPreviewProps {
    result: CondensationResult;
    slides: Slide[];  // Current slides for displaying original content
    onApply: () => void;
    onCancel: () => void;
    isDarkMode: boolean;
  }
  ```

  Import `CondensationResult, CondensationSlideAction` from `../services/aiProvider` and `Slide` from `../types`.

  **Component structure:**

  1. **Empty state** (all slides kept): Show "Already Concise" message with green checkmark (same pattern as CohesionPreview empty state). Trigger when every action is 'keep'.

  2. **Modal layout**: Fixed full-screen overlay (`fixed inset-0 z-50`), max-w-4xl, max-h-[90vh], flex column.

  3. **Header section:**
     - Title: "Deck Condensation Preview" (font-fredoka)
     - Summary banner: orange-50/orange-900 background (condensation identity color), showing `result.summary`
     - **Stats line** (COND-03): Show `"{originalSlideCount} slides → {proposedSlideCount} slides"` with an arrow. Also show counts per action: "{N} kept, {N} edited, {N} removed, {N} merged" using colored badges.
     - Essential topics preserved: small pills showing `result.essentialTopicsPreserved` items

  4. **Slide list** (scrollable): Map over `result.actions` in slide order. For each action:

     **Action badge** (color-coded, positioned to the right of the slide number):
     - `keep`: Green badge, text "Keep"
     - `edit`: Blue badge, text "Edit"
     - `remove`: Red badge, text "Remove"
     - `merge`: Purple badge, text "Merge Target"

     **Slide row layout:**
     - Left: slide number badge (same as CohesionPreview)
     - Middle: slide title (from `slides[action.slideIndex]`) + action badge + reason text
     - Right: expand/collapse chevron (only for edit/merge actions that have diffs to show)

     **For 'keep' actions:** Single row, green badge, reason text. No expandable content.

     **For 'remove' actions:** Single row, red badge with strikethrough styling on the title. Reason text (might say "Merged into slide N"). If reason contains "Merged into", add a faded "→ Slide N" indicator.

     **For 'edit' actions:** Expandable. When expanded, show diffs using ReactDiffViewer (same import and styles as CohesionPreview):
     - Title diff (if proposedTitle differs from original)
     - Content diff (if proposedContent differs)
     - Speaker notes diff (if proposedSpeakerNotes differs)

     **For 'merge' actions:** Expandable with a purple left border (4px). When expanded, show:
     - "Absorbing slides: {mergeWithSlideIndices.map(i => i+1).join(', ')}" label
     - Merged content preview (mergedTitle, mergedContent as bullets, mergedSpeakerNotes preview)
     - Use a simple preview display (not diff) since this is new synthesized content

  5. **Footer:** Cancel button + "Apply Condensation" button with orange-to-red gradient (`from-orange-600 to-red-600 dark:from-amber-500 dark:to-orange-500`).

  **State management:**
  - `expandedSlides: Set<number>` — track which action indices are expanded. Default: expand all edit + merge actions.

  **Key styling decisions:**
  - Dark mode support throughout (same pattern as CohesionPreview)
  - ReactDiffViewer styles reused from CohesionPreview (same diffStyles object)
  - Merge groups: purple left border (border-l-4 border-purple-500)
  - Remove rows: slightly faded (opacity-75) with red accent
  - Keep rows: compact, no expand, subtle green left border
  </action>
  <verify>
  1. `npx tsc --noEmit 2>&1 | grep CondensationPreview` — no errors
  2. File exists and exports default component
  3. `grep 'ReactDiffViewer' components/CondensationPreview.tsx` — uses diff viewer for edit actions
  4. `grep 'Keep\|Edit\|Remove\|Merge Target' components/CondensationPreview.tsx` — all badge labels present
  </verify>
  <done>
  CondensationPreview component renders all four action types with color-coded badges, expandable diffs for edits, merge group indicators with purple borders, stats line showing slide count reduction, and essential topics preserved pills.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire condensation into App.tsx (replace all cohesion)</name>
  <files>App.tsx, components/CohesionPreview.tsx</files>
  <action>
  **A. Update App.tsx imports:**
  - REMOVE: `import CohesionPreview from './components/CohesionPreview';`
  - REMOVE: `CohesionResult` from the aiProvider import (it was removed in Plan 01)
  - ADD: `import CondensationPreview from './components/CondensationPreview';`
  - ADD: `CondensationResult` to the aiProvider import

  **B. Replace cohesion state (around lines 334-336):**
  - REMOVE: `const [isProcessingCohesion, setIsProcessingCohesion] = useState(false);`
  - REMOVE: `const [cohesionResult, setCohesionResult] = useState<CohesionResult | null>(null);`
  - ADD:
  ```typescript
  // Deck Condensation state (Phase 60, replaces Phase 58 cohesion)
  const [isProcessingCondensation, setIsProcessingCondensation] = useState(false);
  const [condensationResult, setCondensationResult] = useState<CondensationResult | null>(null);
  const condenseFileInputRef = useRef<HTMLInputElement>(null);
  ```

  **C. Replace cohesion handlers (around lines 695-740) with condensation handlers:**

  ```typescript
  // Deck Condensation handlers (Phase 60, replaces Phase 58 cohesion)
  const handleCondenseDeck = useCallback(async (lessonText?: string, lessonImages?: string[]) => {
    if (!provider || slides.length < 2) return;

    // Use provided lesson plan or fall back to stored gap analysis plan
    const planText = lessonText || gapLessonPlanText;
    const planImages = lessonImages || gapLessonPlanImages;

    if (!planText) {
      // No lesson plan available — trigger PDF upload
      condenseFileInputRef.current?.click();
      return;
    }

    setIsProcessingCondensation(true);
    addToast('Analyzing deck for condensation...', 3000, 'info');

    try {
      // Strip data URL prefix from images if present
      const rawImages = planImages.map(img =>
        img.replace(/^data:image\/[a-z]+;base64,/, '')
      );

      const result = await withRetry<CondensationResult>(() =>
        provider!.condenseDeck(slides, planText, rawImages, 'Year 6 (10-11 years old)')
      );

      // Check if all actions are 'keep' (nothing to condense)
      const hasChanges = result.actions.some(a => a.action !== 'keep');
      if (!hasChanges) {
        addToast('Your deck is already concise! No changes needed.', 3000, 'success');
      }

      setCondensationResult(result);
    } catch (error: any) {
      const message = error?.userMessage || error?.message || 'Failed to analyze deck for condensation';
      addToast(message, 5000, 'error');
    } finally {
      setIsProcessingCondensation(false);
    }
  }, [provider, slides, gapLessonPlanText, gapLessonPlanImages, addToast]);

  const handleCondensePdfUpload = useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !provider) return;

    // Reset file input so same file can be re-uploaded
    e.target.value = '';

    if (file.type !== 'application/pdf') {
      addToast('Please upload a PDF lesson plan.', 3000, 'error');
      return;
    }

    setIsProcessingCondensation(true);
    addToast('Processing lesson plan PDF...', 2000, 'info');

    try {
      const pdfResult = await new Promise<{ text: string; images: string[] }>((resolve, reject) => {
        processPdf(
          file,
          () => {},
          (text, images) => resolve({ text, images }),
          (errorMsg) => reject(new Error(errorMsg))
        );
      });

      // Store lesson plan for reuse (shares state with gap analysis)
      setGapLessonPlanText(pdfResult.text);
      setGapLessonPlanImages(pdfResult.images);

      // Now run condensation with the freshly uploaded plan
      await handleCondenseDeck(pdfResult.text, pdfResult.images);
    } catch (error: any) {
      const message = error?.userMessage || error?.message || 'Failed to process lesson plan';
      addToast(message, 5000, 'error');
      setIsProcessingCondensation(false);
    }
  }, [provider, handleCondenseDeck, addToast]);

  const handleApplyCondensation = useCallback(() => {
    if (!condensationResult) return;

    // STEP 1: Apply EDITS (update in-place, no index changes)
    for (const action of condensationResult.actions) {
      if (action.action === 'edit') {
        const slide = slides[action.slideIndex];
        if (!slide) continue;
        const updates: Partial<Slide> = {};
        if (action.proposedTitle) updates.title = action.proposedTitle;
        if (action.proposedContent) updates.content = action.proposedContent;
        if (action.proposedSpeakerNotes) updates.speakerNotes = action.proposedSpeakerNotes;
        handleUpdateSlide(slide.id, updates);
      }
    }

    // STEP 2: Apply MERGES (update target slide with merged content)
    for (const action of condensationResult.actions) {
      if (action.action === 'merge') {
        const slide = slides[action.slideIndex];
        if (!slide) continue;
        const updates: Partial<Slide> = {};
        if (action.mergedTitle) updates.title = action.mergedTitle;
        if (action.mergedContent) updates.content = action.mergedContent;
        if (action.mergedSpeakerNotes) updates.speakerNotes = action.mergedSpeakerNotes;
        handleUpdateSlide(slide.id, updates);
      }
    }

    // STEP 3: Collect all IDs to remove: 'remove' slides + merge source slides
    const idsToRemove = new Set<string>();
    for (const action of condensationResult.actions) {
      if (action.action === 'remove') {
        const slide = slides[action.slideIndex];
        if (slide) idsToRemove.add(slide.id);
      }
    }

    // STEP 4: Batch removal by ID (safe regardless of index order)
    if (idsToRemove.size > 0) {
      setSlides(prev => prev.filter(s => !idsToRemove.has(s.id)));
    }

    // STEP 5: Clamp activeSlideIndex
    const newLength = slides.length - idsToRemove.size;
    if (activeSlideIndex >= newLength) {
      setActiveSlideIndex(Math.max(0, newLength - 1));
    }

    const removedCount = idsToRemove.size;
    const editedCount = condensationResult.actions.filter(a => a.action === 'edit').length;
    const mergedCount = condensationResult.actions.filter(a => a.action === 'merge').length;
    addToast(
      `Condensed: ${removedCount} removed, ${editedCount} edited, ${mergedCount} merged`,
      4000,
      'success'
    );
    setCondensationResult(null);
  }, [condensationResult, slides, activeSlideIndex, handleUpdateSlide, setSlides, setActiveSlideIndex, addToast]);

  const handleCancelCondensation = useCallback(() => {
    setCondensationResult(null);
  }, []);
  ```

  **D. Add hidden file input for condensation PDF upload** (next to the gap analysis file input, around line 1975):
  ```html
  {/* Hidden file input for condensation PDF upload (Phase 60) */}
  <input
    type="file"
    ref={condenseFileInputRef}
    onChange={handleCondensePdfUpload}
    className="hidden"
    accept=".pdf"
  />
  ```

  **E. Replace "Make Cohesive" button with "Condense Deck" button** (around lines 2410-2438):
  Replace the entire Make Cohesive button block. The new button:
  - Shows when `slides.length >= 2` (same condition)
  - onClick: `() => handleCondenseDeck()` (will check for existing lesson plan or trigger upload)
  - Disabled when `!provider || isProcessingCondensation`
  - Gradient: `from-orange-600 to-red-600 dark:from-amber-500 dark:to-orange-500` (condensation identity)
  - Processing text: "Condensing..."
  - Default text: "Condense Deck"
  - Icon: scissors SVG (or compress icon):
    ```html
    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
    </svg>
    ```
    Actually, use a more appropriate compress/shrink icon:
    ```html
    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
    </svg>
    ```
    (This is the "shrink/compress" icon — arrows pointing inward from corners.)

  **F. Replace CohesionPreview modal rendering** (around lines 2743-2751):
  - REMOVE the entire `{cohesionResult && (<CohesionPreview ... />)}` block
  - ADD in its place:
  ```tsx
  {/* Condensation Preview Modal (Phase 60) */}
  {condensationResult && (
    <CondensationPreview
      result={condensationResult}
      slides={slides}
      onApply={handleApplyCondensation}
      onCancel={handleCancelCondensation}
      isDarkMode={isDarkMode}
    />
  )}
  ```

  **G. Delete `components/CohesionPreview.tsx`** — it is no longer imported or used anywhere.

  **IMPORTANT NOTES:**
  - The `handleCondenseDeck` function checks `gapLessonPlanText` first (reusing gap analysis lesson plan per COND-01). If it exists, condensation runs immediately with no upload. If not, it triggers the file input.
  - The `handleCondensePdfUpload` stores the lesson plan in the SAME state as gap analysis (`setGapLessonPlanText`, `setGapLessonPlanImages`) so both features share the lesson plan.
  - The apply logic uses a 3-step process: edits first, merges second, removals third — all using slide IDs for safety.
  </action>
  <verify>
  1. `npx tsc --noEmit` — zero errors across the entire project
  2. `grep 'CohesionPreview' App.tsx` — returns nothing (old import removed)
  3. `grep 'CondensationPreview' App.tsx` — returns import and JSX usage
  4. `grep 'Condense Deck' App.tsx` — returns the button text
  5. `grep 'handleCondenseDeck\|handleApplyCondensation\|handleCancelCondensation' App.tsx` — all three handlers present
  6. `grep 'condenseFileInputRef' App.tsx` — ref declared and used
  7. `ls components/CohesionPreview.tsx 2>/dev/null` — file does not exist (deleted)
  8. `grep -rn 'CohesionPreview\|cohesionResult\|isProcessingCohesion\|handleMakeCohesive\|handleApplyCohesion\|handleCancelCohesion' App.tsx` — returns nothing (all old references removed)
  </verify>
  <done>
  "Condense Deck" button replaces "Make Cohesive" with orange-to-red gradient. Button checks for existing lesson plan before triggering upload. CondensationPreview modal shows all slides with action badges, merge groups, and stats. Apply logic correctly handles edits → merges → batch removals by ID. CohesionPreview.tsx deleted. Full project compiles with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors across entire project
2. `npm run build` — production build succeeds
3. `grep -rn 'CohesionPreview\|makeDeckCohesive\|CohesionResult\|CohesionChange\|isProcessingCohesion\|cohesionResult\|handleMakeCohesive\|handleApplyCohesion\|handleCancelCohesion\|COHESION_SYSTEM_PROMPT\|COHESION_TOOL\|COHESION_RESPONSE_SCHEMA\|buildCohesionUserPrompt' --include='*.ts' --include='*.tsx' .` — returns NOTHING (all cohesion dead code removed)
4. `grep -rn 'buildDeckContextForCohesion' --include='*.ts' .` — still exists in cohesionPrompts.ts, gapAnalysisPrompts.ts, condensationPrompts.ts, and both providers (deck serializer preserved)
5. `grep -rn 'condenseDeck\|CondensationResult' --include='*.ts' --include='*.tsx' .` — found in aiProvider.ts, both providers, condensationPrompts.ts, App.tsx, CondensationPreview.tsx
</verification>

<success_criteria>
- "Condense Deck" button visible at 2+ slides, orange-to-red gradient
- Button reuses gap analysis lesson plan if available, otherwise triggers PDF upload
- CondensationPreview shows all slides with color-coded badges (green keep, blue edit, red remove, purple merge)
- Stats line shows "N slides → M slides"
- Merge targets have purple left border with absorbed slide indicators
- Apply handles edits → merges → batch ID removal correctly
- activeSlideIndex clamped after removal
- CohesionPreview.tsx deleted, all cohesion references gone
- Zero TypeScript errors, production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/60-deck-condensation/60-03-SUMMARY.md`
</output>
