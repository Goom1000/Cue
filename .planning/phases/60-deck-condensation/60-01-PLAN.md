---
phase: 60-deck-condensation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - services/prompts/condensationPrompts.ts
  - services/prompts/cohesionPrompts.ts
  - services/providers/geminiProvider.ts
autonomous: true

must_haves:
  truths:
    - "CondensationResult and CondensationSlideAction types are exported from aiProvider.ts"
    - "condenseDeck method exists on AIProviderInterface"
    - "makeDeckCohesive is removed from AIProviderInterface"
    - "Condensation prompts produce four-action model (keep/edit/remove/merge) for every slide"
    - "Gemini provider returns enriched CondensationResult with original slide data"
    - "cohesionPrompts.ts retains only buildDeckContextForCohesion (deck serializer)"
  artifacts:
    - path: "services/aiProvider.ts"
      provides: "CondensationResult types and condenseDeck interface method"
      contains: "condenseDeck"
    - path: "services/prompts/condensationPrompts.ts"
      provides: "System prompt, user prompt builder, context builder, Gemini schema, Claude tool schema"
      exports: ["CONDENSATION_SYSTEM_PROMPT", "buildCondensationUserPrompt", "buildCondensationContext", "CONDENSATION_RESPONSE_SCHEMA", "CONDENSATION_TOOL"]
    - path: "services/providers/geminiProvider.ts"
      provides: "condenseDeck implementation replacing makeDeckCohesive"
      contains: "async condenseDeck"
  key_links:
    - from: "services/prompts/condensationPrompts.ts"
      to: "services/prompts/cohesionPrompts.ts"
      via: "import buildDeckContextForCohesion"
      pattern: "import.*buildDeckContextForCohesion.*from.*cohesionPrompts"
    - from: "services/providers/geminiProvider.ts"
      to: "services/prompts/condensationPrompts.ts"
      via: "import prompts and schemas"
      pattern: "import.*from.*condensationPrompts"
---

<objective>
Create the condensation AI infrastructure: types, prompts, schemas, and Gemini provider implementation. Also clean up cohesion dead code that condensation replaces.

Purpose: Establishes the foundation types (CondensationResult, CondensationSlideAction) and the complete prompt engineering for the four-action condensation model (keep/edit/remove/merge). The Gemini provider is the primary implementation.

Output: Working condenseDeck method on Gemini provider, ready for Claude implementation (Plan 02) and UI integration (Plan 03).
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/aiProvider.ts
@services/prompts/cohesionPrompts.ts
@services/prompts/gapAnalysisPrompts.ts
@services/providers/geminiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add condensation types to aiProvider.ts and update interface</name>
  <files>services/aiProvider.ts</files>
  <action>
  1. Add new condensation types AFTER the existing GapAnalysisResult block (around line 50):

  ```typescript
  // Deck Condensation types for lesson-plan-aware slide reduction (Phase 60)
  export type CondensationAction = 'keep' | 'edit' | 'remove' | 'merge';

  export interface CondensationSlideAction {
    slideIndex: number;
    action: CondensationAction;
    reason: string;
    // For 'edit': proposed new content
    proposedTitle?: string;
    proposedContent?: string[];
    proposedSpeakerNotes?: string;
    // For 'merge': target slide absorbs these source slides
    mergeWithSlideIndices?: number[];
    mergedTitle?: string;
    mergedContent?: string[];
    mergedSpeakerNotes?: string;
  }

  export interface CondensationResult {
    actions: CondensationSlideAction[];
    summary: string;
    originalSlideCount: number;
    proposedSlideCount: number;
    essentialTopicsPreserved: string[];
  }
  ```

  2. In the `AIProviderInterface`, REPLACE the `makeDeckCohesive` method signature with:

  ```typescript
  // Condense deck using lesson plan as essential-content guide (Phase 60, replaces Phase 58 cohesion)
  condenseDeck(
    slides: Slide[],
    lessonPlanText: string,
    lessonPlanImages: string[],
    gradeLevel: string
  ): Promise<CondensationResult>;
  ```

  3. REMOVE the old `CohesionResult` and `CohesionChange` interfaces (lines ~14-30). These are no longer used.

  4. Keep all other exports intact. Ensure `CondensationResult`, `CondensationSlideAction`, and `CondensationAction` are all exported.
  </action>
  <verify>
  Run `npx tsc --noEmit 2>&1 | head -50` â€” expect errors ONLY in geminiProvider.ts and claudeProvider.ts (they still reference the old method). No errors in aiProvider.ts itself. Verify `CondensationResult` is exported by searching the file.
  </verify>
  <done>
  aiProvider.ts exports CondensationResult, CondensationSlideAction, CondensationAction types. AIProviderInterface has condenseDeck method. Old CohesionResult/CohesionChange types and makeDeckCohesive signature are removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create condensationPrompts.ts and gut cohesionPrompts.ts</name>
  <files>services/prompts/condensationPrompts.ts, services/prompts/cohesionPrompts.ts</files>
  <action>
  **A. Create `services/prompts/condensationPrompts.ts`** following the exact pattern of `gapAnalysisPrompts.ts`:

  **Section 1 â€” System Prompt** (`CONDENSATION_SYSTEM_PROMPT`):
  ```
  You are an expert educational content editor for Cue, a presentation app for primary school teachers (Year 6, ages 10-11, Australian curriculum).

  YOUR TASK:
  Compare a slide deck against a lesson plan and propose actions to condense the deck to only essential, non-redundant slides suitable for a 5-10 minute carpet time lesson.

  For EVERY slide, assign exactly ONE action:
  - "keep": Slide covers an essential lesson plan topic. No changes needed.
  - "edit": Slide covers an essential topic but needs tighter language or merged bullet points. Provide proposedTitle, proposedContent, and proposedSpeakerNotes.
  - "remove": Slide is redundant, off-topic, or duplicates content in another slide. Explain why in reason.
  - "merge": This slide is the TARGET that absorbs content from other slides. Provide mergeWithSlideIndices (0-indexed source slides to absorb), mergedTitle, mergedContent, and mergedSpeakerNotes. The absorbed source slides will be marked as "remove" with reason "Merged into slide N".

  CONDENSATION RULES:
  1. The lesson plan defines what is ESSENTIAL. If a slide topic is not in the lesson plan, it is a removal candidate.
  2. If two slides cover the same lesson plan topic, MERGE them (one gets action "merge", the other gets "remove" with merge reason).
  3. Target deck size: 8-12 slides for a 5-10 minute carpet time lesson. If the deck is already within range, keep most slides.
  4. NEVER remove or edit slides marked [pasted-image] â€” they contain teacher-created visual content. You may only "keep" or "remove" them.
  5. For "edit" slides: tighten language, reduce bullets to 3-5, ensure age-appropriate vocabulary.
  6. Every slide MUST appear exactly once in the actions array, in slide order (index 0 first).
  7. Preserve the overall lesson narrative flow â€” removals should not create logical gaps.

  MERGE SEMANTICS:
  - The "merge" action marks the TARGET slide (the one that will remain with combined content).
  - mergeWithSlideIndices lists the SOURCE slides whose content is absorbed into the target.
  - Each source slide MUST also appear in the actions array with action "remove" and reason "Merged into slide {targetIndex + 1}".
  - Merged content should be synthesized, not simply concatenated â€” combine related bullets, remove duplicates.

  TELEPROMPTER NOTES FORMAT (for edit and merge actions):
  Speaker notes use "Progressive Disclosure" with the ðŸ‘‰ emoji as delimiter between segments.
  - Segment 0 (Intro): Set the scene BEFORE any bullet appears.
  - Segment N: Explain Bullet N after student reads it aloud. Do NOT preview upcoming bullets.
  - Segment count MUST equal bullet count + 1.
  - NEVER repeat slide text in speaker notes â€” add value with examples, analogies, "why this matters".
  ```

  **Section 2 â€” User Prompt Builder** (`buildCondensationUserPrompt(gradeLevel: string)`):
  Returns instruction text asking the AI to analyze the deck against the lesson plan and assign keep/edit/remove/merge actions. Include: "Return a JSON object with summary, originalSlideCount, proposedSlideCount, essentialTopicsPreserved, and an actions array."

  **Section 3 â€” Context Builder** (`buildCondensationContext(slides, lessonPlanText)`):
  Reuse `buildDeckContextForCohesion(slides)` from cohesionPrompts.ts for deck serialization. Same pattern as `buildGapAnalysisContext`: deck context + lesson plan text with 8000 char cap.

  **Section 4 â€” Gemini Response Schema** (`CONDENSATION_RESPONSE_SCHEMA`):
  Use `@google/genai` `Type` enum. Schema matches the `CondensationResult` type:
  - `summary` (STRING, required)
  - `originalSlideCount` (NUMBER, required)
  - `proposedSlideCount` (NUMBER, required)
  - `essentialTopicsPreserved` (ARRAY of STRING, required)
  - `actions` (ARRAY of OBJECT, required), each with:
    - `slideIndex` (NUMBER, required)
    - `action` (STRING, enum: ['keep', 'edit', 'remove', 'merge'], required)
    - `reason` (STRING, required)
    - `proposedTitle` (STRING, optional)
    - `proposedContent` (ARRAY of STRING, optional)
    - `proposedSpeakerNotes` (STRING, optional)
    - `mergeWithSlideIndices` (ARRAY of NUMBER, optional)
    - `mergedTitle` (STRING, optional)
    - `mergedContent` (ARRAY of STRING, optional)
    - `mergedSpeakerNotes` (STRING, optional)

  **Section 5 â€” Claude Tool Schema** (`CONDENSATION_TOOL`):
  Same shape as Gemini schema but in JSON Schema format (matching `GAP_ANALYSIS_TOOL` pattern). Name: `propose_condensation`.

  **B. Gut `services/prompts/cohesionPrompts.ts`**:
  Remove EVERYTHING except `buildDeckContextForCohesion` and its supporting constants (`MAX_COHESION_SLIDES`, `MAX_SPEAKER_NOTES_CHARS`). Remove: `COHESION_SYSTEM_PROMPT`, `buildCohesionUserPrompt`, `COHESION_RESPONSE_SCHEMA`, `COHESION_TOOL`. Remove the `VerbosityLevel` import (no longer needed). Keep the `Slide` import and `Type` import ONLY if needed â€” but since the response schema is removed, `Type` import can also be removed. Keep the file comment but update it to reflect it now only contains the deck serializer.
  </action>
  <verify>
  1. Verify condensationPrompts.ts exports all 5 items: `grep -c 'export' services/prompts/condensationPrompts.ts` should be >= 5.
  2. Verify cohesionPrompts.ts only exports the deck serializer: `grep 'export' services/prompts/cohesionPrompts.ts` should show only `buildDeckContextForCohesion`.
  3. Run `npx tsc --noEmit 2>&1 | grep condensationPrompts` â€” no errors in the new file.
  </verify>
  <done>
  condensationPrompts.ts has system prompt, user prompt builder, context builder, Gemini schema, and Claude tool schema â€” all following the gapAnalysisPrompts.ts pattern. cohesionPrompts.ts is gutted to only the deck serializer function (used by both condensation and gap analysis).
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement condenseDeck in Gemini provider and remove makeDeckCohesive</name>
  <files>services/providers/geminiProvider.ts</files>
  <action>
  1. Update imports at top of file:
     - REMOVE imports of cohesion prompts: `COHESION_SYSTEM_PROMPT`, `buildCohesionUserPrompt`, `COHESION_RESPONSE_SCHEMA`
     - ADD imports from condensationPrompts: `CONDENSATION_SYSTEM_PROMPT`, `buildCondensationUserPrompt`, `buildCondensationContext`, `CONDENSATION_RESPONSE_SCHEMA`
     - Keep `buildDeckContextForCohesion` import from cohesionPrompts (still used by gap analysis)
     - Update aiProvider imports: remove `CohesionResult`, add `CondensationResult`

  2. REPLACE the `makeDeckCohesive` method (around line 473) with `condenseDeck`:

  ```typescript
  async condenseDeck(
    slides: Slide[],
    lessonPlanText: string,
    lessonPlanImages: string[],
    gradeLevel: string
  ): Promise<CondensationResult> {
    try {
      const ai = new GoogleGenAI({ apiKey: this.apiKey });
      const context = buildCondensationContext(slides, lessonPlanText);
      const userPrompt = buildCondensationUserPrompt(gradeLevel);
      const fullPrompt = `${userPrompt}\n\n${context}`;

      // Build contents: multimodal if page images available
      let contents: any;
      if (lessonPlanImages.length > 0) {
        const parts: any[] = [{ text: fullPrompt }];
        const limitedImages = lessonPlanImages.slice(0, 5);
        for (const img of limitedImages) {
          parts.push({
            inlineData: { mimeType: 'image/jpeg', data: img }
          });
        }
        contents = parts;
      } else {
        contents = fullPrompt;
      }

      const response = await ai.models.generateContent({
        model: this.model,
        contents,
        config: {
          systemInstruction: CONDENSATION_SYSTEM_PROMPT,
          responseMimeType: 'application/json',
          responseSchema: CONDENSATION_RESPONSE_SCHEMA,
          temperature: 0.5
        }
      });

      const text = response.text || '{}';
      const parsed = JSON.parse(text);

      // Enrich actions with original slide data for preview display
      const actions = (parsed.actions || []).map((action: any) => {
        const slide = slides[action.slideIndex];
        if (!slide) return null;
        return {
          slideIndex: action.slideIndex,
          action: action.action || 'keep',
          reason: action.reason || '',
          proposedTitle: action.proposedTitle || undefined,
          proposedContent: action.proposedContent || undefined,
          proposedSpeakerNotes: action.proposedSpeakerNotes || undefined,
          mergeWithSlideIndices: action.mergeWithSlideIndices || undefined,
          mergedTitle: action.mergedTitle || undefined,
          mergedContent: action.mergedContent || undefined,
          mergedSpeakerNotes: action.mergedSpeakerNotes || undefined,
        };
      }).filter(Boolean);

      return {
        actions,
        summary: parsed.summary || 'Condensation analysis complete',
        originalSlideCount: slides.length,
        proposedSlideCount: parsed.proposedSlideCount ?? slides.length,
        essentialTopicsPreserved: parsed.essentialTopicsPreserved || []
      };
    } catch (error) {
      console.error('[GeminiProvider] condenseDeck error:', error);
      throw this.wrapError(error);
    }
  }
  ```

  3. The method follows the exact same pattern as `analyzeGaps` (multimodal images, temperature 0.5, structured JSON output). Temperature 0.5 matches gap analysis for analytical consistency.

  4. Ensure the old `makeDeckCohesive` method is completely removed.
  </action>
  <verify>
  Run `npx tsc --noEmit 2>&1 | head -30` â€” expect errors ONLY in claudeProvider.ts (still has old makeDeckCohesive). Gemini provider should compile clean. Verify: `grep 'makeDeckCohesive' services/providers/geminiProvider.ts` returns nothing. `grep 'condenseDeck' services/providers/geminiProvider.ts` returns the method.
  </verify>
  <done>
  Gemini provider has working condenseDeck method with multimodal lesson plan support, temperature 0.5, and structured JSON output. Old makeDeckCohesive is removed. Only claudeProvider.ts still has compilation errors (addressed in Plan 02).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -v claudeProvider | grep -v CohesionPreview | grep -v App.tsx` â€” no errors (claudeProvider and UI files will be fixed in Plans 02/03)
2. `grep 'export.*CondensationResult' services/aiProvider.ts` â€” type is exported
3. `grep 'condenseDeck' services/aiProvider.ts` â€” method exists in interface
4. `grep 'makeDeckCohesive' services/aiProvider.ts services/providers/geminiProvider.ts` â€” returns nothing (fully removed)
5. `grep 'export' services/prompts/cohesionPrompts.ts` â€” only shows buildDeckContextForCohesion
</verification>

<success_criteria>
- CondensationResult, CondensationSlideAction, CondensationAction types are exported from aiProvider.ts
- condenseDeck is in AIProviderInterface with correct signature (slides, lessonPlanText, lessonPlanImages, gradeLevel)
- condensationPrompts.ts has system prompt, user prompt, context builder, Gemini schema, Claude tool schema
- Gemini provider implements condenseDeck with multimodal support and temperature 0.5
- Old CohesionResult/CohesionChange types, makeDeckCohesive interface method, and cohesion prompts (except deck serializer) are removed
- No TypeScript errors in files modified by this plan
</success_criteria>

<output>
After completion, create `.planning/phases/60-deck-condensation/60-01-SUMMARY.md`
</output>
