---
phase: 23-the-chase
plan: 05
type: execute
wave: 3
depends_on: ["23-02", "23-03"]
files_modified:
  - components/games/the-chase/HeadToHeadRound.tsx
  - components/games/the-chase/GameOutcome.tsx
autonomous: true

must_haves:
  truths:
    - "Head-to-Head displays GameBoard with contestant and chaser positions"
    - "Contestant answers first, then chaser responds after thinking delay"
    - "Correct answers move respective player down one step"
    - "Game ends with 'Caught' if chaser reaches contestant position"
    - "Game ends with 'Home Safe' if contestant reaches position 6"
  artifacts:
    - path: "components/games/the-chase/HeadToHeadRound.tsx"
      provides: "Head-to-Head chase mechanics"
      min_lines: 150
    - path: "components/games/the-chase/GameOutcome.tsx"
      provides: "Caught/Home Safe result overlays"
      min_lines: 50
  key_links:
    - from: "components/games/the-chase/HeadToHeadRound.tsx"
      to: "components/games/the-chase/GameBoard.tsx"
      via: "board display"
      pattern: "GameBoard"
    - from: "components/games/the-chase/HeadToHeadRound.tsx"
      to: "hooks/useChaserAI.ts"
      via: "AI answer generation"
      pattern: "useChaserAI"
---

<objective>
Create the Head-to-Head round where contestant races against chaser on the game board.

Purpose: This is the core chase mechanic. Contestant and chaser take turns answering questions. Correct answers move each player down the board. Contestant wins by reaching home (position 6) before being caught. Chaser catches contestant by reaching their position.

Output: HeadToHeadRound component with chase mechanics and GameOutcome celebration/defeat overlays.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-the-chase/23-CONTEXT.md
@.planning/phases/23-the-chase/23-RESEARCH.md
@.planning/phases/23-the-chase/23-02-SUMMARY.md
@.planning/phases/23-the-chase/23-03-SUMMARY.md
@components/games/the-chase/GameBoard.tsx
@hooks/useChaserAI.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HeadToHeadRound component with chase mechanics</name>
  <files>components/games/the-chase/HeadToHeadRound.tsx</files>
  <action>
Create the Head-to-Head chase round:

```typescript
import React, { useState, useEffect, useCallback } from 'react';
import { QuizQuestion } from '../../../services/geminiService';
import { useChaserAI, ChaserDifficulty } from '../../../hooks/useChaserAI';
import GameBoard from './GameBoard';
import ChaserThinking from './ChaserThinking';

type RoundPhase = 'contestant-turn' | 'chaser-turn' | 'showing-result' | 'next-question';

interface HeadToHeadRoundProps {
  questions: QuizQuestion[];
  startingPosition: number;      // Contestant's starting position (from offer)
  chaserStartPosition?: number;  // Chaser always starts at 0
  chaserDifficulty: ChaserDifficulty;
  isAIControlled: boolean;
  prizeAmount: number;
  onComplete: (outcome: 'caught' | 'safe', contestantPosition: number) => void;
  onExit: () => void;
}

const HeadToHeadRound: React.FC<HeadToHeadRoundProps> = ({
  questions,
  startingPosition,
  chaserStartPosition = 0,
  chaserDifficulty,
  isAIControlled,
  prizeAmount,
  onComplete,
  onExit
}) => {
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [contestantPosition, setContestantPosition] = useState(startingPosition);
  const [chaserPosition, setChaserPosition] = useState(chaserStartPosition);
  const [roundPhase, setRoundPhase] = useState<RoundPhase>('contestant-turn');
  const [contestantAnswer, setContestantAnswer] = useState<number | null>(null);
  const [chaserAnswer, setChaserAnswer] = useState<number | null>(null);
  const [contestantCorrect, setContestantCorrect] = useState<boolean | null>(null);
  const [chaserCorrect, setChaserCorrect] = useState<boolean | null>(null);

  const currentQuestion = questions[currentQuestionIndex];
  const { getChaserAnswer, isThinking } = useChaserAI({ difficulty: chaserDifficulty });

  // Check for game end conditions
  const checkGameEnd = useCallback((newContestantPos: number, newChaserPos: number) => {
    if (newContestantPos >= 6) {
      // Contestant reached home - they're safe!
      onComplete('safe', newContestantPos);
      return true;
    }
    if (newChaserPos >= newContestantPos) {
      // Chaser caught up - contestant caught!
      onComplete('caught', newContestantPos);
      return true;
    }
    return false;
  }, [onComplete]);

  // Handle contestant answer
  const handleContestantAnswer = async (selectedIndex: number) => {
    if (roundPhase !== 'contestant-turn') return;

    setContestantAnswer(selectedIndex);
    const isCorrect = selectedIndex === currentQuestion.correctAnswerIndex;
    setContestantCorrect(isCorrect);

    // Move contestant if correct
    let newContestantPos = contestantPosition;
    if (isCorrect) {
      newContestantPos = contestantPosition + 1;
      setContestantPosition(newContestantPos);
    }

    // Brief pause to show result
    setRoundPhase('showing-result');
    await new Promise(r => setTimeout(r, 1000));

    // Check if contestant won
    if (checkGameEnd(newContestantPos, chaserPosition)) return;

    // Now chaser's turn
    setRoundPhase('chaser-turn');

    if (isAIControlled) {
      // AI answers
      const aiAnswer = await getChaserAnswer(currentQuestion);
      setChaserAnswer(aiAnswer);
      const aiCorrect = aiAnswer === currentQuestion.correctAnswerIndex;
      setChaserCorrect(aiCorrect);

      let newChaserPos = chaserPosition;
      if (aiCorrect) {
        newChaserPos = chaserPosition + 1;
        setChaserPosition(newChaserPos);
      }

      // Show chaser result
      setRoundPhase('showing-result');
      await new Promise(r => setTimeout(r, 1500));

      // Check if chaser caught
      if (checkGameEnd(newContestantPos, newChaserPos)) return;

      // Move to next question
      advanceToNextQuestion();
    }
  };

  // Handle manual chaser answer (teacher-controlled)
  const handleChaserAnswer = async (selectedIndex: number) => {
    if (roundPhase !== 'chaser-turn' || isAIControlled) return;

    setChaserAnswer(selectedIndex);
    const isCorrect = selectedIndex === currentQuestion.correctAnswerIndex;
    setChaserCorrect(isCorrect);

    let newChaserPos = chaserPosition;
    if (isCorrect) {
      newChaserPos = chaserPosition + 1;
      setChaserPosition(newChaserPos);
    }

    // Show result
    setRoundPhase('showing-result');
    await new Promise(r => setTimeout(r, 1500));

    // Check if chaser caught
    if (checkGameEnd(contestantPosition, newChaserPos)) return;

    // Move to next question
    advanceToNextQuestion();
  };

  // Advance to next question
  const advanceToNextQuestion = () => {
    if (currentQuestionIndex < questions.length - 1) {
      setCurrentQuestionIndex(prev => prev + 1);
      setContestantAnswer(null);
      setChaserAnswer(null);
      setContestantCorrect(null);
      setChaserCorrect(null);
      setRoundPhase('contestant-turn');
    } else {
      // Out of questions - whoever is ahead wins
      // (In real game this wouldn't happen, but safety net)
      if (contestantPosition > chaserPosition) {
        onComplete('safe', contestantPosition);
      } else {
        onComplete('caught', contestantPosition);
      }
    }
  };

  return (
    <div className="w-full h-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex p-6">
      {/* Left: Game Board */}
      <div className="w-1/3 flex flex-col items-center justify-center">
        <h3 className="text-xl font-bold text-amber-400 mb-4 uppercase tracking-wider">
          The Chase
        </h3>
        <GameBoard
          contestantPosition={contestantPosition}
          chaserPosition={chaserPosition}
        />
        <div className="mt-4 text-center">
          <p className="text-slate-400">
            Prize: <span className="text-amber-400 font-bold">${prizeAmount.toLocaleString()}</span>
          </p>
          <p className="text-slate-500 text-sm mt-1">
            Difficulty: {chaserDifficulty.charAt(0).toUpperCase() + chaserDifficulty.slice(1)}
          </p>
        </div>
      </div>

      {/* Right: Question Area */}
      <div className="flex-1 flex flex-col justify-center px-6">
        {/* Turn Indicator */}
        <div className="text-center mb-6">
          <span className={`inline-block px-6 py-2 rounded-full text-lg font-bold uppercase tracking-wider ${
            roundPhase === 'contestant-turn' ? 'bg-blue-600 text-white' :
            roundPhase === 'chaser-turn' ? 'bg-red-600 text-white' :
            'bg-slate-600 text-white'
          }`}>
            {roundPhase === 'contestant-turn' && 'üë§ Contestant\'s Turn'}
            {roundPhase === 'chaser-turn' && 'üòà Chaser\'s Turn'}
            {roundPhase === 'showing-result' && 'Showing Result...'}
          </span>
        </div>

        {/* Question */}
        <div className="bg-slate-800/60 p-8 rounded-2xl border-2 border-slate-600 mb-6">
          <div className="text-xs text-slate-400 uppercase tracking-wider mb-2">
            Question {currentQuestionIndex + 1} of {questions.length}
          </div>
          <p className="text-2xl md:text-3xl font-bold text-white">
            {currentQuestion?.question}
          </p>
        </div>

        {/* Answer Options */}
        <div className="grid grid-cols-2 gap-4">
          {currentQuestion?.options.map((option, idx) => {
            const isCorrect = idx === currentQuestion.correctAnswerIndex;
            const showContestantResult = contestantAnswer !== null;
            const showChaserResult = chaserAnswer !== null;

            return (
              <button
                key={idx}
                onClick={() => {
                  if (roundPhase === 'contestant-turn') handleContestantAnswer(idx);
                  else if (roundPhase === 'chaser-turn' && !isAIControlled) handleChaserAnswer(idx);
                }}
                disabled={roundPhase === 'showing-result' || (roundPhase === 'chaser-turn' && isAIControlled)}
                className={`
                  p-6 rounded-xl text-left font-bold text-lg transition-all border-2
                  ${showContestantResult || showChaserResult
                    ? isCorrect
                      ? 'bg-green-600 border-green-400 text-white'
                      : contestantAnswer === idx || chaserAnswer === idx
                        ? 'bg-red-600 border-red-400 text-white'
                        : 'bg-slate-700 border-slate-600 text-slate-400'
                    : 'bg-slate-700 border-slate-600 text-white hover:bg-slate-600 hover:border-slate-500'
                  }
                `}
              >
                <span className="text-slate-400 mr-3">{String.fromCharCode(65 + idx)}.</span>
                {option}
              </button>
            );
          })}
        </div>

        {/* Manual chaser control hint */}
        {!isAIControlled && roundPhase === 'chaser-turn' && (
          <p className="text-center text-amber-400 mt-4">
            Teacher: Select the chaser's answer
          </p>
        )}
      </div>

      {/* Chaser Thinking Overlay */}
      <ChaserThinking isVisible={isThinking} />

      {/* Exit button */}
      <button
        onClick={onExit}
        className="absolute bottom-6 right-6 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
      >
        End Game
      </button>
    </div>
  );
};

export default HeadToHeadRound;
```
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>HeadToHeadRound displays game board, handles turn-based answers, moves positions, detects caught/safe outcomes</done>
</task>

<task type="auto">
  <name>Task 2: Create GameOutcome component for victory/defeat</name>
  <files>components/games/the-chase/GameOutcome.tsx</files>
  <action>
Create the outcome celebration/defeat overlays:

```typescript
import React from 'react';

interface GameOutcomeProps {
  outcome: 'caught' | 'safe';
  prizeAmount: number;
  onContinue?: () => void;  // For Final Chase (if safe)
  onPlayAgain?: () => void;
  onExit: () => void;
}

const GameOutcome: React.FC<GameOutcomeProps> = ({
  outcome,
  prizeAmount,
  onContinue,
  onPlayAgain,
  onExit
}) => {
  const isSafe = outcome === 'safe';

  return (
    <div className={`fixed inset-0 flex items-center justify-center z-50
      ${isSafe
        ? 'bg-gradient-to-br from-green-900 via-green-800 to-emerald-900'
        : 'bg-gradient-to-br from-red-900 via-red-800 to-rose-900'
      } animate-fade-in`}
    >
      <div className="text-center max-w-2xl mx-auto p-8">
        {/* Large Icon */}
        <div className="text-9xl mb-6 animate-bounce">
          {isSafe ? 'üè†' : 'üòà'}
        </div>

        {/* Outcome Title */}
        <h1 className={`text-6xl font-black mb-4 uppercase tracking-wider ${
          isSafe ? 'text-green-400' : 'text-red-400'
        }`}>
          {isSafe ? 'HOME SAFE!' : 'CAUGHT!'}
        </h1>

        {/* Subtitle */}
        <p className="text-2xl text-white mb-8">
          {isSafe
            ? 'You outran the Chaser!'
            : 'The Chaser got you!'}
        </p>

        {/* Prize Info */}
        <div className={`inline-block px-8 py-4 rounded-2xl mb-10 ${
          isSafe ? 'bg-green-800/50' : 'bg-red-800/50'
        }`}>
          {isSafe ? (
            <>
              <p className="text-slate-300 text-lg">You won:</p>
              <p className="text-5xl font-black text-green-400">
                ${prizeAmount.toLocaleString()}
              </p>
            </>
          ) : (
            <>
              <p className="text-slate-300 text-lg">Prize lost</p>
              <p className="text-4xl font-bold text-red-400 line-through">
                ${prizeAmount.toLocaleString()}
              </p>
            </>
          )}
        </div>

        {/* Action Buttons */}
        <div className="flex justify-center gap-4">
          {isSafe && onContinue && (
            <button
              onClick={onContinue}
              className="px-8 py-4 bg-amber-500 hover:bg-amber-400 text-amber-950 font-bold text-xl rounded-xl transition-colors"
            >
              Continue to Final Chase ‚Üí
            </button>
          )}

          {onPlayAgain && (
            <button
              onClick={onPlayAgain}
              className="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-xl rounded-xl transition-colors"
            >
              Play Again
            </button>
          )}

          <button
            onClick={onExit}
            className="px-8 py-4 bg-white text-slate-900 font-bold text-xl rounded-xl hover:scale-105 transition-transform"
          >
            Back to Lesson
          </button>
        </div>
      </div>
    </div>
  );
};

export default GameOutcome;
```

Features:
- Full-screen overlay with gradient background
- Green theme for "Home Safe", red theme for "Caught"
- Large animated icon (house for safe, chaser for caught)
- Prize display (won amount or crossed out lost amount)
- Continue to Final Chase option if safe
- Play Again and Exit buttons
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>GameOutcome shows victory (green, house icon) or defeat (red, chaser icon) with appropriate messaging and actions</done>
</task>

</tasks>

<verification>
- `npm run build` passes with no TypeScript errors
- HeadToHeadRound renders GameBoard with positions
- Contestant turn allows clicking answers
- AI chaser uses thinking delay before answering
- Positions update with CSS animation on correct answers
- Game ends with GameOutcome when caught or safe
</verification>

<success_criteria>
- GameBoard displays during Head-to-Head with updating positions
- Turn indicator shows whose turn (contestant blue, chaser red)
- Contestant answers first, result shown before chaser turn
- Chaser AI has configurable thinking delay and accuracy
- Correct answers move player down one step (animated)
- "Caught" triggers when chaser reaches contestant position
- "Home Safe" triggers when contestant reaches position 6
- GameOutcome shows appropriate celebration/defeat screen
</success_criteria>

<output>
After completion, create `.planning/phases/23-the-chase/23-05-SUMMARY.md`
</output>
