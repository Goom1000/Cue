---
phase: 64-pdf-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/pdfService.ts
  - components/ShareModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can select PDF format in the share dialog and receive a downloaded PDF file"
    - "Text in the PDF is crisp and readable (vector text, not rasterized screenshots)"
    - "Each page presents the slide image alongside expanded talking points in a print-friendly layout"
  artifacts:
    - path: "services/pdfService.ts"
      provides: "exportScriptPdf function for script-mode PDF download"
      exports: ["exportScriptPdf"]
    - path: "components/ShareModal.tsx"
      provides: "PDF format selection and download wiring"
      contains: "exportScriptPdf"
  key_links:
    - from: "components/ShareModal.tsx"
      to: "services/pdfService.ts"
      via: "import { exportScriptPdf } and call in handleDownload"
      pattern: "exportScriptPdf\\(slides.*transformResult.*lessonTitle\\)"
    - from: "services/pdfService.ts"
      to: "services/aiProvider.ts"
      via: "import ColleagueTransformationResult type"
      pattern: "ColleagueTransformationResult"
    - from: "services/pdfService.ts"
      to: "jspdf"
      via: "import { jsPDF } from 'jspdf'"
      pattern: "new jsPDF"
---

<objective>
Create the exportScriptPdf function and wire it into ShareModal so teachers can download a PDF version of their script-mode deck with readable vector text, slide thumbnails, and expanded talking-point bullets.

Purpose: Completes v4.1 Script Mode by providing PDF as a second export format alongside PPTX. PDF is better for printing, sharing via email, and viewing on any device without PowerPoint.
Output: services/pdfService.ts (new file), components/ShareModal.tsx (modified to enable PDF)
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-pdf-export/64-RESEARCH.md
@.planning/phases/62-pptx-export/62-01-SUMMARY.md
@.planning/phases/63-share-modal-ui/63-01-SUMMARY.md
@services/pptxService.ts
@services/exportService.ts
@components/ShareModal.tsx
@services/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exportScriptPdf function in services/pdfService.ts</name>
  <files>services/pdfService.ts</files>
  <action>
Create `services/pdfService.ts` with an `exportScriptPdf(slides: Slide[], transformationResult: ColleagueTransformationResult, title: string): void` function.

**Function signature mirrors exportScriptPptx** from pptxService.ts (same 3 parameters, same void return). This is a synchronous function -- jsPDF's `doc.save()` triggers the browser download.

**PDF setup:**
- `new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' })`
- Reuse the same page dimensions as exportService.ts: A4 portrait, marginLeft 25mm (binding), marginRight 15mm, marginTop 20mm, marginBottom 20mm, contentWidth 170mm, pageBottom 277mm. Define these as local constants (do NOT import PDF_CONFIG from exportService.ts -- keep pdfService self-contained to avoid coupling).

**Per-slide rendering (iterate `transformationResult.slides`):**
For each transformed slide (add a new page for index > 0):
1. Look up `originalSlide = slides[transformed.slideIndex]` with safety check (skip if not found)
2. Image source: `originalSlide.originalPastedImage || originalSlide.imageUrl` (pasted image priority per MEMORY.md)

**Layout per page:**
- **Slide number** (top-left): "Slide {slideIndex + 1}" in 10pt Helvetica normal, gray (#999999), at (marginLeft, marginTop)
- **Title** (below number): `transformed.originalTitle` in 16pt Helvetica bold, dark (#1e293b), at (marginLeft, marginTop + 8mm). If image exists, title width is `contentWidth - 55mm` (leaving room for thumbnail). If no image, title width is full `contentWidth`. Use `doc.splitTextToSize()` for wrapping.
- **Thumbnail** (top-right, only if image exists): Target max dimensions 50mm x 38mm. Position at (marginLeft + contentWidth - 50mm, marginTop). Use aspect-ratio-safe sizing: load image into an `Image()` element to get naturalWidth/naturalHeight, then calculate proportional dimensions fitting within 50x38mm. Use `doc.addImage(imageSource, 'JPEG', x, y, w, h)`. Before embedding, compress the image via canvas: draw to a canvas with max width 400px, export as JPEG 0.8 quality. This prevents PDF size explosion (research pitfall #3). Create a helper `compressImageForPdf(dataUrl: string, maxWidth: number): Promise<{ dataUrl: string; width: number; height: number }>` that returns the compressed data URL and natural dimensions.
- **Bullets start** Y position: below whichever is taller (title block or thumbnail), plus 4mm gap. For images, this is approximately marginTop + 42mm. For no-image slides, it follows after the wrapped title.
- **Bullet rendering**: For each `expandedBullets` string:
  - Check for cue markers: if bullet starts with `[Discussion point]`, `[Activity]`, `[Question]`, or `[Answer]`, render in 10pt Helvetica italic, indigo color (#4F46E5 dark text color) with 5mm indent. Strip the marker prefix and render the remaining text after it.
  - For regular bullets: render with a bullet character (Unicode \u2022) at marginLeft, text at marginLeft + 5mm, in 11pt Helvetica normal, dark text (#334155). Use `doc.splitTextToSize()` for wrapping within `contentWidth - 5mm`.
  - **Bold key terms**: Parse `**markers**` for inline bold rendering. Split bullet text on `/(\*\*.*?\*\*)/` regex. For each segment: if wrapped in `**`, strip markers and render with `doc.setFont('helvetica', 'bold')`; otherwise render with `doc.setFont('helvetica', 'normal')`. Track x-position using `doc.getStringUnitWidth(text) * fontSize / doc.internal.scaleFactor`. IMPORTANT: run `splitTextToSize()` on the **stripped** text (no `**` markers) to get correct line widths. Then for each wrapped line, re-parse bold markers from the original text for rendering. If this proves too complex during implementation, fall back to stripping `**` markers entirely (like pptxService.ts does) -- readable text is more important than perfect bold formatting.
  - Line spacing: 6mm per line, 4mm extra gap between bullets.
  - Page break check before each line: if `y + 6 > pageBottom`, call `doc.addPage()`, reset `y = marginTop`, and add a continuation header: "Slide {N} (continued)" in 10pt Helvetica italic, gray, at (marginLeft, marginTop), then advance y by 8mm.

**File download:**
- Sanitize title: `title.replace(/[<>:"/\\|?*]/g, '').trim() || 'Lesson'` (same pattern as pptxService.ts)
- `doc.save(\`${sanitizedTitle} - Script Version.pdf\`)`

**Note on async:** The `compressImageForPdf` helper is async (uses Image onload + canvas). Therefore `exportScriptPdf` must be `async` and return `Promise<void>`. This differs from `exportScriptPptx` which is synchronous. The ShareModal handler will need to await it.

**Exports:** `export async function exportScriptPdf(...)`
  </action>
  <verify>
TypeScript compiles: run `npx tsc --noEmit` from project root. The file should import correctly from jspdf, ../types, and ./aiProvider.
  </verify>
  <done>
services/pdfService.ts exists with exportScriptPdf function that: creates A4 portrait PDF via jsPDF, iterates transformationResult.slides, renders slide number + title + compressed thumbnail + expanded bullets with bold formatting and cue marker styling, handles page breaks with continuation headers, and triggers browser download with sanitized filename.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable PDF format in ShareModal and wire download handler</name>
  <files>components/ShareModal.tsx</files>
  <action>
Modify `components/ShareModal.tsx` to enable the PDF export path.

**Import:** Add `import { exportScriptPdf } from '../services/pdfService';` alongside the existing pptxService import.

**Enable PDF button** (~line 255-259): Remove `disabled` attribute from the PDF format button. Make it a selectable option like the PPTX button. Replace the hardcoded "Coming soon" text:
- Change from: `<button disabled className="... opacity-50 cursor-not-allowed">PDF (.pdf) -- Coming soon</button>`
- Change to: `<button onClick={() => setSelectedFormat('pdf')} className={selectedFormat === 'pdf' ? activeClasses : inactiveClasses}>PDF (.pdf)</button>`
- Use the same conditional className pattern as the PPTX button (indigo border when selected, slate border when not).

**Update handleDownload** (~line 104-122): The function currently guards with `if (selectedFormat !== 'pptx') return;`. Change to support both formats:
```
const handleDownload = async () => {
  if (!transformResult) return;
  setPhase('exporting');
  setTimeout(async () => {
    try {
      if (selectedFormat === 'pptx') {
        exportScriptPptx(slides, transformResult, lessonTitle);
      } else {
        await exportScriptPdf(slides, transformResult, lessonTitle);
      }
      addToast(`Script version downloaded as ${selectedFormat.toUpperCase()}!`, 3000, 'success');
      onClose();
    } catch (error) {
      console.error('[ShareModal] Export failed:', error);
      addToast('Export failed. Please try again.', 5000, 'error');
      setPhase('preview');
    }
  }, 50);
};
```

**Update exporting phase text** (~line 199-206): Change "Generating PowerPoint..." to a format-aware message. Use `selectedFormat === 'pptx' ? 'Generating PowerPoint...' : 'Generating PDF...'`. Note: `selectedFormat` is accessible here since it's component state.

**Download button disabled state** (~line 273): Remove the `disabled={selectedFormat !== 'pptx'}` condition from the Download button. Both formats are now supported, so the button should always be enabled when in preview phase.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`. The ShareModal should import exportScriptPdf without errors. Visually verify by searching the file for: (1) no "Coming soon" text, (2) no `disabled` on the PDF button, (3) `exportScriptPdf` call in handleDownload, (4) format-aware exporting message.
  </verify>
  <done>
ShareModal PDF button is enabled and selectable. Clicking Download with PDF selected calls exportScriptPdf and triggers a PDF download. The exporting spinner shows "Generating PDF..." when PDF format is selected. Both PPTX and PDF paths work through the same handleDownload function.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors (both new and modified files compile)
2. `services/pdfService.ts` exists and exports `exportScriptPdf`
3. `components/ShareModal.tsx` imports `exportScriptPdf` and calls it when `selectedFormat === 'pdf'`
4. No "Coming soon" text remains on the PDF button in ShareModal
5. The PDF button in ShareModal is not disabled -- it can be selected
6. The Download button is not gated on `selectedFormat !== 'pptx'`
</verification>

<success_criteria>
- A teacher can open the Share modal, select PDF format, and click Download
- The downloaded PDF has vector text (not rasterized), slide thumbnails, and expanded bullets
- Each page shows slide number, title, thumbnail (when image exists), and talking-point bullets
- Bold key terms are rendered in bold (or gracefully stripped if complexity was too high)
- Cue markers ([Discussion point], [Activity], etc.) are visually distinct from regular bullets
- Page breaks mid-slide include continuation headers
- PDF file size is reasonable (compressed thumbnails, not raw base64 PNGs)
</success_criteria>

<output>
After completion, create `.planning/phases/64-pdf-export/64-01-SUMMARY.md`
</output>
