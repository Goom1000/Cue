---
phase: 62-pptx-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/pptxService.ts
autonomous: true

must_haves:
  truths:
    - "exportScriptPptx function exists and is callable with (slides, transformationResult, title)"
    - "Each exported slide shows the slide title at the top for topic orientation"
    - "Each exported slide shows expanded talking-point bullets in 16pt font with bullet formatting"
    - "Each exported slide shows the slide image as a small thumbnail in the top-right (when image exists)"
    - "Pasted slides use originalPastedImage as the thumbnail source"
    - "Text overflow is handled via fit:shrink so no bullets are clipped"
    - "The downloaded filename follows the pattern '{deckTitle} - Script Version.pptx' with illegal characters stripped"
    - "Slides without teleprompter content (not in transformedSlides) are omitted from the export"
  artifacts:
    - path: "services/pptxService.ts"
      provides: "exportScriptPptx function for script-mode PPTX export"
      exports: ["exportToPowerPoint", "exportScriptPptx"]
      contains: "exportScriptPptx"
  key_links:
    - from: "services/pptxService.ts"
      to: "services/aiProvider.ts"
      via: "import TransformedSlide, ColleagueTransformationResult"
      pattern: "import.*ColleagueTransformationResult.*from.*aiProvider"
    - from: "services/pptxService.ts"
      to: "window.PptxGenJS"
      via: "CDN-loaded PptxGenJS constructor"
      pattern: "new window\\.PptxGenJS"
---

<objective>
Add a dedicated `exportScriptPptx` function to pptxService.ts that exports AI-transformed talking-point bullets as a downloadable PowerPoint file with a layout optimized for expanded text.

Purpose: Phase 63 (Share Modal UI) needs this export function to trigger PPTX downloads. This plan creates the pure export logic with no UI wiring.
Output: `exportScriptPptx` function exported from `services/pptxService.ts`
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-pptx-export/62-RESEARCH.md
@services/pptxService.ts
@services/aiProvider.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exportScriptPptx function to pptxService.ts</name>
  <files>services/pptxService.ts</files>
  <action>
Add a new exported function `exportScriptPptx` to `services/pptxService.ts` alongside the existing `exportToPowerPoint`. Do NOT modify the existing function.

**Signature:**
```typescript
export const exportScriptPptx = (
  slides: Slide[],
  transformationResult: ColleagueTransformationResult,
  title: string
): void => { ... }
```

**Import:** Add `import { ColleagueTransformationResult } from './aiProvider';` at the top (TransformedSlide is used via the result object).

**Guard:** Check `window.PptxGenJS` at start, alert and return if not loaded.

**PptxGenJS setup:**
- `pptx.layout = 'LAYOUT_16x9'`
- `pptx.title = \`${title} - Script Version\``

**Iterate over `transformationResult.slides`** (NOT over the `slides` array). For each `transformed`:
- Look up `originalSlide = slides[transformed.slideIndex]` with safety check (continue if not found)
- Determine image source: `originalSlide.originalPastedImage || originalSlide.imageUrl` (pasted original takes priority per MEMORY.md)
- `hasImage = !!imageSource`

**Layout per slide (dedicated script-mode, NOT reusing existing layout):**
- Background: white (`FFFFFF`)
- Title: `transformed.originalTitle` at x=0.5, y=0.3, w=hasImage?6.5:9.0, h=0.6, fontSize=18, fontFace='Arial', color='1e293b', bold=true, valign='top'
- Image thumbnail (only if hasImage): `addImage({ data: imageSource, x: 7.2, y: 0.3, w: 2.5, h: 1.9, sizing: { type: 'contain', w: 2.5, h: 1.9 } })`
- Expanded bullets: Map `transformed.expandedBullets` to text runs with `{ text: bulletText, options: { breakLine: true } }`. Before mapping, strip any `**` markdown bold markers from each bullet string (replace `**` with empty string). Place at x=0.5, y=1.3, w=hasImage?6.5:9.0, h=4.0, fontSize=16, fontFace='Arial', color='334155', bullet=true, paraSpaceBefore=6, lineSpacingMultiple=1.15, valign='top', fit='shrink'
- Speaker notes: If `originalSlide.speakerNotes` exists, add with prefix "Original teleprompter script:\n\n" to distinguish from on-slide bullets

**Filename:**
- Sanitize title by stripping `<>:"/\|?*` characters
- Fallback to 'Lesson' if empty after sanitization
- Pattern: `${sanitizedTitle} - Script Version.pptx`
- Call `pptx.writeFile({ fileName: ... })`

**Key constraints:**
- Do NOT mutate original Slide objects
- Do NOT use `slide.content` -- use `transformed.expandedBullets` exclusively
- Do NOT reuse the existing exportToPowerPoint layout -- this is a separate function with its own layout
- Use `fit: 'shrink'` (not deprecated `shrinkText` or `autoFit`)
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root -- should pass with no errors. Verify the file exports both `exportToPowerPoint` and `exportScriptPptx` by checking the file content.
  </verify>
  <done>
`services/pptxService.ts` exports `exportScriptPptx` that: (1) accepts Slide[], ColleagueTransformationResult, and title, (2) generates a PPTX with dedicated script-mode layout (18pt title, 16pt bullets, 2.5x1.9" image thumbnail), (3) handles pasted slides via originalPastedImage, (4) strips bold markers from bullets, (5) uses fit:shrink for overflow prevention, (6) downloads with "{title} - Script Version.pptx" filename, and (7) TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (TypeScript compilation)
- `services/pptxService.ts` contains both `exportToPowerPoint` and `exportScriptPptx` as named exports
- `exportScriptPptx` imports `ColleagueTransformationResult` from `./aiProvider`
- The function iterates `transformationResult.slides` (not the slides array directly)
- Layout uses fontSize 16 for bullets (not 24 like the existing export)
- `fit: 'shrink'` is present on the bullet text options
- Image uses `originalPastedImage || imageUrl` for source resolution
- Filename includes " - Script Version" suffix with character sanitization
</verification>

<success_criteria>
A new `exportScriptPptx` function is exported from `services/pptxService.ts` that Phase 63 can call to trigger a PPTX download containing script-mode slides with expanded talking-point bullets, image thumbnails, and titles. TypeScript compiles cleanly. The existing `exportToPowerPoint` function is unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/62-pptx-export/62-01-SUMMARY.md`
</output>
