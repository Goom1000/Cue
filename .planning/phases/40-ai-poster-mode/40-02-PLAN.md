---
phase: 40-ai-poster-mode
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - components/PosterRenderer.tsx
  - components/ExportModal.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can select AI Poster mode from export modal"
    - "AI-generated posters visibly differ from original slides (larger text, clearer hierarchy)"
    - "Poster content reflects understanding of surrounding slide context"
    - "Poster explains concepts in student-friendly language"
    - "Poster PDF downloads in A4 format ready for printing"
    - "Teacher can regenerate any poster they don't like"
  artifacts:
    - path: "components/PosterRenderer.tsx"
      provides: "React component that renders PosterLayout to DOM"
      exports: ["PosterRenderer"]
    - path: "components/ExportModal.tsx"
      provides: "Updated with AI Poster flow"
      contains: "ai-poster"
  key_links:
    - from: "components/ExportModal.tsx"
      to: "services/posterService.ts"
      via: "generatePosterLayouts call"
      pattern: "generatePosterLayouts"
    - from: "components/ExportModal.tsx"
      to: "components/PosterRenderer.tsx"
      via: "PosterRenderer import and render"
      pattern: "PosterRenderer"
---

<objective>
Integrate AI poster generation into the export modal with preview, regeneration, and PDF download.

Purpose: Complete the AI Poster Mode feature by wiring the poster service into the existing export modal, adding a poster preview grid with regenerate buttons, and enabling A4 portrait PDF generation using the same html2canvas approach from Quick Export.

Output: PosterRenderer.tsx component for rendering layouts, ExportModal.tsx updated with full AI Poster flow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-ai-poster-mode/40-CONTEXT.md
@.planning/phases/40-ai-poster-mode/40-RESEARCH.md
@.planning/phases/40-ai-poster-mode/40-01-SUMMARY.md
@components/ExportModal.tsx
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PosterRenderer.tsx component</name>
  <files>components/PosterRenderer.tsx</files>
  <action>
Create a React component that renders a PosterLayout as a styled A4 portrait element suitable for html2canvas capture.

```typescript
import React from 'react';
import { PosterLayout, PosterSection } from '../types';

interface PosterRendererProps {
  layout: PosterLayout;
}

/**
 * Renders a PosterLayout as an A4 portrait-sized div for PDF capture.
 * Uses inline styles for color scheme (dynamic per-poster) and Tailwind for structure.
 *
 * Dimensions: 595x842px (A4 at 72 DPI, will be captured at 2x for print quality)
 */
const PosterRenderer: React.FC<PosterRendererProps> = ({ layout }) => {
  const titleSizeClasses = {
    'large': 'text-4xl',   // ~36-48pt at this scale
    'xl': 'text-5xl',      // ~48-60pt
    '2xl': 'text-6xl'      // ~60-72pt
  };

  const renderSection = (section: PosterSection, index: number) => {
    const baseClasses = section.emphasis
      ? 'p-3 rounded-lg border-2'
      : '';

    const emphasisStyle = section.emphasis
      ? {
          borderColor: layout.colorScheme.primary,
          backgroundColor: `${layout.colorScheme.primary}15` // 15% opacity
        }
      : {};

    return (
      <div
        key={index}
        className={baseClasses}
        style={emphasisStyle}
      >
        {/* Section heading */}
        {section.heading && (
          <h2
            className="text-xl font-semibold mb-1"
            style={{ color: layout.colorScheme.primary }}
          >
            {section.heading}
          </h2>
        )}

        {/* Section content by format */}
        {section.format === 'bullet' ? (
          <div className="flex items-start gap-2">
            <span
              className="text-lg mt-0.5 flex-shrink-0"
              style={{ color: layout.colorScheme.primary }}
            >
              {'\u2022'}
            </span>
            <p className="text-base leading-relaxed">{section.content}</p>
          </div>
        ) : section.format === 'callout' ? (
          <div
            className="p-3 rounded-lg border-l-4"
            style={{
              borderLeftColor: layout.colorScheme.primary,
              backgroundColor: `${layout.colorScheme.secondary}10`
            }}
          >
            <p className="text-base font-medium leading-relaxed">{section.content}</p>
          </div>
        ) : (
          <p className="text-base leading-relaxed">{section.content}</p>
        )}
      </div>
    );
  };

  return (
    <div
      className="w-[595px] h-[842px] p-8 flex flex-col font-sans"
      style={{
        backgroundColor: layout.colorScheme.background,
        color: layout.colorScheme.text
      }}
    >
      {/* Title */}
      <h1
        className={`${titleSizeClasses[layout.typography.titleSize]} font-bold mb-2 leading-tight`}
        style={{ color: layout.colorScheme.primary }}
      >
        {layout.title}
      </h1>

      {/* Subtitle */}
      {layout.subtitle && (
        <p
          className="text-lg mb-6 italic"
          style={{ color: layout.colorScheme.secondary }}
        >
          {layout.subtitle}
        </p>
      )}

      {/* Decorative divider */}
      <div
        className="h-1 w-24 mb-6 rounded"
        style={{ backgroundColor: layout.colorScheme.primary }}
      />

      {/* Sections */}
      <div className="flex-1 space-y-4 overflow-hidden">
        {layout.sections.map((section, i) => renderSection(section, i))}
      </div>

      {/* Footer decoration */}
      <div
        className="h-1 w-full mt-6 rounded"
        style={{ backgroundColor: layout.colorScheme.primary }}
      />
    </div>
  );
};

export default PosterRenderer;
```

Key design decisions:
- 595x842px matches A4 portrait at 72 DPI (will be captured at 2x for ~150 DPI print)
- Uses inline styles for dynamic colorScheme from AI
- Tailwind classes for consistent typography and spacing
- Supports all three section formats: bullet, paragraph, callout
- Emphasis sections get border and tinted background
  </action>
  <verify>Run `npm run build` - should compile with no errors.</verify>
  <done>PosterRenderer.tsx created with layout rendering support</done>
</task>

<task type="auto">
  <name>Task 2: Add AI Poster flow to ExportModal.tsx</name>
  <files>components/ExportModal.tsx</files>
  <action>
Update ExportModal to support AI Poster mode with generation, preview, regeneration, and PDF export.

1. Add imports at top:
```typescript
import PosterRenderer from './PosterRenderer';
import { PosterLayout } from '../types';
import { generatePosterLayouts, PosterGenerationProgress } from '../services/posterService';
```

2. Add new state variables after existing state:
```typescript
// AI Poster state
const [posterLayouts, setPosterLayouts] = useState<PosterLayout[]>([]);
const [isGeneratingPosters, setIsGeneratingPosters] = useState(false);
const [posterProgress, setPosterProgress] = useState<PosterGenerationProgress | null>(null);
const [regeneratingIndex, setRegeneratingIndex] = useState<number | null>(null);
```

3. Add API key retrieval (after state declarations):
```typescript
// Get API key from localStorage (same pattern as other AI features)
const getApiKey = (): string => {
  try {
    const settings = JSON.parse(localStorage.getItem('ai_settings') || '{}');
    return settings.apiKey || '';
  } catch {
    return '';
  }
};
```

4. Add poster generation function:
```typescript
// Generate AI posters for selected slides
const generatePosters = async () => {
  const apiKey = getApiKey();
  if (!apiKey) {
    console.error('No API key configured');
    return;
  }

  setIsGeneratingPosters(true);
  setPosterLayouts([]);

  try {
    // Get indices of selected slides
    const selectedIndices = selectedSlides.map(s => slides.findIndex(slide => slide.id === s.id));

    const layouts = await generatePosterLayouts(
      slides,
      selectedIndices,
      apiKey,
      (progress) => setPosterProgress(progress)
    );

    setPosterLayouts(layouts);
  } catch (error) {
    console.error('Poster generation error:', error);
    // Could show toast here
  } finally {
    setIsGeneratingPosters(false);
    setPosterProgress(null);
  }
};
```

5. Add regenerate single poster function:
```typescript
// Regenerate a single poster
const regeneratePoster = async (layoutIndex: number) => {
  const apiKey = getApiKey();
  if (!apiKey) return;

  setRegeneratingIndex(layoutIndex);

  try {
    const slideIndex = slides.findIndex(s => s.id === selectedSlides[layoutIndex].id);

    const [newLayout] = await generatePosterLayouts(
      slides,
      [slideIndex],
      apiKey
    );

    // Update the specific layout
    setPosterLayouts(prev => {
      const updated = [...prev];
      updated[layoutIndex] = newLayout;
      return updated;
    });
  } catch (error) {
    console.error('Poster regeneration error:', error);
  } finally {
    setRegeneratingIndex(null);
  }
};
```

6. Add PDF generation for posters:
```typescript
// Generate PDF from poster layouts (A4 portrait)
const generatePosterPDF = async () => {
  if (posterLayouts.length === 0) return;

  setIsGenerating(true);
  setGenerationProgress({ current: 0, total: posterLayouts.length });

  try {
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'pt',
      format: 'a4'
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    for (let i = 0; i < posterLayouts.length; i++) {
      if (i > 0) pdf.addPage();
      setGenerationProgress({ current: i + 1, total: posterLayouts.length });

      const container = renderContainerRef.current;
      if (!container) continue;

      // Create temporary element for this poster
      const posterElement = document.createElement('div');
      posterElement.style.width = '595px';
      posterElement.style.height = '842px';
      posterElement.style.position = 'relative';
      container.innerHTML = '';
      container.appendChild(posterElement);

      // Render PosterRenderer into element
      const root = ReactDOM.createRoot(posterElement);
      root.render(<PosterRenderer layout={posterLayouts[i]} />);

      // Wait for render + fonts
      await document.fonts.ready;
      await new Promise(resolve => setTimeout(resolve, 200));

      // Capture to canvas
      const canvas = await html2canvas(posterElement, {
        scale: 2,
        useCORS: true,
        allowTaint: false,
        backgroundColor: posterLayouts[i].colorScheme.background,
        logging: false
      });

      // Add to PDF
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);

      // Cleanup
      root.unmount();
    }

    // Generate filename
    const date = new Date().toISOString().split('T')[0];
    const filename = `AI Poster Export - ${date}.pdf`;

    pdf.save(filename);
    onClose();
  } catch (error) {
    console.error('PDF generation error:', error);
  } finally {
    setIsGenerating(false);
    setGenerationProgress(null);
  }
};
```

7. Update handleExport to route to correct function:
```typescript
const handleExport = () => {
  if (exportMode === 'quick') {
    generatePDF();
  } else if (exportMode === 'ai-poster') {
    if (posterLayouts.length > 0) {
      // Already have layouts, generate PDF
      generatePosterPDF();
    } else {
      // Need to generate layouts first
      generatePosters();
    }
  }
};
```

8. Enable the AI Poster button (currently disabled) - replace the disabled button with:
```typescript
{/* AI Poster */}
<button
  onClick={() => {
    setExportMode('ai-poster');
    setPosterLayouts([]); // Reset layouts when switching mode
  }}
  className={`p-4 rounded-xl border-2 text-left transition-all ${
    exportMode === 'ai-poster'
      ? 'border-purple-600 dark:border-purple-400 bg-purple-50 dark:bg-purple-500/10'
      : 'border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'
  }`}
>
  <div className="flex items-center gap-2 mb-2">
    <svg className="w-5 h-5 text-purple-500 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
    </svg>
    <h3 className="font-bold text-slate-800 dark:text-white">AI Poster</h3>
  </div>
  <p className="text-sm text-slate-500 dark:text-slate-400">
    Transform into educational posters
  </p>
</button>
```

9. Update the preview section to show different content based on mode. Replace the preview section with conditional rendering:

```typescript
{/* Preview Section */}
<div className="flex-1 overflow-y-auto px-6 py-6">
  {exportMode === 'quick' ? (
    <>
      {/* Existing Quick Export preview - keep current code */}
      <label className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide font-bold mb-3 block">
        Selected Slides ({selectedSlides.length})
      </label>
      {/* ... existing slide preview grid ... */}
    </>
  ) : (
    <>
      {/* AI Poster preview */}
      <label className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide font-bold mb-3 block">
        {posterLayouts.length > 0
          ? `AI Posters (${posterLayouts.length})`
          : `Selected Slides (${selectedSlides.length})`
        }
      </label>

      {isGeneratingPosters ? (
        <div className="h-48 flex flex-col items-center justify-center border-2 border-dashed border-purple-200 dark:border-purple-800 rounded-2xl">
          <div className="w-10 h-10 border-4 border-purple-600 dark:border-purple-400 border-t-transparent rounded-full animate-spin mb-4"></div>
          <p className="font-bold text-slate-700 dark:text-white">
            Generating poster {posterProgress?.current || 1} of {posterProgress?.total || selectedSlides.length}...
          </p>
          <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
            AI is transforming your slides
          </p>
        </div>
      ) : posterLayouts.length === 0 ? (
        <div className="h-48 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-2xl text-slate-400 dark:text-slate-500">
          <svg className="w-12 h-12 mb-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
          </svg>
          <p className="font-medium">Ready to generate AI posters</p>
          <p className="text-sm mt-1">Click "Generate Posters" to transform {selectedSlides.length} slide{selectedSlides.length !== 1 ? 's' : ''}</p>
        </div>
      ) : (
        <div className="grid grid-cols-2 gap-4">
          {posterLayouts.map((layout, idx) => (
            <div
              key={idx}
              className="relative group rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700"
              style={{ aspectRatio: '595/842' }}
            >
              {/* Poster thumbnail */}
              <div className="w-full h-full overflow-hidden" style={{ transform: 'scale(0.2)', transformOrigin: 'top left', width: '500%', height: '500%' }}>
                <PosterRenderer layout={layout} />
              </div>

              {/* Poster title overlay */}
              <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                <p className="text-white text-sm font-bold truncate">{layout.title}</p>
              </div>

              {/* Regenerate button */}
              <button
                onClick={() => regeneratePoster(idx)}
                disabled={regeneratingIndex !== null || isGenerating}
                className="absolute top-2 right-2 w-8 h-8 bg-purple-500 hover:bg-purple-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                title="Regenerate this poster"
              >
                {regeneratingIndex === idx ? (
                  <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                ) : (
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                )}
              </button>
            </div>
          ))}
        </div>
      )}
    </>
  )}
</div>
```

10. Update the export button text and behavior:
```typescript
const getExportButtonText = () => {
  if (isGenerating && generationProgress) {
    return `Generating PDF... ${generationProgress.current}/${generationProgress.total}`;
  }
  if (exportMode === 'ai-poster') {
    if (isGeneratingPosters) {
      return `Generating Posters... ${posterProgress?.current || 0}/${posterProgress?.total || 0}`;
    }
    if (posterLayouts.length > 0) {
      return posterLayouts.length === 1 ? 'Export 1 Poster' : `Export ${posterLayouts.length} Posters`;
    }
    return 'Generate Posters';
  }
  const count = selectedSlides.length;
  return count === 1 ? 'Export 1 Slide' : `Export ${count} Slides`;
};
```

11. Update hidden render container for portrait (add second container):
```typescript
{/* Hidden render container for PDF capture */}
<div
  ref={renderContainerRef}
  className="fixed -left-[9999px] top-0 pointer-events-none"
  style={{ width: exportMode === 'ai-poster' ? '595px' : '1190px', height: exportMode === 'ai-poster' ? '842px' : '842px' }}
  aria-hidden="true"
/>
```

12. Disable export button appropriately:
```typescript
disabled={selectedSlides.length === 0 || isGenerating || isGeneratingPosters}
```
  </action>
  <verify>
1. Run `npm run build` - should compile with no errors
2. Manual test: Open export modal, select AI Poster mode, click Generate Posters
3. Verify posters generate with progress indicator
4. Verify regenerate button works on individual posters
5. Verify PDF export produces A4 portrait pages
  </verify>
  <done>
- AI Poster mode selectable in export modal
- Posters generate with progress indicator
- Preview shows generated posters with title overlay
- Regenerate button on each poster
- PDF exports as A4 portrait pages
- All 6 requirements (POS-01 through POS-06) addressed
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. AI Poster button is enabled and selectable
3. Generate Posters produces layouts with progress indicator
4. Poster preview shows AI-generated content (visibly different from slides)
5. Regenerate button regenerates individual posters
6. Export produces A4 portrait PDF with one poster per page
7. PDF downloads automatically with "AI Poster Export - {date}.pdf" filename
</verification>

<success_criteria>
Requirements addressed:
- POS-01: "AI Poster" option transforms slides into educational posters
- POS-02: AI analyzes slide content and surrounding slides for context
- POS-03: AI generates poster with larger text optimized for wall display
- POS-04: AI creates clearer visual hierarchy than original slide
- POS-05: AI explains concept clearly for student reference
- POS-06: Poster output as A4 PDF download

Phase 40 complete: Teachers can transform selected slides into AI-enhanced educational wall posters.
</success_criteria>

<output>
After completion, create `.planning/phases/40-ai-poster-mode/40-02-SUMMARY.md`
</output>
