---
phase: 40-ai-poster-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/providers/claudeProvider.ts
  - services/posterService.ts
  - types.ts
autonomous: true

must_haves:
  truths:
    - "AI can transform slide content into poster layout specifications"
    - "Poster layouts contain 5-8 sections with age-appropriate content"
    - "AI selects subject-appropriate color schemes"
    - "AI uses surrounding slide context for better understanding"
  artifacts:
    - path: "services/posterService.ts"
      provides: "Poster generation orchestration"
      exports: ["generatePosterLayouts", "buildSlideContext", "PosterLayout", "PosterSection"]
    - path: "services/providers/claudeProvider.ts"
      provides: "Extended with poster generation"
      contains: "generatePosterLayout"
    - path: "types.ts"
      provides: "PosterLayout and PosterSection types"
      contains: "PosterLayout"
  key_links:
    - from: "services/posterService.ts"
      to: "services/providers/claudeProvider.ts"
      via: "generatePosterLayout method call"
      pattern: "generatePosterLayout"
    - from: "services/posterService.ts"
      to: "types.ts"
      via: "PosterLayout type import"
      pattern: "import.*PosterLayout.*from"
---

<objective>
Create the AI content transformation service that converts slide content into educational poster layouts.

Purpose: Enable Claude to analyze slide content (with surrounding context) and generate structured poster specifications optimized for classroom wall display (Year 6 reading level, 5-8 key points, subject-appropriate colors).

Output: posterService.ts with orchestration logic, claudeProvider.ts extended with generatePosterLayout, PosterLayout/PosterSection types in types.ts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-ai-poster-mode/40-CONTEXT.md
@.planning/phases/40-ai-poster-mode/40-RESEARCH.md
@.planning/phases/39-export-infrastructure/39-01-SUMMARY.md
@services/providers/claudeProvider.ts
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PosterLayout types to types.ts</name>
  <files>types.ts</files>
  <action>
Add PosterLayout and PosterSection interfaces to types.ts:

```typescript
// AI Poster types for Working Wall export
export interface PosterLayout {
  title: string;              // Enhanced title (not verbatim from slide)
  subtitle?: string;          // Optional context/hook
  sections: PosterSection[];  // 5-8 content sections
  colorScheme: {
    primary: string;          // Hex code for headers, accents
    secondary: string;        // Hex code for subheadings
    background: string;       // Hex code for poster background
    text: string;             // Hex code for body text
  };
  typography: {
    titleSize: 'large' | 'xl' | '2xl';
    bodyFormat: 'bullets' | 'paragraphs' | 'mixed';
  };
}

export interface PosterSection {
  heading?: string;           // Optional section heading
  content: string;            // Main content (enhanced from slide)
  format: 'bullet' | 'paragraph' | 'callout';  // How to display
  emphasis?: boolean;         // Should this stand out? (colored background, border)
}
```

Place these after the Slide interface (before StudentPair).
  </action>
  <verify>Run `npm run build` - should compile with no errors.</verify>
  <done>PosterLayout and PosterSection types exported from types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add generatePosterLayout method to claudeProvider.ts</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
Add a new method to ClaudeProvider class that uses Claude's structured outputs (beta) to generate poster layouts.

1. Add import for PosterLayout, PosterSection from types.ts at the top.

2. Add POSTER_GENERATION_SYSTEM_PROMPT constant (before the class):
```typescript
const POSTER_GENERATION_SYSTEM_PROMPT = `
You are an expert educational poster designer for Year 6 (10-11 year old) classrooms.

Your task: Transform presentation slide content into educational wall posters optimized for:
- Readability from 10 feet distance
- Student reference during independent work
- Visual clarity with strong hierarchy

CONTENT TRANSFORMATION RULES:
1. DENSITY: 5-8 key points maximum (posters are reference aids, not textbooks)
2. VOCABULARY: Year 6 reading level - explain technical terms simply, use concrete examples
3. ENRICHMENT: Add relevant examples, analogies, or clarifications beyond the slide content
4. TITLES: Create clear, engaging titles (don't copy slide title verbatim)
5. NARRATIVE: Use surrounding slides to understand topic progression

LAYOUT DECISION RULES:
1. TYPOGRAPHY FORMAT: Choose based on content type
   - Bullets: For lists, steps, features
   - Paragraphs: For explanations, definitions, context
   - Mixed: For posters with intro paragraph + detail points
2. COLOR SCHEME: Subject-appropriate colors
   - Science: Greens, teals (nature/discovery)
   - Math: Blues, purples (logic/precision)
   - Language: Warm tones (creativity/expression)
   - History: Earth tones (heritage/time)
   - Mixed/unclear: Neutral blues or school brand colors
3. VISUAL HIERARCHY: Ensure title dominates, sections are distinct, content is scannable

CONTEXT USAGE:
- Previous slides show what students already learned
- Next slides show where the lesson is heading
- Use this to judge what needs emphasis, what can be brief

OUTPUT REQUIREMENTS:
- You MUST return valid JSON matching the provided schema
- All content must be appropriate for Year 6 students
- Color values must be valid hex codes (e.g., "#2563eb")
- Typography sizes: "large" (36-48pt equiv), "xl" (48-64pt), "2xl" (64-72pt)
`;
```

3. Add POSTER_SCHEMA constant with JSON schema matching PosterLayout interface:
```typescript
const POSTER_SCHEMA = {
  type: 'object',
  properties: {
    title: { type: 'string', description: 'Clear, engaging poster title' },
    subtitle: { type: 'string', description: 'Optional hook or context' },
    sections: {
      type: 'array',
      description: '5-8 key content sections',
      minItems: 5,
      maxItems: 8,
      items: {
        type: 'object',
        properties: {
          heading: { type: 'string' },
          content: { type: 'string', description: 'Transformed, age-appropriate content' },
          format: {
            type: 'string',
            enum: ['bullet', 'paragraph', 'callout']
          },
          emphasis: { type: 'boolean' }
        },
        required: ['content', 'format']
      }
    },
    colorScheme: {
      type: 'object',
      properties: {
        primary: { type: 'string', pattern: '^#[0-9A-Fa-f]{6}$' },
        secondary: { type: 'string', pattern: '^#[0-9A-Fa-f]{6}$' },
        background: { type: 'string', pattern: '^#[0-9A-Fa-f]{6}$' },
        text: { type: 'string', pattern: '^#[0-9A-Fa-f]{6}$' }
      },
      required: ['primary', 'secondary', 'background', 'text']
    },
    typography: {
      type: 'object',
      properties: {
        titleSize: { type: 'string', enum: ['large', 'xl', '2xl'] },
        bodyFormat: { type: 'string', enum: ['bullets', 'paragraphs', 'mixed'] }
      },
      required: ['titleSize', 'bodyFormat']
    }
  },
  required: ['title', 'sections', 'colorScheme', 'typography']
};
```

4. Add generatePosterLayout method to ClaudeProvider class:
```typescript
async generatePosterLayout(
  slideContext: string,
  subject?: string
): Promise<PosterLayout> {
  const userPrompt = `
Transform the [TARGET] slide into an educational poster.

CONTEXT (surrounding slides for narrative understanding):
${slideContext}

PRESENTATION METADATA:
- Subject: ${subject || 'inferred from content'}
- Grade Level: Year 6 (10-11 years old)

POSTER REQUIREMENTS:
- Optimize for classroom wall display (A4 portrait)
- Ensure readability from 10 feet
- Include 5-8 key points
- Add examples or analogies where helpful
- Create an engaging, student-friendly title

Generate the poster layout now.
`;

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': this.apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-beta': 'structured-outputs-2025-11-13',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4096,
      output_format: {
        type: 'json_schema',
        json_schema: {
          name: 'poster_layout',
          strict: true,
          schema: POSTER_SCHEMA
        }
      },
      system: POSTER_GENERATION_SYSTEM_PROMPT,
      messages: [{ role: 'user', content: userPrompt }]
    })
  });

  if (!response.ok) {
    const errorBody = await response.json().catch(() => ({}));
    const code = mapHttpToErrorCode(response.status, errorBody);
    throw new AIProviderError(USER_ERROR_MESSAGES[code], code, errorBody);
  }

  const data = await response.json();

  // Structured outputs guarantee valid JSON in content[0].text
  return JSON.parse(data.content[0].text);
}
```

Note: This uses the structured outputs beta header (`anthropic-beta: structured-outputs-2025-11-13`) which guarantees valid JSON output matching the schema.
  </action>
  <verify>Run `npm run build` - should compile with no errors.</verify>
  <done>claudeProvider.ts has generatePosterLayout method that returns structured PosterLayout</done>
</task>

<task type="auto">
  <name>Task 3: Create posterService.ts with orchestration logic</name>
  <files>services/posterService.ts</files>
  <action>
Create a new service file that orchestrates poster generation:

```typescript
import { Slide, PosterLayout } from '../types';
import { ClaudeProvider } from './providers/claudeProvider';
import { AIProviderError, USER_ERROR_MESSAGES } from './aiProvider';

/**
 * Build context string from surrounding slides for AI understanding.
 * Provides 2-3 slides before/after the target slide.
 *
 * @param slides All slides in the presentation
 * @param targetIndex Index of the slide being converted to poster
 * @param contextWindow Number of slides before/after to include (default: 2)
 */
export function buildSlideContext(
  slides: Slide[],
  targetIndex: number,
  contextWindow: number = 2
): string {
  const start = Math.max(0, targetIndex - contextWindow);
  const end = Math.min(slides.length, targetIndex + contextWindow + 1);

  const contextSlides = slides.slice(start, end).map((slide, i) => {
    const actualIndex = start + i;
    const position = actualIndex === targetIndex ? '[TARGET]' : '';
    const bulletPoints = slide.content.join('\n  - ');
    return `Slide ${actualIndex + 1} ${position}: ${slide.title}\n  - ${bulletPoints}`;
  });

  return contextSlides.join('\n\n---\n\n');
}

/**
 * Infer subject from presentation content.
 * Checks first slide title and content for common subject keywords.
 */
export function inferSubject(slides: Slide[]): string {
  if (slides.length === 0) return 'General';

  const firstSlide = slides[0];
  const allText = `${firstSlide.title} ${firstSlide.content.join(' ')}`.toLowerCase();

  // Subject detection heuristics
  if (/math|number|fraction|equation|geometry|algebra/.test(allText)) return 'Mathematics';
  if (/science|experiment|biology|chemistry|physics|nature/.test(allText)) return 'Science';
  if (/english|grammar|writing|reading|literature|poem|story/.test(allText)) return 'English';
  if (/history|ancient|war|century|civilization|historical/.test(allText)) return 'History';
  if (/geography|map|country|climate|continent|earth/.test(allText)) return 'Geography';
  if (/art|music|drama|creative|design/.test(allText)) return 'Creative Arts';

  return 'General';
}

export interface PosterGenerationProgress {
  current: number;
  total: number;
  status: 'generating' | 'complete' | 'error';
  error?: string;
}

export type PosterProgressCallback = (progress: PosterGenerationProgress) => void;

/**
 * Generate poster layouts for multiple slides.
 * Uses sequential generation to manage memory and provide progress updates.
 *
 * @param slides All slides in the presentation
 * @param selectedIndices Indices of slides to convert to posters
 * @param apiKey Claude API key
 * @param onProgress Callback for progress updates
 * @returns Array of PosterLayout objects in same order as selectedIndices
 */
export async function generatePosterLayouts(
  slides: Slide[],
  selectedIndices: number[],
  apiKey: string,
  onProgress?: PosterProgressCallback
): Promise<PosterLayout[]> {
  const provider = new ClaudeProvider(apiKey);
  const subject = inferSubject(slides);
  const layouts: PosterLayout[] = [];

  for (let i = 0; i < selectedIndices.length; i++) {
    const targetIndex = selectedIndices[i];

    if (onProgress) {
      onProgress({
        current: i + 1,
        total: selectedIndices.length,
        status: 'generating'
      });
    }

    try {
      const context = buildSlideContext(slides, targetIndex);
      const layout = await provider.generatePosterLayout(context, subject);
      layouts.push(layout);
    } catch (error) {
      // On error, report and rethrow to stop batch
      if (onProgress) {
        onProgress({
          current: i + 1,
          total: selectedIndices.length,
          status: 'error',
          error: error instanceof AIProviderError ? error.message : 'Unknown error'
        });
      }
      throw error;
    }
  }

  if (onProgress) {
    onProgress({
      current: selectedIndices.length,
      total: selectedIndices.length,
      status: 'complete'
    });
  }

  return layouts;
}

// Re-export types for convenience
export type { PosterLayout, PosterSection } from '../types';
```

This service:
- Builds surrounding slide context for AI understanding
- Infers subject from presentation content for color scheme selection
- Orchestrates sequential poster generation with progress callbacks
- Handles errors gracefully with progress reporting
  </action>
  <verify>Run `npm run build` - should compile with no errors.</verify>
  <done>posterService.ts exists with generatePosterLayouts, buildSlideContext, inferSubject functions</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. types.ts exports PosterLayout and PosterSection interfaces
3. claudeProvider.ts has generatePosterLayout method with structured outputs
4. posterService.ts exports generatePosterLayouts, buildSlideContext, inferSubject
5. All imports resolve correctly
</verification>

<success_criteria>
- POS-02 partially addressed: AI can analyze slide content and surrounding slides for context
- Foundation for poster generation: Types, AI integration, and orchestration service ready
- Plan 02 can use posterService.ts to generate layouts and render them as PDFs
</success_criteria>

<output>
After completion, create `.planning/phases/40-ai-poster-mode/40-01-SUMMARY.md`
</output>
