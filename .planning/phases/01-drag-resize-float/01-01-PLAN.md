---
phase: 01-drag-resize-float
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - components/FloatingWindow.tsx
  - hooks/useViewportBounds.ts
  - components/NextSlidePreview.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can drag preview window to any position on screen"
    - "Preview window stays above all other UI elements"
    - "Teacher can resize preview by dragging corners"
    - "Preview maintains aspect ratio during resize"
    - "Preview cannot be resized below 200px minimum"
    - "Preview pushes back into view when browser window shrinks"
    - "Corner handles appear on hover, hidden otherwise"
    - "Preview opacity reduces to ~80% while dragging"
  artifacts:
    - path: "components/FloatingWindow.tsx"
      provides: "Generic draggable/resizable container using react-rnd"
      exports: ["FloatingWindow"]
    - path: "hooks/useViewportBounds.ts"
      provides: "Hook to reposition element when viewport shrinks"
      exports: ["useViewportBounds"]
    - path: "components/NextSlidePreview.tsx"
      provides: "Preview wrapped in FloatingWindow with portal rendering"
      contains: "FloatingWindow"
  key_links:
    - from: "components/NextSlidePreview.tsx"
      to: "components/FloatingWindow.tsx"
      via: "FloatingWindow wrapper"
      pattern: "<FloatingWindow"
    - from: "components/FloatingWindow.tsx"
      to: "hooks/useViewportBounds.ts"
      via: "hook import"
      pattern: "useViewportBounds"
    - from: "components/FloatingWindow.tsx"
      to: "react-rnd"
      via: "Rnd component"
      pattern: "import.*Rnd.*from.*react-rnd"
---

<objective>
Implement drag, resize, and float behavior for the next slide preview window.

Purpose: Teachers need to freely position the preview window wherever works best for their teaching setup, without it getting covered by other UI or being stuck in a fixed position.

Output: A fully interactive floating preview window that can be dragged anywhere, resized from corners (maintaining aspect ratio), and always stays above other UI elements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-drag-resize-float/01-CONTEXT.md
@.planning/phases/01-drag-resize-float/01-RESEARCH.md
@components/NextSlidePreview.tsx
@components/PresentationView.tsx
@hooks/useViewportBounds.ts (will create)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-rnd and create FloatingWindow infrastructure</name>
  <files>
    - package.json
    - components/FloatingWindow.tsx
    - hooks/useViewportBounds.ts
  </files>
  <action>
1. Install react-rnd:
   ```bash
   npm install react-rnd
   ```

2. Create `hooks/useViewportBounds.ts`:
   - Accept position {x, y}, size {width, height}, and rndRef
   - Listen to window resize events
   - When viewport shrinks, calculate if element is now outside bounds
   - If outside, call rndRef.current?.updatePosition() to push back into view
   - Use padding constant (0px - full edge constraint per CONTEXT.md)
   - Animate the push-back with 150-200ms ease-out transition

3. Create `components/FloatingWindow.tsx`:
   - Generic wrapper component accepting children and configuration
   - Props: defaultPosition, defaultSize, minWidth (200), minHeight (calculated from aspect ratio), aspectRatio (16/9 for slides)
   - Use react-rnd's Rnd component with:
     - bounds="window" for viewport constraint
     - lockAspectRatio={16/9} to maintain slide proportions
     - enableResizing: corner handles only (topRight, bottomRight, bottomLeft, topLeft)
     - Custom resizeHandleComponent for corner handles that appear on hover
   - State: isDragging, isHovered, position, size
   - Apply cursor: move on hover to indicate draggability
   - Apply opacity: 0.8 while isDragging, 1 otherwise (with transition)
   - Apply accent border (indigo-500) per project style
   - Apply rounded corners matching existing UI (rounded-lg)
   - Integrate useViewportBounds hook
   - Implement edge magnetism in onDragStop:
     - MAGNET_THRESHOLD = 20px
     - If within 20px of any viewport edge, snap to that edge
     - Apply to all four edges independently
  </action>
  <verify>
    - `npm ls react-rnd` shows react-rnd installed
    - `ls components/FloatingWindow.tsx hooks/useViewportBounds.ts` shows both files exist
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    FloatingWindow component exists with drag, resize, corner handles, opacity feedback, edge magnetism, and viewport bounds enforcement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FloatingWindow with NextSlidePreview</name>
  <files>
    - components/NextSlidePreview.tsx
  </files>
  <action>
1. Refactor NextSlidePreview.tsx:
   - Import FloatingWindow and createPortal from react-dom
   - Keep the toggle button in its current location (in header toolbar)
   - When isVisible is true, render the preview panel WRAPPED in FloatingWindow
   - Render via Portal to document.body for z-index isolation (z-index: 9999)
   - Remove the existing absolute positioning classes (bottom-20 right-4 z-50)
   - Set defaultPosition to bottom-right area: { x: window.innerWidth - 220, y: window.innerHeight - 200 }
   - Set defaultSize to { width: 200, height: 150 } (maintains ~16:9 with header)
   - Remove "Next Slide" header per CONTEXT.md ("No 'Next' label - clean window")
   - Keep the aspect-video content area
   - Border styling: accent border (border-indigo-500 or similar), no shadow

2. Verify the preview content still renders correctly:
   - nextSlide title and content display
   - "End of presentation" state displays
   - Content truncation and "+N more..." still works

3. Test interactions:
   - Preview can be dragged anywhere on screen
   - Preview stays above presentation slide and controls
   - Corner handles appear on hover
   - Resizing maintains aspect ratio
   - Cannot resize below minimum (200px width)
   - Edge magnetism works (snaps when near edges)
   - Push-back works when browser window shrinks
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Load presentation, click "Preview" toggle
    - Preview window appears and can be dragged
    - Preview window can be resized from corners
    - Preview stays above all UI when dragged over slide area
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    NextSlidePreview is now a freely draggable, resizable floating window that stays above all UI and respects viewport bounds.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Drag behavior:**
   - Start dev server: `npm run dev`
   - Open presentation mode
   - Click "Preview" to show preview window
   - Drag from center of preview - should move smoothly
   - Cursor should be move (4-way arrow) on hover
   - Opacity should reduce while dragging

2. **Resize behavior:**
   - Hover over preview - corner handles should appear
   - Drag any corner - preview should resize
   - Aspect ratio should stay locked (no stretching)
   - Cannot resize below 200px width

3. **Float behavior:**
   - Drag preview over main slide area
   - Preview should stay ABOVE the slide (visible, not behind)
   - Drag preview over control panel
   - Preview should stay above controls too

4. **Edge constraints:**
   - Drag preview to right edge - should not go off-screen
   - Drag preview near edge - should snap/magnetize to edge
   - Resize browser window smaller - preview should push back into view

5. **TypeScript check:**
   - `npx tsc --noEmit` should pass
</verification>

<success_criteria>
- [ ] react-rnd installed in package.json
- [ ] FloatingWindow.tsx exists with Rnd wrapper, corner handles, opacity, magnetism
- [ ] useViewportBounds.ts exists and keeps element in viewport on resize
- [ ] NextSlidePreview renders in Portal with FloatingWindow wrapper
- [ ] Preview can be dragged anywhere on screen
- [ ] Preview stays above all other UI (z-index 9999)
- [ ] Preview can be resized from corners only
- [ ] Aspect ratio locked during resize
- [ ] Minimum size 200px enforced
- [ ] Edge magnetism snaps to viewport edges
- [ ] Browser resize pushes preview back into view
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-drag-resize-float/01-01-SUMMARY.md`
</output>
