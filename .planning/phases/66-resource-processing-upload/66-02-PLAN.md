---
phase: 66-resource-processing-upload
plan: 02
type: execute
wave: 2
depends_on: ["66-01"]
files_modified:
  - types.ts
  - services/saveService.ts
  - services/loadService.ts
  - hooks/useAutoSave.ts
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can upload PDF, images, DOCX, and PPTX files as supplementary resources on the landing page"
    - "Resources persist in the .cue save file and are fully restored on reload"
    - "Auto-save excludes supplementary resource binary content to prevent localStorage overflow"
    - "Landing page shows collapsible supplementary resources section with upload panel"
    - "Maximum 5 supplementary resources enforced in UI"
  artifacts:
    - path: "types.ts"
      provides: "CueFileContent with supplementaryResources field, file version 5"
      contains: "supplementaryResources"
    - path: "services/saveService.ts"
      provides: "Save function accepts supplementary resources"
      contains: "supplementaryResources"
    - path: "services/loadService.ts"
      provides: "v4->v5 migration and supplementary resource restoration"
      contains: "supplementaryResources"
    - path: "App.tsx"
      provides: "Landing page UI with supplementary resource upload section"
      contains: "supplementaryResources"
  key_links:
    - from: "App.tsx"
      to: "services/saveService.ts"
      via: "createCueFile call includes supplementaryResources parameter"
      pattern: "supplementaryResources"
    - from: "App.tsx"
      to: "services/loadService.ts"
      via: "Load handler restores supplementaryResources from cueFile.content"
      pattern: "supplementaryResources"
    - from: "services/loadService.ts"
      to: "types.ts"
      via: "migrateFile v4->v5 sets supplementaryResources: []"
      pattern: "version.*5"
---

<objective>
Wire supplementary resources into the landing page UI with persistence (save/load/auto-save) so teachers can upload resources alongside their lesson plan and have them survive the full lifecycle.

Purpose: This completes Phase 66 by connecting the processing infrastructure (Plan 01) to the user-facing landing page and persistence layer. Teachers see a collapsible "Supplementary Resources" section, can upload up to 5 files, and those resources persist in the .cue save file.

Output: Landing page with supplementary resource upload, CueFile v5 with supplementaryResources field, complete save/load/auto-save integration.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-resource-processing-upload/66-RESEARCH.md
@.planning/phases/66-resource-processing-upload/66-01-SUMMARY.md

# Key reference files — read these before implementing
@types.ts  — CueFileContent, CueFile, UploadedResource, CURRENT_FILE_VERSION
@services/saveService.ts  — createCueFile signature to extend
@services/loadService.ts  — migrateFile to add v4->v5, handleLoadFile to restore resources
@hooks/useAutoSave.ts  — AutoSaveData to decide about resource exclusion
@App.tsx  — Landing page JSX (search "Or paste text below" for insertion point), handleSaveClick, handleSaveConfirm, handleLoadFile
@components/UploadPanel.tsx  — Reuse for supplementary resource upload
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend persistence layer (types, save, load, auto-save)</name>
  <files>
    types.ts
    services/saveService.ts
    services/loadService.ts
    hooks/useAutoSave.ts
  </files>
  <action>
1. In `types.ts`:
   - Bump `CURRENT_FILE_VERSION` from 4 to 5
   - Add `supplementaryResources?: UploadedResource[];` to `CueFileContent` interface (after `enhancedResources`)
   - Add comment: `// NEW in v5: landing page supplementary resources`

2. In `services/saveService.ts`:
   - Add `UploadedResource` to the import from `'../types'`
   - Add parameter `supplementaryResources?: UploadedResource[]` to `createCueFile` — add it as the LAST parameter after `enhancedResources`
   - In the returned object's `content` block, add: `...(supplementaryResources && supplementaryResources.length > 0 ? { supplementaryResources } : {})`
   - This follows the exact same pattern as `enhancedResources` spread

3. In `services/loadService.ts`:
   - Add v4->v5 migration block in `migrateFile`:
     ```
     // v4 -> v5: Added supplementaryResources to CueFileContent
     if (data.version < 5) {
       migrated = {
         ...migrated,
         content: {
           ...migrated.content,
           supplementaryResources: []  // Default empty array for older files
         }
       };
     }
     ```
   - Place this AFTER the existing v3->v4 block
   - No changes needed to `isValidCueFile` since `supplementaryResources` is optional

4. In `hooks/useAutoSave.ts`:
   - Do NOT add supplementary resources to AutoSaveData
   - Add a comment at the top of the AutoSaveData interface: `// NOTE: Supplementary resources excluded to prevent localStorage overflow (binary thumbnails/content)`
   - This is a deliberate decision per research Pitfall 5: resource content (especially base64 images/thumbnails) could easily exceed localStorage's ~5MB limit
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `CURRENT_FILE_VERSION` equals 5
    - `CueFileContent` interface includes `supplementaryResources?: UploadedResource[]`
    - `createCueFile` accepts supplementaryResources parameter
    - `migrateFile` handles v4->v5 migration
    - `AutoSaveData` does NOT include supplementary resources
  </verify>
  <done>
    - CueFile format v5 with supplementaryResources field
    - Save service includes supplementary resources in .cue output
    - Load service migrates v1-v4 files to v5 with empty supplementaryResources
    - Auto-save explicitly excludes resources to prevent localStorage overflow
  </done>
</task>

<task type="auto">
  <name>Task 2: Add supplementary resources UI to landing page and wire App state</name>
  <files>
    App.tsx
  </files>
  <action>
1. **Add state** — Near the other landing page state declarations (around line 333 where `enhancedResourceStates` is declared), add:
   ```typescript
   const [supplementaryResources, setSupplementaryResources] = useState<UploadedResource[]>([]);
   ```
   Import `UploadedResource` if not already imported. Import `MAX_SUPPLEMENTARY_RESOURCES` from `utils/resourceCapping`.

2. **Add collapsible section state:**
   ```typescript
   const [showSupplementaryResources, setShowSupplementaryResources] = useState(false);
   ```

3. **Wire save flow** — Update BOTH `handleSaveClick` and `handleSaveConfirm`:
   - In `handleSaveClick`, update the `createCueFile` call to pass `supplementaryResources` as the last argument
   - In `handleSaveConfirm`, update the `createCueFile` call to pass `supplementaryResources` as the last argument
   - Add `supplementaryResources` to the dependency arrays of both useCallback hooks

4. **Wire load flow** — In `handleLoadFile`, after the line that restores enhanced resources (`setEnhancedResourceStates(...)`), add:
   ```typescript
   // Restore supplementary resources if present (v5+)
   setSupplementaryResources(cueFile.content.supplementaryResources || []);
   ```

5. **Wire reset on new generation** — In the early part of `handleGenerate` (where state is reset for a new generation), add:
   - Do NOT clear supplementary resources on generate — they should persist since they're input context, not output

6. **Add landing page UI** — Insert a new section between the textarea (ends around line 2311) and the "Auto-generate AI Visuals" toggle (starts around line 2313). The insertion point is AFTER `</textarea>` and BEFORE the AI Visuals toggle div.

   Build a collapsible supplementary resources section:
   ```jsx
   {/* Supplementary Resources (optional) */}
   <div className="mb-6">
     <button
       onClick={() => setShowSupplementaryResources(!showSupplementaryResources)}
       className="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:border-slate-200 dark:hover:border-slate-600 transition-all group"
     >
       <div className="flex items-center gap-3">
         <div className="w-8 h-8 rounded-lg bg-amber-100 dark:bg-amber-900/40 flex items-center justify-center text-amber-600 dark:text-amber-400 text-sm">
           {supplementaryResources.length > 0 ? supplementaryResources.length : '+'}
         </div>
         <div className="text-left">
           <p className="text-sm font-bold text-slate-700 dark:text-slate-300">
             Supplementary Resources
             <span className="ml-2 text-xs font-normal text-slate-400 dark:text-slate-500">(optional)</span>
           </p>
           <p className="text-xs text-slate-500 dark:text-slate-500">
             Attach worksheets, handouts, or reference materials for richer slide generation
           </p>
         </div>
       </div>
       <svg
         className={`w-5 h-5 text-slate-400 transition-transform ${showSupplementaryResources ? 'rotate-180' : ''}`}
         fill="none" viewBox="0 0 24 24" stroke="currentColor"
       >
         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
       </svg>
     </button>

     {showSupplementaryResources && (
       <div className="mt-3 p-4 rounded-xl bg-slate-50/50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700">
         {supplementaryResources.length >= MAX_SUPPLEMENTARY_RESOURCES && (
           <p className="text-xs text-amber-600 dark:text-amber-400 mb-3 font-medium">
             Maximum {MAX_SUPPLEMENTARY_RESOURCES} supplementary resources reached
           </p>
         )}
         <UploadPanel
           resources={supplementaryResources}
           onResourcesChange={(resources) => {
             // Enforce max resource limit
             if (resources.length > MAX_SUPPLEMENTARY_RESOURCES) {
               resources = resources.slice(0, MAX_SUPPLEMENTARY_RESOURCES);
             }
             setSupplementaryResources(resources);
           }}
         />
         {supplementaryResources.length > 0 && (
           <p className="text-xs text-slate-400 dark:text-slate-500 mt-2 text-center">
             {supplementaryResources.length} of {MAX_SUPPLEMENTARY_RESOURCES} resources attached
           </p>
         )}
       </div>
     )}
   </div>
   ```

   Make sure to import `UploadPanel` at the top of App.tsx if not already imported. Check existing imports first — it may already be imported for ResourceHub.

7. **Auto-expand when resources exist** — If supplementaryResources has items (e.g., after loading a file), auto-expand the section. Add a useEffect:
   ```typescript
   useEffect(() => {
     if (supplementaryResources.length > 0) {
       setShowSupplementaryResources(true);
     }
   }, [supplementaryResources.length]);
   ```

IMPORTANT NOTES:
- Use amber/orange theme (bg-amber-100, text-amber-600) to distinguish from green (lesson plan) and blue (presentation) upload zones per research recommendation
- The UploadPanel component already handles drag-drop, file selection, progress feedback, error display, and resource grid — do NOT rebuild any of that
- Supplementary resources should NOT be cleared when generating — they are persistent input context
- The existing UploadPanel accepts `onResourceClick` and `selectedResourceId` as optional props — do NOT pass these for the landing page usage (they're for ResourceHub enhancement flow)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Landing page has collapsible "Supplementary Resources" section visible between textarea and AI Visuals toggle
    - Save/load round-trips preserve supplementary resources (manual test: upload a resource, save, reload page, load the .cue file — resource should appear)
    - Maximum 5 resources enforced in UI
    - Auto-save does not include supplementary resources (check AutoSaveData type)
  </verify>
  <done>
    - Landing page shows collapsible supplementary resources section with amber/orange theme
    - UploadPanel reused for drag-drop upload with progress and resource grid
    - Maximum 5 supplementary resources enforced
    - Resources included in .cue save file and fully restored on load
    - Auto-save excludes resources (localStorage safety)
    - Section auto-expands when resources are present (e.g., after file load)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Landing page shows collapsible "Supplementary Resources (optional)" section
3. Teacher can upload PDF, images, DOCX, and PPTX files as supplementary resources
4. Maximum 5 resources enforced (6th upload blocked with message)
5. Save to .cue file → close app → load .cue file → supplementary resources fully restored
6. Auto-save does NOT include supplementary resources (check localStorage size stays reasonable)
7. CueFile version is 5; loading v4 files migrates cleanly with empty supplementaryResources
</verification>

<success_criteria>
- Full Phase 66 success criteria met:
  1. Teacher can upload PDF, images, DOCX, and PPTX files as supplementary resources on the landing page
  2. PPTX files parsed for text without new dependencies (from Plan 01)
  3. Content capping utility ready (from Plan 01) — not yet wired to generation (Phase 67/68)
  4. Resources persist in .cue save file and fully restore on reload
</success_criteria>

<output>
After completion, create `.planning/phases/66-resource-processing-upload/66-02-SUMMARY.md`
</output>
