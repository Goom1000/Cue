---
phase: 49-provider-integration-preservation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/geminiService.ts
autonomous: true

must_haves:
  truths:
    - "Gemini service detects preservable content from input text"
    - "System instruction includes preservation rules when content is detected"
    - "System instruction includes teleprompter preservation rules for delivery context"
    - "Fresh mode detects from lessonText"
    - "Refine mode detects from presentationText with high-confidence filter"
    - "Blend mode detects from lessonText (authoritative source)"
  artifacts:
    - path: "services/geminiService.ts"
      provides: "Preservation-aware slide generation"
      exports: ["generateLessonSlides"]
  key_links:
    - from: "services/geminiService.ts"
      to: "services/contentPreservation/detector.ts"
      via: "import detectPreservableContent"
      pattern: "detectPreservableContent\\("
    - from: "services/geminiService.ts"
      to: "services/prompts/contentPreservationRules.ts"
      via: "import getPreservationRules, getTeleprompterPreservationRules"
      pattern: "getPreservationRules|getTeleprompterPreservationRules"
---

<objective>
Integrate content preservation into the Gemini service so detected questions and activities appear verbatim on slides with delivery context in the teleprompter.

Purpose: Mirror the Claude provider integration to ensure consistent preservation behavior across both AI providers. Teachers should get the same verbatim preservation regardless of which provider they use.

Output: Modified geminiService.ts with detection at entry point and preservation rules injected into system instructions for all three generation modes.
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/geminiService.ts
@services/contentPreservation/detector.ts
@services/contentPreservation/types.ts
@services/prompts/contentPreservationRules.ts
@.planning/phases/49-provider-integration-preservation/49-CONTEXT.md
@.planning/phases/49-provider-integration-preservation/49-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add imports and mode-specific helper functions</name>
  <files>services/geminiService.ts</files>
  <action>
Add imports near the top of the file (after existing imports):
```typescript
import { detectPreservableContent } from './contentPreservation/detector';
import { PreservableContent, ConfidenceLevel } from './contentPreservation/types';
import { getPreservationRules, getTeleprompterPreservationRules } from './prompts/contentPreservationRules';
```

Add two helper functions BEFORE the `getSystemInstructionForMode` function (around line 96):

```typescript
/**
 * Get the source text for detection based on generation mode.
 * Fresh: lesson text only
 * Refine: presentation text only
 * Blend: lesson text (authoritative source per CONTEXT decision)
 */
function getDetectionSource(input: GenerationInput): string {
  switch (input.mode) {
    case 'fresh':
      return input.lessonText;
    case 'refine':
      return input.presentationText || '';
    case 'blend':
      return input.lessonText; // Lesson plan is authoritative
  }
}

/**
 * Get minimum confidence threshold based on mode.
 * Refine mode: only high-confidence (clear questions ending in ?, explicit activities)
 * Fresh/Blend: medium confidence (per CONTEXT decision)
 */
function getMinConfidenceForMode(mode: GenerationMode): ConfidenceLevel {
  return mode === 'refine' ? 'high' : 'medium';
}
```

These are identical to the Claude provider helpers - same logic for consistency.
  </action>
  <verify>
Run `npx tsc --noEmit` - no import errors or type errors
  </verify>
  <done>
Imports added and helper functions defined. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Modify getSystemInstructionForMode to accept PreservableContent</name>
  <files>services/geminiService.ts</files>
  <action>
Modify the `getSystemInstructionForMode` function signature to accept an optional fourth parameter:

```typescript
function getSystemInstructionForMode(
  mode: GenerationMode,
  verbosity: VerbosityLevel = 'standard',
  gradeLevel: string = 'Year 6 (10-11 years old)',
  preservableContent?: PreservableContent  // NEW optional parameter
): string {
```

Inside the function, after `const studentFriendlyRules = ...`, add:

```typescript
  // Build preservation rules if content detected
  const minConfidence = getMinConfidenceForMode(mode);
  const preservationRules = preservableContent && preservableContent.all.length > 0
    ? getPreservationRules(preservableContent, minConfidence)
    : '';

  const teleprompterPreservationRules = preservableContent
    ? getTeleprompterPreservationRules(preservableContent)
    : '';
```

Inject `${preservationRules}` into each mode's system instruction AFTER `${studentFriendlyRules}` and BEFORE the mode-specific rules.

Inject `${teleprompterPreservationRules}` AFTER `${teleprompterRules}` in each mode.

Example for 'fresh' mode:
```typescript
case 'fresh':
  return `
You are an elite Primary Education Consultant.
Your goal is to transform a formal lesson plan into a teaching slideshow.

${studentFriendlyRules}

${preservationRules}

CRITICAL: You will be provided with both text AND visual images of the document.
...

${teleprompterRules}

${teleprompterPreservationRules}

LAYOUTS: ...
`;
```

Apply the same pattern to 'refine' and 'blend' modes. Make sure to add `${preservationRules}` after studentFriendlyRules and `${teleprompterPreservationRules}` after teleprompterRules in all three cases.
  </action>
  <verify>
Run `npx tsc --noEmit` - function signature change compiles. Check that template strings include the new interpolations.
  </verify>
  <done>
getSystemInstructionForMode accepts optional PreservableContent. Preservation rules injected into all three mode instructions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add detection at generateLessonSlides entry point</name>
  <files>services/geminiService.ts</files>
  <action>
In the `generateLessonSlides` function, after the input normalization block (around line 186-188) and BEFORE the AI client initialization, add detection:

```typescript
// Detect preservable content from source text based on mode
const sourceText = getDetectionSource(input);
const detectedContent = detectPreservableContent(sourceText);

// Debug logging for development
if (detectedContent.all.length > 0) {
  console.log(`[GeminiService] Detected ${detectedContent.questions.length} questions, ${detectedContent.activities.length} activities`);
}
```

Modify the existing `getSystemInstructionForMode` call (around line 196) to pass the detected content:

```typescript
const systemInstruction = getSystemInstructionForMode(input.mode, input.verbosity, input.gradeLevel, detectedContent);
```
  </action>
  <verify>
Run `npx tsc --noEmit` - compiles without errors. The detection is called and passed to the instruction builder.
  </verify>
  <done>
Detection happens at entry point. Detected content is passed to system instruction builder.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Grep for key patterns:
   - `grep -n "detectPreservableContent" services/geminiService.ts` (should show import and usage)
   - `grep -n "getPreservationRules" services/geminiService.ts` (should show import and usage)
   - `grep -n "getTeleprompterPreservationRules" services/geminiService.ts` (should show import and usage)
3. Verify helper functions exist:
   - `grep -n "getDetectionSource" services/geminiService.ts`
   - `grep -n "getMinConfidenceForMode" services/geminiService.ts`
</verification>

<success_criteria>
- GeminiService imports and uses Phase 48 detection/rules modules
- Detection runs at generateLessonSlides entry point
- Mode-specific source text selection works (Fresh: lesson, Refine: presentation, Blend: lesson)
- Mode-specific confidence filtering works (Refine: high only, others: medium)
- Preservation rules injected into system instruction when content detected
- Teleprompter preservation rules injected for delivery context
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/49-provider-integration-preservation/49-02-SUMMARY.md`
</output>
