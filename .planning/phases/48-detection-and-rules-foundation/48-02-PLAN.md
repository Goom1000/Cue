---
phase: 48-detection-and-rules-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/prompts/contentPreservationRules.ts
autonomous: true

must_haves:
  truths:
    - "Preservation rules can be generated from detection results"
    - "XML tags wrap preserved content with type and method attributes"
    - "Prompt includes few-shot examples for edge cases"
    - "Empty detection results produce empty string (no rules)"
    - "Special characters in content are XML-escaped"
  artifacts:
    - path: "services/prompts/contentPreservationRules.ts"
      provides: "AI prompt rules for content preservation"
      exports: ["buildPreservationPrompt", "getPreservationRules", "escapeXml"]
  key_links:
    - from: "services/prompts/contentPreservationRules.ts"
      to: "services/contentPreservation/types.ts"
      via: "import DetectedContent type"
      pattern: "import.*DetectedContent.*from"
---

<objective>
Build the prompt rules module that generates AI instructions for preserving detected content verbatim in slide generation.

Purpose: Translate detection results into XML-tagged prompt sections that instruct Claude/Gemini to preserve specific questions and activities word-for-word rather than generalizing them.

Output: TypeScript module that builds preservation prompt sections from DetectedContent arrays, following Claude's recommended XML tag format.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/48-detection-and-rules-foundation/48-RESEARCH.md
@services/prompts/studentFriendlyRules.ts
@services/providers/claudeProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create XML escaping and tag building utilities</name>
  <files>services/prompts/contentPreservationRules.ts</files>
  <action>
Create the foundation utilities for building XML-tagged preservation prompts:

```typescript
/**
 * Content Preservation Rules for AI Slide Generation.
 * Generates XML-tagged instructions that tell the AI to preserve
 * specific questions, activities, and instructions verbatim.
 */

import { DetectedContent, PreservableContent, ConfidenceLevel } from '../contentPreservation/types';

/**
 * Escape special XML characters to prevent parsing issues.
 * Teachers may write content like "Compare <plant> and <animal> cells"
 * which would break XML structure without escaping.
 */
export function escapeXml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
}

/**
 * Build a single preserve tag for a detected content item.
 */
function buildPreserveTag(item: DetectedContent): string {
  const escapedText = escapeXml(item.text);
  return `  <preserve type="${item.type}" method="${item.detectionMethod}">${escapedText}</preserve>`;
}
```

This follows the established pattern in `services/prompts/studentFriendlyRules.ts` - pure functions that generate prompt text.
  </action>
  <verify>
Run TypeScript check:
`npx tsc services/prompts/contentPreservationRules.ts --noEmit --skipLibCheck`
  </verify>
  <done>
escapeXml utility function and buildPreserveTag helper created with proper XML escaping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement main prompt builder with few-shot examples</name>
  <files>services/prompts/contentPreservationRules.ts</files>
  <action>
Add the main prompt builder function with few-shot examples for edge cases:

```typescript
/**
 * Few-shot examples for edge case handling.
 * These help the AI understand nuanced preservation scenarios.
 */
const FEW_SHOT_EXAMPLES = `
<preservation_examples>

<example scenario="direct-question">
Source: "What is the water cycle? Explain evaporation first."
Detected: <preserve type="question">What is the water cycle?</preserve>
Output: Slide shows "What is the water cycle?" exactly as written, with supporting content around it.
</example>

<example scenario="activity-instruction">
Source: "List 3 examples of renewable energy. Discuss with your partner."
Detected: <preserve type="activity">List 3 examples of renewable energy.</preserve>
         <preserve type="activity">Discuss with your partner.</preserve>
Output: Both instructions appear verbatim on the slide or in sequence.
</example>

<example scenario="embedded-question">
Source: "The key question to consider is: How does photosynthesis work?"
Detected: <preserve type="question">How does photosynthesis work?</preserve>
Output: Slide shows "How does photosynthesis work?" - the wrapper text may be paraphrased.
</example>

</preservation_examples>
`;

/**
 * Core preservation rules that apply regardless of detected content.
 */
const PRESERVATION_RULES = `
CONTENT PRESERVATION RULES:

When preserved content is provided, you MUST:
1. Include the EXACT text of each <preserve> item on an appropriate slide
2. Match wording, punctuation, and capitalization precisely
3. Place questions in prominent positions (titles or key bullet points)
4. Place activities as clear instructions students can follow

You MAY:
- Add supporting context around preserved items
- Decide which slide is most appropriate for each item
- Rephrase surrounding (non-preserved) content as needed

You MUST NOT:
- Paraphrase or generalize preserved content
- Split preserved sentences into fragments
- Omit any preserved item from the output
- Change "What is 3/4 of 12?" to "Practice fractions" or similar generalizations
`;

/**
 * Build the complete preservation prompt section from detected content.
 * Returns empty string if no content detected (don't clutter prompt).
 *
 * @param detectedItems Array of detected content items to preserve
 * @param minConfidence Minimum confidence level to include (default: skip 'low')
 * @returns Formatted prompt section or empty string
 */
export function buildPreservationPrompt(
  detectedItems: DetectedContent[],
  minConfidence: ConfidenceLevel = 'medium'
): string {
  // Filter by confidence
  const confidenceOrder: ConfidenceLevel[] = ['low', 'medium', 'high'];
  const minIndex = confidenceOrder.indexOf(minConfidence);

  const filteredItems = detectedItems.filter(item => {
    const itemIndex = confidenceOrder.indexOf(item.confidence);
    return itemIndex >= minIndex;
  });

  // No items to preserve - return empty to avoid cluttering prompt
  if (filteredItems.length === 0) {
    return '';
  }

  const preserveTags = filteredItems.map(buildPreserveTag).join('\n');

  return `
<content_preservation>
${PRESERVATION_RULES}

DETECTED CONTENT TO PRESERVE:
<preservable_content>
${preserveTags}
</preservable_content>

${FEW_SHOT_EXAMPLES}
</content_preservation>
`;
}
```
  </action>
  <verify>
Manual test:
```typescript
import { buildPreservationPrompt } from './services/prompts/contentPreservationRules';

const items = [{
  type: 'question',
  text: 'What is photosynthesis?',
  confidence: 'high',
  detectionMethod: 'punctuation',
  startIndex: 0,
  endIndex: 22
}];

const prompt = buildPreservationPrompt(items);
console.log(prompt.includes('What is photosynthesis?')); // true
console.log(prompt.includes('<preserve type="question"')); // true
```
  </verify>
  <done>
buildPreservationPrompt function generates XML-tagged preservation rules with few-shot examples.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add convenience wrapper and teleprompter rules</name>
  <files>services/prompts/contentPreservationRules.ts</files>
  <action>
Add convenience wrapper that takes PreservableContent directly, plus teleprompter-specific preservation guidance:

```typescript
/**
 * Teleprompter-specific preservation rules.
 * Questions and activities need delivery context in speaker notes.
 */
const TELEPROMPTER_PRESERVATION_RULES = `
SPEAKER NOTES FOR PRESERVED CONTENT:

When a slide contains preserved content, the teleprompter should:

For QUESTIONS:
- Introduce the question: "Now ask the class:"
- Include the exact question text
- Add follow-up prompts: "[Wait for responses]", "[Call on 2-3 students]"
- Provide expected answer hints for the teacher

For ACTIVITIES:
- Set up the activity: "Time for a quick activity:"
- Include the exact instruction
- Add timing cues: "[Give them 2 minutes]", "[Walk around and observe]"
- Provide wrap-up guidance

Example teleprompter for a preserved question:
"Now let's check understanding. Ask the class: 'What is 3/4 of 12?' [PAUSE - wait for hands] Look for students who might be struggling. The answer we're looking for is 9."
`;

/**
 * Build preservation prompt from PreservableContent result.
 * Convenience wrapper that handles the aggregated detection output.
 *
 * @param content PreservableContent from detectPreservableContent()
 * @param minConfidence Minimum confidence level to include
 * @returns Formatted prompt section or empty string
 */
export function getPreservationRules(
  content: PreservableContent,
  minConfidence: ConfidenceLevel = 'medium'
): string {
  return buildPreservationPrompt(content.all, minConfidence);
}

/**
 * Build teleprompter-specific preservation guidance.
 * Adds delivery context rules for questions and activities.
 *
 * @param content PreservableContent from detectPreservableContent()
 * @returns Teleprompter guidance section or empty string
 */
export function getTeleprompterPreservationRules(
  content: PreservableContent
): string {
  const hasQuestions = content.questions.length > 0;
  const hasActivities = content.activities.length > 0;

  if (!hasQuestions && !hasActivities) {
    return '';
  }

  return TELEPROMPTER_PRESERVATION_RULES;
}
```

**Exports summary:**
- `escapeXml(text)` - XML character escaping utility
- `buildPreservationPrompt(items, minConfidence)` - Build prompt from DetectedContent array
- `getPreservationRules(content, minConfidence)` - Convenience wrapper for PreservableContent
- `getTeleprompterPreservationRules(content)` - Teleprompter-specific guidance
  </action>
  <verify>
TypeScript compilation:
`npx tsc services/prompts/contentPreservationRules.ts --noEmit --skipLibCheck`

Verify all exports are accessible:
```typescript
import {
  escapeXml,
  buildPreservationPrompt,
  getPreservationRules,
  getTeleprompterPreservationRules
} from './services/prompts/contentPreservationRules';
```
  </verify>
  <done>
contentPreservationRules.ts exports all prompt building functions with teleprompter guidance.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors:
   `npx tsc --noEmit`

2. Module exports all required functions:
   - escapeXml
   - buildPreservationPrompt
   - getPreservationRules
   - getTeleprompterPreservationRules

3. Empty input produces empty output:
   ```typescript
   const result = buildPreservationPrompt([]);
   console.log(result === ''); // true
   ```

4. XML escaping works correctly:
   ```typescript
   const escaped = escapeXml('Compare <plant> & <animal>');
   console.log(escaped); // 'Compare &lt;plant&gt; &amp; &lt;animal&gt;'
   ```

5. Generated prompt includes XML structure:
   - `<content_preservation>` wrapper
   - `<preserve type="...">` tags
   - `<preservation_examples>` section
</verification>

<success_criteria>
- services/prompts/contentPreservationRules.ts exists
- XML escaping handles &, <, >, ", ' characters
- buildPreservationPrompt generates valid XML-tagged prompts
- Empty detection results return empty string
- Few-shot examples included for edge case guidance
- Teleprompter-specific rules added for delivery context
- TypeScript compiles without errors
- Module follows established pattern from studentFriendlyRules.ts
</success_criteria>

<output>
After completion, create `.planning/phases/48-detection-and-rules-foundation/48-02-SUMMARY.md`
</output>
