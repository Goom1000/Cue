---
phase: 48-detection-and-rules-foundation
plan: 03
type: execute
wave: 2
depends_on: ["48-01", "48-02"]
files_modified:
  - services/contentPreservation/detector.test.ts
  - services/prompts/contentPreservationRules.test.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests pass for question detection"
    - "Unit tests pass for activity detection"
    - "Unit tests pass for XML escaping"
    - "Detection produces consistent results on identical input"
    - "Edge cases (rhetorical questions, descriptive context) handled correctly"
  artifacts:
    - path: "services/contentPreservation/detector.test.ts"
      provides: "Jest unit tests for detection patterns"
      contains: "describe('detectQuestions'"
    - path: "services/prompts/contentPreservationRules.test.ts"
      provides: "Jest unit tests for prompt building"
      contains: "describe('buildPreservationPrompt'"
  key_links:
    - from: "services/contentPreservation/detector.test.ts"
      to: "services/contentPreservation/detector.ts"
      via: "import"
      pattern: "import.*from.*detector"
    - from: "services/prompts/contentPreservationRules.test.ts"
      to: "services/prompts/contentPreservationRules.ts"
      via: "import"
      pattern: "import.*from.*contentPreservationRules"
---

<objective>
Create comprehensive unit tests for the detection and prompt modules to verify correct behavior across all requirements (DET-01 through DET-05).

Purpose: Validate detection patterns work correctly for various input formats, edge cases are handled, and the system produces consistent, deterministic results. Tests serve as documentation of expected behavior.

Output: Jest test files with passing tests covering all detection scenarios and prompt building functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/48-detection-and-rules-foundation/48-RESEARCH.md
@.planning/phases/48-detection-and-rules-foundation/48-01-SUMMARY.md
@.planning/phases/48-detection-and-rules-foundation/48-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create detector unit tests</name>
  <files>services/contentPreservation/detector.test.ts</files>
  <action>
Create comprehensive Jest tests for the detection module:

```typescript
import {
  detectQuestions,
  detectActivities,
  detectInstructions,
  detectPreservableContent
} from './detector';

describe('detectQuestions', () => {
  // DET-01: Detect questions by punctuation
  describe('punctuation detection (DET-01)', () => {
    it('detects simple questions ending with ?', () => {
      const text = 'What is photosynthesis?';
      const results = detectQuestions(text);

      expect(results).toHaveLength(1);
      expect(results[0].text).toBe('What is photosynthesis?');
      expect(results[0].confidence).toBe('high');
      expect(results[0].detectionMethod).toBe('punctuation');
    });

    it('detects multiple questions in paragraph', () => {
      const text = 'What is X? Why does Y happen? How do we Z?';
      const results = detectQuestions(text);

      expect(results).toHaveLength(3);
      expect(results.map(r => r.text)).toEqual([
        'What is X?',
        'Why does Y happen?',
        'How do we Z?'
      ]);
    });

    it('handles questions across multiple lines', () => {
      const text = `First question: What is energy?
Second question: How is it measured?`;
      const results = detectQuestions(text);

      expect(results.length).toBeGreaterThanOrEqual(2);
    });
  });

  // DET-02: Detect questions by context
  describe('context detection (DET-02)', () => {
    it('detects "Ask:" prefixed questions', () => {
      const text = 'Ask: How do plants grow?';
      const results = detectQuestions(text);

      const contextMatch = results.find(r => r.detectionMethod === 'context');
      expect(contextMatch).toBeDefined();
      expect(contextMatch?.text).toContain('How do plants grow');
    });

    it('detects "Ask students:" prefixed questions', () => {
      const text = 'Ask students: What is the answer?';
      const results = detectQuestions(text);

      expect(results.some(r => r.detectionMethod === 'context')).toBe(true);
    });

    it('detects "Question:" prefixed content', () => {
      const text = 'Question: Name three types of rocks.';
      const results = detectQuestions(text);

      expect(results.length).toBeGreaterThanOrEqual(1);
    });

    it('detects numbered question format (Q1:)', () => {
      const text = 'Q1: What is the capital? Q2: Name the river.';
      const results = detectQuestions(text);

      expect(results.length).toBeGreaterThanOrEqual(2);
    });
  });

  // Rhetorical question handling
  describe('rhetorical question filtering', () => {
    it('flags rhetorical questions as low confidence', () => {
      const text = "Isn't science amazing? Today we learn about cells.";
      const results = detectQuestions(text);

      const rhetorical = results.find(r => r.text.includes("Isn't"));
      expect(rhetorical?.confidence).toBe('low');
    });

    it('flags "Don\'t you think" as low confidence', () => {
      const text = "Don't you think this is interesting?";
      const results = detectQuestions(text);

      expect(results[0]?.confidence).toBe('low');
    });

    it('does not flag genuine questions as rhetorical', () => {
      const text = 'What is the chemical formula for water?';
      const results = detectQuestions(text);

      expect(results[0]?.confidence).toBe('high');
    });
  });

  // DET-04: Consistency requirement
  describe('consistency (DET-04)', () => {
    it('produces identical results on repeated calls', () => {
      const text = 'What is X? List 3 examples. Ask: Why does Y?';

      const result1 = detectQuestions(text);
      const result2 = detectQuestions(text);

      expect(result1).toEqual(result2);
    });
  });
});

describe('detectActivities', () => {
  // DET-03: Detect activities by instructional language
  describe('action verb detection (DET-03)', () => {
    it('detects "List" activity', () => {
      const text = 'List 3 examples of renewable energy.';
      const results = detectActivities(text);

      expect(results).toHaveLength(1);
      expect(results[0].text).toContain('List 3 examples');
      expect(results[0].confidence).toBe('high');
    });

    it('detects "Discuss" activity', () => {
      const text = 'Discuss in pairs your findings.';
      const results = detectActivities(text);

      expect(results.length).toBeGreaterThanOrEqual(1);
    });

    it('detects "Complete" activity', () => {
      const text = 'Complete the worksheet on page 5.';
      const results = detectActivities(text);

      expect(results.length).toBeGreaterThanOrEqual(1);
    });

    it('detects multiple Bloom verbs', () => {
      const text = 'Analyze the data. Compare the results. Evaluate your findings.';
      const results = detectActivities(text);

      expect(results.length).toBeGreaterThanOrEqual(3);
    });
  });

  describe('imperative vs descriptive', () => {
    it('gives high confidence to imperative instructions', () => {
      const text = 'Discuss in pairs your findings.';
      const results = detectActivities(text);

      expect(results[0]?.confidence).toBe('high');
    });

    it('gives low confidence to descriptive statements', () => {
      const text = 'Students will discuss their findings.';
      const results = detectActivities(text);

      // Should still detect but with lower confidence
      if (results.length > 0) {
        expect(results[0]?.confidence).toBe('low');
      }
    });
  });
});

describe('detectPreservableContent', () => {
  it('aggregates questions and activities', () => {
    const text = 'What is X? List 3 examples. Complete the task.';
    const result = detectPreservableContent(text);

    expect(result.questions.length).toBeGreaterThanOrEqual(1);
    expect(result.activities.length).toBeGreaterThanOrEqual(2);
    expect(result.all.length).toBeGreaterThan(0);
  });

  it('sorts all items by startIndex', () => {
    const text = 'Complete task A. What is X? List items.';
    const result = detectPreservableContent(text);

    for (let i = 1; i < result.all.length; i++) {
      expect(result.all[i].startIndex).toBeGreaterThanOrEqual(result.all[i - 1].startIndex);
    }
  });

  // DET-05: Works with PowerPoint-style input
  describe('PowerPoint input (DET-05)', () => {
    it('handles bullet point format', () => {
      const pptText = `
- What is the main idea?
- List the key points
- Discuss with a partner
      `;
      const result = detectPreservableContent(pptText);

      expect(result.questions.length).toBeGreaterThanOrEqual(1);
      expect(result.activities.length).toBeGreaterThanOrEqual(2);
    });

    it('handles slide text without punctuation context', () => {
      const pptText = 'Key Question: How does this work';
      const result = detectPreservableContent(pptText);

      // Should still detect via context markers
      expect(result.all.length).toBeGreaterThanOrEqual(0);
    });
  });
});
```
  </action>
  <verify>
Run tests:
`npm test -- --testPathPattern="detector.test" --passWithNoTests`

All tests should pass.
  </verify>
  <done>
detector.test.ts contains comprehensive unit tests for DET-01, DET-02, DET-03, DET-04, DET-05.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create prompt rules unit tests</name>
  <files>services/prompts/contentPreservationRules.test.ts</files>
  <action>
Create Jest tests for the prompt building module:

```typescript
import {
  escapeXml,
  buildPreservationPrompt,
  getPreservationRules,
  getTeleprompterPreservationRules
} from './contentPreservationRules';
import { DetectedContent, PreservableContent } from '../contentPreservation/types';

describe('escapeXml', () => {
  it('escapes ampersand', () => {
    expect(escapeXml('A & B')).toBe('A &amp; B');
  });

  it('escapes angle brackets', () => {
    expect(escapeXml('Compare <plant> and <animal>')).toBe('Compare &lt;plant&gt; and &lt;animal&gt;');
  });

  it('escapes quotes', () => {
    expect(escapeXml('Say "hello"')).toBe('Say &quot;hello&quot;');
  });

  it('escapes apostrophe', () => {
    expect(escapeXml("It's working")).toBe("It&apos;s working");
  });

  it('handles multiple special characters', () => {
    const input = '<tag attr="val"> & \'text\'';
    const output = escapeXml(input);
    expect(output).not.toContain('<');
    expect(output).not.toContain('>');
    expect(output).toContain('&lt;');
    expect(output).toContain('&gt;');
  });

  it('returns unchanged text with no special characters', () => {
    expect(escapeXml('Normal text 123')).toBe('Normal text 123');
  });
});

describe('buildPreservationPrompt', () => {
  const mockQuestion: DetectedContent = {
    type: 'question',
    text: 'What is photosynthesis?',
    confidence: 'high',
    detectionMethod: 'punctuation',
    startIndex: 0,
    endIndex: 22
  };

  const mockActivity: DetectedContent = {
    type: 'activity',
    text: 'List 3 examples.',
    confidence: 'high',
    detectionMethod: 'action-verb',
    startIndex: 25,
    endIndex: 40
  };

  it('returns empty string for empty input', () => {
    const result = buildPreservationPrompt([]);
    expect(result).toBe('');
  });

  it('generates XML-tagged prompt for single item', () => {
    const result = buildPreservationPrompt([mockQuestion]);

    expect(result).toContain('<content_preservation>');
    expect(result).toContain('<preserve type="question"');
    expect(result).toContain('What is photosynthesis?');
    expect(result).toContain('</preserve>');
  });

  it('includes detection method in tag', () => {
    const result = buildPreservationPrompt([mockQuestion]);
    expect(result).toContain('method="punctuation"');
  });

  it('handles multiple items', () => {
    const result = buildPreservationPrompt([mockQuestion, mockActivity]);

    expect(result).toContain('type="question"');
    expect(result).toContain('type="activity"');
  });

  it('filters low confidence items by default', () => {
    const lowConfidence: DetectedContent = {
      ...mockQuestion,
      confidence: 'low'
    };

    const result = buildPreservationPrompt([lowConfidence], 'medium');
    expect(result).toBe('');
  });

  it('includes low confidence items when threshold is low', () => {
    const lowConfidence: DetectedContent = {
      ...mockQuestion,
      confidence: 'low'
    };

    const result = buildPreservationPrompt([lowConfidence], 'low');
    expect(result).toContain('What is photosynthesis?');
  });

  it('includes few-shot examples', () => {
    const result = buildPreservationPrompt([mockQuestion]);
    expect(result).toContain('<preservation_examples>');
    expect(result).toContain('</preservation_examples>');
  });

  it('escapes special characters in content', () => {
    const specialContent: DetectedContent = {
      type: 'question',
      text: 'Compare <x> & <y>?',
      confidence: 'high',
      detectionMethod: 'punctuation',
      startIndex: 0,
      endIndex: 20
    };

    const result = buildPreservationPrompt([specialContent]);
    expect(result).toContain('&lt;x&gt;');
    expect(result).toContain('&amp;');
    expect(result).not.toContain('<x>');
  });
});

describe('getPreservationRules', () => {
  it('accepts PreservableContent and returns prompt', () => {
    const content: PreservableContent = {
      questions: [{
        type: 'question',
        text: 'What is X?',
        confidence: 'high',
        detectionMethod: 'punctuation',
        startIndex: 0,
        endIndex: 10
      }],
      activities: [],
      instructions: [],
      all: [{
        type: 'question',
        text: 'What is X?',
        confidence: 'high',
        detectionMethod: 'punctuation',
        startIndex: 0,
        endIndex: 10
      }]
    };

    const result = getPreservationRules(content);
    expect(result).toContain('What is X?');
  });

  it('returns empty string for empty content', () => {
    const emptyContent: PreservableContent = {
      questions: [],
      activities: [],
      instructions: [],
      all: []
    };

    const result = getPreservationRules(emptyContent);
    expect(result).toBe('');
  });
});

describe('getTeleprompterPreservationRules', () => {
  it('returns guidance when questions present', () => {
    const content: PreservableContent = {
      questions: [{
        type: 'question',
        text: 'What?',
        confidence: 'high',
        detectionMethod: 'punctuation',
        startIndex: 0,
        endIndex: 5
      }],
      activities: [],
      instructions: [],
      all: []
    };

    const result = getTeleprompterPreservationRules(content);
    expect(result).toContain('SPEAKER NOTES');
    expect(result).toContain('QUESTIONS');
  });

  it('returns guidance when activities present', () => {
    const content: PreservableContent = {
      questions: [],
      activities: [{
        type: 'activity',
        text: 'List items.',
        confidence: 'high',
        detectionMethod: 'action-verb',
        startIndex: 0,
        endIndex: 10
      }],
      instructions: [],
      all: []
    };

    const result = getTeleprompterPreservationRules(content);
    expect(result).toContain('ACTIVITIES');
  });

  it('returns empty string when no questions or activities', () => {
    const content: PreservableContent = {
      questions: [],
      activities: [],
      instructions: [{
        type: 'instruction',
        text: 'Note this.',
        confidence: 'high',
        detectionMethod: 'instruction-prefix',
        startIndex: 0,
        endIndex: 10
      }],
      all: []
    };

    const result = getTeleprompterPreservationRules(content);
    expect(result).toBe('');
  });
});
```
  </action>
  <verify>
Run tests:
`npm test -- --testPathPattern="contentPreservationRules.test" --passWithNoTests`

All tests should pass.
  </verify>
  <done>
contentPreservationRules.test.ts contains unit tests for XML escaping and prompt building functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run all tests and verify phase requirements</name>
  <files>services/contentPreservation/detector.test.ts, services/prompts/contentPreservationRules.test.ts</files>
  <action>
Run the complete test suite and verify all requirements are met:

1. Run all new tests:
   ```bash
   npm test -- --testPathPattern="(detector|contentPreservationRules)" --coverage
   ```

2. Verify coverage of requirements:
   - DET-01: Question punctuation detection - covered by `punctuation detection` describe block
   - DET-02: Question context detection - covered by `context detection` describe block
   - DET-03: Activity detection - covered by `action verb detection` describe block
   - DET-04: Consistency - covered by `consistency` describe block
   - DET-05: PowerPoint input - covered by `PowerPoint input` describe block

3. If any tests fail, fix the implementation in detector.ts or contentPreservationRules.ts to match expected behavior.

4. Verify the complete test run passes:
   ```bash
   npm test
   ```
  </action>
  <verify>
`npm test` passes with no failures.
Test coverage shows detector.ts and contentPreservationRules.ts are tested.
  </verify>
  <done>
All unit tests pass. Detection module and prompt rules module verified against DET-01 through DET-05 requirements.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. All tests pass:
   `npm test -- --testPathPattern="(detector|contentPreservationRules)"`

2. Requirements verified by tests:
   - DET-01: Punctuation detection tests pass
   - DET-02: Context detection tests pass
   - DET-03: Activity detection tests pass
   - DET-04: Consistency tests pass
   - DET-05: PowerPoint input tests pass

3. Edge cases covered:
   - Rhetorical questions flagged correctly
   - Descriptive vs imperative distinguished
   - XML special characters escaped
   - Empty input handled gracefully

4. Full test suite still passes:
   `npm test`
</verification>

<success_criteria>
- services/contentPreservation/detector.test.ts exists with passing tests
- services/prompts/contentPreservationRules.test.ts exists with passing tests
- Tests cover all five DET requirements
- Edge cases tested (rhetorical, descriptive, special chars)
- Consistency test verifies deterministic behavior
- PowerPoint-style input tested
- Full test suite passes (`npm test`)
</success_criteria>

<output>
After completion, create `.planning/phases/48-detection-and-rules-foundation/48-03-SUMMARY.md`
</output>
