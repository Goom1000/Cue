---
phase: 48-detection-and-rules-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/contentPreservation/types.ts
  - services/contentPreservation/detector.ts
autonomous: true

must_haves:
  truths:
    - "Questions ending with ? are detected as high confidence"
    - "Questions prefixed with Ask:/Question: are detected as medium confidence"
    - "Activities with action verbs are detected"
    - "Rhetorical questions are flagged as low confidence"
    - "Detection results include text, type, confidence, and method"
  artifacts:
    - path: "services/contentPreservation/types.ts"
      provides: "DetectedContent interface and ContentType union"
      exports: ["DetectedContent", "ContentType", "ConfidenceLevel", "PreservableContent"]
    - path: "services/contentPreservation/detector.ts"
      provides: "Detection functions for questions and activities"
      exports: ["detectQuestions", "detectActivities", "detectPreservableContent"]
  key_links:
    - from: "services/contentPreservation/detector.ts"
      to: "services/contentPreservation/types.ts"
      via: "import"
      pattern: "import.*from.*types"
---

<objective>
Build the content detection module that identifies preservable content (questions, activities, instructions) in lesson plan text using regex patterns.

Purpose: Enable the AI to know which teacher-specified content must appear verbatim on slides rather than being generalized. This is the core detection engine that feeds into AI prompts.

Output: TypeScript module with pure functions that accept text input and return typed detection results with confidence levels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/48-detection-and-rules-foundation/48-RESEARCH.md
@services/prompts/studentFriendlyRules.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create types and interfaces</name>
  <files>services/contentPreservation/types.ts</files>
  <action>
Create the TypeScript types for the content preservation detection system:

```typescript
// Content types that can be preserved
export type ContentType = 'question' | 'activity' | 'instruction';

// Confidence levels for detection
export type ConfidenceLevel = 'high' | 'medium' | 'low';

// Detection method identifier
export type DetectionMethod =
  | 'punctuation'      // Detected by ? ending
  | 'context'          // Detected by "Ask:", "Question:" prefix
  | 'numbered-list'    // Detected as part of numbered question list
  | 'action-verb'      // Detected by Bloom's taxonomy action verbs
  | 'instruction-prefix'; // Detected by instruction markers

// Individual detected content item
export interface DetectedContent {
  type: ContentType;
  text: string;
  confidence: ConfidenceLevel;
  detectionMethod: DetectionMethod;
  startIndex: number;
  endIndex: number;
}

// Aggregated preservation results
export interface PreservableContent {
  questions: DetectedContent[];
  activities: DetectedContent[];
  instructions: DetectedContent[];
  all: DetectedContent[];  // Convenience: sorted by startIndex
}
```

Follow the established service pattern from `services/prompts/studentFriendlyRules.ts` - export types and interfaces that will be consumed by detection functions and prompt builders.
  </action>
  <verify>
Run: `npx tsc services/contentPreservation/types.ts --noEmit --skipLibCheck`
Should complete without type errors.
  </verify>
  <done>
types.ts exports DetectedContent, ContentType, ConfidenceLevel, DetectionMethod, and PreservableContent types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement question detection</name>
  <files>services/contentPreservation/detector.ts</files>
  <action>
Create the detector module with question detection functions:

1. **Punctuation-based detection (DET-01):**
   - Pattern: Sentences ending with `?`
   - Use non-greedy matching to avoid capturing across paragraphs
   - Pattern: `/([^.!?\n]*\?)/g`
   - Confidence: high (unless rhetorical)

2. **Context-based detection (DET-02):**
   - Patterns for "Ask:", "Ask students:", "Question:", "Q1:", etc.
   - Pattern: `/(?:Ask(?:\s+(?:students|the\s+class))?|Questions?|Q\d+)\s*:?\s*([^.!?\n]+[.!?]?)/gi`
   - Confidence: medium (context marker is explicit)

3. **Numbered question lists:**
   - Pattern: `/(?:^|\n)\s*(\d+\.|\([a-z]\))\s*([^.!?\n]*\?)/gm`
   - Confidence: medium

4. **Rhetorical question filter:**
   - Patterns: "Isn't it...", "Don't you think...", "Wouldn't it be...", "Can you believe..."
   - If match, downgrade to low confidence

5. **Deduplication helper:**
   - When same text detected by multiple methods, keep highest confidence version
   - Use startIndex/endIndex to detect overlapping detections

Example implementation structure:
```typescript
import { DetectedContent, ConfidenceLevel, PreservableContent } from './types';

// Rhetorical patterns to downgrade confidence
const RHETORICAL_PATTERNS = [
  /^Isn't\s/i,
  /^Don't\s+you\s+think/i,
  /^Wouldn't\s+it\s+be/i,
  /^Can\s+you\s+believe/i,
  /^Have\s+you\s+ever\s+wondered/i,
];

function isRhetorical(text: string): boolean {
  return RHETORICAL_PATTERNS.some(pattern => pattern.test(text.trim()));
}

export function detectQuestions(text: string): DetectedContent[] {
  // Implementation following research patterns
}
```
  </action>
  <verify>
Manual test in browser console or simple test file:
```typescript
import { detectQuestions } from './services/contentPreservation/detector';
const result = detectQuestions('What is photosynthesis? Ask students: How do plants grow?');
console.log(result); // Should show 2 questions
```
  </verify>
  <done>
detectQuestions function detects questions by punctuation (DET-01) and context (DET-02), with rhetorical filtering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement activity detection and main export</name>
  <files>services/contentPreservation/detector.ts</files>
  <action>
Add activity detection (DET-03) and the main aggregation function:

1. **Bloom's Taxonomy action verbs:**
```typescript
const BLOOM_ACTION_VERBS = {
  remember: ['define', 'identify', 'describe', 'list', 'label', 'name', 'state', 'match', 'select', 'recall'],
  understand: ['summarize', 'interpret', 'classify', 'compare', 'explain', 'discuss', 'distinguish', 'paraphrase'],
  apply: ['solve', 'complete', 'use', 'demonstrate', 'show', 'illustrate', 'apply', 'calculate'],
  analyze: ['analyze', 'contrast', 'differentiate', 'categorize', 'examine', 'investigate', 'organize'],
  evaluate: ['evaluate', 'judge', 'defend', 'critique', 'prioritize', 'assess', 'justify'],
  create: ['create', 'design', 'develop', 'formulate', 'construct', 'plan', 'compose', 'produce']
};
```

2. **Activity detection logic:**
   - Build regex from all action verbs
   - Pattern must be at sentence start (imperative mood)
   - Check for descriptive context ("Students will...") to downgrade confidence
   - Pattern: `/(?:^|[.!?]\s+)(verb)\s+([^.!?]+[.!?])/gim`

3. **Instruction detection:**
   - Similar to activities but with instruction markers: "Note:", "Remember:", "Important:"
   - Higher confidence when explicit marker present

4. **Main export function:**
```typescript
export function detectPreservableContent(text: string): PreservableContent {
  const questions = detectQuestions(text);
  const activities = detectActivities(text);
  const instructions = detectInstructions(text);

  const all = [...questions, ...activities, ...instructions]
    .sort((a, b) => a.startIndex - b.startIndex);

  return { questions, activities, instructions, all };
}
```

5. **Export all functions:**
   - `detectQuestions(text: string): DetectedContent[]`
   - `detectActivities(text: string): DetectedContent[]`
   - `detectInstructions(text: string): DetectedContent[]`
   - `detectPreservableContent(text: string): PreservableContent`

The functions must be pure (no side effects) and deterministic (same input = same output) per DET-04 requirement.
  </action>
  <verify>
Run TypeScript compilation check:
`npx tsc services/contentPreservation/detector.ts --noEmit --skipLibCheck`

Manual verification:
```typescript
import { detectPreservableContent } from './services/contentPreservation/detector';
const result = detectPreservableContent('List 3 examples of renewable energy. What is solar power? Discuss in pairs your findings.');
console.log(result.all.length); // Should be 3
```
  </verify>
  <done>
detector.ts exports detectQuestions, detectActivities, detectInstructions, and detectPreservableContent functions covering DET-01, DET-02, DET-03.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors:
   `npx tsc --noEmit`

2. Detection module exports all required functions:
   - Check exports in detector.ts
   - Check types in types.ts

3. Module can be imported without errors:
   ```typescript
   import { detectPreservableContent, DetectedContent, PreservableContent } from './services/contentPreservation/detector';
   ```

4. Detection produces consistent results (DET-04 requirement):
   - Run detection twice on same input
   - Results should be identical
</verification>

<success_criteria>
- services/contentPreservation/types.ts exists with DetectedContent interface
- services/contentPreservation/detector.ts exists with detection functions
- Questions detected by punctuation (?) with high confidence
- Questions detected by context (Ask:, Question:) with medium confidence
- Rhetorical questions flagged as low confidence
- Activities detected by action verbs (list, discuss, complete, etc.)
- All functions are pure and deterministic
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/48-detection-and-rules-foundation/48-01-SUMMARY.md`
</output>
