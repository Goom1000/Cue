---
phase: 09-ai-adaptation-logic
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - App.tsx
autonomous: false

must_haves:
  truths:
    - "Fresh mode generates slides from lesson content only"
    - "Refine mode generates slides from presentation content only"
    - "Blend mode generates slides combining lesson and presentation"
    - "Teleprompter scripts generated for ALL modes"
  artifacts:
    - path: "App.tsx"
      provides: "handleGenerate passes GenerationInput to provider"
      contains: "generateLessonSlides.*mode.*uploadMode"
  key_links:
    - from: "App.tsx"
      to: "services/aiProvider.ts"
      via: "provider.generateLessonSlides()"
      pattern: "provider\\.generateLessonSlides"
---

<objective>
Wire App.tsx to pass upload mode and presentation content to the AI provider for generation.

Purpose: Connect the UI state (uploadMode, existingPptText, existingPptImages) to the AI provider so all three generation modes work end-to-end.

Output: handleGenerate uses GenerationInput, all three modes functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ai-adaptation-logic/09-CONTEXT.md
@.planning/phases/09-ai-adaptation-logic/09-01-SUMMARY.md
@.planning/phases/09-ai-adaptation-logic/09-02-SUMMARY.md

@App.tsx
@services/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update handleGenerate to use GenerationInput</name>
  <files>App.tsx</files>
  <action>
Update the handleGenerate function to pass structured GenerationInput to the provider:

1. Import GenerationInput and GenerationMode types:
```typescript
import { createAIProvider, AIProviderError, AIProviderInterface, GenerationInput, GenerationMode } from './services/aiProvider';
```

2. Update the UploadMode type to match GenerationMode (or cast it):
The existing `type UploadMode = 'fresh' | 'refine' | 'blend' | 'none';` is close, but GenerationMode doesn't have 'none'. That's fine - we guard against 'none' before calling generate.

3. Replace the current generateLessonSlides call in handleGenerate:

BEFORE:
```typescript
const generatedSlides = await provider.generateLessonSlides(lessonText, pageImages);
```

AFTER:
```typescript
// Build GenerationInput based on uploadMode
const generationInput: GenerationInput = {
  lessonText: lessonText,
  lessonImages: pageImages.length > 0 ? pageImages : undefined,
  presentationText: existingPptText || undefined,
  presentationImages: existingPptImages.length > 0 ? existingPptImages : undefined,
  mode: uploadMode as GenerationMode, // Safe cast - we guard against 'none' above
};

const generatedSlides = await provider.generateLessonSlides(generationInput);
```

4. Verify the existing validation guards against 'none' mode:
```typescript
if (!hasLessonContent && !hasPptContent) return;
```
This ensures uploadMode is never 'none' when we reach the API call.

5. Remove the Phase 8 TODO comment:
```typescript
// Phase 8: Pass existing behavior for lesson content
// Phase 9 will differentiate by uploadMode and use existingPptImages/existingPptText
```

This is now implemented, so delete the comment.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>handleGenerate passes GenerationInput with mode, lesson data, and presentation data to provider</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete AI adaptation logic for all three generation modes</what-built>
  <how-to-verify>
Test all three generation modes in the app:

**Test 1: Fresh Mode (lesson only)**
1. Start the app: `npm run dev`
2. On landing page, upload a lesson plan PDF to the green "Lesson Plan PDF" zone
3. Verify mode indicator shows "Fresh Generation" (green)
4. Click "Generate Slideshow"
5. Verify: Slides generated with teleprompter scripts, works as before

**Test 2: Refine Mode (presentation only)**
1. Clear any files, return to landing page
2. Upload an existing PowerPoint PDF to the blue "Existing Presentation" zone
3. Verify mode indicator shows "Refine Mode" (blue)
4. Click "Refine Presentation"
5. Verify:
   - Slides generated in PiPi style (less text-dense than original)
   - Teleprompter scripts present for each slide
   - Visual descriptions noted where applicable: "[Visual: ...]"
   - No references to "slide 3 from original" etc.

**Test 3: Blend Mode (both files)**
1. Clear files, return to landing page
2. Upload lesson PDF to green zone AND presentation PDF to blue zone
3. Verify mode indicator shows "Blend Mode" (purple)
4. Click "Enhance Slides"
5. Verify:
   - Slides generated combining both sources
   - Topics from lesson that weren't in presentation get new slides
   - Teleprompter scripts synthesize both sources
   - Any conflicts noted: "[Note: ...]" in speaker notes

**Test 4: Provider switch**
- Repeat tests 1-3 with the other AI provider (switch in Settings)
- Both Gemini and Claude should produce similar quality results

Report any issues with:
- Missing teleprompter scripts
- Mode not affecting output
- Errors during generation
- Provider-specific issues
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Fresh mode generates slides from lesson only (existing behavior preserved)
3. Refine mode generates PiPi-style slides from presentation
4. Blend mode generates combined slides from both sources
5. All modes include teleprompter scripts with proper delimiter format
6. Both Claude and Gemini providers work correctly
</verification>

<success_criteria>
Requirements covered:
- UPLOAD-05: AI refines existing slides to PiPi format (refine mode working)
- UPLOAD-06: AI uses lesson content to improve existing slides (blend mode working)
- UPLOAD-07: AI preserves teacher's style/preferences when adapting (prompts include style guidance)

Technical criteria:
- handleGenerate builds GenerationInput with all available data
- uploadMode cast to GenerationMode is safe (guarded by validation)
- No regression in fresh mode (existing behavior preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-adaptation-logic/09-03-SUMMARY.md`
</output>
