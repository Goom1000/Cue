---
phase: 09-ai-adaptation-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - services/providers/claudeProvider.ts
autonomous: true

must_haves:
  truths:
    - "Provider interface accepts mode parameter (fresh/refine/blend)"
    - "Claude generates refine-mode slides from presentation-only input"
    - "Claude generates blend-mode slides from lesson+presentation input"
    - "All modes produce teleprompter scripts with proper delimiter format"
  artifacts:
    - path: "services/aiProvider.ts"
      provides: "GenerationMode type, GenerationInput interface, updated AIProviderInterface"
      contains: "GenerationMode.*fresh.*refine.*blend"
    - path: "services/providers/claudeProvider.ts"
      provides: "Mode-specific system prompts, content building for all modes"
      min_lines: 450
  key_links:
    - from: "services/providers/claudeProvider.ts"
      to: "services/aiProvider.ts"
      via: "implements AIProviderInterface"
      pattern: "implements AIProviderInterface"
---

<objective>
Add GenerationMode types and implement mode-specific slide generation in ClaudeProvider.

Purpose: Enable AI to generate appropriate content based on upload mode (fresh from lesson, refine existing presentation, or blend both sources).

Output: Updated types in aiProvider.ts, Claude provider with refine/blend prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ai-adaptation-logic/09-CONTEXT.md
@.planning/phases/09-ai-adaptation-logic/09-RESEARCH.md
@.planning/phases/08-flexible-upload-ui/08-01-SUMMARY.md

@services/aiProvider.ts
@services/providers/claudeProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GenerationMode types and update interface</name>
  <files>services/aiProvider.ts</files>
  <action>
Add new types and update the interface signature:

1. Add GenerationMode type:
```typescript
export type GenerationMode = 'fresh' | 'refine' | 'blend';
```

2. Add GenerationInput interface:
```typescript
export interface GenerationInput {
  lessonText: string;
  lessonImages?: string[];
  presentationText?: string;
  presentationImages?: string[];
  mode: GenerationMode;
}
```

3. Update AIProviderInterface.generateLessonSlides signature to accept EITHER the new GenerationInput OR the old (string, string[]) signature for backward compatibility:
```typescript
generateLessonSlides(
  inputOrText: GenerationInput | string,
  pageImages?: string[]
): Promise<Slide[]>;
```

This allows existing callers to work while new callers can use the structured input.

Export the new types alongside existing exports.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>GenerationMode and GenerationInput types exported, interface accepts both old and new signatures</done>
</task>

<task type="auto">
  <name>Task 2: Implement mode-specific generation in ClaudeProvider</name>
  <files>services/providers/claudeProvider.ts</files>
  <action>
Update ClaudeProvider.generateLessonSlides to handle all three modes:

1. Import the new types:
```typescript
import { GenerationInput, GenerationMode } from '../aiProvider';
```

2. Extract TELEPROMPTER_RULES as a shared constant (from existing systemPrompt):
```typescript
const TELEPROMPTER_RULES = `
STRICT SPEAKER NOTE RULES (TELEPROMPTER LOGIC):
The app uses a "Progressive Disclosure" system.
1. The visual bullet point appears.
2. The Student reads the bullet.
3. The Teacher (Teleprompter) adds insight.

Therefore:
- **NEVER** repeat the text that is on the slide in the speaker notes.
- **NEVER** re-summarize a point that was just made in the previous bullet.
- Each note must **ADD VALUE**: provide a concrete example, an analogy, or a "Why this matters" explanation.
- Ensure a continuous narrative flow. Note 2 must naturally follow Note 1.

FORMATTING:
The speaker notes must use "pointing_right" as a delimiter.
- Segment 0 (Intro): Set the scene before bullet 1 appears.
- Segment 1 (for Bullet 1): Elaborate on Bullet 1.
- Segment 2 (for Bullet 2): Elaborate on Bullet 2 (Do not repeat Segment 1).
- The number of "pointing_right" segments MUST be exactly (Number of Bullets + 1).
`;
```

3. Create getSystemPromptForMode(mode: GenerationMode) function that returns mode-specific prompts:

FRESH MODE (existing prompt, refactored):
- Transform lesson plan into teaching slideshow
- Preserve pedagogical structure (Hook, I Do, We Do, You Do)
- Include Success Criteria and Differentiation slides

REFINE MODE (new):
- Extract key concepts from existing presentation
- Create NEW PiPi-style slides (less text-dense, clean format)
- AI decides optimal slide count (not forced to match original)
- May reorder for better pedagogical flow
- Note visuals with "[Visual: description]" so teacher can re-add
- No references to "original slide 3" - output stands alone
- Generate teleprompter scripts from inferred teaching goals

BLEND MODE (new):
- Analyze BOTH lesson plan AND existing presentation
- Determine content overlap between sources
- Add slides for topics in lesson but not in presentation
- Standardize ALL output to PiPi style
- Flag conflicts: "[Note: Sources differ on X]" in speakerNotes
- Scripts synthesize both sources into cohesive narrative

4. Update generateLessonSlides method signature to accept GenerationInput OR old params:
```typescript
async generateLessonSlides(
  inputOrText: GenerationInput | string,
  pageImages?: string[]
): Promise<Slide[]> {
  // Normalize to GenerationInput
  const input: GenerationInput = typeof inputOrText === 'string'
    ? { lessonText: inputOrText, lessonImages: pageImages, mode: 'fresh' }
    : inputOrText;

  const systemPrompt = getSystemPromptForMode(input.mode);
  // ... rest of implementation
}
```

5. Build contentParts based on mode:
- FRESH: Text prompt with lesson + lesson images
- REFINE: Text prompt with presentation + presentation images
- BLEND: Text prompt with both sources + both image sets (limit to 5 images per source to avoid token limits)

6. Use JSON output format instructions in all mode prompts (existing pattern).

Important: The existing FRESH mode behavior MUST be preserved exactly. Test that passing (string, string[]) still works.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Run app with Claude provider selected, upload lesson PDF only, generate - should work exactly as before.
  </verify>
  <done>ClaudeProvider handles fresh/refine/blend modes with appropriate prompts, backward compatible with old signature</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Fresh mode (lesson only) works exactly as before
3. Code review: getSystemPromptForMode covers all three modes
4. Code review: TELEPROMPTER_RULES constant is included in all mode prompts
5. Code review: contentParts correctly includes appropriate images for each mode
</verification>

<success_criteria>
- GenerationMode and GenerationInput types exported from aiProvider.ts
- ClaudeProvider.generateLessonSlides accepts both old and new signatures
- Fresh mode behavior unchanged (backward compatible)
- Refine and blend mode prompts include:
  - Mode-specific instructions per CONTEXT.md decisions
  - TELEPROMPTER_RULES for script generation
  - JSON output format instructions
- No new dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-adaptation-logic/09-01-SUMMARY.md`
</output>
