---
phase: 72-day-picker-ui-mode-selector
plan: 02
type: execute
wave: 2
depends_on: [72-01]
files_modified:
  - App.tsx
autonomous: false
requirements: [MODE-01, MODE-02, MODE-03, DAY-01, DAY-02, DAY-03, DAY-04, DAY-05]

must_haves:
  truths:
    - "After uploading a lesson plan with scripted markers, an amber banner appears suggesting scripted import mode with a toggle switch"
    - "Toggle switch allows teacher to override back to AI generation mode"
    - "When a multi-day lesson plan is detected in scripted mode, day cards appear in a grid showing day number, title, sections, and block counts"
    - "All days are pre-selected by default; teacher can deselect individual days or use select all/deselect all"
    - "Amber cross-day reference warning appears when not all days are selected (hidden when all selected or only 1 day)"
    - "Compact stats line above generate button shows days/sections/blocks counts that update reactively as days are selected"
    - "Generate button shows scripted-specific label when in scripted mode"
    - "DOCX, PDF, and TXT files can all be uploaded as lesson plans"
    - "Verbosity selector is hidden when scripted mode is active (scripted preserves verbatim text)"
    - "Scripted mode override resets when a new file is uploaded"
  artifacts:
    - path: "App.tsx"
      provides: "Scripted mode state, banner, day picker, stats, multi-format upload"
      contains: "detectScriptedMarkers"
  key_links:
    - from: "App.tsx"
      to: "services/scriptedParser/scriptedParser.ts"
      via: "Import detectScriptedMarkers and parseScriptedLessonPlan"
      pattern: "import.*detectScriptedMarkers"
    - from: "App.tsx"
      to: "services/generationPipeline.ts"
      via: "Passes selectedDays in GenerationInput to pipeline"
      pattern: "selectedDays"
    - from: "App.tsx"
      to: "services/documentProcessors/docxProcessor.ts"
      via: "Import mammoth or processDocx for DOCX upload handling"
      pattern: "mammoth|processDocx"
---

<objective>
Build the complete teacher-facing UI for scripted import mode: auto-detection banner, day picker with selection, import statistics, multi-format upload, and pipeline wiring.

Purpose: This is the user-visible layer of the scripted import feature. After uploading a lesson plan with scripted markers, teachers should automatically see the scripted mode suggestion, be able to pick which days to import, see statistics, and generate slides with a scripted-specific button label.

Output: Updated App.tsx with all Phase 72 UI features wired into the landing page
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/72-day-picker-ui-mode-selector/72-RESEARCH.md
@.planning/phases/72-day-picker-ui-mode-selector/72-01-SUMMARY.md

@App.tsx
@services/scriptedParser/scriptedParser.ts
@services/scriptedParser/types.ts
@services/aiProvider.ts
@services/documentProcessors/docxProcessor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Multi-format upload + scripted mode state + mode banner + button label</name>
  <files>App.tsx</files>
  <action>
This task adds the foundation: multi-format file upload, scripted mode detection state, the mode banner with toggle, and generate button label override. All changes are in App.tsx.

**1. Add imports at the top of App.tsx:**
```typescript
import { detectScriptedMarkers, parseScriptedLessonPlan } from './services/scriptedParser/scriptedParser';
import { ScriptedParseResult } from './services/scriptedParser/types';
import mammoth from 'mammoth';
```

**2. Extend the lesson plan file input to accept multiple formats (MODE-02):**

In `handleFileChange` (around line 513), replace the PDF-only check:
```typescript
// OLD:
if (file.type !== 'application/pdf') {
  setError("Please upload a PDF document.");
  return;
}
```
With multi-format routing:
```typescript
const ext = file.name.split('.').pop()?.toLowerCase();
const supportedExts = ['pdf', 'docx', 'txt'];
if (!ext || !supportedExts.includes(ext)) {
  setError("Please upload a PDF, DOCX, or TXT document.");
  return;
}

setUploadedFile(file);
setError(null);

if (ext === 'pdf') {
  await processPdf(file, setIsProcessingFile, (text, images) => {
    setLessonText(text);
    setPageImages(images);
  }, setError);
} else if (ext === 'docx') {
  setIsProcessingFile(true);
  try {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    setLessonText(result.value);
    setPageImages([]);
  } catch (err) {
    setError('Failed to read DOCX file');
  } finally {
    setIsProcessingFile(false);
  }
} else if (ext === 'txt') {
  setIsProcessingFile(true);
  try {
    const text = await file.text();
    setLessonText(text);
    setPageImages([]);
  } catch (err) {
    setError('Failed to read text file');
  } finally {
    setIsProcessingFile(false);
  }
}
```

Remove the `setUploadedFile(file)` and `setError(null)` lines that currently appear AFTER the old type check (around line 522-523), since they're now at the top of the handler before the format routing. Also remove the old `await processPdf(...)` call that was below them.

Update the file input `accept` attribute (around line 2234) from `accept=".pdf"` to `accept=".pdf,.docx,.txt"`. Also update the hidden input at line 2153 and 2162 if those are for the lesson plan (check -- the lines at 2162 may be for PPT, keep those as PDF-only).

Update the upload zone label from "Lesson Plan PDF" (line 2224/2258) to "Lesson Plan" and the helper text referencing PDF to mention "PDF, DOCX, or TXT".

**3. Add scripted mode state (after the `uploadMode` useMemo, around line 411):**

```typescript
// Scripted mode detection and state (Phase 72)
const hasScriptedMarkers = useMemo(() => {
  if (!lessonText.trim()) return false;
  return detectScriptedMarkers(lessonText);
}, [lessonText]);

const [scriptedModeOverride, setScriptedModeOverride] = useState<boolean | null>(null);
const isScriptedMode = scriptedModeOverride ?? hasScriptedMarkers;

// Parse result for day picker and stats (only computed when scripted mode is active)
const [parseResult, setParseResult] = useState<ScriptedParseResult | null>(null);
const [selectedDays, setSelectedDays] = useState<Set<number>>(new Set());

// Run full parse eagerly when scripted mode activates
useEffect(() => {
  if (isScriptedMode && lessonText.trim()) {
    const result = parseScriptedLessonPlan(lessonText);
    setParseResult(result);
    setSelectedDays(new Set(result.days.map(d => d.dayNumber)));
  } else {
    setParseResult(null);
    setSelectedDays(new Set());
  }
}, [isScriptedMode, lessonText]);

// Reset scripted mode override when new file is uploaded (Pitfall 2 from RESEARCH.md)
useEffect(() => {
  setScriptedModeOverride(null);
}, [uploadedFile]);

// Day selection toggle helper
const toggleDaySelection = (dayNumber: number) => {
  setSelectedDays(prev => {
    const next = new Set(prev);
    if (next.has(dayNumber)) {
      next.delete(dayNumber);
    } else {
      next.add(dayNumber);
    }
    return next;
  });
};

// Reactive import stats (MODE-03)
const importStats = useMemo(() => {
  if (!parseResult) return null;
  const selected = parseResult.days.filter(d => selectedDays.has(d.dayNumber));
  const sectionCount = selected.reduce((sum, day) =>
    sum + day.blocks.filter(b => b.type === 'section-heading').length, 0);
  const blockCount = selected.reduce((sum, day) =>
    sum + day.blocks.filter(b => b.type !== 'section-heading').length, 0);
  return { days: selected.length, sections: sectionCount, blocks: blockCount };
}, [parseResult, selectedDays]);
```

**4. Add scripted mode banner (MODE-01):**

Place this AFTER the existing Mode Indicator section (after line ~2340, after the closing `)}` of the Mode Indicator), but BEFORE the Verbosity Selection:

```tsx
{/* Scripted Mode Banner (Phase 72 - MODE-01) */}
{hasScriptedMarkers && uploadMode === 'fresh' && (
  <div className="mb-6 p-4 rounded-xl border border-amber-200 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/20">
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-3">
        <div className="w-8 h-8 rounded-lg bg-amber-500 text-white flex items-center justify-center">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div>
          <p className="font-bold text-sm text-amber-700 dark:text-amber-300">Scripted markers detected</p>
          <p className="text-xs text-slate-600 dark:text-slate-400">
            Your lesson plan contains Say:, Ask:, and other scripted markers
          </p>
        </div>
      </div>
      <label className="relative inline-flex items-center cursor-pointer">
        <input
          type="checkbox"
          className="sr-only peer"
          checked={isScriptedMode}
          onChange={() => setScriptedModeOverride(prev => prev === null ? !hasScriptedMarkers : !prev)}
        />
        <div className="w-11 h-6 bg-slate-200 dark:bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
      </label>
    </div>
  </div>
)}
```

**5. Hide verbosity selector in scripted mode:**

The existing verbosity selector condition (around line 2343) is `{uploadMode !== 'none' && (`. Change it to:
```tsx
{uploadMode !== 'none' && !isScriptedMode && (
```
Rationale: Scripted mode preserves the teacher's verbatim text; there is no AI teleprompter generation to control verbosity for.

**6. Override generate button label in scripted mode:**

The generate button text (around line 2484) currently reads:
```tsx
{uploadMode === 'refine' ? 'Refine Presentation' : uploadMode === 'blend' ? 'Enhance Slides' : 'Generate Slideshow'}
```
Change to:
```tsx
{isScriptedMode ? 'Import Scripted Lesson' : uploadMode === 'refine' ? 'Refine Presentation' : uploadMode === 'blend' ? 'Enhance Slides' : 'Generate Slideshow'}
```

**7. Wire scripted mode into handleGenerate:**

In `handleGenerate` (around line 577-586), update the `generationInput` construction:

Change the mode assignment from:
```typescript
mode: uploadMode as GenerationMode,
```
To:
```typescript
mode: (isScriptedMode ? 'scripted' : uploadMode) as GenerationMode,
```

And add `selectedDays` to the input:
```typescript
selectedDays: isScriptedMode && parseResult && parseResult.totalDays > 1
  ? Array.from(selectedDays) : undefined,
```

IMPORTANT: The `provider` check at the top of handleGenerate (line 558) should be bypassed for scripted mode since scripted mode may or may not need AI (enrichment is try/catch with fallback). However, the existing check shows an "enable AI" modal. For scripted mode, we should still allow generation to proceed even without a provider -- BUT the pipeline currently requires a provider parameter. Looking at the pipeline signature, `provider: AIProviderInterface` is required. The enrichment try/catch will handle provider failure gracefully. So keep the provider check as-is; if user has no API key, they'll be prompted (enrichment will just fall back to synthesized prompts on failure).

Actually, re-examining: the provider IS required by the pipeline signature. If no provider exists, the generate button already shows a lock icon and is effectively hidden. So no change needed here -- scripted mode still goes through the pipeline which needs a provider object even if enrichment fails.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Check that the file input accepts `.pdf,.docx,.txt`. Verify the banner JSX is placed between Mode Indicator and Verbosity Selection.
  </verify>
  <done>
- Lesson plan upload accepts PDF, DOCX, and TXT files (MODE-02)
- Scripted markers auto-detected after upload with banner showing toggle switch (MODE-01)
- Toggle allows override back to AI generation mode
- Verbosity selector hidden in scripted mode
- Generate button shows "Import Scripted Lesson" in scripted mode
- Scripted mode override resets on new file upload
- handleGenerate passes `mode: 'scripted'` and `selectedDays` to pipeline
  </done>
</task>

<task type="auto">
  <name>Task 2: Day picker grid + select all + cross-day warning + import stats</name>
  <files>App.tsx</files>
  <action>
This task adds the day picker card grid, select all/deselect all control, cross-day reference warning, and compact import stats line. All within the App.tsx landing page.

**1. Add day picker UI (DAY-01, DAY-02, DAY-03, DAY-04, DAY-05):**

Place this section AFTER the scripted mode banner (from Task 1) and BEFORE the "Or paste text below" divider (which is around line 2378). This positions the day picker inline on the landing page below the upload area, per CONTEXT.md decision.

```tsx
{/* Day Picker (Phase 72 - DAY-01 through DAY-05) */}
{parseResult && parseResult.totalDays >= 2 && isScriptedMode && (
  <div className="mb-6">
    {/* Select All / Deselect All (DAY-04) */}
    <div className="flex items-center justify-between mb-3">
      <p className="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
        Select Days to Import
      </p>
      <button
        onClick={() => {
          if (selectedDays.size === parseResult.totalDays) {
            setSelectedDays(new Set());
          } else {
            setSelectedDays(new Set(parseResult.days.map(d => d.dayNumber)));
          }
        }}
        className="text-xs font-medium text-indigo-600 dark:text-indigo-400 hover:underline"
      >
        {selectedDays.size === parseResult.totalDays ? 'Deselect All' : 'Select All'}
      </button>
    </div>

    {/* Day Cards Grid (DAY-01, DAY-02, DAY-03) */}
    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
      {parseResult.days.map(day => {
        const isSelected = selectedDays.has(day.dayNumber);
        const sectionCount = day.blocks.filter(b => b.type === 'section-heading').length;
        const blockCount = day.blocks.filter(b => b.type !== 'section-heading').length;
        return (
          <button
            key={day.dayNumber}
            onClick={() => toggleDaySelection(day.dayNumber)}
            className={`p-4 rounded-xl border-2 text-left transition-all ${
              isSelected
                ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 dark:border-indigo-400'
                : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 opacity-60'
            }`}
          >
            <p className="font-bold text-sm text-slate-800 dark:text-white">
              Day {day.dayNumber}
            </p>
            {day.title && (
              <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5 truncate">
                {day.title}
              </p>
            )}
            <div className="flex gap-2 mt-2">
              <span className="text-[10px] px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 rounded font-medium">
                {sectionCount} {sectionCount === 1 ? 'section' : 'sections'}
              </span>
              <span className="text-[10px] px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 rounded font-medium">
                {blockCount} {blockCount === 1 ? 'block' : 'blocks'}
              </span>
            </div>
          </button>
        );
      })}
    </div>

    {/* Cross-day reference warning (DAY-05) */}
    {selectedDays.size < parseResult.totalDays && selectedDays.size > 0 && (
      <div className="mt-3 p-3 rounded-xl bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 text-xs text-amber-700 dark:text-amber-300">
        Some days may reference content from unselected days
      </div>
    )}
  </div>
)}
```

**2. Add import stats line (MODE-03):**

Place this JUST ABOVE the generate button container (before the `<div className="flex justify-center gap-4">` around line 2467):

```tsx
{/* Import Stats (Phase 72 - MODE-03) */}
{isScriptedMode && importStats && (
  <p className="text-center text-sm text-slate-500 dark:text-slate-400 mb-4 font-medium">
    {importStats.days} {importStats.days === 1 ? 'day' : 'days'} &middot;{' '}
    {importStats.sections} {importStats.sections === 1 ? 'section' : 'sections'} &middot;{' '}
    {importStats.blocks} script {importStats.blocks === 1 ? 'block' : 'blocks'}
  </p>
)}
```

**3. Disable generate button when no days selected in scripted mode:**

Update the generate button `disabled` condition (around line 2481) from:
```tsx
disabled={uploadMode === 'none' || isGenerating}
```
To:
```tsx
disabled={uploadMode === 'none' || isGenerating || (isScriptedMode && selectedDays.size === 0)}
```
This prevents generating with zero days selected (the stats would show "0 days" which is meaningless).

**Summary of insertion points (in order within the landing page card):**
1. Upload zones (existing)
2. Mode Indicator (existing)
3. Scripted Mode Banner (Task 1)
4. Day Picker Grid + Warning (this task) -- between banner and verbosity
5. Verbosity Selection (existing, hidden in scripted mode per Task 1)
6. "Or paste text below" divider (existing)
7. Textarea (existing)
8. Supplementary Resources (existing)
9. Auto-generate AI Visuals toggle (existing)
10. Error display (existing)
11. Import Stats line (this task)
12. Load + Generate buttons (existing, with label override from Task 1)
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Visually verify in the browser:
1. Upload a multi-day scripted lesson plan (with Say:/Ask: markers and ## Day 1/## Day 2 headers)
2. Confirm banner appears with toggle
3. Confirm day cards appear in grid with correct counts
4. Confirm select all/deselect all works
5. Confirm stats line updates when toggling days
6. Confirm amber warning appears when not all days selected
7. Confirm generate button says "Import Scripted Lesson"
  </verify>
  <done>
- Day picker card grid appears for multi-day lesson plans with 2+ days (DAY-01)
- Each card shows day number, title, section count, and block count (DAY-02)
- Cards are clickable to toggle selection (DAY-03)
- Select All / Deselect All control above grid (DAY-04)
- Amber cross-day warning appears when subset of days selected, hidden when all selected (DAY-05)
- Compact stats line shows reactive day/section/block counts above generate button (MODE-03)
- Generate button disabled when zero days selected in scripted mode
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify scripted import flow end-to-end</name>
  <files>App.tsx</files>
  <action>
Human verification of complete scripted import UI: auto-detection banner with toggle, day picker with selection, reactive stats, multi-format upload (PDF/DOCX/TXT), cross-day warning, and scripted generate button label.

**Test 1: Multi-format upload (MODE-02)**
1. Upload a `.txt` file containing scripted markers (Say:, Ask:, etc.) -- confirm it loads successfully
2. Upload a `.docx` file with lesson content -- confirm text is extracted
3. Upload a `.pdf` file -- confirm existing behavior still works

**Test 2: Auto-detection + banner (MODE-01)**
1. Upload or paste a lesson plan containing `Say:` and `Ask:` markers
2. Confirm an amber "Scripted markers detected" banner appears below the Mode Indicator
3. Confirm the toggle switch is ON by default
4. Toggle OFF -- confirm the banner stays but verbosity selector reappears and button text changes back to "Generate Slideshow"
5. Toggle back ON -- confirm scripted mode re-engages

**Test 3: Day picker (DAY-01 through DAY-05)**
1. Paste or upload a multi-day lesson plan (e.g., with Day 1 and Day 2 headers plus Say:/Ask: markers)
2. Confirm day cards appear in a grid with correct day numbers and block counts
3. Click a day card to deselect it -- confirm amber warning appears: "Some days may reference content from unselected days"
4. Click "Select All" -- confirm warning disappears and all cards re-selected
5. Click "Deselect All" -- confirm all cards deselected and generate button is disabled

**Test 4: Import stats (MODE-03)**
1. With scripted mode active and days selected, confirm stats line shows above the generate button
2. Toggle days on/off -- confirm stats update reactively

**Test 5: Generate (end-to-end)**
1. Select at least one day and click "Import Scripted Lesson"
2. Confirm slides are generated from the scripted content
3. Verify the correct days were imported (not filtered-out days)
  </action>
  <verify>All 5 test scenarios pass visual and functional verification in the browser.</verify>
  <done>Teacher-facing scripted import flow verified end-to-end: upload, detection, day picking, stats, and generation all work correctly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Scripted mode banner appears only when markers are detected AND uploadMode is 'fresh'
3. Day picker appears only when 2+ days detected AND scripted mode is active
4. All days pre-selected by default; select all/deselect all works
5. Cross-day warning appears only when subset of days selected (not when all selected or only 1 day)
6. Stats line updates reactively as days are toggled
7. Generate button shows "Import Scripted Lesson" in scripted mode
8. Verbosity selector hidden in scripted mode
9. DOCX and TXT files upload successfully alongside PDF
10. Override resets when new file uploaded
</verification>

<success_criteria>
- Teacher can upload a multi-day scripted lesson plan in any supported format
- Scripted mode is auto-suggested when markers detected
- Day picker shows accurate day/section/block previews
- Selected days flow through to the pipeline and only those days produce slides
- All 8 requirements (DAY-01 through DAY-05, MODE-01 through MODE-03) are implemented
</success_criteria>

<output>
After completion, create `.planning/phases/72-day-picker-ui-mode-selector/72-02-SUMMARY.md`
</output>
