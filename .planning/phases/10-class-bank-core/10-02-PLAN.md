---
phase: 10-class-bank-core
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - components/ClassBankDropdown.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can load a saved class to instantly populate the student list"
    - "Classes are available in any presentation on the same device"
    - "Active class indicator shows after loading a class"
    - "Load button disabled when no saved classes exist"
  artifacts:
    - path: "components/ClassBankDropdown.tsx"
      provides: "Dropdown menu for loading saved classes"
      exports: ["ClassBankDropdown"]
    - path: "App.tsx"
      provides: "Save/Load buttons in student management bar"
      contains: "useClassBank"
  key_links:
    - from: "App.tsx"
      to: "hooks/useClassBank.ts"
      via: "useClassBank hook import"
      pattern: "useClassBank\\(\\)"
    - from: "App.tsx"
      to: "components/ClassBankSaveModal.tsx"
      via: "modal rendering"
      pattern: "ClassBankSaveModal"
    - from: "App.tsx"
      to: "components/ClassBankDropdown.tsx"
      via: "dropdown rendering"
      pattern: "ClassBankDropdown"
    - from: "components/ClassBankDropdown.tsx"
      to: "types.ts"
      via: "SavedClass import"
      pattern: "import.*SavedClass.*from"
---

<objective>
Add load functionality and integrate class bank UI into App.tsx.

Purpose: Complete the class bank feature by enabling teachers to load saved classes and see their active class. This makes the save/load workflow accessible from the editor view.

Output: ClassBankDropdown component for loading, Save/Load buttons in student management bar, active class indicator, and full integration with existing toast notifications.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-class-bank-core/10-CONTEXT.md
@.planning/phases/10-class-bank-core/10-01-PLAN.md (for hook/modal created in Plan 01)

Key file locations:
- TOP CLASS MANAGEMENT BAR: App.tsx around line 927
- Toast usage: useToast hook with addToast(message, duration, variant)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClassBankDropdown component</name>
  <files>components/ClassBankDropdown.tsx</files>
  <action>
Create components/ClassBankDropdown.tsx with props:
```typescript
interface ClassBankDropdownProps {
  classes: SavedClass[];
  onLoad: (classData: SavedClass) => void;
  onClose: () => void;
}
```

Structure:
1. Position: absolute dropdown below trigger (will be positioned by parent)
2. Container: `absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden z-50`
3. Header: "Load Class" title (small, muted)
4. List of classes with:
   - Class name (bold)
   - Student count: "(24 students)" in muted text
   - Hover state with bg change
   - Click calls onLoad with the class data
5. Empty state: "No saved classes" if classes.length === 0 (shouldn't happen since button is disabled, but defensive)

Click-outside handling:
- Use useRef for container
- useEffect to add mousedown listener when mounted
- Check if click target is outside ref, call onClose
- Clean up listener on unmount

Keyboard:
- Escape key closes dropdown (onClose)
  </action>
  <verify>
- File exists: `ls components/ClassBankDropdown.tsx`
- Has SavedClass import: `grep -n "SavedClass" components/ClassBankDropdown.tsx`
- Has click-outside logic: `grep -n "mousedown" components/ClassBankDropdown.tsx`
  </verify>
  <done>ClassBankDropdown renders list of classes with name and student count, closes on click-outside or Escape, calls onLoad with selected class.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Save/Load UI into App.tsx</name>
  <files>App.tsx</files>
  <action>
1. Add imports at top:
```typescript
import { useClassBank } from './hooks/useClassBank';
import ClassBankSaveModal from './components/ClassBankSaveModal';
import ClassBankDropdown from './components/ClassBankDropdown';
```

2. Add state near other state declarations:
```typescript
const [classes, saveClass, deleteClass, getClassByName] = useClassBank();
const [showSaveClassModal, setShowSaveClassModal] = useState(false);
const [showLoadDropdown, setShowLoadDropdown] = useState(false);
const [activeClassName, setActiveClassName] = useState<string | null>(null);
```

3. Add handlers:
```typescript
const handleSaveClass = (name: string) => {
  saveClass(name, studentNames);
  setShowSaveClassModal(false);
  addToast('Class saved!', 3000, 'success');
};

const handleLoadClass = (classData: SavedClass) => {
  // Check if current students are "dirty" (not from a loaded class)
  const hasUnsavedStudents = studentNames.length > 0 && activeClassName === null;
  if (hasUnsavedStudents) {
    if (!window.confirm('You have students not saved. Load anyway?')) {
      return;
    }
  }
  setStudentNames(classData.students);
  setActiveClassName(classData.name);
  setShowLoadDropdown(false);
  addToast(`Loaded ${classData.name}`, 3000, 'success');
};
```

4. In TOP CLASS MANAGEMENT BAR (after the divider, before student chips), add Save/Load buttons:
```tsx
{/* Class Bank Controls */}
<div className="flex items-center gap-1 shrink-0 relative">
  {/* Save Button */}
  <button
    onClick={() => setShowSaveClassModal(true)}
    disabled={studentNames.length === 0}
    title={studentNames.length === 0 ? 'Add students first' : 'Save class'}
    className="p-1.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg transition-colors text-slate-600 dark:text-slate-400"
  >
    {/* Save/folder icon */}
  </button>

  {/* Load Button */}
  <button
    onClick={() => setShowLoadDropdown(!showLoadDropdown)}
    disabled={classes.length === 0}
    title={classes.length === 0 ? 'No saved classes' : 'Load class'}
    className="p-1.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg transition-colors text-slate-600 dark:text-slate-400"
  >
    {/* Folder-open/download icon */}
  </button>

  {/* Load Dropdown */}
  {showLoadDropdown && (
    <ClassBankDropdown
      classes={classes}
      onLoad={handleLoadClass}
      onClose={() => setShowLoadDropdown(false)}
    />
  )}
</div>

<div className="h-8 w-px bg-slate-100 dark:bg-slate-800 shrink-0"></div>

{/* Active Class Indicator (before student chips) */}
{activeClassName && (
  <div className="flex items-center gap-1 shrink-0">
    <span className="text-[10px] bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-2 py-0.5 rounded-full font-medium">
      {activeClassName}
    </span>
    <button
      onClick={() => setActiveClassName(null)}
      className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
      title="Clear active class"
    >
      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
)}
```

5. Render SaveModal at end of component (before ToastContainer):
```tsx
{showSaveClassModal && (
  <ClassBankSaveModal
    onSave={handleSaveClass}
    onClose={() => setShowSaveClassModal(false)}
    existingNames={classes.map(c => c.name)}
  />
)}
```

6. Clear activeClassName when students are manually modified:
- In the student chip remove handler, add: `setActiveClassName(null)`
- In handleAddNames (after adding students), add: `setActiveClassName(null)`

Icons to use (similar style to existing app icons):
- Save: folder with plus or download arrow
- Load: folder-open or upload arrow
  </action>
  <verify>
- useClassBank imported: `grep -n "useClassBank" App.tsx`
- Save button exists: `grep -n "Save class" App.tsx`
- Load button exists: `grep -n "Load class" App.tsx`
- Active class indicator: `grep -n "activeClassName" App.tsx`
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Save/Load buttons visible in student management bar. Save opens modal. Load opens dropdown. Active class indicator shows after loading. Buttons properly disabled when appropriate.</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification</name>
  <files>none (verification only)</files>
  <action>
Run the app and verify the complete flow:

1. Start dev server: `npm run dev`

2. Navigate to editor (create or generate a presentation)

3. Test Save flow:
   - Add 3 students manually
   - Click Save button (should be enabled)
   - Enter class name "Test Class"
   - Click Save
   - Verify toast "Class saved!" appears
   - Open browser DevTools > Application > Local Storage
   - Verify `pipi-class-bank` key exists with the saved class

4. Test Load flow:
   - Remove all students (clear the list)
   - Click Load button
   - Verify dropdown shows "Test Class (3 students)"
   - Click to load
   - Verify students are restored
   - Verify "Test Class" indicator shows
   - Verify toast "Loaded Test Class" appears

5. Test duplicate name:
   - Modify student list (add/remove one)
   - Click Save, enter "Test Class" again
   - Verify confirmation dialog appears
   - Confirm replacement
   - Reload page, load class, verify updated students

6. Test disabled states:
   - With no students, Save button should be disabled
   - Clear localStorage (remove pipi-class-bank), Load button should be disabled

7. Test unsaved warning:
   - Add students without saving
   - Click Load
   - Verify "You have students not saved. Load anyway?" prompt
  </action>
  <verify>
- Dev server starts without errors
- Save flow completes with toast
- Load flow completes with toast
- localStorage contains saved class
- Active class indicator displays correctly
- Disabled states work properly
  </verify>
  <done>Complete save/load flow works. Classes persist across page reload. Confirmation dialogs appear appropriately. Toast notifications confirm actions.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. App builds: `npm run build`
3. Manual test: Save class, reload page, load class - students persist
4. Requirements check:
   - CLASS-01: Save with custom name (Save modal)
   - CLASS-02: Load to populate (Load dropdown)
   - CLASS-03: Available across presentations (localStorage)
   - CLASS-04: localStorage storage (pipi-class-bank key)
</verification>

<success_criteria>
- Save button in student bar, disabled when no students
- Load button in student bar, disabled when no saved classes
- Save modal accepts class name, validates, handles duplicates
- Load dropdown shows all classes with student counts
- Loading replaces student list and shows active class indicator
- Toast notifications on save and load
- Unsaved students warning when loading
- All four CLASS requirements (01-04) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/10-class-bank-core/10-02-SUMMARY.md`
</output>
