---
phase: 39-export-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - components/ExportModal.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Export button appears in toolbar when 1+ slides selected"
    - "Export button opens modal with Quick Export and AI Poster mode options"
    - "Modal shows preview grid of selected slides with removal capability"
    - "Removing slides in modal updates main selection state"
    - "Quick Export generates A4 PDF with exact slide content"
    - "PDF downloads automatically after generation"
  artifacts:
    - path: "components/ExportModal.tsx"
      provides: "Export modal with mode selection and slide preview"
      min_lines: 150
    - path: "App.tsx"
      provides: "Export button in toolbar, modal state, ExportModal integration"
      contains: "ExportModal"
  key_links:
    - from: "App.tsx"
      to: "components/ExportModal.tsx"
      via: "showExportModal state and onClose/onUpdateSelection callbacks"
      pattern: "showExportModal"
    - from: "components/ExportModal.tsx"
      to: "jsPDF + html2canvas"
      via: "generatePDF function"
      pattern: "new jsPDF|html2canvas"
    - from: "components/ExportModal.tsx"
      to: "SlideContentRenderer"
      via: "preview and PDF capture rendering"
      pattern: "SlideContentRenderer"
---

<objective>
Enable teachers to export selected slides as A4 PDFs for Working Wall display.

Purpose: Teachers need printable versions of their slides to display on classroom walls as reference material for students. This phase provides the export UI and Quick Export functionality that preserves exact slide content.

Output: ExportModal component with mode selection (Quick Export vs AI Poster), slide preview with removal, and PDF generation that auto-downloads.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-slide-selection-ui/38-01-SUMMARY.md
@.planning/phases/39-export-infrastructure/39-CONTEXT.md
@.planning/phases/39-export-infrastructure/39-RESEARCH.md
@components/ClassBankSaveModal.tsx
@components/SlideRenderers.tsx
@App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create ExportModal component</name>
  <files>
    - package.json
    - components/ExportModal.tsx
    - App.tsx
  </files>
  <action>
1. Install jsPDF and html2canvas:
   ```bash
   npm install jspdf html2canvas
   ```
   Both include TypeScript types - no @types packages needed.

2. Create `components/ExportModal.tsx` following ClassBankSaveModal patterns:
   - Props: `slides: Slide[]`, `selectedSlideIds: Set<string>`, `onUpdateSelection: (ids: Set<string>) => void`, `onClose: () => void`, `onExport: (mode: 'quick' | 'ai-poster', slideIds: string[]) => void`
   - State: `exportMode: 'quick' | 'ai-poster'` (default 'quick')
   - Fixed overlay with dark backdrop (same as ClassBankSaveModal)
   - Escape key closes modal
   - Modal size: `max-w-4xl` to accommodate preview grid
   - Dark mode support throughout

   Modal structure:
   - Header: Icon, "Export for Working Wall" title, close X button
   - Mode selection: Two card-style buttons (Quick Export / AI Poster)
     - Quick Export: "Export slides exactly as they appear"
     - AI Poster: "Transform into educational posters" (disabled with "Coming Soon" badge)
   - Preview section: Grid of selected slides (3 columns on desktop)
     - Each preview shows slide content via SlideContentRenderer (scaled down)
     - Slide number badge (bottom-left)
     - Remove X button (top-right, visible on hover)
     - Clicking X removes slide from selection (call onUpdateSelection with new Set minus that ID)
   - Empty state: If all slides removed, show message "No slides selected"
   - Footer: Cancel button, Export button (disabled when no slides selected)
     - Export button text: "Export {N} Slides" or "Export 1 Slide"

3. Update `App.tsx`:
   - Add state: `const [showExportModal, setShowExportModal] = useState(false)`
   - Add import for ExportModal
   - Add Export button in toolbar after Deselect All button:
     - Label: "Export for Working Wall"
     - Style: Primary button style (indigo-600/amber-500 background)
     - Disabled when selectedSlideIds.size === 0
     - onClick: `setShowExportModal(true)`
   - Render ExportModal at bottom of component (near other modals) when showExportModal is true
   - Pass: slides, selectedSlideIds, setSelectedSlideIds (for onUpdateSelection), onClose handler
   - Create placeholder handleExport function that just closes modal (PDF generation in Task 2)
  </action>
  <verify>
    - `npm run build` succeeds
    - Export button appears in toolbar when slides are selected
    - Clicking Export button opens modal
    - Modal shows mode selection cards and preview grid
    - Clicking X on a preview removes it (count updates)
    - Escape key closes modal
    - Cancel button closes modal
  </verify>
  <done>
    - Export button visible and functional in toolbar
    - ExportModal opens with mode selection and slide previews
    - Selection sync works (removing in modal updates main state)
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Quick Export PDF generation</name>
  <files>
    - components/ExportModal.tsx
  </files>
  <action>
Update `components/ExportModal.tsx` to add PDF generation:

1. Add imports at top:
   ```typescript
   import { jsPDF } from 'jspdf';
   import html2canvas from 'html2canvas';
   ```

2. Add state for generation:
   - `isGenerating: boolean` (default false)
   - `generationProgress: { current: number; total: number } | null`

3. Add ref for hidden render container:
   - `renderContainerRef = useRef<HTMLDivElement>(null)`

4. Add hidden render container in component JSX (after modal, position off-screen):
   ```tsx
   <div
     ref={renderContainerRef}
     className="fixed -left-[9999px] top-0 pointer-events-none"
     style={{ width: '1190px', height: '842px' }}
   >
     {/* Slides rendered here during PDF generation */}
   </div>
   ```
   Dimensions: 1190x842px = A4 landscape at 2x scale for print quality

5. Add generatePDF function:
   ```typescript
   const generatePDF = async () => {
     const selectedSlides = slides.filter(s => selectedSlideIds.has(s.id));
     if (selectedSlides.length === 0) return;

     setIsGenerating(true);
     setGenerationProgress({ current: 0, total: selectedSlides.length });

     try {
       const pdf = new jsPDF({
         orientation: 'landscape',
         unit: 'pt',
         format: 'a4'
       });

       const pageWidth = pdf.internal.pageSize.getWidth();
       const pageHeight = pdf.internal.pageSize.getHeight();

       for (let i = 0; i < selectedSlides.length; i++) {
         if (i > 0) pdf.addPage();
         setGenerationProgress({ current: i + 1, total: selectedSlides.length });

         // Render slide to hidden container
         const slide = selectedSlides[i];
         const container = renderContainerRef.current;
         if (!container) continue;

         // Create temporary element for this slide
         const slideElement = document.createElement('div');
         slideElement.style.width = '1190px';
         slideElement.style.height = '842px';
         container.innerHTML = '';
         container.appendChild(slideElement);

         // Render SlideContentRenderer into element using ReactDOM
         const root = ReactDOM.createRoot(slideElement);
         root.render(
           <SlideContentRenderer
             slide={slide}
             visibleBullets={slide.content.length}
           />
         );

         // Wait for render
         await new Promise(resolve => setTimeout(resolve, 100));

         // Capture to canvas
         const canvas = await html2canvas(slideElement, {
           scale: 2,
           useCORS: true,
           allowTaint: false,
           backgroundColor: null,
           logging: false
         });

         // Add to PDF
         const imgData = canvas.toDataURL('image/jpeg', 0.95);
         pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);

         // Cleanup
         root.unmount();
       }

       // Generate filename: "Working Wall Export - {date}.pdf"
       const date = new Date().toISOString().split('T')[0];
       const filename = `Working Wall Export - ${date}.pdf`;

       // Trigger download
       pdf.save(filename);
       onClose();
     } catch (error) {
       console.error('PDF generation error:', error);
       // Could show toast here, but for now just log
     } finally {
       setIsGenerating(false);
       setGenerationProgress(null);
     }
   };
   ```

6. Add import for ReactDOM:
   ```typescript
   import ReactDOM from 'react-dom/client';
   ```

7. Update Export button:
   - When clicked and mode is 'quick', call generatePDF()
   - When isGenerating: show spinner and progress text "Generating... {current}/{total}"
   - Disable button during generation

8. Add loading overlay during generation:
   - Semi-transparent overlay over modal content
   - Centered spinner with progress text
   - Prevent closing modal during generation (disable X button, ignore Escape)
  </action>
  <verify>
    - Select 1-3 slides in the app
    - Click Export button, modal opens
    - Click Export in modal with Quick Export selected
    - Loading indicator shows with progress
    - PDF file downloads automatically
    - PDF contains selected slides (open PDF to verify)
    - Each slide on its own A4 landscape page
    - Content matches what's shown in the app
  </verify>
  <done>
    - Quick Export generates multi-page A4 PDF
    - PDF preserves exact slide content and styling
    - PDF downloads automatically with dated filename
    - Loading state shows during generation
    - Modal closes after successful export
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes with no TypeScript errors
2. Export workflow:
   - Select 2+ slides using checkboxes
   - "Export for Working Wall" button appears/enables
   - Click button -> modal opens
   - Preview shows selected slides
   - Remove a slide from preview -> count updates, main selection syncs
   - Click Export -> loading shows -> PDF downloads
   - Open PDF -> slides match app content
3. Edge cases:
   - Deselect all in preview -> Export button disables
   - Single slide export works
   - Cancel closes modal without export
   - Escape closes modal (when not generating)
</verification>

<success_criteria>
- EXP-01: Export button appears when 1+ slides selected
- EXP-02: Modal opens with Quick Export and AI Poster (disabled) options
- EXP-03: Modal shows preview grid with removal capability
- QEX-01: Quick Export produces A4 landscape PDF
- QEX-02: PDF content matches exact slide appearance
- QEX-03: PDF downloads automatically after generation
</success_criteria>

<output>
After completion, create `.planning/phases/39-export-infrastructure/39-01-SUMMARY.md`
</output>
