---
phase: 31-work-together-slide-insertion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - services/aiProvider.ts
  - services/geminiService.ts
  - services/providers/geminiProvider.ts
  - services/providers/claudeProvider.ts
  - components/SlideRenderers.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher clicks 'Work Together' in + menu to insert slide"
    - "AI generates collaborative activity instructions for pairs"
    - "Activity includes group-of-3 variant for odd class sizes"
    - "Activity uses only basic classroom resources (pen, paper, whiteboard)"
    - "Teleprompter shows full delivery script for facilitating the activity"
    - "Student pairs are displayed if roster is loaded"
    - "Shuffle button re-randomizes pairs without regenerating AI content"
  artifacts:
    - path: "types.ts"
      provides: "StudentPair interface and pairs field on Slide"
      contains: "StudentPair"
    - path: "services/aiProvider.ts"
      provides: "generateWorkTogetherSlide method signature"
      contains: "generateWorkTogetherSlide"
    - path: "services/geminiService.ts"
      provides: "Gemini implementation with activity constraints"
      contains: "generateWorkTogetherSlide"
    - path: "services/providers/geminiProvider.ts"
      provides: "Gemini provider passthrough"
      contains: "generateWorkTogetherSlide"
    - path: "services/providers/claudeProvider.ts"
      provides: "Claude implementation with activity constraints"
      contains: "generateWorkTogetherSlide"
    - path: "components/SlideRenderers.tsx"
      provides: "WorkTogetherLayout component"
      contains: "WorkTogetherLayout"
    - path: "App.tsx"
      provides: "Work Together button in InsertPoint + handler"
      contains: "handleInsertWorkTogetherSlide"
  key_links:
    - from: "App.tsx handleInsertWorkTogetherSlide"
      to: "provider.generateWorkTogetherSlide"
      via: "AIProviderInterface call"
      pattern: "provider\\.generateWorkTogetherSlide"
    - from: "App.tsx handleInsertWorkTogetherSlide"
      to: "generatePairs"
      via: "function call after AI generation"
      pattern: "generatePairs\\(studentNames\\)"
    - from: "components/SlideRenderers.tsx SlideContentRenderer"
      to: "WorkTogetherLayout"
      via: "layout switch case"
      pattern: "case 'work-together'"
---

<objective>
Add Work Together slide insertion to the + menu, enabling teachers to generate AI-powered collaborative pair activities with randomized student pairings from the class roster.

Purpose: Gives teachers one-click access to 2-3 minute collaborative activities that reinforce lesson content through peer interaction, with automatic pair generation and shuffle capability.

Output: Working "Work Together" button in + menu, AI generation with activity constraints (basic resources only, group-of-3 variant), dedicated layout renderer with pair display and shuffle button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-work-together-slide-insertion/31-CONTEXT.md
@.planning/phases/31-work-together-slide-insertion/31-RESEARCH.md

# Prior pattern (Phase 30 established elaborate slide insertion)
@.planning/phases/30-elaborate-slide-insertion/30-01-SUMMARY.md

# Source files
@App.tsx (lines 29-79 for InsertPoint, lines 469-515 for handleInsertElaborateSlide)
@services/aiProvider.ts (lines 169-218 for AIProviderInterface)
@services/geminiService.ts (lines 497-557 for generateElaborateSlide)
@services/providers/claudeProvider.ts (lines 515-570 for generateElaborateSlide)
@components/SlideRenderers.tsx (lines 335-348 for SlideContentRenderer switch)
@types.ts (lines 1-23 for Slide interface)
@components/PresentationView.tsx (lines 24-31 for Fisher-Yates shuffleArray)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Types and AI Provider Interface</name>
  <files>
    types.ts
    services/aiProvider.ts
  </files>
  <action>
**1. Add StudentPair interface and extend Slide (types.ts):**

Add after the Slide interface (around line 23):
```typescript
// Student pairs for Work Together slides
// Stored separately from content so shuffle doesn't require AI regeneration
export interface StudentPair {
  students: string[];      // 2 or 3 student names
  isGroupOfThree?: boolean;
}
```

Add to Slide interface (after `slideType` field):
```typescript
// For Work Together slides: randomized student pairs
pairs?: StudentPair[];
```

Also add 'work-together' to the layout union type (around line 11):
```typescript
layout?: 'split' | 'full-image' | 'center-text' | 'flowchart' | 'grid' | 'tile-overlap' | 'work-together';
```

**2. Add method to AIProviderInterface (services/aiProvider.ts):**

Add after `generateElaborateSlide` (around line 196):
```typescript
generateWorkTogetherSlide(
  lessonTopic: string,
  sourceSlide: Slide,
  allSlides: Slide[]
): Promise<Slide>;
```
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`
Verify no type errors for:
- StudentPair interface exists
- Slide interface has pairs field
- AIProviderInterface has generateWorkTogetherSlide method
  </verify>
  <done>
Types extended with StudentPair interface, Slide.pairs field, 'work-together' layout type, and AIProviderInterface has generateWorkTogetherSlide signature.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement AI Generation in Both Providers</name>
  <files>
    services/geminiService.ts
    services/providers/geminiProvider.ts
    services/providers/claudeProvider.ts
  </files>
  <action>
**1. Implement in geminiService.ts:**

Add after `generateElaborateSlide` function (around line 557):

```typescript
export const generateWorkTogetherSlide = async (
  apiKey: string,
  lessonTopic: string,
  sourceSlide: Slide,
  allSlides: Slide[]
): Promise<Slide> => {
  const ai = new GoogleGenAI({ apiKey });
  const model = "gemini-3-flash-preview";

  // Build full presentation context for coherence
  const presentationContext = allSlides
    .map((s, i) => `Slide ${i + 1}: "${s.title}" - ${s.content.slice(0, 2).join('; ')}`)
    .join('\n');

  const systemInstruction = `
You are an educational designer creating "Work Together" collaborative activities for Year 6 (10-11 year olds).
Topic: ${lessonTopic}
Creating activity based on: "${sourceSlide.title}"
Source content: ${sourceSlide.content.join('; ')}

PRESENTATION CONTEXT (maintain coherence):
${presentationContext}

TASK: Create a quick, engaging collaborative activity (2-3 minutes) for student pairs.

ACTIVITY REQUIREMENTS:
1. Design for PAIRS (2 students) as the primary grouping
2. ALWAYS include a group-of-3 variant (e.g., "If you're in a group of 3, one person can be the recorder" or "take turns")
3. Use ONLY basic classroom resources: pen, paper, whiteboard, mini-whiteboard
4. Do NOT require: tablets, computers, scissors, glue, colored materials, internet
5. Activity should reinforce the source slide content
6. Keep instructions clear and actionable for 10-11 year olds
7. Include a clear outcome (e.g., "Be ready to share one thing you discovered")

CONTENT FORMAT:
- Provide 3-5 content points as numbered instructions or prose
- Include the group-of-3 variant inline with the instructions (not as a separate point)
- Title should indicate collaboration (e.g., "Partner Challenge: [Topic]" or "Work Together: [Topic]")

${TELEPROMPTER_RULES}

STRICT: You MUST provide exactly (Number of content points + 1) speaker note segments separated by "ðŸ‘‰".
The teleprompter script should include:
- Segment 0: INTRO - how to launch the activity and get pairs started
- Segments 1-N: What to say/observe during each phase of the activity
- Final segment: How to wrap up and transition (share-out if applicable)
`;

  const response = await ai.models.generateContent({
    model,
    contents: `Generate a Work Together collaborative activity slide for: "${sourceSlide.title}". Use 'work-together' layout.`,
    config: {
      systemInstruction,
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          title: { type: Type.STRING, description: "Should indicate collaboration" },
          content: { type: Type.ARRAY, items: { type: Type.STRING } },
          speakerNotes: { type: Type.STRING, description: "Must follow ðŸ‘‰ format" },
          imagePrompt: { type: Type.STRING },
          layout: { type: Type.STRING, enum: ['work-together'] }
        },
        required: ['title', 'content', 'speakerNotes', 'imagePrompt', 'layout']
      }
    }
  });

  const data = JSON.parse(response.text || "{}");
  return {
    ...data,
    id: `work-together-${Date.now()}`,
    isGeneratingImage: false,
    slideType: 'work-together',
    layout: 'work-together'  // Ensure layout is set
  };
};
```

**2. Add passthrough in geminiProvider.ts:**

Add import at top with other geminiService imports:
```typescript
generateWorkTogetherSlide as geminiGenerateWorkTogetherSlide,
```

Add method in GeminiProvider class (after generateElaborateSlide):
```typescript
async generateWorkTogetherSlide(lessonTopic: string, sourceSlide: Slide, allSlides: Slide[]): Promise<Slide> {
  try {
    return await geminiGenerateWorkTogetherSlide(this.apiKey, lessonTopic, sourceSlide, allSlides);
  } catch (error) {
    throw this.wrapError(error);
  }
}
```

**3. Implement in claudeProvider.ts:**

Add after `generateElaborateSlide` method (around line 570):

```typescript
async generateWorkTogetherSlide(lessonTopic: string, sourceSlide: Slide, allSlides: Slide[]): Promise<Slide> {
  // Build full presentation context for coherence
  const presentationContext = allSlides
    .map((s, i) => `Slide ${i + 1}: "${s.title}" - ${s.content.slice(0, 2).join('; ')}`)
    .join('\n');

  const systemPrompt = `
You are an educational designer creating "Work Together" collaborative activities for Year 6 (10-11 year olds).
Topic: ${lessonTopic}
Creating activity based on: "${sourceSlide.title}"
Source content: ${sourceSlide.content.join('; ')}

PRESENTATION CONTEXT (maintain coherence):
${presentationContext}

TASK: Create a quick, engaging collaborative activity (2-3 minutes) for student pairs.

ACTIVITY REQUIREMENTS:
1. Design for PAIRS (2 students) as the primary grouping
2. ALWAYS include a group-of-3 variant (e.g., "If you're in a group of 3, one person can be the recorder" or "take turns")
3. Use ONLY basic classroom resources: pen, paper, whiteboard, mini-whiteboard
4. Do NOT require: tablets, computers, scissors, glue, colored materials, internet
5. Activity should reinforce the source slide content
6. Keep instructions clear and actionable for 10-11 year olds
7. Include a clear outcome (e.g., "Be ready to share one thing you discovered")

CONTENT FORMAT:
- Provide 3-5 content points as numbered instructions or prose
- Include the group-of-3 variant inline with the instructions (not as a separate point)
- Title should indicate collaboration (e.g., "Partner Challenge: [Topic]" or "Work Together: [Topic]")

STRICT SPEAKER NOTES (TELEPROMPTER LOGIC):
- You MUST provide exactly (Number of content points + 1) segments separated by "ðŸ‘‰"
- Segment 0: INTRO - how to launch the activity and get pairs started
- Segments 1-N: What to say/observe during each phase of the activity
- Final segment: How to wrap up and transition (share-out if applicable)
- Include pacing cues: "[Give them 30 seconds]", "[Walk around and check progress]"

IMPORTANT: Return your response as valid JSON with these fields:
- title (string - should indicate collaboration)
- content (array of strings - activity instructions)
- speakerNotes (string - must follow the ðŸ‘‰ format)
- imagePrompt (string)
- layout (must be 'work-together')

Do not include any text before or after the JSON.
`;

  const messages: ClaudeMessage[] = [{
    role: 'user',
    content: `Generate a Work Together collaborative activity slide for: "${sourceSlide.title}". Use 'work-together' layout.`
  }];

  const response = await callClaude(this.apiKey, messages, systemPrompt, 2048);
  const data = extractJSON<any>(response);

  return {
    ...data,
    id: `work-together-${Date.now()}`,
    isGeneratingImage: false,
    slideType: 'work-together',
    layout: 'work-together'
  };
}
```
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`
Verify no type errors for:
- generateWorkTogetherSlide function in geminiService.ts
- GeminiProvider implements the method
- ClaudeProvider implements the method
  </verify>
  <done>
Both AI providers implement generateWorkTogetherSlide with activity constraints (basic resources only, group-of-3 variant required), proper teleprompter rules, and slideType: 'work-together' marker.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add WorkTogetherLayout and Wire InsertPoint</name>
  <files>
    components/SlideRenderers.tsx
    App.tsx
  </files>
  <action>
**1. Add WorkTogetherLayout component (components/SlideRenderers.tsx):**

Add before `SlideContentRenderer` (around line 334):

```typescript
// Work Together layout with activity instructions and optional pair display
export const WorkTogetherLayout: React.FC<{ slide: Slide, visibleBullets: number }> = ({ slide, visibleBullets }) => (
  <div
    className="w-full h-full flex flex-col overflow-hidden"
    style={{ backgroundColor: slide.backgroundColor || '#0d9488' }}  // Teal-600
  >
    {/* Header */}
    <div className="px-6 md:px-10 pt-6 md:pt-8">
      <h2 className="text-5xl md:text-7xl font-bold text-white text-center font-poppins">
        {slide.title}
      </h2>
    </div>

    {/* Main content area */}
    <div className="flex-1 flex flex-col md:flex-row gap-4 md:gap-6 p-4 md:p-6 overflow-hidden">
      {/* Left: Activity Instructions */}
      <div className="flex-1 bg-white/10 rounded-2xl p-4 md:p-6 backdrop-blur-sm overflow-auto">
        <h3 className="text-xl md:text-2xl font-bold text-white/80 mb-3 md:mb-4 uppercase tracking-wider">Instructions</h3>
        <div className="space-y-3 md:space-y-4">
          {slide.content.map((point, idx) => (
            <div
              key={idx}
              className={`flex gap-3 md:gap-4 items-start transition-all duration-500 ${
                idx < visibleBullets ? 'opacity-100 translate-x-0' : 'opacity-0 -translate-x-4'
              }`}
            >
              <div className="w-7 h-7 md:w-8 md:h-8 rounded-full bg-amber-400 text-teal-900 font-bold flex items-center justify-center shrink-0 text-sm md:text-base">
                {idx + 1}
              </div>
              <p className="text-xl md:text-2xl lg:text-3xl text-white font-medium leading-relaxed">
                <MarkdownText text={point} />
              </p>
            </div>
          ))}
        </div>
      </div>

      {/* Right: Student Pairs (if available) */}
      {slide.pairs && slide.pairs.length > 0 ? (
        <div className="w-full md:w-1/3 bg-white/10 rounded-2xl p-4 md:p-6 backdrop-blur-sm overflow-auto">
          <h3 className="text-xl md:text-2xl font-bold text-white/80 mb-3 md:mb-4 uppercase tracking-wider">Your Pairs</h3>
          <ul className="space-y-2 text-lg md:text-xl text-white">
            {slide.pairs.map((pair, idx) => (
              <li
                key={idx}
                className={`py-1.5 px-3 rounded-lg ${pair.isGroupOfThree ? 'bg-amber-500/20 text-amber-200' : 'bg-white/5'}`}
              >
                {pair.students.join(' & ')}
                {pair.isGroupOfThree && <span className="ml-2 text-amber-300 text-sm">(group of 3)</span>}
              </li>
            ))}
          </ul>
        </div>
      ) : (
        <div className="w-full md:w-1/3 bg-white/5 rounded-2xl p-4 md:p-6 border-2 border-dashed border-white/20 flex items-center justify-center">
          <p className="text-white/40 text-center text-lg">
            Load a class list to show pairs here
          </p>
        </div>
      )}
    </div>
  </div>
);
```

**2. Update SlideContentRenderer switch (components/SlideRenderers.tsx):**

Add case for 'work-together' layout:
```typescript
export const SlideContentRenderer: React.FC<{ slide: Slide, visibleBullets: number }> = ({ slide, visibleBullets }) => {
    switch (slide.layout) {
        case 'full-image':
            return <FullImageLayout slide={slide} visibleBullets={visibleBullets} />;
        case 'flowchart':
            return <FlowchartLayout slide={slide} visibleBullets={visibleBullets} />;
        case 'grid':
            return <GridLayout slide={slide} visibleBullets={visibleBullets} />;
        case 'tile-overlap':
            return <TileOverlapLayout slide={slide} visibleBullets={visibleBullets} />;
        case 'work-together':
            return <WorkTogetherLayout slide={slide} visibleBullets={visibleBullets} />;
        default:
            return <DefaultLayout slide={slide} visibleBullets={visibleBullets} />;
    }
};
```

**3. Add generatePairs helper function (App.tsx):**

Add near the top of the file, after imports (around line 27):

```typescript
import { StudentPair } from './types';

// Generate randomized student pairs with Fisher-Yates shuffle
// Handles odd numbers by creating one group of 3
function generatePairs(studentNames: string[]): StudentPair[] {
  if (studentNames.length < 2) {
    // Single student or empty: return as single group
    return studentNames.length === 1 ? [{ students: studentNames }] : [];
  }

  // Fisher-Yates shuffle
  const shuffled = [...studentNames];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }

  const pairs: StudentPair[] = [];
  const isOdd = shuffled.length % 2 !== 0;

  // Create pairs of 2
  const pairEndIndex = isOdd ? shuffled.length - 3 : shuffled.length;
  for (let i = 0; i < pairEndIndex; i += 2) {
    pairs.push({ students: [shuffled[i], shuffled[i + 1]] });
  }

  // Handle last 3 (odd) or last 2 (even)
  if (isOdd) {
    pairs.push({ students: shuffled.slice(-3), isGroupOfThree: true });
  }

  return pairs;
}
```

**4. Update InsertPoint component (App.tsx lines 29-79):**

Add `onClickWorkTogether` prop and teal "Work Together" button:

```typescript
const InsertPoint = ({
  onClickBlank,
  onClickExemplar,
  onClickElaborate,
  onClickWorkTogether
}: {
  onClickBlank: () => void,
  onClickExemplar: () => void,
  onClickElaborate: () => void,
  onClickWorkTogether: () => void
}) => {
    const [isOpen, setIsOpen] = useState(false);

    return (
        <div
            className="group/insert py-1 flex items-center justify-center relative -my-1 min-h-[1.5rem]"
            onMouseLeave={() => setIsOpen(false)}
        >
            <div className={`absolute left-4 right-4 h-px transition-colors z-0 ${isOpen ? 'bg-indigo-400 dark:bg-amber-500' : 'bg-transparent group-hover/insert:bg-indigo-300/50 dark:group-hover/insert:bg-amber-500/30'}`}></div>

            {!isOpen ? (
                <button
                    onClick={(e) => { e.stopPropagation(); setIsOpen(true); }}
                    className="z-10 w-6 h-6 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-slate-400 hover:text-indigo-600 dark:hover:text-amber-400 hover:border-indigo-400 dark:hover:border-amber-400 shadow-sm flex items-center justify-center transition-all opacity-0 group-hover/insert:opacity-100 scale-75 group-hover/insert:scale-100 hover:shadow-md"
                    title="Insert Slide"
                >
                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 4v16m8-8H4" /></svg>
                </button>
            ) : (
                <div className="z-20 flex flex-col gap-1 animate-fade-in bg-white dark:bg-slate-800 border border-indigo-100 dark:border-amber-500/30 rounded-xl p-1.5 shadow-xl ring-4 ring-indigo-50 dark:ring-amber-500/10">
                    <button
                        onClick={(e) => { e.stopPropagation(); onClickBlank(); setIsOpen(false); }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 rounded-lg transition-colors"
                    >
                        <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Blank</span>
                    </button>
                    <button
                        onClick={(e) => { e.stopPropagation(); onClickExemplar(); setIsOpen(false); }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 dark:bg-amber-500 hover:bg-indigo-700 dark:hover:bg-amber-400 text-white dark:text-slate-900 rounded-lg transition-colors shadow-sm"
                    >
                        <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Exemplar</span>
                    </button>
                    <button
                        onClick={(e) => { e.stopPropagation(); onClickElaborate(); setIsOpen(false); }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors shadow-sm"
                    >
                        <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Elaborate</span>
                    </button>
                    <button
                        onClick={(e) => { e.stopPropagation(); onClickWorkTogether(); setIsOpen(false); }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-teal-600 hover:bg-teal-700 text-white rounded-lg transition-colors shadow-sm"
                    >
                        <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Work Together</span>
                    </button>
                </div>
            )}
        </div>
    );
};
```

**5. Add handleInsertWorkTogetherSlide handler (App.tsx after handleInsertElaborateSlide ~line 515):**

```typescript
const handleInsertWorkTogetherSlide = async (index: number) => {
  if (!provider) {
    setErrorModal({ title: 'AI Not Configured', message: 'Please configure your AI provider in Settings.' });
    return;
  }

  // Source slide is the slide ABOVE the + button (what we're creating activity for)
  const source = index >= 0 ? slides[index] : undefined;
  if (!source) {
    setErrorModal({ title: 'Cannot Create Activity', message: 'Need a slide above to create an activity for.' });
    return;
  }

  const tempId = `temp-work-${Date.now()}`;
  const tempSlide: Slide = {
    id: tempId,
    title: "Creating Activity...",
    content: ["Generating collaborative activity...", "Designing pair instructions..."],
    speakerNotes: "",
    imagePrompt: "",
    isGeneratingImage: true,
    layout: 'work-together'
  };

  // Insert temp slide after source
  const newSlides = [...slides];
  newSlides.splice(index + 1, 0, tempSlide);
  setSlides(newSlides);
  setActiveSlideIndex(index + 1);

  try {
    const workTogether = await provider.generateWorkTogetherSlide(lessonTitle, source, slides);

    // Generate pairs from roster if available
    const pairs = studentNames.length >= 2 ? generatePairs(studentNames) : undefined;

    setSlides(curr => curr.map(s => s.id === tempId
      ? { ...workTogether, id: tempId, pairs, isGeneratingImage: autoGenerateImages }
      : s
    ));

    if (autoGenerateImages) {
      const img = await provider.generateSlideImage(workTogether.imagePrompt, workTogether.layout);
      setSlides(curr => curr.map(s => s.id === tempId ? { ...s, imageUrl: img, isGeneratingImage: false } : s));
    }
  } catch (err) {
    console.error("Work Together error:", err);
    // Fallback to blank if generation fails
    setSlides(curr => curr.map(s => s.id === tempId ? { ...tempSlide, title: "New Slide", isGeneratingImage: false } : s));
    if (err instanceof AIProviderError) {
      setErrorModal({ title: 'Activity Generation Failed', message: err.userMessage });
    }
  }
};
```

**6. Wire InsertPoint usages (2 locations in App.tsx):**

Find both `<InsertPoint` usages and add the new prop:

Location 1 (~line 1213):
```tsx
<InsertPoint
    onClickBlank={() => handleInsertBlankSlide(-1)}
    onClickExemplar={() => handleInsertExemplarSlide(-1)}
    onClickElaborate={() => handleInsertElaborateSlide(-1)}
    onClickWorkTogether={() => handleInsertWorkTogetherSlide(-1)}
/>
```

Location 2 (~line 1247):
```tsx
<InsertPoint
  onClickBlank={() => handleInsertBlankSlide(idx)}
  onClickExemplar={() => handleInsertExemplarSlide(idx)}
  onClickElaborate={() => handleInsertElaborateSlide(idx)}
  onClickWorkTogether={() => handleInsertWorkTogetherSlide(idx)}
/>
```

Note: For the first location (index -1), handleInsertWorkTogetherSlide will show an error since there's no slide above. This is intentional - you can't create an activity based on nothing.

**7. Add shuffle handler for Work Together slides (App.tsx):**

Add a handler to reshuffle pairs without regenerating AI content. Add after handleInsertWorkTogetherSlide:

```typescript
const handleShufflePairs = (slideId: string) => {
  if (studentNames.length < 2) return;

  const newPairs = generatePairs(studentNames);
  setSlides(curr => curr.map(s =>
    s.id === slideId ? { ...s, pairs: newPairs } : s
  ));
};
```

Then in SlideCard (where Work Together slides are displayed in editor), you can add a shuffle button. However, for MVP, the shuffle button in PresentationView is more important. For the editor, just ensure pairs are displayed.
  </action>
  <verify>
1. Run TypeScript compilation: `npx tsc --noEmit`
2. Start dev server: `npm run dev`
3. Verify:
   - Click + between slides shows 4-option vertical dropdown (Blank, Exemplar, Elaborate, Work Together)
   - Click "Work Together" inserts "Creating Activity..." temp slide
   - AI generates activity with numbered instructions
   - Activity includes group-of-3 variant in instructions
   - Activity uses only basic resources (check output for no tech requirements)
   - Teleprompter script has correct segment count
   - If roster loaded: pairs display on right side
   - If no roster: placeholder shows "Load a class list to show pairs here"
   - If clicked at top (no slide above): shows error modal
  </verify>
  <done>
WorkTogetherLayout renders activity instructions with pair display, InsertPoint has 4 options including teal "Work Together" button, handleInsertWorkTogetherSlide generates pairs from roster, shuffle capability available for re-randomizing pairs.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript:** `npx tsc --noEmit` passes with no errors
2. **Functional test with roster:**
   - Load a class list with 5+ students
   - Create presentation with 2-3 slides
   - Click + between slides
   - Verify dropdown shows Blank, Exemplar, Elaborate, Work Together in vertical layout
   - Click "Work Together"
   - Verify "Creating Activity..." temp slide appears
   - Verify generated slide has:
     - Title indicating collaboration (e.g., "Partner Challenge: [Topic]")
     - 3-5 instruction points
     - Group-of-3 variant mentioned in instructions
     - No tech requirements (no tablets, computers mentioned)
     - Teleprompter script with correct segment count
     - Student pairs displayed on right
   - Verify slideType is 'work-together' (check via console or React DevTools)
3. **Functional test without roster:**
   - Clear student list
   - Insert Work Together slide
   - Verify activity generates but pairs section shows placeholder
4. **Edge cases:**
   - Test with 3 students: should show one group of 3
   - Test with 4 students: should show two pairs
   - Test with 5 students: should show one pair + one group of 3
5. **Error handling:** Click + at top (before first slide), click Work Together, verify error modal appears
</verification>

<success_criteria>
- WORK-01: User can insert Work Together slide via "+" menu option - DONE
- WORK-02: AI generates collaborative activity instructions for pairs (with group-of-3 alternative) - DONE
- WORK-03: Activity uses only basic classroom resources (pen, paper, whiteboard) - DONE
- WORK-04: Teleprompter shows facilitation notes for teacher - DONE

All 4 requirements satisfied with working Work Together slide insertion following established Elaborate pattern, plus student pair generation and dedicated layout renderer.
</success_criteria>

<output>
After completion, create `.planning/phases/31-work-together-slide-insertion/31-01-SUMMARY.md`
</output>
