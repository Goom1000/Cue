---
phase: 30-elaborate-slide-insertion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/aiProvider.ts
  - services/geminiService.ts
  - services/providers/geminiProvider.ts
  - services/providers/claudeProvider.ts
  - App.tsx
  - types.ts
autonomous: true

must_haves:
  truths:
    - "Teacher clicks 'Elaborate' in + menu to insert slide"
    - "AI generates 3-5 content points with examples and analogies"
    - "Generated content provides deeper understanding than source slide"
    - "Teleprompter script follows current verbosity level"
    - "Elaborate slide appears immediately after source slide"
  artifacts:
    - path: "services/aiProvider.ts"
      provides: "generateElaborateSlide method signature"
      contains: "generateElaborateSlide"
    - path: "services/geminiService.ts"
      provides: "Gemini implementation with full context"
      contains: "generateElaborateSlide"
    - path: "services/providers/geminiProvider.ts"
      provides: "Gemini provider passthrough"
      contains: "generateElaborateSlide"
    - path: "services/providers/claudeProvider.ts"
      provides: "Claude implementation with full context"
      contains: "generateElaborateSlide"
    - path: "App.tsx"
      provides: "InsertPoint with Elaborate button + handler"
      contains: "handleInsertElaborateSlide"
  key_links:
    - from: "App.tsx handleInsertElaborateSlide"
      to: "provider.generateElaborateSlide"
      via: "AIProviderInterface call"
      pattern: "provider\\.generateElaborateSlide"
    - from: "services/geminiService.ts generateElaborateSlide"
      to: "allSlides context"
      via: "presentation context in prompt"
      pattern: "allSlides\\.map"
---

<objective>
Add Elaborate slide insertion to the + menu, enabling teachers to generate AI-powered depth content that expands on the previous slide with examples, analogies, and application focus.

Purpose: Gives teachers one-click access to pedagogically rich content that helps students understand concepts more deeply through concrete examples and real-world applications.

Output: Working Elaborate button in + menu, AI generation with full presentation context, teleprompter script following current verbosity level.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-elaborate-slide-insertion/30-CONTEXT.md
@.planning/phases/30-elaborate-slide-insertion/30-RESEARCH.md

# Prior patterns (Phase 29 established context-aware regeneration)
@.planning/phases/29-single-teleprompter-regeneration/29-01-SUMMARY.md

# Source files
@App.tsx (lines 29-66 for InsertPoint, lines 412-453 for handleInsertExemplarSlide)
@services/aiProvider.ts (lines 169-213 for AIProviderInterface)
@services/geminiService.ts (lines 453-495 for generateExemplarSlide, lines 6-65 for TELEPROMPTER_RULES)
@services/providers/claudeProvider.ts (lines 474-514 for generateExemplarSlide)
@types.ts (lines 1-21 for Slide interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AI Provider Interface and Implement generateElaborateSlide</name>
  <files>
    services/aiProvider.ts
    services/geminiService.ts
    services/providers/geminiProvider.ts
    services/providers/claudeProvider.ts
  </files>
  <action>
**1. Add method to AIProviderInterface (services/aiProvider.ts):**

Add after `generateExemplarSlide`:
```typescript
generateElaborateSlide(
  lessonTopic: string,
  sourceSlide: Slide,
  allSlides: Slide[]
): Promise<Slide>;
```

**2. Implement in geminiService.ts:**

Add after `generateExemplarSlide` function (around line 495):

```typescript
export const generateElaborateSlide = async (
  apiKey: string,
  lessonTopic: string,
  sourceSlide: Slide,
  allSlides: Slide[]
): Promise<Slide> => {
  const ai = new GoogleGenAI({ apiKey });
  const model = "gemini-3-flash-preview";

  // Build full presentation context for coherence
  const presentationContext = allSlides
    .map((s, i) => `Slide ${i + 1}: "${s.title}" - ${s.content.slice(0, 2).join('; ')}`)
    .join('\n');

  const systemInstruction = `
You are an educational designer creating "Elaborate" slides for Year 6 (10-11 year olds).
Topic: ${lessonTopic}
You are expanding on: "${sourceSlide.title}"
Source content: ${sourceSlide.content.join('; ')}

PRESENTATION CONTEXT (maintain coherence, don't repeat earlier content):
${presentationContext}

TASK: Create a deeper-dive slide that helps students truly understand and apply this concept.

CONTENT REQUIREMENTS:
1. Title should reference the source (e.g., "More on [Topic]" or "[Topic]: Going Deeper")
2. ALWAYS include at least one analogy ("Think of it like...")
3. Focus on APPLICATION - show HOW to use the concept in practice
4. Match the tone of the source slide
5. Provide 3-5 content points mixing prose context with concrete examples
6. Format: Opening context point, then concrete examples/applications, then analogy

${TELEPROMPTER_RULES}

STRICT: You MUST provide exactly (Number of content points + 1) speaker note segments separated by "ðŸ‘‰".
`;

  const response = await ai.models.generateContent({
    model,
    contents: `Generate an Elaborate slide for: "${sourceSlide.title}". Use 'split' or 'grid' layout.`,
    config: {
      systemInstruction,
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          title: { type: Type.STRING, description: "Reference source topic" },
          content: { type: Type.ARRAY, items: { type: Type.STRING } },
          speakerNotes: { type: Type.STRING, description: "Must follow ðŸ‘‰ format" },
          imagePrompt: { type: Type.STRING },
          layout: { type: Type.STRING, enum: ['split', 'full-image', 'flowchart', 'grid', 'tile-overlap'] }
        },
        required: ['title', 'content', 'speakerNotes', 'imagePrompt']
      }
    }
  });

  const data = JSON.parse(response.text || "{}");
  return { ...data, id: `elaborate-${Date.now()}`, isGeneratingImage: false, slideType: 'elaborate' };
};
```

**3. Add passthrough in geminiProvider.ts:**

Add method in GeminiProvider class:
```typescript
async generateElaborateSlide(lessonTopic: string, sourceSlide: Slide, allSlides: Slide[]): Promise<Slide> {
  return generateElaborateSlide(this.apiKey, lessonTopic, sourceSlide, allSlides);
}
```

Add import at top: `generateElaborateSlide` from `../geminiService`.

**4. Implement in claudeProvider.ts:**

Add after `generateExemplarSlide` method:
```typescript
async generateElaborateSlide(lessonTopic: string, sourceSlide: Slide, allSlides: Slide[]): Promise<Slide> {
  // Build full presentation context for coherence
  const presentationContext = allSlides
    .map((s, i) => `Slide ${i + 1}: "${s.title}" - ${s.content.slice(0, 2).join('; ')}`)
    .join('\n');

  const systemPrompt = `
You are an educational designer creating "Elaborate" slides for Year 6 (10-11 year olds).
Topic: ${lessonTopic}
You are expanding on: "${sourceSlide.title}"
Source content: ${sourceSlide.content.join('; ')}

PRESENTATION CONTEXT (maintain coherence, don't repeat earlier content):
${presentationContext}

TASK: Create a deeper-dive slide that helps students truly understand and apply this concept.

CONTENT REQUIREMENTS:
1. Title should reference the source (e.g., "More on [Topic]" or "[Topic]: Going Deeper")
2. ALWAYS include at least one analogy ("Think of it like...")
3. Focus on APPLICATION - show HOW to use the concept in practice
4. Match the tone of the source slide
5. Provide 3-5 content points mixing prose context with concrete examples
6. Format: Opening context point, then concrete examples/applications, then analogy

STRICT SPEAKER NOTES (TELEPROMPTER LOGIC):
- You MUST provide exactly (Number of content points + 1) segments separated by "ðŸ‘‰"
- Segment 0: INTRO - set context for why we're going deeper
- Segment N: Explain the point (do NOT repeat the bullet text)
- Include pacing cues: "[Pause for effect]", "[Let this sink in]"

IMPORTANT: Return your response as valid JSON with these fields:
- title (string)
- content (array of strings)
- speakerNotes (string - must follow the ðŸ‘‰ format)
- imagePrompt (string)
- layout (one of: 'split', 'full-image', 'flowchart', 'grid', 'tile-overlap')

Do not include any text before or after the JSON.
`;

  const messages: ClaudeMessage[] = [{
    role: 'user',
    content: `Generate an Elaborate slide for: "${sourceSlide.title}". Use 'split' or 'grid' layout.`
  }];

  const response = await callClaude(this.apiKey, messages, systemPrompt, 2048);
  const data = extractJSON<any>(response);

  return {
    ...data,
    id: `elaborate-${Date.now()}`,
    isGeneratingImage: false,
    slideType: 'elaborate'
  };
}
```
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`
Verify no type errors for:
- AIProviderInterface has generateElaborateSlide method
- GeminiProvider implements the method
- ClaudeProvider implements the method
  </verify>
  <done>
Both AI providers implement generateElaborateSlide with full presentation context, teleprompter rules following standard verbosity, and slideType marker for UI badge.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Elaborate Button to InsertPoint and Wire Handler</name>
  <files>
    App.tsx
    types.ts
  </files>
  <action>
**1. Add slideType to Slide interface (types.ts):**

Add optional field after `verbosityCache`:
```typescript
// Slide type indicator for UI badges (optional, defaults to standard)
slideType?: 'standard' | 'elaborate' | 'work-together' | 'class-challenge';
```

**2. Extend InsertPoint component (App.tsx lines 29-66):**

Update props and add Elaborate button. Change from horizontal pill to vertical dropdown for 3 options:
```typescript
const InsertPoint = ({
  onClickBlank,
  onClickExemplar,
  onClickElaborate
}: {
  onClickBlank: () => void,
  onClickExemplar: () => void,
  onClickElaborate: () => void
}) => {
    const [isOpen, setIsOpen] = useState(false);

    return (
        <div
            className="group/insert py-1 flex items-center justify-center relative -my-1 min-h-[1.5rem]"
            onMouseLeave={() => setIsOpen(false)}
        >
            <div className={`absolute left-4 right-4 h-px transition-colors z-0 ${isOpen ? 'bg-indigo-400 dark:bg-amber-500' : 'bg-transparent group-hover/insert:bg-indigo-300/50 dark:group-hover/insert:bg-amber-500/30'}`}></div>

            {!isOpen ? (
                <button
                    onClick={(e) => { e.stopPropagation(); setIsOpen(true); }}
                    className="z-10 w-6 h-6 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-slate-400 hover:text-indigo-600 dark:hover:text-amber-400 hover:border-indigo-400 dark:hover:border-amber-400 shadow-sm flex items-center justify-center transition-all opacity-0 group-hover/insert:opacity-100 scale-75 group-hover/insert:scale-100 hover:shadow-md"
                    title="Insert Slide"
                >
                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 4v16m8-8H4" /></svg>
                </button>
            ) : (
                <div className="z-20 flex flex-col gap-1 animate-fade-in bg-white dark:bg-slate-800 border border-indigo-100 dark:border-amber-500/30 rounded-xl p-1.5 shadow-xl ring-4 ring-indigo-50 dark:ring-amber-500/10">
                    <button
                        onClick={(e) => { e.stopPropagation(); onClickBlank(); setIsOpen(false); }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 rounded-lg transition-colors"
                    >
                        <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Blank</span>
                    </button>
                    <button
                        onClick={(e) => { e.stopPropagation(); onClickExemplar(); setIsOpen(false); }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 dark:bg-amber-500 hover:bg-indigo-700 dark:hover:bg-amber-400 text-white dark:text-slate-900 rounded-lg transition-colors shadow-sm"
                    >
                        <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Exemplar</span>
                    </button>
                    <button
                        onClick={(e) => { e.stopPropagation(); onClickElaborate(); setIsOpen(false); }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors shadow-sm"
                    >
                        <span className="text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">Elaborate</span>
                    </button>
                </div>
            )}
        </div>
    );
};
```

**3. Add handleInsertElaborateSlide handler (App.tsx after handleInsertExemplarSlide ~line 453):**

```typescript
const handleInsertElaborateSlide = async (index: number) => {
  if (!provider) {
    setErrorModal({ title: 'AI Not Configured', message: 'Please configure your AI provider in Settings.' });
    return;
  }

  // Source slide is the slide ABOVE the + button (what we're elaborating on)
  const source = index >= 0 ? slides[index] : undefined;
  if (!source) {
    setErrorModal({ title: 'Cannot Elaborate', message: 'Need a slide above to elaborate on.' });
    return;
  }

  const tempId = `temp-elab-${Date.now()}`;
  const tempSlide: Slide = {
    id: tempId,
    title: "Elaborating...",
    content: ["Expanding on the concept...", "Adding depth and examples..."],
    speakerNotes: "",
    imagePrompt: "",
    isGeneratingImage: true,
    layout: 'split'
  };

  // Insert temp slide after source
  const newSlides = [...slides];
  newSlides.splice(index + 1, 0, tempSlide);
  setSlides(newSlides);
  setActiveSlideIndex(index + 1);

  try {
    const elaborate = await provider.generateElaborateSlide(lessonTitle, source, slides);
    setSlides(curr => curr.map(s => s.id === tempId ? { ...elaborate, id: tempId, isGeneratingImage: autoGenerateImages } : s));

    if (autoGenerateImages) {
      const img = await provider.generateSlideImage(elaborate.imagePrompt, elaborate.layout);
      setSlides(curr => curr.map(s => s.id === tempId ? { ...s, imageUrl: img, isGeneratingImage: false } : s));
    }
  } catch (err) {
    console.error("Elaborate error:", err);
    // Fallback to blank if elaborate fails
    setSlides(curr => curr.map(s => s.id === tempId ? { ...tempSlide, title: "New Slide", isGeneratingImage: false } : s));
    if (err instanceof AIProviderError) {
      setErrorModal({ title: 'Elaborate Generation Failed', message: err.userMessage });
    }
  }
};
```

**4. Wire InsertPoint usages (2 locations in App.tsx):**

Find both `<InsertPoint` usages (around lines 1148 and 1181) and add the new prop:

Location 1 (~line 1148):
```tsx
<InsertPoint
    onClickBlank={() => handleInsertBlankSlide(-1)}
    onClickExemplar={() => handleInsertExemplarSlide(-1)}
    onClickElaborate={() => handleInsertElaborateSlide(-1)}
/>
```

Location 2 (~line 1181):
```tsx
<InsertPoint
  onClickBlank={() => handleInsertBlankSlide(idx)}
  onClickExemplar={() => handleInsertExemplarSlide(idx)}
  onClickElaborate={() => handleInsertElaborateSlide(idx)}
/>
```

Note: For the first location (index -1), handleInsertElaborateSlide will show an error since there's no slide above. This is intentional - you can't elaborate on nothing.
  </action>
  <verify>
1. Run TypeScript compilation: `npx tsc --noEmit`
2. Start dev server and verify:
   - Click + between slides shows 3-option vertical dropdown (Blank, Exemplar, Elaborate)
   - Click Elaborate inserts "Elaborating..." temp slide
   - AI generates content with examples and analogies
   - Teleprompter script has correct segment count
   - If clicked at top (no slide above), shows error modal
  </verify>
  <done>
InsertPoint shows Elaborate option in vertical dropdown, handleInsertElaborateSlide creates temp slide and calls AI with full presentation context, generated slide has slideType: 'elaborate' marker, error handling matches Exemplar pattern.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript:** `npx tsc --noEmit` passes with no errors
2. **Functional test:**
   - Create presentation with 2-3 slides
   - Click + between slides
   - Verify dropdown shows Blank, Exemplar, Elaborate in vertical layout
   - Click Elaborate
   - Verify "Elaborating..." temp slide appears
   - Verify generated slide has:
     - Title referencing source (e.g., "More on [Topic]")
     - 3-5 content points
     - At least one analogy
     - Teleprompter script with correct segment count
   - Verify slideType is 'elaborate' (check via console or React DevTools)
3. **Error handling:** Click + at top (before first slide), click Elaborate, verify error modal appears
</verification>

<success_criteria>
- ELAB-01: Teacher clicks "Elaborate" in + menu to insert slide - DONE
- ELAB-02: AI generates 3-5 paragraphs expanding on current slide content - DONE
- ELAB-03: Generated content includes examples, explanations, and analogies for deeper understanding - DONE
- ELAB-04: Teleprompter provides guide for delivering detailed content - DONE

All 4 requirements satisfied with working Elaborate slide insertion following existing Exemplar pattern.
</success_criteria>

<output>
After completion, create `.planning/phases/30-elaborate-slide-insertion/30-01-SUMMARY.md`
</output>
