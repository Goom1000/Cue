---
phase: 54-quality-assurance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/contentPreservation/detector.integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Detection works correctly with numbered Q&A format (1. Q: ... A: ...)"
    - "Detection works correctly with prose/inline answer format"
    - "Detection works correctly with bullet/header Q&A format"
    - "Detection works correctly with mixed content formats"
    - "Detection correctly classifies content categories across formats"
  artifacts:
    - path: "services/contentPreservation/detector.integration.test.ts"
      provides: "Format diversity detection tests"
      min_lines: 150
  key_links:
    - from: "services/contentPreservation/detector.integration.test.ts"
      to: "services/contentPreservation/detector.ts"
      via: "import detectTeachableMoments"
      pattern: "import.*detectTeachableMoments.*from"
---

<objective>
Validate QUA-02: Detection works across lesson plan formats (various teachers' styles)

Purpose: Teachers write lesson plans in many different formats. The teachable moment detection must work reliably regardless of whether content is numbered, bulleted, prose, or mixed. This ensures all teachers benefit from the delay answer reveal feature.

Output: Integration test file with format diversity matrix covering real teacher styles
</objective>

<execution_context>
@/Users/ricky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ricky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/54-quality-assurance/54-RESEARCH.md

@services/contentPreservation/detector.ts
@services/contentPreservation/detector.test.ts
@services/contentPreservation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create format diversity detection tests</name>
  <files>services/contentPreservation/detector.integration.test.ts</files>
  <action>
Create a new integration test file `detector.integration.test.ts` that validates QUA-02 format diversity detection.

Use the format matrix approach from the research. Test detection against multiple real-world lesson plan formats that teachers actually use.

```typescript
import { detectTeachableMoments, classifyContentCategory } from './detector';
import { ContentCategory } from './types';

/**
 * Format Diversity Test Suite for QUA-02
 *
 * Tests that teachable moment detection works across the variety of
 * lesson plan formats teachers actually use.
 */
describe('QUA-02: Format Diversity Detection', () => {

  // ==========================================================================
  // Format Matrix - Real Teacher Styles
  // ==========================================================================

  const TEACHER_FORMATS = {
    'Numbered Q&A (Mrs. Smith style)': `
      Math Practice:
      1. Q: What is 2+2?
         A: 4
      2. Q: What is 3x3?
         A: 9
      3. Q: What is 10-4?
         A: 6
    `,

    'Prose with inline answers (Mr. Jones style)': `
      Today we'll learn about fractions. What is 1/2 of 10? The answer is 5.
      Then we'll practice: What is 1/4 of 20? Answer: 5.
      Finally: What is 3/4 of 8? Answer: 6.
    `,

    'Bullet headers (Ms. Garcia style)': `
      Vocabulary Review:

      Question: Define evaporation
      Answer: When water turns to gas

      Question: Define condensation
      Answer: When gas turns to water

      Question: Define precipitation
      Answer: When water falls from clouds
    `,

    'QA blocks (Dr. Lee style)': `
      Science Quiz:

      Q1: What is photosynthesis?
      A1: Process by which plants make food using sunlight

      Q2: What is chlorophyll?
      A2: Green pigment in plants

      Q3: What is the chemical equation?
      A3: 6CO2 + 6H2O = C6H12O6 + 6O2
    `,

    'Mixed format (Coach Williams style)': `
      Learning Objective: Understand fractions

      Activity: What is 3/4 of 12? (Answer: 9)

      Discussion Questions:
      - Why do we use fractions? Answer: To represent parts of a whole.
      - How does this relate to division?

      Quick Check:
      Q: What is 1/2 + 1/4?
      A: 3/4
    `,

    'Table-like format (Ms. Chen style)': `
      Vocabulary Match:

      | Term | Definition |
      |------|------------|
      | Evaporation | Water turns to gas |
      | Condensation | Gas turns to water |

      Questions:
      What causes evaporation? Answer: Heat energy
      What causes condensation? Answer: Cooling
    `,

    'Parenthetical answers (Prof. Brown style)': `
      Comprehension Questions:

      1. Why did the main character leave home? (Because she wanted adventure)
      2. What was the turning point? (When she met the mentor)
      3. How did the story end? (She returned home changed)
    `,

    'Colon-separated (Ms. Patel style)': `
      Math Word Problems:

      Problem: A train travels 60 miles in 2 hours. What is its speed?
      Solution: 30 miles per hour

      Problem: If you have 24 cookies and 6 friends, how many does each get?
      Solution: 4 cookies each
    `
  };

  // ==========================================================================
  // Core Detection Tests
  // ==========================================================================

  describe('Format detection matrix', () => {
    Object.entries(TEACHER_FORMATS).forEach(([styleName, lessonText]) => {
      describe(styleName, () => {
        it('detects at least one teachable moment', () => {
          const moments = detectTeachableMoments(lessonText);
          expect(moments.length).toBeGreaterThanOrEqual(1);
        });

        it('correctly pairs problems with answers', () => {
          const moments = detectTeachableMoments(lessonText);
          const withAnswers = moments.filter(m => m.answer !== null);

          // Most formats should have at least one paired answer
          expect(withAnswers.length).toBeGreaterThanOrEqual(1);
        });

        it('assigns valid content category to each moment', () => {
          const moments = detectTeachableMoments(lessonText);

          const validCategories: ContentCategory[] = [
            'math', 'vocabulary', 'comprehension', 'science', 'general'
          ];

          moments.forEach(m => {
            expect(validCategories).toContain(m.contentCategory);
          });
        });

        it('maintains position ordering', () => {
          const moments = detectTeachableMoments(lessonText);

          // Moments should be sorted by position in text
          for (let i = 1; i < moments.length; i++) {
            expect(moments[i].problem.startIndex)
              .toBeGreaterThan(moments[i - 1].problem.startIndex);
          }
        });
      });
    });
  });

  // ==========================================================================
  // Category Classification Tests
  // ==========================================================================

  describe('Content category classification across formats', () => {
    const MATH_SAMPLES = [
      'What is 2+2? Answer: 4',
      '1. Q: Calculate 3x3  A: 9',
      'Problem: What is 1/2 of 10? Solution: 5'
    ];

    const VOCABULARY_SAMPLES = [
      'Question: Define evaporation  Answer: When water turns to gas',
      'What does osmosis mean? Answer: It means the movement of water',
      'Term: Photosynthesis  Definition: The process plants use'
    ];

    const COMPREHENSION_SAMPLES = [
      'Why did the character leave? Answer: Because she wanted adventure',
      'Q: What caused the conflict?  A: Because the two groups disagreed',
      'What is the main theme? (The answer is: perseverance through hardship)'
    ];

    const SCIENCE_SAMPLES = [
      'What is photosynthesis? Answer: Process plants use to make food',
      'Q1: Describe the experiment  A1: The experiment showed oxidation',
      'What is your hypothesis? Answer: My hypothesis is that plants need light'
    ];

    MATH_SAMPLES.forEach((sample, i) => {
      it(`classifies math sample ${i + 1} correctly`, () => {
        const moments = detectTeachableMoments(sample);
        expect(moments.length).toBeGreaterThan(0);
        expect(moments[0].contentCategory).toBe('math');
      });
    });

    VOCABULARY_SAMPLES.forEach((sample, i) => {
      it(`classifies vocabulary sample ${i + 1} correctly`, () => {
        const moments = detectTeachableMoments(sample);
        expect(moments.length).toBeGreaterThan(0);
        expect(moments[0].contentCategory).toBe('vocabulary');
      });
    });

    COMPREHENSION_SAMPLES.forEach((sample, i) => {
      it(`classifies comprehension sample ${i + 1} correctly`, () => {
        const moments = detectTeachableMoments(sample);
        expect(moments.length).toBeGreaterThan(0);
        expect(moments[0].contentCategory).toBe('comprehension');
      });
    });

    SCIENCE_SAMPLES.forEach((sample, i) => {
      it(`classifies science sample ${i + 1} correctly`, () => {
        const moments = detectTeachableMoments(sample);
        expect(moments.length).toBeGreaterThan(0);
        expect(moments[0].contentCategory).toBe('science');
      });
    });
  });

  // ==========================================================================
  // Edge Cases
  // ==========================================================================

  describe('Format edge cases', () => {
    it('handles emoji bullets', () => {
      const text = `
        Math Practice:
        ðŸ“ What is 5+5? Answer: 10
        âœï¸ What is 6-2? Answer: 4
      `;
      const moments = detectTeachableMoments(text);
      expect(moments.length).toBeGreaterThanOrEqual(1);
    });

    it('handles markdown-style formatting', () => {
      const text = `
        ## Quiz Questions

        **Q:** What is the capital of France?
        **A:** Paris

        **Q:** What is the capital of Germany?
        **A:** Berlin
      `;
      const moments = detectTeachableMoments(text);
      expect(moments.length).toBeGreaterThanOrEqual(1);
    });

    it('handles tab-separated content', () => {
      const text = `
        Question\tAnswer
        What is 2+2?\t4
        What is 3+3?\t6
      `;
      const moments = detectTeachableMoments(text);
      // May or may not detect depending on format - should not crash
      expect(Array.isArray(moments)).toBe(true);
    });

    it('handles very long lesson plans', () => {
      // Generate a lesson plan with many Q&A pairs
      const qaPairs = Array.from({ length: 20 }, (_, i) =>
        `Q${i + 1}: What is ${i}+1? A${i + 1}: ${i + 1}`
      ).join('\n');

      const text = `
        Lengthy Math Review

        ${qaPairs}

        Extra content to ensure padding.
        More content here.
        And some more.
      `;

      const moments = detectTeachableMoments(text);

      // Should apply 30% throttling
      expect(moments.length).toBeLessThanOrEqual(10); // ~30% of ~25 lines
      expect(moments.length).toBeGreaterThan(0);
    });

    it('handles content with no Q&A pairs gracefully', () => {
      const text = `
        Lesson Introduction

        Today we will learn about fractions.
        Fractions represent parts of a whole.
        This is important for everyday math.
      `;

      const moments = detectTeachableMoments(text);
      expect(moments).toEqual([]);
    });
  });

  // ==========================================================================
  // Determinism Tests
  // ==========================================================================

  describe('DET-04: Deterministic output across formats', () => {
    Object.entries(TEACHER_FORMATS).forEach(([styleName, lessonText]) => {
      it(`produces consistent results for ${styleName}`, () => {
        const results1 = detectTeachableMoments(lessonText);
        const results2 = detectTeachableMoments(lessonText);
        const results3 = detectTeachableMoments(lessonText);

        expect(results1).toEqual(results2);
        expect(results2).toEqual(results3);
      });
    });
  });
});
```

This test suite covers:
- 8 distinct teacher formatting styles
- Detection, pairing, classification, and ordering for each format
- Category classification with 12 samples across 4 categories
- Edge cases (emoji, markdown, tabs, long content, no Q&A)
- Determinism verification for each format
  </action>
  <verify>
Run: `npm test -- detector.integration.test.ts`

Expected: All tests pass:
- 32 format matrix tests (8 formats x 4 assertions each)
- 12 category classification tests
- 5 edge case tests
- 8 determinism tests

Total: 57+ tests passing
  </verify>
  <done>
detector.integration.test.ts exists with 50+ test cases covering 8 teacher styles. Detection works correctly across numbered, prose, bullet, and mixed formats. All content categories are correctly classified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify throttling behavior across formats</name>
  <files>services/contentPreservation/detector.integration.test.ts</files>
  <action>
Add additional test cases to detector.integration.test.ts that specifically verify the 30% throttling behavior works correctly across different format densities.

Append to the existing test file:

```typescript
// ==========================================================================
// Throttling Behavior Across Formats
// ==========================================================================

describe('Throttling consistency across formats', () => {
  it('applies 30% throttling consistently regardless of format', () => {
    // Dense numbered format
    const numberedFormat = Array.from({ length: 15 }, (_, i) =>
      `${i + 1}. Q: What is ${i}? A: ${i}`
    ).join('\n');

    // Dense prose format
    const proseFormat = Array.from({ length: 15 }, (_, i) =>
      `What is ${i}? Answer: ${i}.`
    ).join(' ');

    // Dense bullet format
    const bulletFormat = Array.from({ length: 15 }, (_, i) =>
      `- Question: What is ${i}?\n  Answer: ${i}`
    ).join('\n');

    const numberedMoments = detectTeachableMoments(numberedFormat);
    const proseMoments = detectTeachableMoments(proseFormat);
    const bulletMoments = detectTeachableMoments(bulletFormat);

    // All should be throttled to ~30% of content
    // With 15 Q&A items, expect at most ~5-6 moments
    expect(numberedMoments.length).toBeLessThanOrEqual(6);
    expect(proseMoments.length).toBeLessThanOrEqual(6);
    expect(bulletMoments.length).toBeLessThanOrEqual(6);

    // All should have at least some moments detected
    expect(numberedMoments.length).toBeGreaterThan(0);
    expect(proseMoments.length).toBeGreaterThan(0);
    expect(bulletMoments.length).toBeGreaterThan(0);
  });

  it('prioritizes high-confidence detections when throttling', () => {
    // Mix of clear and ambiguous formats
    const mixedConfidence = `
      Introduction paragraph.

      What is 2+2? Answer: 4

      Some ambiguous content here.

      What is 3+3? Answer: 6

      More content.

      Clear Question: What is 4+4?
      Clear Answer: 8

      Final content.
    `;

    const moments = detectTeachableMoments(mixedConfidence);

    // Should have detected some moments
    expect(moments.length).toBeGreaterThan(0);

    // All retained moments should have valid confidence
    moments.forEach(m => {
      expect(['high', 'medium', 'low']).toContain(m.confidence);
    });
  });
});
```
  </action>
  <verify>
Run: `npm test -- detector.integration.test.ts`

Expected: All tests continue to pass, including the new throttling tests.
  </verify>
  <done>
detector.integration.test.ts includes throttling behavior tests. 30% throttling is verified to work consistently across numbered, prose, and bullet formats.
  </done>
</task>

</tasks>

<verification>
Run the full integration test suite:

```bash
npm test -- detector.integration.test.ts --verbose
```

All tests should pass. Run 3 times to confirm determinism (no flaky tests).
</verification>

<success_criteria>
1. detector.integration.test.ts has 55+ test cases
2. All 8 teacher format styles are tested
3. Detection finds Q&A pairs in all formats
4. Category classification works across formats
5. 30% throttling applies consistently across formats
6. All tests pass deterministically
</success_criteria>

<output>
After completion, create `.planning/phases/54-quality-assurance/54-02-SUMMARY.md`
</output>
