---
phase: 03-resilience-polish
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/PresentationView.tsx
  - components/StudentView.tsx
  - components/NextSlidePreview.tsx
autonomous: true

must_haves:
  truths:
    - "If student window is closed, button re-enables and teacher can reopen it"
    - "Visual indicator in teacher view shows whether student window is connected"
    - "Sync survives page refresh (teacher reconnects to existing student window)"
    - "Page Up/Down keyboard shortcuts navigate slides"
    - "Escape key closes the student window remotely"
    - "Navigation buttons show keyboard shortcut tooltips on hover"
    - "Teacher view shows next slide preview thumbnail (toggleable)"
  artifacts:
    - path: "components/PresentationView.tsx"
      provides: "Integrated resilience features and polish"
      contains: "ConnectionStatus"
    - path: "components/StudentView.tsx"
      provides: "Heartbeat acknowledgment and remote close handling"
      contains: "HEARTBEAT_ACK"
    - path: "components/NextSlidePreview.tsx"
      provides: "Toggleable next slide preview component"
      exports: ["default"]
  key_links:
    - from: "components/PresentationView.tsx"
      to: "components/StudentView.tsx"
      via: "BroadcastChannel heartbeat"
      pattern: "HEARTBEAT.*HEARTBEAT_ACK"
    - from: "components/PresentationView.tsx"
      to: "components/NextSlidePreview.tsx"
      via: "import and render"
      pattern: "NextSlidePreview"
    - from: "components/StudentView.tsx"
      to: "window.close"
      via: "CLOSE_STUDENT message handler"
      pattern: "CLOSE_STUDENT.*window\\.close"
---

<objective>
Integrate resilience features and presenter conveniences into the application.

Purpose: Wire up all Phase 3 infrastructure to deliver complete resilience (window recovery, connection status, session persistence) and polish (keyboard navigation, tooltips, next slide preview).

Output: Fully functional resilience and polish features integrated into teacher and student views.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-resilience-polish/03-CONTEXT.md
@.planning/phases/03-resilience-polish/03-RESEARCH.md
@.planning/phases/03-resilience-polish/03-01-SUMMARY.md
@components/PresentationView.tsx
@components/StudentView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heartbeat response and remote close to StudentView</name>
  <files>components/StudentView.tsx</files>
  <action>
Update StudentView.tsx to respond to heartbeats and handle remote close:

1. Import the new message types (already in PresentationMessage union)

2. Add heartbeat acknowledgment:
   - In the useEffect that handles lastMessage, add a case for 'HEARTBEAT':
   ```typescript
   if (lastMessage.type === 'HEARTBEAT') {
     postMessage({ type: 'HEARTBEAT_ACK', timestamp: lastMessage.timestamp });
   }
   ```

3. Add remote close handling:
   - In the same useEffect, add a case for 'CLOSE_STUDENT':
   ```typescript
   if (lastMessage.type === 'CLOSE_STUDENT') {
     window.close();
   }
   ```

4. No UI changes needed - StudentView remains pure slide display
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - StudentView handles HEARTBEAT messages by sending HEARTBEAT_ACK
    - StudentView handles CLOSE_STUDENT by calling window.close()
  </verify>
  <done>
    - StudentView responds to HEARTBEAT with HEARTBEAT_ACK
    - StudentView closes itself when CLOSE_STUDENT received
    - Existing functionality preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NextSlidePreview component and integrate all features into PresentationView</name>
  <files>components/NextSlidePreview.tsx, components/PresentationView.tsx</files>
  <action>
**Part A: Create components/NextSlidePreview.tsx**

Props interface:
```typescript
interface NextSlidePreviewProps {
  nextSlide: Slide | null;  // null when on last slide
  isVisible: boolean;
  onToggle: () => void;
}
```

Component structure:
1. Toggle button: `px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600 border border-slate-600`
   - Text: "Hide Preview" when visible, "Preview" when hidden
   - title attribute: "Toggle next slide preview"

2. Preview panel (shown when isVisible):
   - Position: absolute bottom-20 right-4 (above nav buttons area)
   - Size: w-48, aspect-video thumbnail
   - Style: bg-slate-800 rounded-lg shadow-xl border border-slate-700
   - Header: "Next Slide" label (text-[10px] uppercase tracking-wider)
   - Content when nextSlide exists:
     - White background panel
     - Show slide.title (truncated)
     - Show first 3 bullets (truncated, tiny text-[8px])
   - Content when nextSlide is null:
     - Dark bg-slate-900 panel
     - Center text: "End of presentation" (text-slate-500)

**Part B: Update PresentationView.tsx with all integrations**

1. Imports:
   - Add: ConnectionStatus, useKeyboardNavigation, NextSlidePreview, useToast, ToastContainer

2. Connection status and button re-enabling:
   - Update useBroadcastSync call: `{ enableHeartbeat: true }`
   - Extract isConnected from the hook return
   - Replace isStudentWindowOpen logic:
     - Button disabled state: `disabled={isConnected}` (not isStudentWindowOpen)
     - Remove isStudentWindowOpen state variable entirely
   - Add ConnectionStatus component in header (near the launch button)

3. Keyboard navigation:
   - Replace existing useEffect keydown handler with useKeyboardNavigation hook
   - Configure: onNext=handleNext, onPrev=handlePrev, onEscape=handleCloseStudent
   - Create handleCloseStudent function: `postMessage({ type: 'CLOSE_STUDENT' })`
   - Note: Escape now closes student window, NOT exits presentation (per CONTEXT.md)

4. Button tooltips:
   - Add title attributes to nav buttons:
     - Back button: `title="Previous (Left Arrow or Page Up)"`
     - Next/Reveal button: `title="Next (Right Arrow, Page Down, or Space)"`
   - Add title to Exit button: `title="Exit presentation"`

5. Next slide preview:
   - Add showPreview state (boolean, default false)
   - Calculate nextSlide: `slides[currentIndex + 1] || null`
   - Render NextSlidePreview in header area with toggle button and preview panel
   - Position toggle button near other header controls

6. Toast for reconnection:
   - Add useToast hook
   - Render ToastContainer at component level
   - Show toast when teacher reconnects to existing student:
     - In useEffect watching isConnected, if isConnected becomes true and there was a previous connection (use ref to track), show "Reconnected to student view"
   - Auto-dismiss after 3 seconds

7. Session persistence (handled automatically):
   - BroadcastChannel already handles reconnection - when teacher refreshes, the existing student window continues to respond to heartbeats
   - On mount, STATE_REQUEST triggers state sync
   - Connection detected through heartbeat acks
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Run dev server: `npm run dev`
    - Launch student window - ConnectionStatus shows "Connected"
    - Close student window - button re-enables within 5 seconds, status shows "Disconnected"
    - Press Page Down/Up or Arrow keys - slides navigate
    - Press Escape with student window open - student window closes
    - Hover over nav buttons - tooltips show keyboard shortcuts
    - Click Preview button - next slide preview appears
    - When on last slide - preview shows "End of presentation"
  </verify>
  <done>
    - ConnectionStatus chip displays connection state in header
    - Launch button disabled based on isConnected, re-enables when student window closed
    - Keyboard navigation works with Page Up/Down, Arrow keys, Space
    - Escape key closes student window remotely
    - Navigation buttons have keyboard shortcut tooltips
    - Next slide preview toggleable and shows upcoming content
    - Toast appears on reconnection after page refresh
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify all Phase 3 requirements:

**RES-01 (Window Recovery):**
1. Launch student window
2. Close student window manually (X button)
3. Within 5 seconds, "Launch Student" button should re-enable
4. Click button - student window reopens at current slide position

**RES-02 (Connection Status):**
1. Before launching student - no status shown (or "Disconnected")
2. After launching student - ConnectionStatus shows green "Connected"
3. Close student window - status changes to gray "Disconnected"

**RES-03 (Session Persistence):**
1. Launch student window
2. Refresh teacher page (F5 or Cmd+R)
3. Student window should remain open
4. Within seconds, ConnectionStatus should show "Connected" again
5. Toast notification appears "Reconnected to student view"
6. Slide navigation continues to sync

**PRES-01 (Keyboard Navigation):**
1. Press Right Arrow or Page Down - advances to next bullet/slide
2. Press Left Arrow or Page Up - goes back
3. Press Space - advances (same as Next)
4. Press Escape - closes student window (not exits presentation)
5. All keys work regardless of where focus is (except in input fields)

**PRES-02 (Next Slide Preview):**
1. Click "Preview" button in header - preview panel appears
2. Panel shows thumbnail of next slide with title and bullets
3. Click "Hide Preview" - panel disappears
4. Navigate to last slide - preview shows "End of presentation"
</verification>

<success_criteria>
All 5 Phase 3 requirements verified working:
- RES-01: Student window recoverable after close
- RES-02: Connection status indicator visible
- RES-03: Session survives page refresh
- PRES-01: Keyboard shortcuts work for presenter remotes
- PRES-02: Next slide preview available
</success_criteria>

<output>
After completion, create `.planning/phases/03-resilience-polish/03-02-SUMMARY.md`
</output>
