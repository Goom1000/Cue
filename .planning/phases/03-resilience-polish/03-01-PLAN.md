---
phase: 03-resilience-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types.ts
  - hooks/useBroadcastSync.ts
  - hooks/useKeyboardNavigation.ts
  - components/ConnectionStatus.tsx
  - components/Toast.tsx
autonomous: true

must_haves:
  truths:
    - "Heartbeat messages can be sent and received via BroadcastChannel"
    - "Connection status can be tracked based on heartbeat acknowledgments"
    - "Keyboard events for Page Up/Down/Arrow keys can be captured globally"
    - "Toast notifications can appear and auto-dismiss"
  artifacts:
    - path: "types.ts"
      provides: "Extended PresentationMessage union with HEARTBEAT, HEARTBEAT_ACK, CLOSE_STUDENT"
      contains: "HEARTBEAT"
    - path: "hooks/useBroadcastSync.ts"
      provides: "Optional heartbeat capability with isConnected state"
      contains: "enableHeartbeat"
    - path: "hooks/useKeyboardNavigation.ts"
      provides: "Global keyboard event hook for navigation"
      exports: ["default"]
    - path: "components/ConnectionStatus.tsx"
      provides: "Visual status chip component"
      exports: ["default"]
    - path: "components/Toast.tsx"
      provides: "Auto-dismissing notification component and hook"
      exports: ["Toast", "useToast"]
  key_links:
    - from: "hooks/useBroadcastSync.ts"
      to: "types.ts"
      via: "message type handling"
      pattern: "HEARTBEAT_ACK"
---

<objective>
Build resilience infrastructure for Phase 3 features.

Purpose: Create foundational hooks and components that enable connection status tracking, keyboard navigation for presenter remotes, and toast notifications for reconnection feedback.

Output: Extended types, enhanced BroadcastChannel hook with heartbeat, keyboard navigation hook, ConnectionStatus chip component, Toast notification component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-resilience-polish/03-CONTEXT.md
@.planning/phases/03-resilience-polish/03-RESEARCH.md
@types.ts
@hooks/useBroadcastSync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types and useBroadcastSync with heartbeat capability</name>
  <files>types.ts, hooks/useBroadcastSync.ts</files>
  <action>
1. In types.ts, extend the PresentationMessage union with three new message types:
   ```typescript
   | { type: 'HEARTBEAT'; timestamp: number }
   | { type: 'HEARTBEAT_ACK'; timestamp: number }
   | { type: 'CLOSE_STUDENT' }
   ```

2. In hooks/useBroadcastSync.ts, add optional heartbeat capability:
   - Add options parameter: `{ enableHeartbeat?: boolean; heartbeatInterval?: number; heartbeatTimeout?: number }`
   - Default values: heartbeatInterval = 2000ms, heartbeatTimeout = 5000ms
   - Add `isConnected` state (boolean, default false)
   - Add `lastAckRef` to track last acknowledgment timestamp
   - When enableHeartbeat is true:
     - Send HEARTBEAT message every heartbeatInterval
     - Track HEARTBEAT_ACK messages, update lastAckRef and set isConnected = true
     - Check every 1000ms if (Date.now() - lastAckRef > heartbeatTimeout), set isConnected = false
   - Return `isConnected` in the hook return value
   - Important: Only start heartbeat checks AFTER first ack received (avoid showing "disconnected" before any connection)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - types.ts contains HEARTBEAT, HEARTBEAT_ACK, CLOSE_STUDENT message types
    - useBroadcastSync accepts enableHeartbeat option
    - useBroadcastSync returns isConnected boolean
  </verify>
  <done>
    - PresentationMessage union includes all three new message types
    - useBroadcastSync hook supports optional heartbeat with configurable intervals
    - Hook returns isConnected state that reflects heartbeat acknowledgment status
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useKeyboardNavigation hook and ConnectionStatus component</name>
  <files>hooks/useKeyboardNavigation.ts, components/ConnectionStatus.tsx</files>
  <action>
1. Create hooks/useKeyboardNavigation.ts:
   ```typescript
   interface UseKeyboardNavigationOptions {
     onNext: () => void;
     onPrev: () => void;
     onEscape?: () => void;
     enabled?: boolean;
   }
   ```
   - Listen to document 'keydown' events when enabled (default true)
   - Handle keys: ArrowRight, PageDown, Space -> onNext
   - Handle keys: ArrowLeft, PageUp -> onPrev
   - Handle Escape -> onEscape (if provided)
   - Skip handling if event.target is INPUT or TEXTAREA (prevent conflict with form fields)
   - Prevent default on handled keys
   - Clean up listener on unmount or when enabled changes

2. Create components/ConnectionStatus.tsx:
   - Props: `{ isConnected: boolean }`
   - Render a small status chip with:
     - Green filled circle + "Connected" text when isConnected
     - Gray hollow circle + "Disconnected" text when not connected
   - Use Tailwind classes matching existing UI:
     - Connected: `bg-green-900/30 text-green-400 border border-green-500/30`
     - Disconnected: `bg-slate-700/50 text-slate-400 border border-slate-600/30`
   - Include subtle pulse animation on the green dot when connected
   - Size: compact (text-xs, px-2 py-1, rounded-full)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - hooks/useKeyboardNavigation.ts exists and exports default function
    - components/ConnectionStatus.tsx exists and exports default component
  </verify>
  <done>
    - useKeyboardNavigation hook handles Page Up/Down, Arrow keys, Escape with input field filtering
    - ConnectionStatus component displays visual indicator with connected/disconnected states
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Toast notification component and hook</name>
  <files>components/Toast.tsx</files>
  <action>
Create components/Toast.tsx with both the component and useToast hook:

1. useToast hook:
   ```typescript
   interface Toast {
     id: string;
     message: string;
     duration?: number;
   }

   function useToast() {
     // State: array of Toast objects
     // addToast(message: string, duration?: number): void
     //   - Generate id with crypto.randomUUID()
     //   - Default duration 3000ms
     // removeToast(id: string): void
     // Return { toasts, addToast, removeToast }
   }
   ```

2. Toast component:
   - Props: `{ message: string; duration: number; onDismiss: () => void }`
   - Auto-dismiss after duration via useEffect + setTimeout
   - Clean up timeout on unmount
   - Style: fixed position bottom-4 right-4, green success color for reconnection
   - Use Tailwind: `bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50`
   - Simple fade-in animation using Tailwind animate-fade-in (or opacity transition)

3. ToastContainer component (optional helper):
   - Renders list of toasts from useToast
   - Maps over toasts array, renders Toast for each
   - Handles dismiss callback

Export: `{ Toast, useToast, ToastContainer }`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - components/Toast.tsx exports Toast, useToast, and ToastContainer
  </verify>
  <done>
    - useToast hook manages toast array with add/remove functions
    - Toast component renders auto-dismissing notification
    - ToastContainer renders all active toasts
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npx tsc --noEmit` - should pass with no errors
2. Verify types.ts has HEARTBEAT, HEARTBEAT_ACK, CLOSE_STUDENT in PresentationMessage
3. Verify useBroadcastSync returns `{ lastMessage, postMessage, isConnected }`
4. Verify useKeyboardNavigation.ts exports hook
5. Verify ConnectionStatus.tsx exports component
6. Verify Toast.tsx exports Toast, useToast, ToastContainer
</verification>

<success_criteria>
- All infrastructure components compile without TypeScript errors
- useBroadcastSync hook enhanced with optional heartbeat capability
- useKeyboardNavigation hook ready for integration
- ConnectionStatus component ready for teacher view header
- Toast component ready for reconnection feedback
</success_criteria>

<output>
After completion, create `.planning/phases/03-resilience-polish/03-01-SUMMARY.md`
</output>
