# Architecture Patterns: Clipboard Paste & Deck Cohesion

**Project:** Cue v4.0 - Clipboard Builder
**Researched:** 2026-02-02
**Confidence:** HIGH (based on codebase analysis + browser API documentation)

## Executive Summary

Clipboard paste and deck cohesion features integrate cleanly with Cue's existing architecture. The centralized state management in App.tsx, established slide manipulation patterns, and AI provider strategy pattern provide natural extension points. No architectural changes required - these are feature additions following existing patterns.

## Recommended Architecture

### High-Level Integration

```
                    ┌─────────────────────────────────────┐
                    │           App.tsx                   │
                    │  ┌─────────────────────────────┐    │
                    │  │    slides: Slide[]          │    │
                    │  │    handlePasteSlide()       │ ◄──┼── NEW
                    │  │    handleMakeCohesive()     │ ◄──┼── NEW
                    │  └─────────────────────────────┘    │
                    └───────────┬─────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────────┐
        │                       │                           │
        ▼                       ▼                           ▼
┌───────────────┐     ┌─────────────────┐        ┌──────────────────┐
│ usePaste.ts   │     │ AIProviderInterface │    │ LandingPage      │
│ (NEW hook)    │     │ (extend interface)  │    │ (add paste zone) │
│               │     │                     │    │                  │
│ - paste event │     │ + analyzeSlide()    │    │ - useEffect      │
│ - image blob  │     │ + makeCohesive()    │    │   paste handler  │
│ - HTML parse  │     │ + suggestGapSlides()│    │ - visual drop    │
└───────────────┘     └─────────────────────┘    └──────────────────┘
```

### Component Boundaries

| Component | Responsibility | Communicates With |
|-----------|---------------|-------------------|
| **App.tsx** | Slide state, orchestration | All components (props down, callbacks up) |
| **usePaste** (NEW) | Clipboard event handling, data extraction | App.tsx (returns parsed data) |
| **PasteZone** (NEW) | Visual paste target, drag-drop for images | usePaste, App.tsx |
| **CohesionPanel** (NEW) | "Make Cohesive" UI, gap display | App.tsx, AI provider |
| **AIProviderInterface** | Extend with cohesion methods | GeminiProvider, ClaudeProvider |
| **InsertPoint** (MODIFY) | Add "Paste" option alongside Blank/Exemplar | App.tsx slide insertion |

### Data Flow: Paste Slide

```
User pastes (Cmd+V)
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ usePaste hook captures paste event                    │
│ - Check clipboardData.types for content              │
│ - Priority: image/png > text/html > text/plain      │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Extract content based on type:                        │
│ - image/png → blob → base64 (slide.imageUrl)         │
│ - text/html → parse for structure (title, bullets)   │
│ - text/plain → use as slide.content                  │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ App.tsx: handlePasteSlide(pastedContent)              │
│ - Create temp slide with parsing indicator           │
│ - Call provider.analyzeSlide(pastedContent)          │
│ - Update slide with AI-enhanced content              │
│ - If image only: set layout='full-image'             │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ setSlides([...slides, newSlide])                      │
│ setActiveSlideIndex(slides.length)                    │
└───────────────────────────────────────────────────────┘
```

### Data Flow: Make Cohesive

```
User clicks "Make Cohesive"
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ CohesionPanel renders (modal or sidebar)              │
│ - Shows current deck as flow diagram                 │
│ - Highlights potential issues                        │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ provider.makeCohesive(slides, lessonPlan?)            │
│ - Analyzes slide sequence                            │
│ - Returns: { suggestions, reorderedSlides, gaps }    │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ User reviews suggestions in UI:                       │
│ - Reorder recommendations                            │
│ - Gap-fill slide suggestions                         │
│ - Transition improvements                            │
│ - Click "Apply" to accept                            │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ setSlides(acceptedChanges)                            │
│ Optional: regenerate speakerNotes for flow           │
└───────────────────────────────────────────────────────┘
```

## New Components Needed

### 1. usePaste Hook
**Location:** `hooks/usePaste.ts`
**Pattern:** Follows useDragDrop.ts pattern

```typescript
interface PasteResult {
  type: 'image' | 'html' | 'text';
  imageBlob?: Blob;       // For image paste
  imageBase64?: string;   // Converted for storage
  htmlContent?: string;   // Raw HTML
  parsedTitle?: string;   // Extracted title
  parsedBullets?: string[]; // Extracted content
  rawText?: string;       // Fallback
}

function usePaste(
  onPaste: (result: PasteResult) => void,
  enabled: boolean = true
): void
```

**Key implementation details:**
- Listen to window `paste` event (like useDragDrop does for drop)
- Check `event.clipboardData.types` for available formats
- For images: `clipboardData.files[0]` or `clipboardData.items`
- For HTML: `clipboardData.getData('text/html')`
- Parse HTML using DOMParser to extract structure

### 2. PasteZone Component
**Location:** `components/PasteZone.tsx`
**Purpose:** Visual target for paste operations with feedback

- Renders in landing page INPUT state
- Shows "Paste slide here (Cmd+V)" hint
- Animates when paste detected
- Optional: accept file drops for images

### 3. CohesionPanel Component
**Location:** `components/CohesionPanel.tsx`
**Purpose:** "Make Cohesive" review UI

- Modal or slide-out panel
- Shows deck flow visualization
- Displays AI suggestions
- Accept/reject controls per suggestion

### 4. AIProvider Extensions
**Location:** `services/aiProvider.ts` (interface) + provider implementations

```typescript
interface AIProviderInterface {
  // ... existing methods

  // NEW: Analyze pasted content and suggest improvements
  analyzeSlide(
    content: PasteResult,
    existingSlides: Slide[]
  ): Promise<Partial<Slide>>;

  // NEW: Review deck for cohesion
  makeCohesive(
    slides: Slide[],
    lessonPlan?: string
  ): Promise<CohesionResult>;

  // NEW: Suggest gap-filling slides
  suggestGapSlides(
    slides: Slide[],
    lessonPlan: string
  ): Promise<Slide[]>;
}

interface CohesionResult {
  suggestions: CohesionSuggestion[];
  reorderedIndices?: number[];  // Suggested new order
  gapSlides?: Slide[];          // Slides to fill gaps
}

interface CohesionSuggestion {
  type: 'reorder' | 'gap' | 'transition' | 'style';
  description: string;
  affectedSlides: number[];
  autoApplicable: boolean;
}
```

## Modified Components

### App.tsx Modifications

**New state:**
```typescript
const [isPasteActive, setIsPasteActive] = useState(false);
const [showCohesionPanel, setShowCohesionPanel] = useState(false);
const [cohesionResult, setCohesionResult] = useState<CohesionResult | null>(null);
```

**New handlers:**
```typescript
const handlePasteSlide = async (pasteResult: PasteResult) => {
  // Similar pattern to handleInsertBlankSlide / handleInsertExemplarSlide
  // 1. Create temp slide
  // 2. Call AI to analyze
  // 3. Update slide with results
};

const handleMakeCohesive = async () => {
  // 1. Set loading state
  // 2. Call provider.makeCohesive(slides, lessonText)
  // 3. Show CohesionPanel with results
};

const handleApplyCohesion = (result: CohesionResult) => {
  // Apply accepted suggestions to slides
};
```

### InsertPoint Modifications

Add "Paste" button option:
```typescript
<button onClick={onClickPaste}>Paste</button>
```

This triggers focus on paste zone or opens a paste dialog.

### Types.ts Additions

```typescript
// Slide type extension for paste tracking
interface Slide {
  // ... existing fields
  sourceType?: 'generated' | 'pasted' | 'blank';  // Track origin
  originalPasteContent?: string;  // Keep original for reference
}

// Cohesion types
interface CohesionSuggestion {
  type: 'reorder' | 'gap' | 'transition' | 'style';
  description: string;
  affectedSlides: number[];
  autoApplicable: boolean;
}
```

## Patterns to Follow

### Pattern 1: Window Event Hooks
**What:** Centralize window event handling in custom hooks
**When:** Any feature needing document/window-level events
**Example:** usePaste follows useDragDrop pattern

```typescript
// Pattern from useDragDrop.ts
useEffect(() => {
  if (!enabled) return;

  const handler = (e: Event) => {
    e.preventDefault();
    // Process event
    onCallback(result);
  };

  window.addEventListener('eventType', handler);
  return () => window.removeEventListener('eventType', handler);
}, [onCallback, enabled]);
```

### Pattern 2: Temp Slide → AI Process → Update
**What:** Show placeholder, process async, update in place
**When:** Any AI-assisted slide creation
**Example:** handleInsertExemplarSlide, handleInsertElaborateSlide

```typescript
// 1. Create temp slide with loading state
const tempId = `temp-paste-${Date.now()}`;
const tempSlide: Slide = {
  id: tempId,
  title: "Processing paste...",
  content: ["Analyzing content..."],
  isGeneratingImage: true,
};
setSlides([...slides, tempSlide]);

// 2. Process with AI
const processed = await provider.analyzeSlide(pasteResult);

// 3. Update in place
setSlides(curr => curr.map(s =>
  s.id === tempId ? { ...processed, id: tempId } : s
));
```

### Pattern 3: Provider Strategy
**What:** All AI operations through provider interface
**When:** Any new AI feature
**Example:** Add methods to AIProviderInterface, implement in both providers

```typescript
// In aiProvider.ts interface
analyzeSlide(content: PasteResult): Promise<Partial<Slide>>;

// In GeminiProvider.ts
async analyzeSlide(content: PasteResult): Promise<Partial<Slide>> {
  // Gemini-specific implementation
}

// In ClaudeProvider.ts
async analyzeSlide(content: PasteResult): Promise<Partial<Slide>> {
  // Claude-specific implementation
}
```

## Anti-Patterns to Avoid

### Anti-Pattern 1: Direct DOM Clipboard Access
**What:** Using document.execCommand or synchronous clipboard API
**Why bad:** Deprecated, inconsistent across browsers
**Instead:** Use async Clipboard API with paste event fallback

### Anti-Pattern 2: State in Components
**What:** Managing slide state in CohesionPanel or PasteZone
**Why bad:** Breaks centralized state model, causes sync issues
**Instead:** All state in App.tsx, components receive props + callbacks

### Anti-Pattern 3: Blocking AI Calls
**What:** Awaiting AI without showing loading state
**Why bad:** UI freezes, poor UX
**Instead:** Set loading state, use temp slides, update async

### Anti-Pattern 4: Breaking Existing Slide Types
**What:** Modifying Slide interface in breaking ways
**Why bad:** Breaks file compatibility, existing presentations
**Instead:** Add optional fields, maintain backward compatibility

## Build Order Recommendation

### Phase 1: Paste Infrastructure
1. **usePaste hook** - Core paste event handling
2. **Types updates** - PasteResult, sourceType field
3. **Basic handlePasteSlide** - Insert raw paste without AI
4. **Visual feedback** - Toast for paste success

**Rationale:** Get paste working end-to-end before adding AI. Allows testing with real PowerPoint content.

### Phase 2: AI Slide Analysis
1. **AIProviderInterface.analyzeSlide** - Interface definition
2. **GeminiProvider implementation** - Primary provider
3. **ClaudeProvider implementation** - Secondary provider
4. **Integration** - Connect to handlePasteSlide

**Rationale:** AI analysis builds on working paste. Provider parity important for consistency.

### Phase 3: Image Paste
1. **Image extraction in usePaste** - Handle blob conversion
2. **Full-image layout option** - New layout type in SlideCard
3. **Image-only slide creation** - No AI processing needed

**Rationale:** Image paste is simpler than HTML but different code path. Separate phase reduces complexity.

### Phase 4: Deck Cohesion
1. **AIProviderInterface.makeCohesive** - Interface definition
2. **CohesionPanel component** - Review UI
3. **Provider implementations** - Both providers
4. **Apply suggestions handler** - Update slides based on selection

**Rationale:** Cohesion requires complete deck context. Best built after paste is stable.

### Phase 5: Gap Analysis
1. **Lesson plan integration** - Optional upload after deck built
2. **AIProviderInterface.suggestGapSlides** - Interface
3. **Gap suggestion UI** - Show in CohesionPanel
4. **Insert suggested slides** - Reuse existing insert patterns

**Rationale:** Gap analysis is extension of cohesion. Leverages existing lesson plan parsing.

## Integration Points Summary

| Existing Component | Integration Type | Details |
|--------------------|------------------|---------|
| App.tsx | Extend | Add paste handler, cohesion state |
| AIProviderInterface | Extend | Add 3 new methods |
| GeminiProvider | Extend | Implement new methods |
| ClaudeProvider | Extend | Implement new methods |
| types.ts | Extend | Add optional fields |
| InsertPoint | Modify | Add paste option |
| Landing page | Modify | Add paste hint/zone |
| SlideCard | Modify | Add full-image layout option |

## Clipboard API Notes

### Browser Compatibility (HIGH confidence)

The Async Clipboard API `read()` method can access images. The `clipboardData` from paste events provides:
- `text/plain` - Always available
- `text/html` - Available when copying from rich sources
- `image/png` - Available when copying images

When copying from PowerPoint desktop:
- Slide image rendered as PNG
- Formatted text as HTML
- Plain text fallback

### Permission Considerations

Reading clipboard on paste events does NOT require permission - the paste is user-initiated. Only programmatic `navigator.clipboard.read()` requires permission.

## Scalability Considerations

| Concern | At 5 slides | At 20 slides | At 50+ slides |
|---------|-------------|--------------|---------------|
| Cohesion AI call | Fast (<2s) | Moderate (3-5s) | May need chunking |
| Gap analysis | Fast | Fast | Context limits may apply |
| Paste processing | Instant | Instant | Instant |
| State updates | Fast | Fast | Consider batching |

**Recommendation:** For cohesion with large decks, consider:
- Summarizing slides before AI call (title + first bullet)
- Progressive disclosure of suggestions
- Background processing with progress indicator

## Sources

- Codebase analysis: App.tsx, useDragDrop.ts, aiProvider.ts, types.ts
- [web.dev - How to paste images](https://web.dev/patterns/clipboard/paste-images)
- [The web's clipboard, and how it stores data](https://alexharri.com/blog/clipboard)
- [SitePoint - Clipboard API](https://www.sitepoint.com/clipboard-api/)
- [Lucid - Definitive Guide to Copying and Pasting in JavaScript](https://lucid.co/techblog/2014/12/02/definitive-guide-copying-pasting-javascript)
- [Microsoft - PowerPoint copy and paste](https://support.microsoft.com/en-us/office/copy-and-paste-in-powerpoint-for-the-web-e5bf5376-cf9f-482c-a72c-c98f8a1ba4ed)
