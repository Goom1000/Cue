# Project Research Summary: v4.0 Clipboard Builder

**Project:** Cue v4.0 - Clipboard Paste & Deck Cohesion
**Domain:** Teacher presentation tool with AI enhancement
**Researched:** 2026-02-02
**Confidence:** HIGH

## Executive Summary

The v4.0 Clipboard Builder milestone enables teachers to paste slides directly from PowerPoint and images from their clipboard, then unify mismatched content with an AI-powered "Make Cohesive" button. Research confirms this requires **zero new dependencies** - the existing stack (native Clipboard API, @google/genai embeddings, established slide manipulation patterns in App.tsx) provides everything needed. The architecture follows Cue's existing patterns: centralized state in App.tsx, AI operations through the provider strategy pattern, and temp-slide-then-update for async processing.

The primary technical risk is **browser clipboard permission fragmentation** - Safari and Firefox handle clipboard access differently than Chrome, requiring feature detection and paste-event fallbacks. The primary UX risk is **AI cohesion destroying user edits** - without content provenance tracking, the "Make Cohesive" button could overwrite carefully crafted manual changes. Both risks have clear mitigations documented in the research.

The recommended approach is to build in phases: paste infrastructure first (proving end-to-end flow works), then AI enhancement of pasted content, then image handling, then cohesion features, and finally gap analysis. This ordering respects technical dependencies and allows early validation with real PowerPoint content before investing in advanced AI features.

## Key Findings

### Recommended Stack

No new packages required. The existing stack fully supports this milestone:

**Core technologies:**
- **Native Clipboard API** (browser): Paste handling via `paste` event + `clipboardData` - 96%+ browser support, no permissions needed for paste events
- **@google/genai ^1.30.0** (already installed): `embedContent` API for semantic similarity in gap analysis - 3072-dimension embeddings, significantly cheaper than generative calls
- **Existing imageProcessor.ts pattern**: Reuse for processing pasted images - proven approach already in codebase

**Key insight:** PowerPoint copies as CF_HTML format with `text/html`, `text/plain`, and optionally `image/png`. Parse HTML for structured content, fall back to plain text. No special libraries needed.

### Expected Features

**Must have (table stakes):**
- Paste images via Ctrl/Cmd+V - universal UX expectation
- Paste text with formatting - users copy from web/docs
- Paste feedback (visual confirmation) - users need to know it worked
- Loading state during AI processing - standard async UX
- Undo paste action - mistakes happen

**Should have (differentiators):**
- AI-powered slide improvement on paste - restructure with proper layouts
- "Make Cohesive" button - one-click to unify mismatched slides
- Lesson plan gap analysis - compare slides against uploaded lesson plan
- Batch paste (multiple slides) - power user workflow

**Defer (v4.1+):**
- Paste directly into presentation mode (editing should happen in edit mode)
- Complex paste formatting dialogs (AI decides, minimal UI)
- Auto-generate images for every pasted slide (slow, expensive)

### Architecture Approach

The architecture extends existing patterns rather than introducing new ones. A new `usePaste` hook follows the `useDragDrop.ts` pattern for window-level event handling. State remains centralized in App.tsx with new handlers (`handlePasteSlide`, `handleMakeCohesive`, `handleApplyCohesion`). AI operations extend `AIProviderInterface` with three new methods: `analyzeSlide()`, `makeCohesive()`, and `suggestGapSlides()`.

**Major components:**
1. **usePaste hook** - Captures paste events, extracts images/HTML/text, returns typed `PasteResult`
2. **PasteZone component** - Visual paste target with drag-drop support, renders on landing page
3. **CohesionPanel component** - Modal/sidebar for "Make Cohesive" review UI, shows suggestions with accept/reject controls
4. **AIProvider extensions** - `analyzeSlide()` for paste improvement, `makeCohesive()` for deck unification, `suggestGapSlides()` for gap analysis

### Critical Pitfalls

1. **Browser Clipboard API Permission Fragmentation** - Different browsers (Chrome vs Safari vs Firefox) implement clipboard permissions completely differently. Code that works in Chrome fails silently in Safari. **Prevention:** Use feature detection, implement paste-event fallback, test on all three browser engines early.

2. **XSS via Unsanitized Clipboard HTML** - PowerPoint clipboard data includes complex HTML that could contain scripts or malicious content. Known CVEs exist (e.g., CVE-2020-26956). **Prevention:** Sanitize with DOMPurify BEFORE any DOM insertion, never trust browser sanitization alone.

3. **AI Cohesion Destroys User Edits** - "Make Cohesive" receives full deck, returns full deck potentially rewritten. Teacher's careful customizations get overwritten. **Prevention:** Track content provenance (`source: 'ai-generated' | 'pasted' | 'manual'`), cohesion only modifies AI-generated content by default, show diff preview before applying.

4. **PowerPoint Clipboard Data Loss** - HTML representation may lose tables (rendered as tab-separated garbage) and images (stored as external references). **Prevention:** Accept HTML first, fall back to plain text, warn users "copy one slide at a time for best results," parse HTML tables specifically.

5. **State Explosion with Paste History** - Each paste adds megabytes (base64 images) to state, filling localStorage (5-10MB limit). **Prevention:** Track state size, consider IndexedDB for images, compress on paste, offer "export and clear" workflow.

## Implications for Roadmap

Based on research, suggested phase structure:

### Phase 1: Paste Infrastructure
**Rationale:** Get paste working end-to-end before adding AI. Allows testing with real PowerPoint content.
**Delivers:** Basic paste → slide workflow, visual feedback, undo
**Addresses:** Table stakes (paste images, paste text, paste feedback)
**Avoids:** Browser permission fragmentation (test all browsers early)

Implementation tasks:
1. `usePaste` hook - Core paste event handling
2. Types updates - `PasteResult` interface, `sourceType` field on Slide
3. Basic `handlePasteSlide` - Insert raw paste without AI processing
4. Visual feedback - Toast for paste success

### Phase 2: AI Slide Analysis
**Rationale:** AI enhancement builds on working paste. Provider parity is important for user consistency.
**Delivers:** Pasted slides get AI improvement (layouts, structure, notes)
**Uses:** Existing AI provider pattern, `analyzeSlide()` method
**Implements:** AIProviderInterface extension for both Gemini and Claude

Implementation tasks:
1. `AIProviderInterface.analyzeSlide()` - Interface definition
2. GeminiProvider implementation
3. ClaudeProvider implementation
4. Integration with `handlePasteSlide`

### Phase 3: Image Paste
**Rationale:** Image paste is simpler than HTML but different code path. Separate phase reduces complexity.
**Delivers:** Paste screenshots/images directly, full-image layout support
**Avoids:** Format inconsistency (accept that all images become PNG)

Implementation tasks:
1. Image extraction in `usePaste` - Handle blob → base64 conversion
2. Full-image layout option in SlideCard
3. Image-only slide creation (no AI processing needed)
4. Size validation and compression

### Phase 4: Deck Cohesion
**Rationale:** Cohesion requires complete deck context. Best built after paste is stable.
**Delivers:** "Make Cohesive" button, preview before applying, user edit protection
**Avoids:** Destroying user edits (provenance tracking from Phase 1 pays off)

Implementation tasks:
1. `AIProviderInterface.makeCohesive()` - Interface definition
2. CohesionPanel component - Review UI with accept/reject
3. Provider implementations (Gemini, Claude)
4. Apply suggestions handler with diff preview

### Phase 5: Gap Analysis
**Rationale:** Gap analysis is extension of cohesion. Leverages existing lesson plan parsing and embeddings.
**Delivers:** Compare slides to lesson plan, identify missing topics, offer to generate missing slides
**Uses:** Gemini embeddings (`embedContent`) for semantic similarity

Implementation tasks:
1. Lesson plan topic extraction (using existing `lessonText` state)
2. `AIProviderInterface.suggestGapSlides()` - Interface
3. Gap suggestion UI in CohesionPanel
4. Insert suggested slides using existing insert patterns

### Phase Ordering Rationale

- **Phase 1 before 2:** Paste must work before AI can improve it. Early browser testing catches Safari/Firefox issues.
- **Phase 2 before 3:** Text/HTML paste is more complex than images; solving it first establishes patterns for simpler image case.
- **Phase 3 before 4:** Image handling adds state size concerns that inform cohesion design decisions.
- **Phase 4 before 5:** Cohesion UI (CohesionPanel) provides the container for gap analysis features.
- **XSS mitigation in Phase 1:** DOMPurify sanitization must be present from day 1, not retrofitted.

### Research Flags

**Phases likely needing deeper research during planning:**
- **Phase 4 (Cohesion):** User expectations for "cohesion" are ambiguous (visual vs narrative vs structural). Consider user research or explicit UI options.
- **Phase 5 (Gap Analysis):** Embedding threshold tuning needed - what cosine similarity score means "topic covered"?

**Phases with standard patterns (skip research-phase):**
- **Phase 1 (Paste Infrastructure):** Well-documented browser APIs, MDN/web.dev provide clear patterns
- **Phase 2 (AI Analysis):** Extends existing provider pattern, no novel architecture
- **Phase 3 (Image Paste):** Subset of Phase 1 patterns, simpler case

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | HIGH | Zero new dependencies needed; Clipboard API and Gemini embeddings well-documented |
| Features | HIGH | Table stakes verified across competitors (Diffit, MagicSchool); differentiators based on established patterns |
| Architecture | HIGH | Direct extension of existing App.tsx patterns; codebase analysis confirms integration points |
| Pitfalls | HIGH | Clipboard issues verified with MDN/CVEs; XSS advisories cited; Cue-specific issues from codebase analysis |

**Overall confidence:** HIGH

### Gaps to Address

- **Cohesion definition clarity:** "Make Cohesive" could mean visual consistency, narrative flow, or structural normalization. Need to decide before Phase 4 implementation or offer explicit options in UI.
- **Embedding threshold tuning:** For gap analysis, what cosine similarity score indicates adequate coverage? Will need empirical testing with real lesson plans.
- **Large deck performance:** Cohesion AI call at 50+ slides may hit context limits. Consider summarizing slides (title + first bullet) before sending to AI.
- **CueFile migration:** Adding `source` and `pastedAt` fields to Slide requires version bump and migration logic. Plan before Phase 1.

## Sources

### Primary (HIGH confidence)
- [MDN Clipboard API](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API) - Browser compatibility, permission model
- [MDN Paste Event](https://developer.mozilla.org/en-US/docs/Web/API/Element/paste_event) - Event handling patterns
- [web.dev Clipboard Access](https://web.dev/articles/async-clipboard) - Modern async patterns
- [web.dev Paste Images](https://web.dev/patterns/clipboard/paste-images) - Image paste implementation
- [Gemini Embeddings API](https://ai.google.dev/gemini-api/docs/embeddings) - embedContent documentation
- [@google/genai npm](https://www.npmjs.com/package/@google/genai) - SDK v1.39.0 capabilities

### Secondary (MEDIUM confidence)
- [Microsoft PowerPoint Copy/Paste](https://support.microsoft.com/en-us/office/copy-and-paste-in-powerpoint-for-the-web-e5bf5376-cf9f-482c-a72c-c98f8a1ba4ed) - Clipboard format limitations
- [DeckRobot](https://www.deckrobot.com/) - Deck cohesion feature patterns
- [Beautiful.ai](https://www.beautiful.ai/) - Smart slide design patterns
- [GitHub paste-markdown Security Advisory](https://github.com/github/paste-markdown/security/advisories/GHSA-gpfj-4j6g-c4w9) - XSS via clipboard

### Tertiary (Cue-specific)
- Cue codebase analysis: App.tsx, useDragDrop.ts, aiProvider.ts, types.ts
- Existing slide manipulation patterns in handleInsertExemplarSlide, handleInsertElaborateSlide

---
*Research completed: 2026-02-02*
*Ready for roadmap: yes*
