# Milestone v3.8: Preserve Teacher Content

**Status:** SHIPPED 2026-02-01
**Phases:** 48-50
**Total Plans:** 7

## Overview

This milestone teaches the AI to distinguish between content that should be transformed (explanatory text) and content that must be preserved verbatim (teacher-specified questions, activities, and instructions). The solution is prompt engineering with heuristic detection, not architectural changes. Teachers upload lesson plans containing "What is 3/4 of 12?" and that exact question appears on slides and in the teleprompter, not a generalized "practice fractions."

## Phases

### Phase 48: Detection and Rules Foundation

**Goal:** Build the detection patterns and prompt rules that identify preservable content before AI processing.
**Depends on:** None (foundation phase)
**Plans:** 3 plans

Plans:
- [x] 48-01-PLAN.md — Detection module with types and regex patterns for questions/activities
- [x] 48-02-PLAN.md — Prompt rules module with XML tags and few-shot examples
- [x] 48-03-PLAN.md — Unit tests verifying all DET requirements

**Requirements:**
- DET-01: Detect questions by punctuation (sentences ending with `?`)
- DET-02: Detect questions by context ("Ask:", "Ask students:", question-related headings)
- DET-03: Detect activities by instructional language (action verbs like "list", "discuss", "complete")
- DET-04: Detection works on lesson plan PDF input
- DET-05: Detection works on PowerPoint input (Refine/Blend modes)

**Details:**
- Type system for detected content with ContentType, ConfidenceLevel, and DetectionMethod
- Question detection via punctuation (?), context prefixes (Ask:, Question:), and numbered lists
- Activity detection via Bloom's taxonomy action verbs (60+ verbs across 6 cognitive levels)
- Rhetorical question filtering with pattern-based confidence downgrade
- XML escaping and tag building utilities for prompt construction
- 102 unit tests with Jest infrastructure

---

### Phase 49: Provider Integration and Preservation

**Goal:** Integrate preservation rules into both AI providers so preserved content appears verbatim in slides and teleprompter.
**Depends on:** Phase 48 (detection patterns and rules must exist)
**Plans:** 2 plans

Plans:
- [x] 49-01-PLAN.md — Claude provider integration with detection and preservation rules
- [x] 49-02-PLAN.md — Gemini service integration with detection and preservation rules

**Requirements:**
- PRES-01: Preserved questions appear verbatim on slides
- PRES-02: Preserved questions appear in teleprompter with delivery context
- PRES-03: Preserved activities appear verbatim on slides
- PRES-04: Preserved activities appear in teleprompter with delivery context
- PRES-05: Preservation works in Fresh mode (lesson plan only)
- PRES-06: Preservation works in Refine mode (existing presentation)
- PRES-07: Preservation works in Blend mode (lesson + presentation)

**Details:**
- Detection runs at generateLessonSlides entry point before prompt building
- Mode-specific source text selection: Fresh/Blend use lessonText, Refine uses presentationText
- Mode-specific confidence filtering: Refine requires high confidence, Fresh/Blend allow medium
- Preservation rules injected into system prompts for all three generation modes
- Teleprompter preservation rules injected for delivery context in speaker notes

---

### Phase 50: Quality Assurance

**Goal:** Ensure preservation doesn't degrade the quality of non-preserved content or break existing functionality.
**Depends on:** Phase 49 (preservation must be working to assess quality impact)
**Plans:** 2 plans

Plans:
- [x] 50-01-PLAN.md — Test infrastructure and fixtures for quality validation
- [x] 50-02-PLAN.md — Validation execution with human quality review and refinement

**Requirements:**
- QUAL-01: Non-preserved content maintains student-friendly language
- QUAL-02: Slide flow remains coherent around preserved elements
- QUAL-03: Teleprompter quality does not degrade
- QUAL-04: Existing slide layouts continue to work correctly

**Details:**
- 3 test fixtures: sparse (2 preserved elements), dense (11 elements), edge-case (long questions, multi-part activities, rhetorical detection)
- Structured quality review checklist mapping to QUAL-01 through QUAL-04
- All fixtures passed human quality review without prompt refinements needed

---

## Milestone Summary

**Key Decisions:**

- Native RegExp for detection (no NLP library needed) — sufficient for educational text patterns
- Rhetorical questions flagged as low confidence, not excluded — allows future UI to show if needed
- Bloom's taxonomy verbs for activity detection (60+ verbs across 6 cognitive levels)
- XML tags with type/method attributes for preserve instructions
- Medium confidence default filter to skip low-confidence detections
- Fresh/Blend modes use medium confidence threshold; Refine uses high
- Jest 30 with ES Module support via --experimental-vm-modules

**Issues Resolved:**

- npm dependency conflict with React 19 peer dependency — resolved with --legacy-peer-deps
- Jest testPathPattern deprecated in Jest 30 — updated to --testPathPatterns

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- Debug console.log statements in claudeProvider.ts and geminiService.ts — intentional development logging, can be removed later
- RESULTS-*.md files are templates with unchecked boxes — human verification was performed but not documented in structured format

---

_For current project status, see .planning/PROJECT.md_
